<?xml version="1.0" encoding="utf-8" ?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">  
<!--http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd-->  
<html xmlns="http://www.w3.org/1999/xhtml"  
> 
<head>
   <title>Notes on tokamak equilibrium</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
<meta name="generator" content="TeX4ht (http://www.tug.org/tex4ht/)" /> 
<meta name="originator" content="TeX4ht (http://www.tug.org/tex4ht/)" /> 
<!-- xhtml,2,charset=utf-8,html --> 
<meta name="src" content="tokamak_equilibrium.tex" /> 
<link rel="stylesheet" type="text/css" href="tokamak_equilibrium.css" /> 
</head><body 
>
   <div class="maketitle">
                                                                                

                                                                                
   <a 
 id="likesection.1"></a><a 
 id="x1-2r1"></a>
                                                                                

                                                                                
                                                                                

                                                                                

<h2 class="titleHead">Notes on tokamak equilibrium</h2>
<div class="author" >Youjun Hu<span 
class="cmr-7">1</span></div>
<div class="institute"> <span 
class="cmr-9">Institute of Plasma Physics, Chinese Academy of Sciences</span><br />
<span 
class="cmr-9">Email: yjhu@ipp.cas.cn </span></div>
<div class="thanks" ><br /><a 
 id="tk-1"></a><span class="thank-mark"><span 
class="cmmi-10">⋆</span></span><span 
class="cmti-10">Note: </span>This document has been written using GNU TE X<span 
class="cmcsc-10"><span 
class="small-caps">m</span><span 
class="small-caps">a</span><span 
class="small-caps">c</span><span 
class="small-caps">s</span></span> <span class="cite">[<span 
class="cmbx-10">?</span>]</span>.</div><a 
 id="Q1-1-1"></a><a 
 id="Q1-1-2"></a></div>
   <div 
class="abstract" 
>
     <span 
class="cmbx-9">Abstract.</span> <span 
class="cmr-9">This  document  discusses  the  free  boundary  equilibrium  ﬁtting  problem,</span>
     <span 
class="cmr-9">ﬁxed-boundary equilibrium problem, and magnetic coordinates.</span>
</div>
<!--l. 38--><p class="indent" >    
</p>
   <div class="tableofcontents">
    <span class="sectionToc" >1 <a 
href="#x1-10001" id="QQ2-1-3"> Axisymmetric magnetic ﬁeld</a></span>
<br />    <span class="sectionToc" >2 <a 
href="#x1-140002" id="QQ2-1-21">Non-axisymmetric magnetic perturbations</a></span>
<br />    <span class="sectionToc" >3 <a 
href="#x1-150003" id="QQ2-1-22">Plasma current density in terms of <span 
class="cmmi-10">Ψ </span>and <span 
class="cmmi-10">g</span></a></span>
<br />    <span class="sectionToc" >4 <a 
href="#x1-180004" id="QQ2-1-25">Constraint of force-balance on magnetic ﬁeld</a></span>
<br />    <span class="sectionToc" >5 <a 
href="#x1-230005" id="QQ2-1-30">Free-boundary ﬁtting problem</a></span>
<br />    <span class="sectionToc" >6 <a 
href="#x1-290006" id="QQ2-1-36">Magnetic control (to be continued)</a></span>
<br />    <span class="sectionToc" >7 <a 
href="#x1-300007" id="QQ2-1-37">Circuit equation</a></span>
<br />    <span class="sectionToc" >8 <a 
href="#x1-350008" id="QQ2-1-42">Coordinates based on magnetic ﬁeld structure</a></span>
<br />    <span class="sectionToc" >9 <a 
href="#x1-600009" id="QQ2-1-68">Constructing magnetic surface coordinate system from discrete <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>) data</a></span>
<br />    <span class="sectionToc" >10 <a 
href="#x1-6400010" id="QQ2-1-79">Magnetic surface averaging</a></span>
<br />    <span class="sectionToc" >11 <a 
href="#x1-6600011" id="QQ2-1-81">Flux Surface Functions</a></span>
<br />    <span class="sectionToc" >12 <a 
href="#x1-6700012" id="QQ2-1-82">Magnetic ﬂux diﬀusion equation</a></span>
<br />    <span class="sectionToc" >13 <a 
href="#x1-7200013" id="QQ2-1-87">Fixed boundary equilibrium problem</a></span>
<br />    <span class="sectionToc" >14 <a 
href="#x1-8100014" id="QQ2-1-100">Magnetic coordinates with general toroidal angle</a></span>
<br />    <span class="sectionToc" >15 <a 
href="#x1-9200015" id="QQ2-1-111">Field-line-following coordinates</a></span>
   </div>
   <h3 class="sectionHead"><span class="titlemark">1   </span> <a 
 id="x1-10001"></a> Axisymmetric magnetic ﬁeld</h3>
<!--l. 42--><p class="noindent" >Due to the divergence-free condition, i.e., <span 
class="cmsy-10">∇⋅</span> <span 
class="cmbx-10">B</span> = 0, magnetic ﬁeld can be expressed as the curl of a
vector ﬁeld:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-1001r1"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium0x.png" alt="B = ∇ × A,
" class="math-display"  /></center></td><td class="equation-label">(1)</td></tr></table>
<!--l. 46--><p class="nopar" >
where <span 
class="cmbx-10">A </span>is called the vector potential of <span 
class="cmbx-10">B</span>. (The usefullness of this representation is that, once <span 
class="cmbx-10">B </span>is in
this form, we do not need to worry about the divergence-free constraint.) In cylindrical coordinates
(<span 
class="cmmi-10">R,ϕ,Z</span>), the above expression is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-1002r2"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium1x.png" alt="    (             )    (                  )     (           )
B =   1∂AZ- − ∂A-ϕ Rˆ +  1-∂(RA-ϕ)− -1∂AR-  ˆZ +  ∂AR- − ∂AZ-  ˆϕ.
      R ∂ϕ    ∂Z         R   ∂R     R  ∂ϕ         ∂Z    ∂R
" class="math-display"  /></center></td><td class="equation-label">(2)</td></tr></table>
<!--l. 58--><p class="nopar" >
We consider axisymmetric magnetic ﬁeld, which means that, when expressed in the cylindrical
coordinate system (<span 
class="cmmi-10">R,ϕ,Z</span>), the components of <span 
class="cmbx-10">B</span>, namely <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">R</span></sub>, <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">Z</span></sub>, and <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">ϕ</span></sub>, are all independent of <span 
class="cmmi-10">ϕ</span>.
For this case, it can be proved that an axisymmetric vector potential <span 
class="cmbx-10">A </span>suﬃces for expressing the
magnetic ﬁeld, i.e., all the components of the vector potential <span 
class="cmbx-10">A </span>can also be taken independent of <span 
class="cmmi-10">ϕ</span>.
Using this, Eq. (<a 
href="#x1-1002r2">2<!--tex4ht:ref: 4-16-p1 --></a>) is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-1003r3"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium2x.png" alt="     ∂A       1∂(RA  )    (∂A     ∂A  )
B = −---ϕRˆ+ -------ϕ-ˆZ +  ---R − ---Z  ˆϕ.
      ∂Z     R   ∂R         ∂Z     ∂R
" class="math-display"  /></center></td><td class="equation-label">(3)</td></tr></table>
                                                                                

                                                                                
<!--l. 71--><p class="nopar" >
In tokamak literature, <img 
src="tokamak_equilibrium3x.png" alt="ˆϕ"  class="circ"  /> direction is called the toroidal direction, and (<span 
class="cmmi-10">R,Z</span>) planes (i.e., <span 
class="cmmi-10">ϕ </span>= const
planes) are called poloidal planes.
</p><!--l. 76--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">1.1   </span> <a 
 id="x1-20001.1"></a>Poloidal magnetic ﬁeld</h4>
<!--l. 78--><p class="noindent" >Equation (<a 
href="#x1-1003r3">3<!--tex4ht:ref: 9-6-p1 --></a>) indicates that the two poloidal components of <span 
class="cmbx-10">B</span>, namely <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">R</span></sub> and <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">Z</span></sub>, are
determined by a single component of <span 
class="cmbx-10">A</span>, namely <span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">ϕ</span></sub>. This motivates us to deﬁne a function
<span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>):
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-2001r4"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium4x.png" alt="Ψ (R, Z) ≡ RA ϕ(R,Z ).
" class="math-display"  /></center></td><td class="equation-label">(4)</td></tr></table>
<!--l. 84--><p class="nopar" >
Then Eq. (<a 
href="#x1-1003r3">3<!--tex4ht:ref: 9-6-p1 --></a>) implies the poloidal components, <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">R</span></sub> and <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">Z</span></sub>, can be written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-2002r5"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium5x.png" alt="       1∂ Ψ
BR = −R-∂Z-,
" class="math-display"  /></center></td><td class="equation-label">(5)</td></tr></table>
<!--l. 89--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-2003r6"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium6x.png" alt="      1-∂Ψ-
BZ =  R ∂R.
" class="math-display"  /></center></td><td class="equation-label">(6)</td></tr></table>
<!--l. 92--><p class="nopar" >
(Note that it is the property of being axisymmetric and divergence-free that enables us to express the
two components of <span 
class="cmbx-10">B</span>, namely <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">R</span></sub> and <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">Z</span></sub>, in terms of a single function <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>).) Furthermore, it
is ready to prove that <span 
class="cmmi-10">Ψ </span>is constant along a magnetic ﬁeld line, i.e. <span 
class="cmbx-10">B </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">Ψ </span>= 0. [Proof:
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium7x.png" alt="           (            )
             ∂Ψ-ˆ   ∂Ψ-ˆ
B ⋅∇ Ψ = B ⋅  ∂RR +  ∂ZZ
          1 ∂Ψ ∂Ψ   1 ∂Ψ ∂Ψ
      = − R-∂Z-∂R-+ R-∂R-∂Z-
      = 0.                                         (7)
" class="math-display"  /></center>
</div>]
<!--l. 109--><p class="indent" >   (We note that <span 
class="cmmi-10">Ψ </span>is related to poloidal magnetic ﬂux, as we will discuss in Sec. <a 
href="#x1-80001.7">1.7<!--tex4ht:ref: 9-5-5 --></a>.)
</p><!--l. 112--><p class="indent" >   Using Eqs. (<a 
href="#x1-2002r5">5<!--tex4ht:ref: 7-14-p1 --></a>) and (<a 
href="#x1-2003r6">6<!--tex4ht:ref: 6-9-a4 --></a>), the poloidal magnetic ﬁeld <span 
class="cmbx-10">B</span><sub><span 
class="cmmi-7">p</span></sub> is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium8x.png" alt="Bp = BRRˆ +BZ ˆZ
       1∂ Ψ     1∂Ψ
   = −R-∂Z-Rˆ+ R-∂R-ˆZ
     1
   = R-∇Ψ × ˆϕ
   = ∇Ψ × ∇ ϕ                                   (8)
" class="math-display"  /><a 
 id="x1-2005r8"></a></center>
</div>
<!--l. 122--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">1.2   </span> <a 
 id="x1-30001.2"></a>Toroidal magnetic ﬁeld</h4>
<!--l. 124--><p class="noindent" >Next, let’s examine the toroidal component <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">ϕ</span></sub>. Equation (<a 
href="#x1-1003r3">3<!--tex4ht:ref: 9-6-p1 --></a>) indicates that <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">ϕ</span></sub> involves both <span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">R</span></sub> and
<span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">Z</span></sub>. This indicates that using the potential form does not enable useful simpliﬁcation for <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">ϕ</span></sub>. Therfore
we will directly use <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">ϕ</span></sub>. Deﬁne <span 
class="cmmi-10">g </span><span 
class="cmsy-10">≡ </span><span 
class="cmmi-10">RB</span><sub><span 
class="cmmi-7">ϕ</span></sub>(<span 
class="cmmi-10">R,Z</span>) (the reason that we deﬁne this quantity will
become clear when we discuss the forece balance), then the toroidal magnetic ﬁeld is written
as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-3001r9"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium9x.png" alt="            g
Bϕ = Bϕϕˆ=  Rˆϕ = g∇ ϕ.
" class="math-display"  /></center></td><td class="equation-label">(9)</td></tr></table>
<!--l. 133--><p class="nopar" >
</p><!--l. 135--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">1.3   </span> <a 
 id="x1-40001.3"></a>General form of axisymmetric magnetic ﬁeld</h4>
<!--l. 137--><p class="noindent" >Combining Eqs. (<a 
href="#x1-2005r8">8<!--tex4ht:ref: 20-5-9-p10 --></a>) and (<a 
href="#x1-3001r9">9<!--tex4ht:ref: 7-28-1 --></a>), we obtain </p><div class="eqnarray">
   <center class="math-display" >
                                                                                

                                                                                
<img 
src="tokamak_equilibrium10x.png" alt="B = Bp + B ϕ
  = ∇ Ψ × ∇ϕ + g∇ϕ,                           (10)
" class="math-display"  /><a 
 id="x1-4001r10"></a></center>
</div>which is a general expression of axisymmetric magnetic ﬁeld. Expression (<a 
href="#x1-4001r10">10<!--tex4ht:ref: 7-28-6 --></a>) is a famous formula in
tokamak physics.
<!--l. 145--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">1.4   </span> <a 
 id="x1-50001.4"></a>Gauge freedom of <span 
class="cmmi-10">Ψ</span></h4>
<!--l. 147--><p class="noindent" >Let us discuss the gauge freedom of <span 
class="cmbx-10">A </span>in the axisymmetric case. Magnetic ﬁeld remains the same under
the following gauge transformation of the vector potential:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-5001r11"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium11x.png" alt="Anew = A +∇f,
" class="math-display"  /></center></td><td class="equation-label">(11)</td></tr></table>
<!--l. 152--><p class="nopar" >
where <span 
class="cmmi-10">f </span>is an arbitrary scalar ﬁeld. Here we require that <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">f </span>be axisymmetric because, as mentioned
above, an axisymmetric vector potential suﬃces for describing an axisymmetric magnetic ﬁeld. In
cylindrical coordinates, <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">f </span>is given by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-5002r12"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium12x.png" alt="      ∂f     ∂f    1 ∂f
∇f = ---Rˆ+ ---ˆZ + ----ϕˆ.
     ∂R     ∂Z     R ∂ϕ
" class="math-display"  /></center></td><td class="equation-label">(12)</td></tr></table>
                                                                                

                                                                                
<!--l. 161--><p class="nopar" >
Since <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">f </span>is axisymmetric, it follows that all the three components of <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">f </span>are independent of <span 
class="cmmi-10">ϕ</span>, i.e.,
<span 
class="cmmi-10">∂</span><sup><span 
class="cmr-7">2</span></sup><span 
class="cmmi-10">f∕∂R∂ϕ </span>= 0, <span 
class="cmmi-10">∂</span><sup><span 
class="cmr-7">2</span></sup><span 
class="cmmi-10">f∕∂Z∂ϕ </span>= 0, and <span 
class="cmmi-10">∂</span><sup><span 
class="cmr-7">2</span></sup><span 
class="cmmi-10">f∕∂ϕ</span><sup><span 
class="cmr-7">2</span></sup> = 0, which implies that <span 
class="cmmi-10">∂f∕∂ϕ </span>is independent of <span 
class="cmmi-10">R</span>, <span 
class="cmmi-10">Z</span>,
and <span 
class="cmmi-10">ϕ</span>, i.e., <span 
class="cmmi-10">∂f∕∂ϕ </span> is actually a spatial constant. Denote this constant by <span 
class="cmmi-10">C</span>. Then <span 
class="cmmi-10">ϕ </span>component of the
gauge transformation (<a 
href="#x1-5001r11">11<!--tex4ht:ref: 7-25-1 --></a>) is written </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium13x.png" alt=" new       -1∂f-
Aϕ  = A ϕ + R ∂ϕ
           C-
    = A ϕ + R ,                             (13)
" class="math-display"  /><a 
 id="x1-5003r13"></a></center>
</div>(We see that the requirement of being axial symmetry greatly reduces gauge freedom of
<span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">ϕ</span></sub>.) Multiplying Eq. (<a 
href="#x1-5003r13">13<!--tex4ht:ref: 7-24-p1 --></a>) with <span 
class="cmmi-10">R</span>, we obtain the corresponding gauge transformation for
<span 
class="cmmi-10">Ψ</span>,
   <table 
class="equation"><tr><td><a 
 id="x1-5004r14"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium14x.png" alt="Ψ new = Ψ + C,
" class="math-display"  /></center></td><td class="equation-label">(14)</td></tr></table>
<!--l. 179--><p class="nopar" >
which indicates <span 
class="cmmi-10">Ψ </span>is similar to that of electrostatic potential, i.e., adding a constant to it does not
make diﬀerence. Note that the deﬁnition <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>) <span 
class="cmsy-10">≡ </span><span 
class="cmmi-10">RA</span><sub><span 
class="cmmi-7">ϕ</span></sub> does not imply <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R </span>= 0<span 
class="cmmi-10">,Z</span>) = 0
because <span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">ϕ</span></sub> can adopt 1<span 
class="cmmi-10">∕R </span>dependence under the gauge transformation (<a 
href="#x1-5003r13">13<!--tex4ht:ref: 7-24-p1 --></a>). If <span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">ϕ</span></sub> is ﬁnite at
<span 
class="cmmi-10">R </span>= 0, then <span 
class="cmmi-10">Ψ </span>is zero there. This is the case we encounter in the equilibrium reconstruction
problem.
</p><!--l. 188--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">1.5   </span> <a 
 id="x1-60001.5"></a>Contours of <span 
class="cmmi-10">Ψ </span>in the poloidal plane</h4>
<!--l. 190--><p class="noindent" >Because <span 
class="cmmi-10">Ψ </span>is constant along a magnetic ﬁeld line and <span 
class="cmmi-10">Ψ </span>is independent of <span 
class="cmmi-10">ϕ</span>, the projection of a
magnetic ﬁeld line onto (<span 
class="cmmi-10">R,Z</span>) plane is a contour of <span 
class="cmmi-10">Ψ</span>. Inversely, a contour of <span 
class="cmmi-10">Ψ </span>is also
                                                                                

                                                                                
projections of a magnetic ﬁeld line onto the plane. [Proof. A contour of <span 
class="cmmi-10">Ψ </span>on (<span 
class="cmmi-10">R,Z</span>) plane
satisﬁes
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-6001r15"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium15x.png" alt="dΨ = 0,
" class="math-display"  /></center></td><td class="equation-label">(15)</td></tr></table>
<!--l. 197--><p class="nopar" >
i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-6002r16"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium16x.png" alt="∂Ψ-dR + ∂Ψ-dZ = 0.
∂R      ∂Z
" class="math-display"  /></center></td><td class="equation-label">(16)</td></tr></table>
<!--l. 202--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-6003r17"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium17x.png" alt="   1 ∂Ψ      1∂Ψ
⇒  ----dR + -----dZ = 0.
   R∂R      R ∂Z
" class="math-display"  /></center></td><td class="equation-label">(17)</td></tr></table>
                                                                                

                                                                                
<!--l. 206--><p class="nopar" >
Using Eqs. (<a 
href="#x1-2002r5">5<!--tex4ht:ref: 7-14-p1 --></a>) and (<a 
href="#x1-2003r6">6<!--tex4ht:ref: 6-9-a4 --></a>), the above equation is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-6004r18"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium18x.png" alt="BZdR  − BRdZ = 0,
" class="math-display"  /></center></td><td class="equation-label">(18)</td></tr></table>
<!--l. 210--><p class="nopar" >
i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-6005r19"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium19x.png" alt="dZ-=  BZ-,
dR    BR
" class="math-display"  /></center></td><td class="equation-label">(19)</td></tr></table>
<!--l. 214--><p class="nopar" >
which is the equation of the projection of a magnetic ﬁeld line in (<span 
class="cmmi-10">R,Z</span>) plane. This proves that
contours of <span 
class="cmmi-10">Ψ </span>are projections of magnetic ﬁeld lines in (<span 
class="cmmi-10">R,Z</span>) plane.]
</p><!--l. 219--><p class="indent" >   Figure <a 
href="#x1-60061">1<!--tex4ht:ref: 24-11-15-1 --></a> shows typical contours of <span 
class="cmmi-10">Ψ </span>in a tokamak (CFETR tokamak as an example).
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-60061"></a>
                                                                                

                                                                                
<!--l. 223--><p class="noindent" > <img 
src="my_figure/home/yj/theory/nbi/cfetr/fig5b/p.png" alt="pict"  
 width="194.72751pt" />
</p><!--l. 225--><p class="noindent" > 
<br /> </p><div class="caption" 
><span class="id">Fig. 1: </span><span  
class="content">Blue lines are contours of <span 
class="cmmi-10">Ψ</span>. The black line is the machine wall. </span></div><!--tex4ht:label?: x1-60061 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
<!--l. 230--><p class="indent" >   Points where the poloidal ﬁeld is zero (i.e., <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">Ψ</span>=0) are called magnetic null points. There are two
types of null points : O-points and X-points, which can be visually identiﬁed by viewing contours
of <span 
class="cmmi-10">Ψ</span>. Mathematically, O-points and X-points are distinguished by the sign of <span 
class="cmmi-10">S </span>deﬁned
by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-6007r20"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium20x.png" alt="         ∂2Ψ ∂2Ψ   (  ∂2Ψ )2
S(R,Z ) = ∂R2-∂Z2-−  ∂R∂Z--  ,
" class="math-display"  /></center></td><td class="equation-label">(20)</td></tr></table>
<!--l. 239--><p class="nopar" >
where <span 
class="cmmi-10">S </span><span 
class="msam-10">≥ </span>0 corresponds to O-points and <span 
class="cmmi-10">S &#x003C; </span>0 corresponds to X-points.
</p>
   <h4 class="subsectionHead"><span class="titlemark">1.6   </span> <a 
 id="x1-70001.6"></a>Magnetic surfaces</h4>
<!--l. 245--><p class="noindent" >Surfaces of revolution generated by rotating <span 
class="cmmi-10">Ψ </span>contours around the axis of symmetry (<span 
class="cmmi-10">Z </span>axis) are called
magnetic surfaces or ﬂux surfaces. No ﬁeld line intersects these surfaces. We are only interested in ﬂux
surfaces within the machine wall. Some <span 
class="cmmi-10">Ψ </span>contours intersect the wall before they can form
closed curves. These ﬂux surfaces are called “open”. Otherwsie, they are called closed ﬂux
surfaces.
</p><!--l. 252--><p class="indent" >   The value of <span 
class="cmmi-10">Ψ </span>is constant on a magnetic surface. Meanwhile, the values of <span 
class="cmmi-10">Ψ </span>on diﬀerent magnetic
surfaces are usually diﬀerent. These two properties enable <span 
class="cmmi-10">Ψ </span>to be used as labels of magnetic surfaces.
[In cases that there are multiple magnetic surfaces of the same value of <span 
class="cmmi-10">Ψ</span>, the ambiguity can be
resolved by specifying which region the ﬂux surfaces lie in, e.g., within or outside the last-closed-ﬂux
surface region, near the high-ﬁeld side or low-ﬁeld side, in the Scrape-Oﬀ Layer or the private ﬂux
region (the area between the X-point and the material divertor., i.e, the region between divertor legs
that is unconnected to the plasma).]
</p><!--l. 263--><p class="indent" >   In most part of a tokamak plasma, contours of <span 
class="cmmi-10">Ψ </span>in (<span 
class="cmmi-10">R,Z</span>) plane are closed before they touch the
machine wall. Figure <a 
href="#x1-70012">2<!--tex4ht:ref: 7-1-p101 --></a> shows some examples of closed ﬂux surfaces.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-70012"></a>
                                                                                

                                                                                
<!--l. 268--><p class="noindent" > <img 
src="my_figure/home/yj/theory/tokamak_equilibrium/figures/poloidal_flux-1.png" alt="pict"  
 width="384.43625pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 2: </span><span  
class="content">Closed magnetic surfaces (blue) and various toroidal ribbons used to deﬁne the poloidal
magnetic ﬂux discussed in Sec. <a 
href="#x1-80001.7">1.7<!--tex4ht:ref: 9-5-5 --></a>. The magnetic ﬂux through the toroidal ribbons <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">2</span></sub> and <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">3</span></sub>
is equal to each other. Also the magnetic ﬂux through <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">4</span></sub>  and <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">5</span></sub>  is equal to each other; the
magnetic ﬂux through <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">0</span></sub> and <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">1</span></sub> is equal to each other.</span></div><!--tex4ht:label?: x1-70012 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
<!--l. 277--><p class="indent" >   The innermost magnetic surface reduces to a curve, which is called magnetic axis (in Fig. <a 
href="#x1-70012">2<!--tex4ht:ref: 7-1-p101 --></a>, <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">0</span></sub>
labels the magnetic axis). <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">Ψ </span>is zero at the magnetic axis since <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>) reach maximum/minimum
there. As a result, the poloidal magnetic ﬁeld is zero there (refer to Eq. (<a 
href="#x1-2005r8">8<!--tex4ht:ref: 20-5-9-p10 --></a>)). For closed ﬂux surfaces,
since <span 
class="cmbx-10">B</span><sub><span 
class="cmmi-7">p</span></sub> = <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">Ψ </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">ϕ</span>, the condition <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">LCFS</span></sub> <span 
class="cmsy-10">− </span><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">axis</span></sub> <span 
class="cmmi-10">&#x003E; </span>0 means <span 
class="cmbx-10">B</span><sub><span 
class="cmmi-7">p</span></sub> points in the anticlockwise
direction (viewed along <span 
class="cmmib-10">ϕ</span> direction), and <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">LCFS</span></sub> <span 
class="cmsy-10">− </span><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">axis</span></sub> <span 
class="cmmi-10">&#x003C; </span>0 means <span 
class="cmbx-10">B</span><sub><span 
class="cmmi-7">p</span></sub> points in the clockwise
direction.
</p>
   <h4 class="subsectionHead"><span class="titlemark">1.7   </span> <a 
 id="x1-80001.7"></a>Relation of <span 
class="cmmi-10">Ψ </span>with the poloidal magnetic ﬂux</h4>
<!--l. 290--><p class="noindent" >Note that <span 
class="cmmi-10">Ψ </span>is deﬁned by <span 
class="cmmi-10">Ψ </span>= <span 
class="cmmi-10">RA</span><sub><span 
class="cmmi-7">ϕ</span></sub>, which is just a component of the vector potential <span 
class="cmbx-10">A</span>, thereby
having no obvious physical meaning. Next, we show that <span 
class="cmmi-10">Ψ </span>has a simple relation with the poloidal
magnetic ﬂux that can be be measured in experiments.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-80013"></a>
                                                                                

                                                                                
<!--l. 296--><p class="noindent" > <img 
src="my_figure/home/yj/theory/tokamak_equilibrium/figures/axisymmetrical_magnetic_field-3b.png" alt="pict"  
 width="301.125pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 3: </span><span  
class="content">The poloidal magnetic ﬂux <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub><sup><span 
class="cmr-7">(12)</span></sup> between the two magnetic surfaces <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">1</span></sub> and <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">2</span></sub> is given
by <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub><sup><span 
class="cmr-7">(12)</span></sup> = 2<span 
class="cmmi-10">π</span>(<span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">2</span></sub> <span 
class="cmsy-10">− </span><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">1</span></sub>), where the surface orientation for the poloidal ﬂux deﬁnition is chosen
to be +<img 
src="tokamak_equilibrium21x.png" alt="ˆZ"  class="circ"  />.</span></div><!--tex4ht:label?: x1-80013 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
<!--l. 305--><p class="indent" >   In Fig. <a 
href="#x1-80013">3<!--tex4ht:ref: 9-8-p1 --></a>, there are two magnetic surfaces labeled, respectively, by <span 
class="cmmi-10">Ψ </span>= <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">1</span></sub> and <span 
class="cmmi-10">Ψ </span>= <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">2</span></sub>. The poloidal
magnetic ﬂux through any toroidal ribbons between the two magnetic surfaces is equal
to each other (due to the magnetic Gauss theorem). Denote this poloidal magnetic ﬂux
by <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub><sup><span 
class="cmr-7">(12)</span></sup>.  Next, we calculate this ﬂux. To make the calculation easy, we select a plane
perpendicular to the <span 
class="cmmi-10">Z </span>axis, as is shown by the dash line in Fig. (<a 
href="#x1-80013">3<!--tex4ht:ref: 9-8-p1 --></a>). In this case, only <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">Z</span></sub>
contribute to the poloidal magnetic ﬂux: (the positive direction of the plane is chosen to be <img 
src="tokamak_equilibrium22x.png" alt="ˆZ"  class="circ"  />)
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium23x.png" alt="  (12)  ∫ R2
Ψ p  =     Bz (R, Z)2πRdR
       ∫R1R2
     =      1∂-Ψ2πRdR
        R1  R∂R
          ∫ R2 ∂Ψ
     = 2π     ∂R-dR
           R1
     = 2π[Ψ2 − Ψ1].                              (21)
" class="math-display"  /><a 
 id="x1-8002r21"></a></center>
</div>Equation (<a 
href="#x1-8002r21">21<!--tex4ht:ref: 7-24-2 --></a>) indicates that the diﬀerence of <span 
class="cmmi-10">Ψ </span>between two magnetic surfaces is equal to the poloidal
ﬂux divided by 2<span 
class="cmmi-10">π</span>.
<!--l. 325--><p class="indent" >   In experiments, we measure the poloidal magnetic ﬂux through toroidal loops around the central
symmetric axis (discussed in Sec. <a 
href="#x1-90001.8">1.8<!--tex4ht:ref: 24-11-13-p1 --></a>). Consider one of the loops that located at point (<span 
class="cmmi-10">R,Z</span>), then,
using (<a 
href="#x1-8002r21">21<!--tex4ht:ref: 7-24-2 --></a>), the ﬂux through the loop can be written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-8003r22"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium24x.png" alt="Ψp = 2π[Ψ (R, Z)− Ψ(R = 0,Z)],
" class="math-display"  /></center></td><td class="equation-label">(22)</td></tr></table>
<!--l. 331--><p class="nopar" >
The central symmetric axis (<span 
class="cmmi-10">R </span>= 0) is a ﬁeld line. If <span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">ϕ</span></sub> is ﬁnite at <span 
class="cmmi-10">R </span>= 0, then <span 
class="cmmi-10">Ψ </span>= <span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">ϕ</span></sub><span 
class="cmmi-10">R </span>is zero there.
This is the case we encounter in the equilibrium reconstruction problem. Then this ﬂux is written
                                                                                

                                                                                
as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-8004r23"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium25x.png" alt="Ψp = 2πΨ (R,Z).
" class="math-display"  /></center></td><td class="equation-label">(23)</td></tr></table>
<!--l. 338--><p class="nopar" >
Due to this relation, <span 
class="cmmi-10">Ψ </span>is often called the poloidal magnetic ﬂux per radian (SI unit: web/rad), or
simply “the poloidal ﬂux”. This relation allows the poloidal ﬂux measurements to be used to constrain
the GS equation in the equilibrium reconstrunction (discussed in Sec. <a 
href="#x1-230005">5<!--tex4ht:ref: 24-7-5-p1 --></a>). Note that the positive normal
direction of the surface (where the magnetic ﬂux <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub> is deﬁned) is chosen in the +<span 
class="cmbx-10">Z </span>direction. This sign
choice along with the 2<span 
class="cmmi-10">π </span>factor appearing in Eq. (<a 
href="#x1-8004r23">23<!--tex4ht:ref: 25-2-16-1 --></a>) are often confusing people when they try to relate
the experimentally measured ﬂux with the <span 
class="cmmi-10">Ψ </span>appearing in the GS equation. The 2<span 
class="cmmi-10">π </span>factor also appears
when we relate the Green function of <span 
class="cmmi-10">Ψ </span>to the mutual inductance, i.e., <span 
class="cmmi-10">M </span>= 2<span 
class="cmmi-10">πG </span>(discussed
later).
</p><!--l. 351--><p class="indent" >   A further compliction is that when one talks about  “the poloidal magnetic ﬂux of a magnetic
surface”, there are two possibilities of the deﬁntion. One of them is deﬁned relative to the <span 
class="cmmi-10">R </span>= 0
(as is discussed above), and another is relative to the magnetic axis. The ﬁrst deﬁnition is
the ﬂux through the central hole of the magnetic surface, i.e., the poloidal ﬂux through
<span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">0</span></sub> in Fig. <a 
href="#x1-70012">2<!--tex4ht:ref: 7-1-p101 --></a>. In this case, as is discussed above, the poloidal magnetic ﬂux is related to <span 
class="cmmi-10">Ψ</span>
by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-8005r24"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium26x.png" alt="Ψp = 2π(Ψ − Ψ(R = 0,Z )) = 2πΨ,
" class="math-display"  /></center></td><td class="equation-label">(24)</td></tr></table>
<!--l. 360--><p class="nopar" >
where the postive direction is +<img 
src="tokamak_equilibrium27x.png" alt="ˆZ"  class="circ"  />. The is the more often used deﬁntion, and we will stick to this in the
equilibrium reconstruction problem.
</p><!--l. 365--><p class="indent" >   The second deﬁnition is the ﬂux enclosed by the closed ﬂux surface, i.e., the ﬂux through the
toroidal ribbon <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">2</span></sub>. Denote this ﬂux by <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmr-7">axis</span><span 
class="cmr-7">)</span></sup>, then
</p>
                                                                                

                                                                                
   <table 
class="equation"><tr><td><a 
 id="x1-8006r25"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium28x.png" alt="Ψ(axis) = 2π(Ψaxis − Ψ),
 p
" class="math-display"  /></center></td><td class="equation-label">(25)</td></tr></table>
<!--l. 370--><p class="nopar" >
where <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">axis</span></sub> is the value of <span 
class="cmmi-10">Ψ </span>at the magnetic axis, the <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">2</span></sub> orientation is in the clockwise direction when
an observer looks along the direction of <img 
src="tokamak_equilibrium29x.png" alt="ˆϕ"  class="circ"  />.
</p>
   <h4 class="subsectionHead"><span class="titlemark">1.8   </span> <a 
 id="x1-90001.8"></a>Measuring poloidal magnetic ﬂux in experiments</h4>
<!--l. 378--><p class="noindent" >By measuring the voltage around a toroidal wire loop, we can obtain the time derivative of the poloidal
ﬂux and, after integrating over time, the ﬂux itself.
</p><!--l. 382--><p class="indent" >   Suppose that there is a toroidal wire loop located at (<span 
class="cmmi-10">R,Z</span>) and denote the magnetic ﬂux through
the loop by <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub>(<span 
class="cmmi-10">R,Z,t</span>) (only the poloidal magnetic ﬁeld contribute to this ﬂux, hence this ﬂux is called
the poloidal ﬂux). Then Faraday’s law
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-9001r26"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium30x.png" alt="∮          ∫  ∂B
   E⋅dl = −   ∂t-⋅dS,
" class="math-display"  /></center></td><td class="equation-label">(26)</td></tr></table>
<!--l. 389--><p class="nopar" >
where the direction of the loop integration and the direction of <span 
class="cmmi-10">d</span><span 
class="cmbx-10">S </span>is related by the right-hand rule, is
written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-9002r27"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium31x.png" alt="𝜀 = − dΨp-,
      dt
" class="math-display"  /></center></td><td class="equation-label">(27)</td></tr></table>
<!--l. 394--><p class="nopar" >
where <span 
class="cmmi-10">𝜀 </span>= <span 
class="cmex-10">∮</span>
  <span 
class="cmbx-10">E </span><span 
class="cmsy-10">⋅ </span><span 
class="cmmi-10">d</span><span 
class="cmbx-10">l </span>is often called electromotive force (emf). If the loop is a coil with <span 
class="cmmi-10">N </span>turns, the
induced voltage <span 
class="cmmi-10">V </span>in the coil is <span 
class="cmmi-10">N </span>times the emf, i.e., <span 
class="cmmi-10">V </span>= <span 
class="cmmi-10">N𝜀</span>. Then Eq. (<a 
href="#x1-9002r27">27<!--tex4ht:ref: 8-16-e1 --></a>) is written
as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-9003r28"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium32x.png" alt="V = − NdΨp-.
        dt
" class="math-display"  /></center></td><td class="equation-label">(28)</td></tr></table>
<!--l. 401--><p class="nopar" >
Integrating the above equation over time, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-9004r29"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium33x.png" alt="                       1 ∫ t
Ψp(R,Z,t) = Ψp(R,Z,0)− --   Vdt.
                       N  0
" class="math-display"  /></center></td><td class="equation-label">(29)</td></tr></table>
<!--l. 406--><p class="nopar" >
The starting time <span 
class="cmmi-10">t </span>= 0 can be chosen as when <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub>(<span 
class="cmmi-10">R,Z,</span>0) is easy to know (e.g., when there is no
plasma). Equation (<a 
href="#x1-9004r29">29<!--tex4ht:ref: 24-6-25-e1 --></a>) tells us how to calcualte <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub> from the measured loop voltage <span 
class="cmmi-10">V </span>. Then <span 
class="cmmi-10">Ψ </span>is
obtained by <span 
class="cmmi-10">Ψ </span>= <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub><span 
class="cmmi-10">∕</span>(2<span 
class="cmmi-10">π</span>).
                                                                                

                                                                                
</p><!--l. 412--><p class="indent" >   There are usually many ﬂux loops (e.g. 35 on EAST<span class="cite">[<span 
class="cmbx-10">?</span>]</span>) at diﬀerent locations in the poloidal plane
(see Fig. <a 
href="#x1-90054">4<!--tex4ht:ref: 19-5-4-p1mm --></a>). They are outside of the plasma region and thus are “external magnetic measurements”.
The measured poloidal ﬂux, along with the poloidal ﬁeld measurement by magnetic probes, can be used
as constraints in reconstructing the magnetic ﬁeld within the plasma region. This is discussed in Sec.
<a 
href="#x1-230005">5<!--tex4ht:ref: 24-7-5-p1 --></a>.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-90054"></a>
                                                                                

                                                                                
<!--l. 421--><p class="noindent" > <img 
src="my_figure/home/yj/theory/heq/fig1b/p.png" alt="pict"  
 width="244.91501pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 4: </span><span  
class="content">Flux loops (circles) and magnetic probes (blue arows) on EAST tokamak. Arrows indicate
the positive normal direction of the probes.</span></div><!--tex4ht:label?: x1-90054 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
   <h4 class="subsectionHead"><span class="titlemark">1.9   </span> <a 
 id="x1-100001.9"></a>Safety factor</h4>
<!--l. 429--><p class="noindent" >A magnetic ﬁeld line on a closed magnetic surface travel a closed curve in the poloidal plane. For these
ﬁeld lines, we can deﬁne the safety factor <span 
class="cmmi-10">q</span>: the number of toroidal loops a magnetic ﬁeld line travels
when it makes one poloidal loop, i.e.
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-10001r30"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium34x.png" alt="q ≡ △ϕ-,
    2π
" class="math-display"  /></center></td><td class="equation-label">(30)</td></tr></table>
<!--l. 435--><p class="nopar" >
where <span 
class="cmsy-10">△</span><span 
class="cmmi-10">ϕ </span>as the change of the toroidal angle when a magnetic ﬁeld line travels a full poloidal
loop.
</p><!--l. 439--><p class="indent" >   For open ﬁeld line region (where a ﬁeld line touches the wall before its poloidal projection can close
itself), the “connection length” is often used to characterize the magnetic ﬁeld.
</p>
   <h5 class="subsubsectionHead"><a 
 id="x1-110001.9"></a>Expression of safety factor in terms of magnetic ﬁeld</h5>
<!--l. 445--><p class="noindent" >The equation of magnetic ﬁeld lines is given by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-11001r31"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium35x.png" alt="Rdϕ   B
----= --ϕ,
dℓp   Bp
" class="math-display"  /></center></td><td class="equation-label">(31)</td></tr></table>
<!--l. 448--><p class="nopar" >
where <span 
class="cmmi-10">dℓ</span><sub><span 
class="cmmi-7">p</span></sub> is the line element along the direction of <span 
class="cmbx-10">B</span><sub><span 
class="cmmi-7">p</span></sub> on the poloidal plane. Equation (<a 
href="#x1-11001r31">31<!--tex4ht:ref: 7-1-p2 --></a>) can be
arranged in the form
                                                                                

                                                                                
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-11002r32"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium36x.png" alt="     1-B-ϕ
dϕ = R Bp dℓp,
" class="math-display"  /></center></td><td class="equation-label">(32)</td></tr></table>
<!--l. 453--><p class="nopar" >
which can be integrated over <span 
class="cmmi-10">dℓ</span><sub><span 
class="cmmi-7">p</span></sub> to give
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-11003r33"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium37x.png" alt="     ∮  1 Bϕ
△ϕ =    R-B-dℓp,
           p
" class="math-display"  /></center></td><td class="equation-label">(33)</td></tr></table>
<!--l. 457--><p class="nopar" >
where the line integration is along the poloidal magnetic ﬁeld (the contour of <span 
class="cmmi-10">Ψ </span>on the poloidal plane).
Using this, Eq. (<a 
href="#x1-10001r30">30<!--tex4ht:ref: 7-1-p3 --></a>) is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-11004r34"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium38x.png" alt="     1 ∮ 1 B
q = ---  ---ϕ-dℓp.
    2π   R Bp
" class="math-display"  /></center></td><td class="equation-label">(34)</td></tr></table>
<!--l. 465--><p class="nopar" >
                                                                                

                                                                                
</p>
   <h5 class="subsubsectionHead"><a 
 id="x1-120001.9"></a>Expression of safety factor in terms of magnetic ﬂux</h5>
<!--l. 470--><p class="noindent" >The safety factor given by Eq. (<a 
href="#x1-11004r34">34<!--tex4ht:ref: 9-5-e1 --></a>) is expressed in terms of the components of the magnetic ﬁeld.
The safety factor can also be expressed in terms of the magnetic ﬂux. Deﬁne <span 
class="cmmi-10">ΔΨ</span><sub><span 
class="cmmi-7">p</span></sub> as the
poloidal magnetic ﬂux enclosed by two neighboring magnetic surface, then <span 
class="cmmi-10">ΔΨ</span><sub><span 
class="cmmi-7">p</span></sub> is given
by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-12001r35"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium39x.png" alt="Δ Ψ = 2πR ΔxB
   p          p
" class="math-display"  /></center></td><td class="equation-label">(35)</td></tr></table>
<!--l. 477--><p class="nopar" >
where <span 
class="cmmi-10">Δx </span>is the length of a line segment in the poloidal plane between the two magnetic surfaces,
which is perpendicular to the ﬁrst magnetic surface (so perpendicular to the <span 
class="cmbx-10">B</span><sub><span 
class="cmmi-7">p</span></sub>). Note that <span 
class="cmmi-10">Δx</span>, as well
as <span 
class="cmmi-10">R </span>and <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">p</span></sub>, generally depends on the poloidal location whereas <span 
class="cmmi-10">ΔΨ</span><sub><span 
class="cmmi-7">p</span></sub> is independent of the poloidal
location.
</p><!--l. 484--><p class="indent" >   Using Eq. (<a 
href="#x1-12001r35">35<!--tex4ht:ref: 7-9-dy --></a>), the poloidal magnetic ﬁeld is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-12002r36"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium40x.png" alt="      1  Δ Ψp
Bp = 2πR-Δx--.
" class="math-display"  /></center></td><td class="equation-label">(36)</td></tr></table>
<!--l. 487--><p class="nopar" >
Substituting Eq. (<a 
href="#x1-12002r36">36<!--tex4ht:ref: 7-28 --></a>) into Eq. (<a 
href="#x1-11004r34">34<!--tex4ht:ref: 9-5-e1 --></a>), we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-12003r37"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium41x.png" alt="      ∮               ∮                 ∮
q = 1--  1-Bϕ-dℓp = -1-  1-2πR-ΔxB-ϕdℓp =   ΔxB-ϕdℓp.
    2π   R Bp      2π   R    ΔΨp           Δ Ψp
" class="math-display"  /></center></td><td class="equation-label">(37)</td></tr></table>
<!--l. 493--><p class="nopar" >
We know <span 
class="cmmi-10">ΔΨ</span><sub><span 
class="cmmi-7">p</span></sub> is a constant independent of the poloidal location, so <span 
class="cmmi-10">ΔΨ</span><sub><span 
class="cmmi-7">p</span></sub> can be taken outside the
integration to give
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-12004r38"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium42x.png" alt="        ∮
   --1-
q = Δ Ψp  ΔxB ϕdℓp
" class="math-display"  /></center></td><td class="equation-label">(38)</td></tr></table>
<!--l. 499--><p class="nopar" >
It is ready to realise that the integral appearing in Eq. (<a 
href="#x1-12004r38">38<!--tex4ht:ref: 17-11-12-1 --></a>) is the toroidal magnetic ﬂux enclosed by
the two magnetic surfaces, <span 
class="cmmi-10">ΔΦ</span>. Using this, Eq. (<a 
href="#x1-12004r38">38<!--tex4ht:ref: 17-11-12-1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-12005r39"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium43x.png" alt="    Δ Φ
q = ----
    ΔΨp
" class="math-display"  /></center></td><td class="equation-label">(39)</td></tr></table>
<!--l. 505--><p class="nopar" >
Equation (<a 
href="#x1-12005r39">39<!--tex4ht:ref: 9-6-p2 --></a>) indicates that the safety factor of a magnetic surface is equal to the diﬀerential of the
toroidal magnetic ﬂux with respect to the poloidal magnetic ﬂux enclosed by the magnetic
surface.
                                                                                

                                                                                
</p>
   <h5 class="subsubsectionHead"><a 
 id="x1-130001.9"></a>Rational surfaces vs. irrational surfaces</h5>
<!--l. 512--><p class="noindent" >If the safety factor of a magnetic surface is a rational number, i.e., <span 
class="cmmi-10">q </span>= <span 
class="cmmi-10">m∕n</span>, where <span 
class="cmmi-10">m </span>and <span 
class="cmmi-10">n </span>are
integers, then this magnetic surface is called a rational surface, otherwise an irrational surface. A ﬁeld
line on a rational surface with <span 
class="cmmi-10">q </span>= <span 
class="cmmi-10">m∕n </span>closes itself after it travels <span 
class="cmmi-10">n </span>poloidal loops. An example of a
ﬁeld line on a rational surface is shown in Fig. <a 
href="#x1-130015">5<!--tex4ht:ref: 17-1-1-1 --></a>.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-130015"></a>
                                                                                

                                                                                
<!--l. 519--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/nbi_fig/fig12/p.png" alt="pict"  
 width="264.99pt" />                                     <img 
src="my_figure/home/yj/project_new/nbi_fig/fig12b/p.png" alt="pict"  
 width="166.6225pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 5: </span><span  
class="content">Left: A magnetic ﬁeld line (blue) on a rational surface with <span 
class="cmmi-10">q </span>= 2<span 
class="cmmi-10">.</span>1 = 21<span 
class="cmmi-10">∕</span>10 (magnetic
ﬁeld is from EAST discharge #59954@3.1s). This ﬁeld line closes itself after traveling 21 toroidal
loops (meanwhile, it travels 10 poloidal loops). Right: The intersecting points of the magnetic
ﬁeld line with the <span 
class="cmmi-10">ϕ </span>= 0 plane when it is traveling toroidally. The sequence of the intersecting
points is indicated by the number labels. The 22nd intersecting point coincides with the 1st point
and then the intersecting points repeat themselves.</span></div><!--tex4ht:label?: x1-130015 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
<!--l. 530--><p class="indent" >    
</p><!--l. 532--><p class="indent" >    
</p>
   <h3 class="sectionHead"><span class="titlemark">2   </span> <a 
 id="x1-140002"></a>Non-axisymmetric magnetic perturbations</h3>
<!--l. 536--><p class="noindent" >In the above, the magnetic ﬁeld is assumed to be axisymmetric. With this assumption, the poloidal
magnetic ﬁeld (having two components) can be expressed in terms of a single component of the vector
potential <span 
class="cmbx-10">A</span>, <span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">ϕ</span></sub> (speciﬁcally via <span 
class="cmmi-10">Ψ </span><span 
class="cmsy-10">≡ </span><span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">ϕ</span></sub><span 
class="cmmi-10">R</span>). This kind of simpliﬁcation is not achievable if the
axisymmetricity assumption is dropped, because other components of the vector potential (namely <span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">R</span></sub>
and <span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">Z</span></sub>) will appear in the expression of the poloidal magnetic ﬁeld. Let us re-examine Eq. (<a 
href="#x1-1002r2">2<!--tex4ht:ref: 4-16-p1 --></a>) for a
general magnetic perturbation: </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium44x.png" alt="     (1 ∂δA     ∂δA )     ( 1 ∂(R δA )   1 ∂δA  )
δB  =  ------Z−  ---ϕ- ˆR +   -------ϕ--− -----R- Zˆ
     (R  ∂ϕ      ∂Z)        R   ∂R      R  ∂ϕ
   +  ∂δAR- − ∂δAZ- ϕˆ.                                       (40)
       ∂Z      ∂R
" class="math-display"  /><a 
 id="x1-14001r40"></a></center>
</div>When studying tearing modes and electromagnetic turbulence, most authors narrow the possible
perturbations by setting <span 
class="cmmi-10">δA</span><sub><span 
class="cmmi-7">R</span></sub> = <span 
class="cmmi-10">δA</span><sub><span 
class="cmmi-7">Z</span></sub> = 0, i.e.,
   <table 
class="equation"><tr><td><a 
 id="x1-14002r41"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium45x.png" alt="        1∂ δΨ
δBR = − -----,
        R ∂Z
" class="math-display"  /></center></td><td class="equation-label">(41)</td></tr></table>
<!--l. 558--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-14003r42"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium46x.png" alt="δBZ  = 1-∂δΨ,
       R ∂R
" class="math-display"  /></center></td><td class="equation-label">(42)</td></tr></table>
<!--l. 561--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-14004r43"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium47x.png" alt="δBϕ = 0.
" class="math-display"  /></center></td><td class="equation-label">(43)</td></tr></table>
<!--l. 564--><p class="nopar" >
where <span 
class="cmmi-10">δΨ </span>= <span 
class="cmmi-10">RδA</span><sub><span 
class="cmmi-7">ϕ</span></sub>. Therefore this kind of magnetic perturbation can still be written in the same form
as the equilibrium poloidal magnetic ﬁeld:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-14005r44"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium48x.png" alt="δB = ∇ δΨ × ∇ϕ.
" class="math-display"  /></center></td><td class="equation-label">(44)</td></tr></table>
<!--l. 570--><p class="nopar" >
The above approximation is widely used in practice, e.g., in turbulence simulation, where <span 
class="cmmi-10">δA</span><sub><span 
class="cmmi-7">ϕ</span></sub> is
replaced by <span 
class="cmmi-10">δA</span><sub><span 
class="cmsy-7">∥</span></sub>. (Do we miss some magnetic perturbations that is important for plasma transport
when using the above speciﬁc form?)
</p><!--l. 576--><p class="indent" >   The total magnetic ﬁeld is then written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-14006r45"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium49x.png" alt="B = ∇ (Ψ + δΨ )× ∇ϕ + g∇ϕ.
" class="math-display"  /></center></td><td class="equation-label">(45)</td></tr></table>
<!--l. 579--><p class="nopar" >
**check**Can the projection of the total magnetic ﬁeld line in the poloidal plane can be traced by
tracing the contour of <span 
class="cmmi-10">Ψ </span>+ <span 
class="cmmi-10">δΨ</span>? No. The contours of <span 
class="cmmi-10">Ψ </span>+ <span 
class="cmmi-10">δΨ </span>will not show island structures in the
poloidal plane. To show the expected island structures, we need to subtract non-reconnecting poloidal
magnetic ﬁeld from the total poloidal ﬁeld? **check** The contours of the so-called helical ﬂux will
give the expected island structures near the resonant surfaces?**check**
</p><!--l. 588--><p class="indent" >   Next, we go back to discuss the 2D case (i.e., assuming axisymmetry).
</p><!--l. 590--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">3   </span> <a 
 id="x1-150003"></a>Plasma current density in terms of <span 
class="cmmi-10">Ψ </span>and <span 
class="cmmi-10">g</span></h3>
<!--l. 592--><p class="noindent" >When the displacement current term is neglectable (the case we consider here), the conductive current
is just another representation of the magnetic ﬁeld. Speciﬁcally, the current density is proportional to
the curl of the magnetic ﬁeld (Ampère’s law): </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium50x.png" alt="μ0J = ∇ × B                (            )
       ∂B-ϕˆ   1-∂(RB-ϕ)ˆ    ∂BR-   ∂BZ-  ˆ
   = −  ∂Z R + R   ∂R   Z+    ∂Z −  ∂R   ϕ,               (46)
" class="math-display"  /><a 
 id="x1-15001r46"></a></center>
</div>where <span 
class="cmmi-10">μ</span><sub><span 
class="cmr-7">0</span></sub> is vacuum magnetic permeability.
<!--l. 605--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">3.1   </span> <a 
 id="x1-160003.1"></a>Poloidal current density</h4>
<!--l. 607--><p class="noindent" >Use Eq. (<a 
href="#x1-15001r46">46<!--tex4ht:ref: 3-11-p1 --></a>) and the deﬁnition <span 
class="cmmi-10">g </span><span 
class="cmsy-10">≡ </span><span 
class="cmmi-10">RB</span><sub><span 
class="cmmi-7">ϕ</span></sub>, the poloidal components of the current density, <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">Z</span></sub> and <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">R</span></sub>,
can be written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-16001r47"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium51x.png" alt="μ0JR = −-1∂g-,
        R ∂Z
" class="math-display"  /></center></td><td class="equation-label">(47)</td></tr></table>
<!--l. 611--><p class="nopar" >
and
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-16002r48"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium52x.png" alt="μ0JZ =  1-∂g,
        R∂R
" class="math-display"  /></center></td><td class="equation-label">(48)</td></tr></table>
<!--l. 615--><p class="nopar" >
respectively.
</p><!--l. 618--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">3.2   </span> <a 
 id="x1-170003.2"></a>Toroidal current density</h4>
<!--l. 620--><p class="noindent" >Ampere’s law (<a 
href="#x1-15001r46">46<!--tex4ht:ref: 3-11-p1 --></a>) indicates the toroidal current density <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub> is given by </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium53x.png" alt="      ∂BR    ∂BZ
μ0Jϕ =-∂Z- − -∂R-
        1 ∂2Ψ    ∂ ( 1 ∂Ψ)
    = − ----2-− ---  ----- .                      (49)
        R ∂Z    ∂R   R ∂R
" class="math-display"  /><a 
 id="x1-17001r49"></a></center>
                                                                                

                                                                                
</div>Deﬁne <span 
class="cmsy-10">△</span><sup><span 
class="cmmi-7">⋆</span></sup> by
   <table 
class="equation"><tr><td><a 
 id="x1-17002r50"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium54x.png" alt="                (      )
△ ∗ ≡ ∂2--+ R-∂-  1--∂- ,
      ∂Z2    ∂R   R ∂R
" class="math-display"  /></center></td><td class="equation-label">(50)</td></tr></table>
<!--l. 634--><p class="nopar" >
then Eq. (<a 
href="#x1-17001r49">49<!--tex4ht:ref: 9-5-1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-17003r51"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium55x.png" alt="Jϕ = − -1-△ ∗Ψ.
       μ0R
" class="math-display"  /></center></td><td class="equation-label">(51)</td></tr></table>
<!--l. 638--><p class="nopar" >
(Many authors incorrectly refer to Eq. (<a 
href="#x1-17003r51">51<!--tex4ht:ref: 6-9-a1 --></a>) as the Grad-Shafranov (GS) equation. Eq. (<a 
href="#x1-17003r51">51<!--tex4ht:ref: 6-9-a1 --></a>) is just
Ampere’s law, which has nothing to do with the force-balance. Only after we express <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub> in
terms of the plasma pressure, can Eq. (<a 
href="#x1-17003r51">51<!--tex4ht:ref: 6-9-a1 --></a>) be called the GS equation, as is discussed Sec.
<a 
href="#x1-210004.3">4.3<!--tex4ht:ref: 24-11-11-2 --></a>.)
</p><!--l. 645--><p class="indent" >   The operator <span 
class="cmsy-10">△</span><sup><span 
class="cmmi-7">⋆</span></sup> is diﬀerent from the Laplacian operator <span 
class="cmsy-10">△≡∇⋅∇</span>. In terms of the nabla operator
<span 
class="cmsy-10">∇</span>, the operator <span 
class="cmsy-10">△</span><sup><span 
class="cmmi-7">⋆</span></sup> is writen as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-17004r52"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium56x.png" alt="△∗Ψ = R2∇ ⋅ 1-∇ Ψ.
            R2
" class="math-display"  /></center></td><td class="equation-label">(52)</td></tr></table>
<!--l. 651--><p class="nopar" >
</p><!--l. 654--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">4   </span> <a 
 id="x1-180004"></a>Constraint of force-balance on magnetic ﬁeld</h3>
<!--l. 656--><p class="noindent" >Let us consider what constraint the force balance imposes on the axisymmetric magnetic ﬁeld discussed
above. The MHD momentum equation is given by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-18001r53"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium57x.png" alt="  (           )
ρ  ∂u-+ u ⋅∇u   = ρqE + J × B − ∇ ⋅ℙ
    ∂t
" class="math-display"  /></center></td><td class="equation-label">(53)</td></tr></table>
<!--l. 662--><p class="nopar" >
where <span 
class="cmmi-10">ρ</span>, <span 
class="cmmi-10">ρ</span><sub><span 
class="cmmi-7">q</span></sub>, <span 
class="msbm-10">ℙ</span>, <span 
class="cmbx-10">J</span>, <span 
class="cmbx-10">E</span>, and <span 
class="cmbx-10">B </span>are mass density, charge density, thermal pressure tensor, current density,
electric ﬁeld, and magnetic ﬁeld, respectively. The electric ﬁeld force <span 
class="cmmi-10">ρ</span><sub><span 
class="cmmi-7">q</span></sub><span 
class="cmbx-10">E </span>is usually ignored due to
either <span 
class="cmmi-10">ρ</span><sub><span 
class="cmmi-7">q</span></sub> = 0 or <span 
class="cmbx-10">E </span>= 0. Further assume that there is no plasma ﬂow (<span 
class="cmbx-10">u </span>= 0, the ﬂow eﬀect is discussed
in <span 
class="cmbx-10">??</span>) and the plasma pressure is isotropic, then the steady state momentum equation (force balance
equation) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-18002r54"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium58x.png" alt="J × B = ∇P,
" class="math-display"  /></center></td><td class="equation-label">(54)</td></tr></table>
<!--l. 673--><p class="nopar" >
where <span 
class="cmmi-10">P </span>is the scalar plasma pressure.
                                                                                

                                                                                
</p><!--l. 676--><p class="indent" >   Is the force balance (<a 
href="#x1-18002r54">54<!--tex4ht:ref: 7-7-force --></a>) always satisﬁed in a real toakamak discharge? To answer this question, we
need to go back to the original momentum equation (<a 
href="#x1-18001r53">53<!--tex4ht:ref: 19-5-5-1 --></a>). The imbalance between <span 
class="cmbx-10">J </span><span 
class="cmsy-10">× </span><span 
class="cmbx-10">B </span>and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">P </span>will
give rise to the compressional Alfven waves, the time-scale of which, <span 
class="cmmi-10">τ</span><sub><span 
class="cmmi-7">A</span></sub>, is much shorter than the
time-scale <span 
class="cmmi-10">τ </span>we are interested in. Therefore, on the time scale <span 
class="cmmi-10">τ </span>(and for slow ﬂow with <span 
class="cmbx-10">u </span><span 
class="cmmi-10">&#x003C; C</span><sub><span 
class="cmmi-7">s</span></sub>,
where <span 
class="cmmi-10">C</span><sub><span 
class="cmmi-7">s</span></sub> is the the sound speed), the leading order of the momentum equation is the force
balance (<a 
href="#x1-18002r54">54<!--tex4ht:ref: 7-7-force --></a>).<span class="cite">[<span 
class="cmbx-10">?</span>]</span>. I.e. the inertial eﬀect can be neglected (plasma mass is approximately
zero).
</p><!--l. 687--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">4.1   </span> <a 
 id="x1-190004.1"></a>Parallel force balance </h4>
<!--l. 689--><p class="noindent" >Consider the force balance in the direction of <span 
class="cmbx-10">B</span>. Dotting the equilibrium equation (<a 
href="#x1-18002r54">54<!--tex4ht:ref: 7-7-force --></a>) by <span 
class="cmbx-10">B</span>, we
obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-19001r55"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium59x.png" alt="0 = B ⋅∇P,
" class="math-display"  /></center></td><td class="equation-label">(55)</td></tr></table>
<!--l. 693--><p class="nopar" >
which implies that <span 
class="cmmi-10">P </span>is constant along a magnetic ﬁeld line. Since <span 
class="cmmi-10">Ψ </span>is also constant along a magnetic
ﬁeld line, <span 
class="cmmi-10">P </span>can be expressed in terms of only <span 
class="cmmi-10">Ψ </span>on a single magnetic line. Note that this does not
necessarily mean <span 
class="cmmi-10">P </span>is a single-valued function of <span 
class="cmmi-10">Ψ</span>, (i.e. <span 
class="cmmi-10">P </span>= <span 
class="cmmi-10">P</span>(<span 
class="cmmi-10">Ψ</span>)). This is because <span 
class="cmmi-10">P </span>still has the
freedom of taking diﬀerent values on diﬀerent magnetic ﬁeld lines with the same value of <span 
class="cmmi-10">Ψ</span>
while still satisfying <span 
class="cmbx-10">B </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">P </span>= 0. This situation can appear when there are saddle points (X
points) in <span 
class="cmmi-10">Ψ </span>contours (refer to Sec. <span 
class="cmbx-10">??</span>) and <span 
class="cmmi-10">P </span>takes diﬀerent functions of <span 
class="cmmi-10">Ψ </span>in islands of <span 
class="cmmi-10">Ψ</span>
sepearated by a X point. For pressure within a single island of <span 
class="cmmi-10">Ψ</span>, <span 
class="cmmi-10">P </span>= <span 
class="cmmi-10">P</span>(<span 
class="cmmi-10">Ψ</span>) can be safely
assumed.
</p><!--l. 706--><p class="indent" >   On the other hand, if <span 
class="cmmi-10">P </span>= <span 
class="cmmi-10">P</span>(<span 
class="cmmi-10">Ψ</span>), then we obtain
</p>
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
                             <span 
class="cmbx-10">B </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">P </span>= <img 
src="tokamak_equilibrium60x.png" alt="dP-
dΨ"  class="frac" align="middle" /><span 
class="cmbx-10">B </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">Ψ </span>= 0<span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 708--><p class="nopar" >
i.e., Eq. (<a 
href="#x1-19001r55">55<!--tex4ht:ref: 15-11-27-1 --></a>) is satisﬁed, indicating <span 
class="cmmi-10">P </span>= <span 
class="cmmi-10">P</span>(<span 
class="cmmi-10">Ψ</span>) is a suﬃcient condition for the force balance in the
parallel (to the magnetic ﬁeld) direction.
</p><!--l. 713--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">4.2   </span> <a 
 id="x1-200004.2"></a>Toroidal force balance</h4>
<!--l. 715--><p class="noindent" >Consider the force balance in the toroidal direction. The <span 
class="cmmi-10">ϕ </span>component of Eq. (<a 
href="#x1-18002r54">54<!--tex4ht:ref: 7-7-force --></a>) is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-20001r56"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium61x.png" alt="JZBR  − JRBZ = -1∂P-.
               R  ∂ϕ
" class="math-display"  /></center></td><td class="equation-label">(56)</td></tr></table>
<!--l. 720--><p class="nopar" >
Since <span 
class="cmmi-10">P </span>= <span 
class="cmmi-10">P</span>(<span 
class="cmmi-10">Ψ</span>), which implies <span 
class="cmmi-10">∂P∕∂ϕ </span>= 0, equation (<a 
href="#x1-20001r56">56<!--tex4ht:ref: 15-11-27-2 --></a>) reduces to
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-20002r57"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium62x.png" alt="JZBR − JRBZ  = 0
" class="math-display"  /></center></td><td class="equation-label">(57)</td></tr></table>
<!--l. 725--><p class="nopar" >
Using the expressions of the poloidal current density (<a 
href="#x1-16001r47">47<!--tex4ht:ref: 5-2-a2 --></a>) and (<a 
href="#x1-16002r48">48<!--tex4ht:ref: 5-2-a1 --></a>) in the force balance equation (<a 
href="#x1-20002r57">57<!--tex4ht:ref: 7-7-1 --></a>)
yields
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-20003r58"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium63x.png" alt="∂g      ∂g
---BR + ---BZ = 0,
∂R      ∂Z
" class="math-display"  /></center></td><td class="equation-label">(58)</td></tr></table>
<!--l. 731--><p class="nopar" >
which can be further written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-20004r59"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium64x.png" alt="B ⋅∇g = 0.
" class="math-display"  /></center></td><td class="equation-label">(59)</td></tr></table>
<!--l. 735--><p class="nopar" >
According to the same reasoning for the pressure, we conclude that <span 
class="cmmi-10">g </span>= <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>) is a suﬃcient
condition for the toroidal force balance. (The function <span 
class="cmmi-10">g </span>deﬁned here is usually called the
“poloidal current function” in tokamak literature. The reason for this name is discussed in Sec.
<span 
class="cmbx-10">??</span>.)
</p><!--l. 742--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">4.3   </span> <a 
 id="x1-210004.3"></a>Force balance along the major radius</h4>
<!--l. 744--><p class="noindent" >Consider the force balance in <img 
src="tokamak_equilibrium65x.png" alt="Rˆ"  class="circ"  /> direction. The <img 
src="tokamak_equilibrium66x.png" alt="ˆR"  class="circ"  /> component of Eq. (<a 
href="#x1-18002r54">54<!--tex4ht:ref: 7-7-force --></a>) is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-21001r60"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium67x.png" alt="JϕBZ − JZB ϕ = ∂P
              ∂R
                                                                                

                                                                                
" class="math-display"  /></center></td><td class="equation-label">(60)</td></tr></table>
<!--l. 749--><p class="nopar" >
Using the expressions of the current density and magnetic ﬁeld [Eqs. (<a 
href="#x1-2003r6">6<!--tex4ht:ref: 6-9-a4 --></a>) and (<a 
href="#x1-16002r48">48<!--tex4ht:ref: 5-2-a1 --></a>)], equation (<a 
href="#x1-21001r60">60<!--tex4ht:ref: 7-8-radia --></a>) is
written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-21002r61"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium68x.png" alt="Jϕ 1-∂Ψ-− -1--∂g-g-= ∂P-.
   R ∂R   μ0R ∂R R   ∂R
" class="math-display"  /></center></td><td class="equation-label">(61)</td></tr></table>
<!--l. 756--><p class="nopar" >
Assuming the suﬃcient condition discussed above, i.e., <span 
class="cmmi-10">P </span>and <span 
class="cmmi-10">g </span>are a function of only <span 
class="cmmi-10">Ψ</span>, i.e., <span 
class="cmmi-10">P </span>= <span 
class="cmmi-10">P</span>(<span 
class="cmmi-10">Ψ</span>)
and <span 
class="cmmi-10">g </span>= <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>), Eq. (<a 
href="#x1-21002r61">61<!--tex4ht:ref: 3-30-1 --></a>) is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-21003r62"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium69x.png" alt="Jϕ 1-∂Ψ-−-1--dg-∂Ψ-g-= dP-∂Ψ-,
  R ∂R   μ0R dΨ ∂R R   dΨ ∂R
" class="math-display"  /></center></td><td class="equation-label">(62)</td></tr></table>
<!--l. 764--><p class="nopar" >
which can be simpliﬁed to
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-21004r63"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium70x.png" alt="J = R dP-+ --1--dg-g,
 ϕ    dΨ   μ0R dΨ
" class="math-display"  /></center></td><td class="equation-label">(63)</td></tr></table>
<!--l. 769--><p class="nopar" >
which is the requirement of force-balance along the major radius. On the other hand, we know <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub> can
be expressed in <span 
class="cmmi-10">Ψ </span>via Eq. (<a 
href="#x1-17003r51">51<!--tex4ht:ref: 6-9-a1 --></a>). Combining this with Eq. (<a 
href="#x1-21004r63">63<!--tex4ht:ref: 24-5-29-p4 --></a>) yields
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-21005r64"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium71x.png" alt="            dP    dg
△∗Ψ = − μ0R2---− ---g,
            dΨ   dΨ
" class="math-display"  /></center></td><td class="equation-label">(64)</td></tr></table>
<!--l. 776--><p class="nopar" >
i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-21006r65"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium72x.png" alt="           (      )
-∂2Ψ- +R -∂-  1-∂Ψ-  = − μ R2 dP-− dgg.
∂Z2     ∂R   R ∂R       0   dΨ   dΨ
" class="math-display"  /></center></td><td class="equation-label">(65)</td></tr></table>
<!--l. 782--><p class="nopar" >
Equation (<a 
href="#x1-21006r65">65<!--tex4ht:ref: 7-1-p1 --></a>) is known as Grad-Shafranov (GS) equation.
</p><!--l. 785--><p class="indent" >   [Note that the <span 
class="cmmi-10">Z </span>component of the force balance equation is written
</p>
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
<div class="array"> <table id="TBL-1" class="array" 
cellpadding="0" cellspacing="0"  
><colgroup id="TBL-1-1g"><col 
id="TBL-1-1" /></colgroup><tr  
 style="vertical-align:baseline;"><td  style="white-space:nowrap; text-align:left;" 
><div class="td11"><span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">R</span></sub><span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">ϕ</span></sub> <span 
class="cmsy-10">− </span><span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub><span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">R</span></sub> = <img 
src="tokamak_equilibrium73x.png" alt="∂∂PZ-"  class="frac" align="middle" />                         </div></td>
</tr><tr  
 style="vertical-align:baseline;"><td  style="white-space:nowrap; text-align:left;" 
><div class="td11"><span 
class="cmsy-10">⇒−</span><img 
src="tokamak_equilibrium74x.png" alt="-∂g-
∂Z"  class="frac" align="middle" /><img 
src="tokamak_equilibrium75x.png" alt="1-
R"  class="frac" align="middle" /><img 
src="tokamak_equilibrium76x.png" alt="-g
R"  class="frac" align="middle" /> <span 
class="cmsy-10">−</span><img 
src="tokamak_equilibrium77x.png" alt="-1
R"  class="frac" align="middle" /><span 
class="cmsy-10">△</span><sup><span 
class="cmsy-7">∗</span></sup><span 
class="cmmi-10">Ψ</span><img 
src="tokamak_equilibrium78x.png" alt="1-
R"  class="frac" align="middle" /><img 
src="tokamak_equilibrium79x.png" alt="∂Ψ-
∂Z"  class="frac" align="middle" /> = <span 
class="cmmi-10">μ</span><sub><span 
class="cmr-7">0</span></sub><img 
src="tokamak_equilibrium80x.png" alt="dP-
dΨ"  class="frac" align="middle" /><img 
src="tokamak_equilibrium81x.png" alt="∂Ψ-
∂Z"  class="frac" align="middle" />    </div></td>
</tr><tr  
 style="vertical-align:baseline;"><td  style="white-space:nowrap; text-align:left;" 
><div class="td11"><span 
class="cmsy-10">⇒−</span><img 
src="tokamak_equilibrium82x.png" alt="-dg
dΨ"  class="frac" align="middle" /><img 
src="tokamak_equilibrium83x.png" alt="∂Ψ-
∂Z"  class="frac" align="middle" /><img 
src="tokamak_equilibrium84x.png" alt="1-
R"  class="frac" align="middle" /><img 
src="tokamak_equilibrium85x.png" alt="g-
R"  class="frac" align="middle" /> <span 
class="cmsy-10">−</span><img 
src="tokamak_equilibrium86x.png" alt="1-
R"  class="frac" align="middle" /><span 
class="cmsy-10">△</span><sup><span 
class="cmsy-7">∗</span></sup><span 
class="cmmi-10">Ψ</span><img 
src="tokamak_equilibrium87x.png" alt="-1
R"  class="frac" align="middle" /><img 
src="tokamak_equilibrium88x.png" alt="∂Ψ-
∂Z"  class="frac" align="middle" /> = <span 
class="cmmi-10">μ</span><sub><span 
class="cmr-7">0</span></sub><img 
src="tokamak_equilibrium89x.png" alt="dP
dΨ"  class="frac" align="middle" /><img 
src="tokamak_equilibrium90x.png" alt="∂Ψ-
∂Z"  class="frac" align="middle" /></div></td>
</tr><tr  
 style="vertical-align:baseline;"><td  style="white-space:nowrap; text-align:left;" 
><div class="td11"><span 
class="cmsy-10">⇒−</span><img 
src="tokamak_equilibrium91x.png" alt="-dg
dΨ"  class="frac" align="middle" /><img 
src="tokamak_equilibrium92x.png" alt="1-
R"  class="frac" align="middle" /><img 
src="tokamak_equilibrium93x.png" alt="-g
R"  class="frac" align="middle" /> <span 
class="cmsy-10">−</span><img 
src="tokamak_equilibrium94x.png" alt="-1
R"  class="frac" align="middle" /><span 
class="cmsy-10">△</span><sup><span 
class="cmsy-7">∗</span></sup><span 
class="cmmi-10">Ψ</span><img 
src="tokamak_equilibrium95x.png" alt="1-
R"  class="frac" align="middle" /> = <span 
class="cmmi-10">μ</span><sub><span 
class="cmr-7">0</span></sub><img 
src="tokamak_equilibrium96x.png" alt="dP
dΨ"  class="frac" align="middle" />            </div></td>
</tr><tr  
 style="vertical-align:baseline;"><td  style="white-space:nowrap; text-align:left;" 
><div class="td11"><span 
class="cmsy-10">⇒△</span><sup><span 
class="cmsy-7">∗</span></sup><span 
class="cmmi-10">Ψ </span>= <span 
class="cmsy-10">−</span><span 
class="cmmi-10">μ</span><sub><span 
class="cmr-7">0</span></sub><span 
class="cmmi-10">R</span><sup><span 
class="cmr-7">2</span></sup><img 
src="tokamak_equilibrium97x.png" alt="dP
dΨ"  class="frac" align="middle" /> <span 
class="cmsy-10">−</span><img 
src="tokamak_equilibrium98x.png" alt="dg
dΨ"  class="frac" align="middle" /><span 
class="cmmi-10">g              </span></div></td></tr></table>                                            </div>
</td></tr></table>
<!--l. 800--><p class="nopar" >
which turns out to be identical with the Grad-Shafranov equation. This is not a coincidence. The
reason is that the force balance equation has been satisﬁed in three diﬀerent directions (namely, <img 
src="tokamak_equilibrium99x.png" alt="ˆ
ϕ"  class="circ"  />, <img 
src="tokamak_equilibrium100x.png" alt="ˆ
R"  class="circ"  />,
and <span 
class="cmbx-10">B </span>direction) and thus it must be satisﬁed in all the directions.]
</p><!--l. 807--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">4.4   </span> <a 
 id="x1-220004.4"></a>Axisymmetric equilibrium magnetic ﬁeld</h4>
<!--l. 809--><p class="noindent" >A general axisymmetric magnetic ﬁeld (which does not necessarily satisfy the force balance), is given by
Eq. (<a 
href="#x1-4001r10">10<!--tex4ht:ref: 7-28-6 --></a>), i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-22001r66"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium101x.png" alt="B = ∇Ψ × ∇ ϕ+  g∇ϕ ,
    ◟--◝◜--◞   ◟◝◜◞
     poloidal   toroidal
" class="math-display"  /></center></td><td class="equation-label">(66)</td></tr></table>
<!--l. 814--><p class="nopar" >
For the above axisymmetric magnetic ﬁeld to be consistent with the force balance equation
(<a 
href="#x1-18002r54">54<!--tex4ht:ref: 7-7-force --></a>), there are additional requirements for <span 
class="cmmi-10">Ψ </span>and <span 
class="cmmi-10">g</span>. Speciﬁcally, <span 
class="cmmi-10">Ψ </span>is restricted by the GS
equation and <span 
class="cmmi-10">g </span>should be a function of only <span 
class="cmmi-10">Ψ</span>. Therefore an axisymmetric equilibrium
magnetic ﬁeld is fully determined by two functions, <span 
class="cmmi-10">Ψ </span>= <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>) and <span 
class="cmmi-10">g </span>= <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>). The <span 
class="cmmi-10">Ψ </span>is
determined by solving the GS equation with speciﬁed RHS source terms and boundary
conditions.
</p><!--l. 823--><p class="indent" >   The RHS source terms in the GS equation (<a 
href="#x1-21006r65">65<!--tex4ht:ref: 7-1-p1 --></a>) are <span 
class="cmmi-10">P</span>(<span 
class="cmmi-10">Ψ</span>) and <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>), both of which must be speciﬁed
before the GS equation can be solved. For most cases, the source terms are nonlinear about <span 
class="cmmi-10">Ψ </span>and thus
the GS equation is a two-dimensional (in <span 
class="cmmi-10">R </span>and <span 
class="cmmi-10">Z</span>) nonlinear partial diﬀerential equation for
<span 
class="cmmi-10">Ψ</span>.
</p><!--l. 829--><p class="indent" >   For most choices of <span 
class="cmmi-10">P</span>(<span 
class="cmmi-10">Ψ</span>) and <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>), the GS equation (<a 
href="#x1-21006r65">65<!--tex4ht:ref: 7-1-p1 --></a>) has to be solved numerically. For some
particular choices of <span 
class="cmmi-10">P </span>and <span 
class="cmmi-10">g </span>proﬁles, analytical solutions are available, one of which is the Solovév
equilibrium and is discussed in Appendix <span 
class="cmbx-10">??</span>.
                                                                                

                                                                                
</p><!--l. 834--><p class="indent" >   Note that we solve the GS equation in order to obtain the poloidal magnetic ﬂux <span 
class="cmmi-10">Ψ </span>and thus the
poloidal magnetic ﬁeld. The toroidal magnetic ﬁeld must be speciﬁed in some way before we can solve
the GS equation. There are several ways of specifying the toroidal magnetic ﬁeld: (1) given <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>), (2)
given <span 
class="cmsy-10">⟨</span><span 
class="cmmi-10">j</span><sub><span 
class="cmsy-7">∥</span></sub><span 
class="cmsy-10">⟩</span>, (3) given the safety factor <span 
class="cmmi-10">q</span>(<span 
class="cmmi-10">Ψ</span>). There are simple relations between <span 
class="cmmi-10">g</span>, <span 
class="cmsy-10">⟨</span><span 
class="cmmi-10">j</span><sub><span 
class="cmsy-7">∥</span></sub><span 
class="cmsy-10">⟩</span>, and <span 
class="cmmi-10">q</span>, which
allows translation form one to another (discussed later). In transport simulations, <span 
class="cmsy-10">⟨</span><span 
class="cmmi-10">j</span><sub><span 
class="cmsy-7">∥</span></sub><span 
class="cmsy-10">⟩ </span>is
obtained from current drive models and neoclassical bootstrap current models. Note that the
speciﬁcation of the source terms (<span 
class="cmmi-10">P</span>, <span 
class="cmmi-10">g</span>, <span 
class="cmmi-10">q</span>, and <span 
class="cmsy-10">⟨</span><span 
class="cmmi-10">j</span><sub><span 
class="cmsy-7">∥</span></sub><span 
class="cmsy-10">⟩</span>) usually involve the unknown <span 
class="cmmi-10">Ψ </span>(via
not only the explicit presence of <span 
class="cmmi-10">Ψ</span>, but also the ﬂux-surface averaging which implicitly
involves <span 
class="cmmi-10">Ψ</span>). This indicates that iterations are needed when numerically solving the GS
equation.
</p><!--l. 849--><p class="indent" >    
</p><!--l. 851--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">5   </span> <a 
 id="x1-230005"></a>Free-boundary ﬁtting problem</h3>
<!--l. 853--><p class="noindent" >A routine in tokamak operation is to reconstruct magnetic ﬁeld under the constraints of MHD force
balance and expermental measurements. This kind of task can be done by various codes, e.g., <span 
class="cmtt-10">EFIT</span>. I
developed a similar code, <span 
class="cmtt-10">heq</span> (github.com/youjunhu/heq). I will discuss details on this
code.
</p><!--l. 859--><p class="indent" >   Ampere’s law in Eq. (<a 
href="#x1-17003r51">51<!--tex4ht:ref: 6-9-a1 --></a>) can be generalized to include discrete toroidal currents: </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium102x.png" alt="  ∗                 ∑
△  Ψ = − μ0RJ ϕ − μ0R  Iiδ(R − Ri)δ(Z − Zi),               (67)
                     i
" class="math-display"  /></center>
</div>where <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub> is the plasma toroidal current density,  <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">i</span></sub> is a toroidal curent ﬁlament located at
(<span 
class="cmmi-10">R </span>= <span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">i</span></sub><span 
class="cmmi-10">,Z </span>= <span 
class="cmmi-10">Z</span><sub><span 
class="cmmi-7">i</span></sub>), <span 
class="cmmi-10">δ</span>(<span 
class="cmsy-10">⋅</span>) is Dirac’s delta function. The solution to the above equation is given
by
   <table 
class="equation"><tr><td><a 
 id="x1-23002r68"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium103x.png" alt="          ∫                              ∑
Ψ (R,Z) =   G (R′,Z ′,R, Z)Jϕ(R′,Z ′)dR ′dZ′ +   G (Ri,Zi,R, Z)Ii,
           Ω                              i
                                                                                

                                                                                
" class="math-display"  /></center></td><td class="equation-label">(68)</td></tr></table>
<!--l. 871--><p class="nopar" >
where <span 
class="cmmi-10">G </span>is the fundamental solution given by </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium104x.png" alt="  G(R ′,Z′,R,Z)
  μ0R ∫ 2π              R′cosϕ′dϕ′
= -4π-    ∘-(Z-−-Z′)2-+-(R-−-R-′cosϕ′)2 +-(R′sin-ϕ′)2,           (69)
       0
" class="math-display"  /><a 
 id="x1-23003r69"></a></center>
</div>which is often called Green’s function in this context (which is obtained by using a formula similar to
the Biot-Savart Law, see <span 
class="cmbx-10">??</span>).
<!--l. 882--><p class="indent" >   If all the toroidal currents (plasma current + coil/vessel curents) are known, then <span 
class="cmmi-10">Ψ </span>can be
calculated by using Eq. (<a 
href="#x1-23002r68">68<!--tex4ht:ref: 10-31-1 --></a>). Unfortunately, <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub> is usually unknown. Meanwhile the force-balance
indicates that <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub> can be expressed in terms of <span 
class="cmmi-10">Ψ </span>via Eq. (<a 
href="#x1-21004r63">63<!--tex4ht:ref: 24-5-29-p4 --></a>), i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-23004r70"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium105x.png" alt="      dP     1  dg
Jϕ = R dΨ-+ μ-R-gdΨ-.
             0
" class="math-display"  /></center></td><td class="equation-label">(70)</td></tr></table>
<!--l. 890--><p class="nopar" >
Substituting this into Eq. (<a 
href="#x1-23002r68">68<!--tex4ht:ref: 10-31-1 --></a>) gives an implicit formula for <span 
class="cmmi-10">Ψ</span>, which can be iterated (with an initial
guess of <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>), and assuming the function forms, <span 
class="cmmi-10">P</span>(<span 
class="cmmi-10">Ψ</span>) and <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>), as well as the coil currents <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">i</span></sub>, are
known ). We can see that this is a Picard iteration. Will the iteration converge? We do not
know for sure. Numerical experiments indicate it does in some cases. Let us discuss some
speciﬁc cases. We assume that the 1D functions, <span 
class="cmmi-10">P</span>(<span 
class="cmmi-10">Ψ</span>) and <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>), can be modeled as (EFIT’s
model<span class="cite">[<span 
class="cmbx-10">?</span>]</span>):
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-23005r71"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium106x.png" alt="        { ∑NP −1
dP-(Ψ-)=     j=0  αj(xj − xNp )forx ≤ 1
  dΨ      0    for x &#x003E; 1
" class="math-display"  /></center></td><td class="equation-label">(71)</td></tr></table>
<!--l. 904--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-23006r72"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium107x.png" alt=" dg   { ∑NF −1βj(xj − xNF )forx ≤ 1
gdΨ-=   0 j=0 forx &#x003E; 1
" class="math-display"  /></center></td><td class="equation-label">(72)</td></tr></table>
<!--l. 911--><p class="nopar" >
where
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-23007r73"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium108x.png" alt="    Ψ − Ψ
x ≡ -----A-,
    ΨB − ΨA
" class="math-display"  /></center></td><td class="equation-label">(73)</td></tr></table>
<!--l. 915--><p class="nopar" >
<span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">A</span></sub> and <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">B</span></sub> are values of <span 
class="cmmi-10">Ψ </span>at the magnetic axis and LCFS, the coeﬃcients <span 
class="cmmi-10">α</span><sub><span 
class="cmmi-7">j</span></sub> and <span 
class="cmmi-10">β</span><sub><span 
class="cmmi-7">j</span></sub> are to be
determined, <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">p</span></sub> and <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">F</span></sub> are integers chosen by users. Expressions (<a 
href="#x1-23005r71">71<!--tex4ht:ref: 24-6-5-1 --></a>) and (<a 
href="#x1-23006r72">72<!--tex4ht:ref: 24-6-5-2 --></a>) guarantee that <span 
class="cmmi-10">dP∕dΨ</span>
and <span 
class="cmmi-10">gdg∕dΨ </span>are zero at and outside the LCFS, and thus no plasma current there. Note that expressions
(<a 
href="#x1-23005r71">71<!--tex4ht:ref: 24-6-5-1 --></a>) and (<a 
href="#x1-23006r72">72<!--tex4ht:ref: 24-6-5-2 --></a>) are nonlinear functions of <span 
class="cmmi-10">Ψ </span>even for <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">p</span></sub> = <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">F</span></sub> = 1. This is because the unknowns, <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">A</span></sub>
and <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">B</span></sub>, appear in the denominator of expression (<a 
href="#x1-23007r73">73<!--tex4ht:ref: 24-11-6-1 --></a>). Another nonlinearity is related to the fact that
the unkonw <span 
class="cmmi-10">Ψ </span>determines where the LCFS is and thus determines the region where the current
                                                                                

                                                                                
desnsity is set to zero. This also gives rise to the name “free-boundary” for this kind of
problems.
</p><!--l. 929--><p class="indent" >   Choosing an initial guess of <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>) on gridpoints, we can get the values of <span 
class="cmmi-10">α</span><sub><span 
class="cmmi-7">j</span></sub>, <span 
class="cmmi-10">β</span><sub><span 
class="cmmi-7">j</span></sub>, and <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">i</span></sub> by
solving a least square problem that minimises the diﬀerence between quantities computed and
the corresponding quantities measured in actual experiments. (Details are given in Sec.
<a 
href="#x1-240005.1">5.1<!--tex4ht:ref: 24-11-6-e1 --></a>.)
</p><!--l. 935--><p class="indent" >   After the coeﬃcients <span 
class="cmmi-10">α</span><sub><span 
class="cmmi-7">j</span></sub> and <span 
class="cmmi-10">β</span><sub><span 
class="cmmi-7">j</span></sub> are obtained, <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub> can be updated by using Eqs. (<a 
href="#x1-23004r70">70<!--tex4ht:ref: 24-6-5-5 --></a>)-(<a 
href="#x1-23006r72">72<!--tex4ht:ref: 24-6-5-2 --></a>). Then, we
use the latest <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub> and <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">i</span></sub> in Eq. (<a 
href="#x1-23002r68">68<!--tex4ht:ref: 10-31-1 --></a>) to re-compute the values of <span 
class="cmmi-10">Ψ </span>on gridpoints by using Eq. (<a 
href="#x1-23002r68">68<!--tex4ht:ref: 10-31-1 --></a>). The
procedure is repeted until convergecne in <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>). This is called Picard iteration. (Alternatively,
the values of <span 
class="cmmi-10">Ψ </span>on the inner gridpoints can be updated by inverting the Laplace operator
<span 
class="cmsy-10">△</span><sup><span 
class="cmmi-7">⋆</span></sup>, see Sec. <a 
href="#x1-270005.4">5.4<!--tex4ht:ref: 24-11-14-e1 --></a>. The values of <span 
class="cmmi-10">Ψ </span>on the bounary still have to be obtained by using Eq.
(<a 
href="#x1-23002r68">68<!--tex4ht:ref: 10-31-1 --></a>).)
</p><!--l. 945--><p class="indent" >   I implemented the above method in a Python code  (<span 
class="cmtt-10">HEQ</span> https://github.com/youjunhu/heq). The
following subsections discuss details of the code: Sec. <a 
href="#x1-240005.1">5.1<!--tex4ht:ref: 24-11-8-e3 --></a> discusses the least square problem. Sec.
<a 
href="#x1-260005.3">5.3<!--tex4ht:ref: 24-11-8-e1 --></a> discusses the vertical displacement instability stabilizer. Without the stabilizer, the
Picard iteration diverges for many elongated conﬁgurations, due to the vertical displacement
instability.
</p><!--l. 953--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">5.1   </span> <a 
 id="x1-240005.1"></a>Design matrix of the least square problem</h4>
<!--l. 955--><p class="noindent" >For <span 
class="cmmi-10">x </span><span 
class="msam-10">≤ </span>1, plugging expressions (<a 
href="#x1-23005r71">71<!--tex4ht:ref: 24-6-5-1 --></a>) and (<a 
href="#x1-23006r72">72<!--tex4ht:ref: 24-6-5-2 --></a>) into (<a 
href="#x1-23004r70">70<!--tex4ht:ref: 24-6-5-5 --></a>), we obtain </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium109x.png" alt="    ′  ′    ′N∑p−1    j   Np    -1--NF∑− 1   j    NF
Jϕ(R ,Z ) = R     αj(x − x  )+  μ0R′     βj(x  − x  ),          (74)
              j=0                    j=0
" class="math-display"  /><a 
 id="x1-24001r74"></a></center>
</div>For notation ease, deﬁne the following basis functions:
   <table 
class="equation"><tr><td><a 
 id="x1-24002r75"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium110x.png" alt="          {
      ′    R ′(xj − xNp)         for  0 ≤ j &#x003C; Np
bj(x,R ) =  (xj−Np − xNF )∕(μ0R ′) for  Np ≤ j &#x003C; Np + NF
" class="math-display"  /></center></td><td class="equation-label">(75)</td></tr></table>
<!--l. 969--><p class="nopar" >
and the corresponding expansion coeﬃcients
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24003r76"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium111x.png" alt="    {
     αj   for  0 ≤ j &#x003C; Np
cj =  βj−Np   for  Np ≤ j &#x003C; Np + NF
" class="math-display"  /></center></td><td class="equation-label">(76)</td></tr></table>
<!--l. 976--><p class="nopar" >
then Eq. (<a 
href="#x1-24001r74">74<!--tex4ht:ref: 24-6-5-3 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24004r77"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium112x.png" alt="    Nb∑−1        ′
Jϕ =    cjbj(x,R ),
     j=0
" class="math-display"  /></center></td><td class="equation-label">(77)</td></tr></table>
<!--l. 980--><p class="nopar" >
where <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">b</span></sub> = <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">P</span></sub> + <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">F</span></sub>. Plugging expression (<a 
href="#x1-24004r77">77<!--tex4ht:ref: 24-6-4-p1 --></a>) into Eq. (<a 
href="#x1-23002r68">68<!--tex4ht:ref: 10-31-1 --></a>), we obtain </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium113x.png" alt="         Nb∑−1  ∫      ′ ′           ′   ′  ′
Ψ(R,Z ) =    cj Ω G(R ,Z ,R,Z )bj(x,R )dR dZ
          j=0
         Nc∑−1    (c)  (c)
       +     G (Rj ,Zj ,R,Z )Ij.                           (78)
          j=0
" class="math-display"  /><a 
 id="x1-24005r78"></a></center>
</div>Collect all the free parameters as a column vector: <span 
class="cmbx-10">u </span>= (<span 
class="cmmi-10">c</span><sub><span 
class="cmr-7">0</span></sub><span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">c</span><sub><span 
class="cmmi-7">N</span><sub><span 
class="cmmi-5">b</span></sub><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span></sub><span 
class="cmmi-10">,I</span><sub><span 
class="cmr-7">0</span></sub><span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">,I</span><sub><span 
class="cmmi-7">N</span><sub><span 
class="cmmi-5">c</span></sub><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span></sub>)<sup><span 
class="cmmi-7">T</span></sup>. Denote the size of
vector <span 
class="cmbx-10">u </span>by <span 
class="cmmi-10">N</span>, which is the number of free parameters, i.e., <span 
class="cmmi-10">N </span>= <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">b</span></sub> + <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">c</span></sub>, then the rhs of Eq. (<a 
href="#x1-24005r78">78<!--tex4ht:ref: 24-6-5-p1 --></a>)
can be written as matrix-vector product, <span 
class="cmmi-10">Γ</span><span 
class="cmbx-10">u</span>. Denote the total number of measurements
of the poloidal ﬂux by <span 
class="cmmi-10">M</span><sub><span 
class="cmr-7">FL</span></sub>. Then matrix elements of <span 
class="cmmi-10">Γ </span>for <span 
class="cmmi-10">i </span>= 0<span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">,M</span><sub><span 
class="cmr-7">FL</span></sub> <span 
class="cmsy-10">− </span>1 are given
by:
   <table 
class="equation"><tr><td><a 
 id="x1-24006r79"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium114x.png" alt="     ∫
Γ ij =  G (R′,Z ′,R (FiL),Z(iFL))bj(x,R ′)dR ′dZ ′,
      Ω
" class="math-display"  /></center></td><td class="equation-label">(79)</td></tr></table>
<!--l. 999--><p class="nopar" >
for <span 
class="cmmi-10">j </span>= 0<span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">,N</span><sub><span 
class="cmmi-7">b</span></sub> <span 
class="cmsy-10">− </span>1, and
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24007r80"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium115x.png" alt="Γ ij = G (R (cj)−Nb,Z(jc)−Nb,R(iFL),Zi(FL)),
" class="math-display"  /></center></td><td class="equation-label">(80)</td></tr></table>
<!--l. 1004--><p class="nopar" >
for <span 
class="cmmi-10">j </span>= <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">b</span></sub><span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">,N </span><span 
class="cmsy-10">− </span>1. Here (<span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">i</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmr-7">FL</span><span 
class="cmr-7">)</span></sup><span 
class="cmmi-10">,Z</span><sub><span 
class="cmmi-7">i</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmr-7">FL</span><span 
class="cmr-7">)</span></sup>) is the location where the <span 
class="cmmi-10">i</span>th ﬂux measurement is
made.
</p><!--l. 1008--><p class="indent" >   The matrix <span 
class="cmmi-10">Γ </span>, which is of shape (<span 
class="cmmi-10">M,N</span>), is called “response matrix”. (In least square problems,
this matrix is called “design matrix’.) The value of <span 
class="cmmi-10">M </span>is equal to number of measurements/constraints
included (measurements/constraints are merged to <span 
class="cmmi-10">Γ </span>by row stacking). We will include <span 
class="cmmi-10">M</span><sub><span 
class="cmr-7">FL</span></sub>
measurements of the poloidal ﬂux, <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">B</span></sub> measurements of the poloidal magnetic ﬁeld, 1 measurement of
                                                                                

                                                                                
plasma current, a constraint for the on-axis safety factor. Then <span 
class="cmmi-10">M </span>= <span 
class="cmmi-10">M</span><sub><span 
class="cmr-7">FL</span></sub> + <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">B</span></sub> + 1 + 1. (For EAST,
<span 
class="cmmi-10">M</span><sub><span 
class="cmr-7">FL</span></sub> = 35<span 
class="cmmi-10">,M</span><sub><span 
class="cmmi-7">B</span></sub> = 38.)
</p><!--l. 1017--><p class="indent" >   Next, we consider the poloidal ﬁeld measurement:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24008r81"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium116x.png" alt="Bp (Ri,Zi) = Bp ⋅nˆi = BR cos𝜃pi + BZ sin𝜃pi,
" class="math-display"  /></center></td><td class="equation-label">(81)</td></tr></table>
<!--l. 1021--><p class="nopar" >
where (<span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">i</span></sub><span 
class="cmmi-10">,Z</span><sub><span 
class="cmmi-7">i</span></sub>) is the location of the No. i probe, <img 
src="tokamak_equilibrium117x.png" alt="ˆn"  class="circ"  /><sub><span 
class="cmmi-7">i</span></sub> is a unit vector denoting the positive normal
direction of the No. <span 
class="cmmi-10">i </span>magnetic probe, cos<span 
class="cmmi-10">𝜃</span><sub><span 
class="cmmi-7">pi</span></sub> = <img 
src="tokamak_equilibrium118x.png" alt="ˆn"  class="circ"  /><sub><span 
class="cmmi-7">i</span></sub> <span 
class="cmsy-10">⋅ </span><span 
class="cmbx-10">e</span><sub><span 
class="cmmi-7">R</span></sub>, sin<span 
class="cmmi-10">𝜃</span><sub><span 
class="cmmi-7">pi</span></sub> = <img 
src="tokamak_equilibrium119x.png" alt="nˆ"  class="circ"  /><sub><span 
class="cmmi-7">i</span></sub> <span 
class="cmsy-10">⋅ </span><span 
class="cmbx-10">e</span><sub><span 
class="cmmi-7">Z</span></sub>.
</p><!--l. 1027--><p class="indent" >   <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">p</span></sub>(<span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">i</span></sub><span 
class="cmmi-10">,Z</span><sub><span 
class="cmmi-7">i</span></sub>) can be inferred from <span 
class="cmbx-10">u </span>via </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium120x.png" alt="           N −1  ∫
            b∑            ′  ′           ′   ′  ′
Bp(Ri,Zi) =    cj Ω GB (R ,Z ,Ri,Zi)bj(x,R )dR dZ
            j=0
           Nc∑−1     (c)  (c)
         +     GB (Rj ,Zj ,Ri,Zi)Ij.                         (82)
            j=0
" class="math-display"  /><a 
 id="x1-24009r82"></a></center>
</div>
<!--l. 1036--><p class="indent" >   where
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24010r83"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium121x.png" alt="GB (R′,Z′,Ri,Zi) = GBR(R ′,Z′,Ri,Zi)cos𝜃pi + GBZ (R′,Z′,Ri,Zi)sin𝜃pi,
" class="math-display"  /></center></td><td class="equation-label">(83)</td></tr></table>
<!--l. 1040--><p class="nopar" >
and <span 
class="cmmi-10">G</span><sub><span 
class="cmmi-7">B</span><sub><span 
class="cmmi-5">R</span></sub></sub> and <span 
class="cmmi-10">G</span><sub><span 
class="cmmi-7">B</span><sub><span 
class="cmmi-5">Z</span></sub></sub> is given by Eq. (<span 
class="cmbx-10">??</span>) and (<span 
class="cmbx-10">??</span>). The rhs of Eq. (<a 
href="#x1-24009r82">82<!--tex4ht:ref: 24-6-6-1 --></a>) indicates that the matrix
elements of <span 
class="cmmi-10">Γ </span>are given by:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24011r84"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium122x.png" alt="     ∫
Γ ij =  GB (R′,Z′,Ri,Zi)bj(x,R ′)dR ′dZ ′,
      Ω
" class="math-display"  /></center></td><td class="equation-label">(84)</td></tr></table>
<!--l. 1046--><p class="nopar" >
for (<span 
class="cmmi-10">j </span>= 0<span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">,N</span><sub><span 
class="cmmi-7">b</span></sub> <span 
class="cmsy-10">− </span>1), and
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24012r85"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium123x.png" alt="          (c)    (c)
Γ ij = GB (Rj−Nb,Zj−Nb,Ri,Zi),
" class="math-display"  /></center></td><td class="equation-label">(85)</td></tr></table>
<!--l. 1050--><p class="nopar" >
for (<span 
class="cmmi-10">j </span>= <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">b</span></sub><span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">,N </span><span 
class="cmsy-10">− </span>1) . I place the magnetic ﬁeld equations after the ﬂux equations, i.,e the row number
<span 
class="cmmi-10">i </span>is in the range [<span 
class="cmmi-10">M</span><sub><span 
class="cmr-7">FL</span></sub><span 
class="cmmi-10">,M</span><sub><span 
class="cmr-7">FL</span></sub> + <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">B</span></sub> <span 
class="cmsy-10">− </span>1].
</p><!--l. 1055--><p class="indent" >   Next, we consider the constraint of plasma current. The plasma current <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">p</span></sub> can be inferred from <span 
class="cmbx-10">u</span>
via
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24013r86"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium124x.png" alt="    ∫            Nb−1  ∫
I =    J dR′dZ′ = ∑  c    b (x,R ′)dR ′dZ′.
 p   Ω  ϕ         j=0 j Ω  j
" class="math-display"  /></center></td><td class="equation-label">(86)</td></tr></table>
<!--l. 1060--><p class="nopar" >
The rhs of Eq. (<a 
href="#x1-24013r86">86<!--tex4ht:ref: 24-6-6-6 --></a>) indicates that the matrix elements of <span 
class="cmmi-10">Γ </span>are given by:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24014r87"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium125x.png" alt="     ∫        ′  ′  ′
Γ ij =  bj(x,R )dR dZ ,
      Ω
" class="math-display"  /></center></td><td class="equation-label">(87)</td></tr></table>
<!--l. 1065--><p class="nopar" >
for (<span 
class="cmmi-10">j </span>= 0<span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">,N</span><sub><span 
class="cmmi-7">b</span></sub> <span 
class="cmsy-10">− </span>1), and zero for (<span 
class="cmmi-10">j </span>= <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">b</span></sub><span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">,N </span><span 
class="cmsy-10">− </span>1) . This equation is placed after the equations of
ﬂux and magnetic ﬁeld measurement, i.e., its row number is  <span 
class="cmmi-10">i </span>= <span 
class="cmmi-10">M</span><sub><span 
class="cmr-7">FL</span></sub> + <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">B</span></sub>.
</p><!--l. 1070--><p class="indent" >   Let us consider the constraint of the on-axis safety factor <span 
class="cmmi-10">q</span><sub><span 
class="cmr-7">axis</span></sub>. A formula for computing <span 
class="cmmi-10">q</span><sub><span 
class="cmr-7">axis</span></sub> is
given by:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24015r88"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium126x.png" alt="      𝜖2 + 1 B
qaxis =----- --ϕaxis-,
      𝜖Raxis μ0Jϕaxis
" class="math-display"  /></center></td><td class="equation-label">(88)</td></tr></table>
<!--l. 1075--><p class="nopar" >
where
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24016r89"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium127x.png" alt="   ∘ --------------
     ( ∂2Ψ∕∂R2 )
𝜖 =    -2-----2    ,
       ∂ Ψ∕∂Z   axis
" class="math-display"  /></center></td><td class="equation-label">(89)</td></tr></table>
<!--l. 1080--><p class="nopar" >
is the ellipticity (elongation) at the magnetic axis. Organizing Eq. (<a 
href="#x1-24015r88">88<!--tex4ht:ref: 25-5-14-1 --></a>) as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24017r90"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium128x.png" alt="         2
--1- = 𝜖R2axis-μ0-Jϕaxis,
qaxis   𝜖 + 1g(0)
" class="math-display"  /></center></td><td class="equation-label">(90)</td></tr></table>
<!--l. 1086--><p class="nopar" >
and using
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24018r91"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium129x.png" alt="        N∑b−1
Jϕ axis =    cjbj(x = 0,Raxis),
        j=0
" class="math-display"  /></center></td><td class="equation-label">(91)</td></tr></table>
<!--l. 1091--><p class="nopar" >
equation (<a 
href="#x1-24017r90">90<!--tex4ht:ref: 24-7-17-1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24019r92"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium130x.png" alt="   2      Nb∑−1
-𝜖Raxisμ0--    cjbj(x = 0,Raxis) =--1-.
(𝜖2 +1)g(0) j=0                  qaxis
" class="math-display"  /></center></td><td class="equation-label">(92)</td></tr></table>
<!--l. 1096--><p class="nopar" >
This provides one linear equation for <span 
class="cmmi-10">c</span><sub><span 
class="cmmi-7">j</span></sub>, with the matrix elements given by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-24020r93"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium131x.png" alt="         2
Γ ij = -𝜖Raxisμ0--bj(x = 0,Raxis).
      (𝜖2 + 1)g(0)
" class="math-display"  /></center></td><td class="equation-label">(93)</td></tr></table>
<!--l. 1101--><p class="nopar" >
for (<span 
class="cmmi-10">j </span>= 0<span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">,N</span><sub><span 
class="cmmi-7">b</span></sub> <span 
class="cmsy-10">− </span>1), and zero for (<span 
class="cmmi-10">j </span>= <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">b</span></sub><span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">,N </span><span 
class="cmsy-10">− </span>1) .
</p><!--l. 1104--><p class="indent" >   In <span 
class="cmtt-10">HEQ</span>, the ellipticity <span 
class="cmmi-10">𝜖 </span>is calculated by computing the elongation of the innermost magnetic surface
found by the contour program.
</p><!--l. 1107--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">5.2   </span> <a 
 id="x1-250005.2"></a>Algorithm summary</h4>
<!--l. 1109--><p class="noindent" >Step 0. Initial guess of <span 
class="cmmi-10">Ψ</span>: <span 
class="cmmi-10">Ψ</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">k</span><span 
class="cmr-7">)</span></sup> with <span 
class="cmmi-10">k </span>= 0.
</p><!--l. 1111--><p class="indent" >   Step 1. Search for the magnetic axis and LCFS of <span 
class="cmmi-10">Ψ</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">k</span><span 
class="cmr-7">)</span></sup> so that we get the values of <span 
class="cmmi-10">Ψ</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">k</span><span 
class="cmr-7">)</span></sup> at those
locations. These values are needed in computing <span 
class="cmmi-10">x </span>= (<span 
class="cmmi-10">Ψ</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">k</span><span 
class="cmr-7">)</span></sup> <span 
class="cmsy-10">− </span><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">M</span></sub>)<span 
class="cmmi-10">∕</span>(<span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">B</span></sub> <span 
class="cmsy-10">− </span><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">M</span></sub>). The location of
the LCFS are also needed because we need to set the plasma current to zero outside the
LCFS.
</p><!--l. 1117--><p class="indent" >   Step 2. Compute elements of response matrix <span 
class="cmmi-10">Γ </span>using <span 
class="cmmi-10">Ψ</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">k</span><span 
class="cmr-7">)</span></sup>.
</p><!--l. 1119--><p class="indent" >   Step 3. Solve linear least-square problem to get (<span 
class="cmmi-10">c</span><sub><span 
class="cmr-7">1</span></sub><span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">,c</span><sub><span 
class="cmmi-7">N</span><sub><span 
class="cmmi-5">b</span></sub></sub><span 
class="cmmi-10">,I</span><sub><span 
class="cmr-7">1</span></sub><span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">,I</span><sub><span 
class="cmmi-7">N</span><sub><span 
class="cmmi-5">c</span></sub></sub>).
</p><!--l. 1122--><p class="indent" >   Step 4. Update <span 
class="cmmi-10">Ψ </span>using the latest plasma and coil currents:
</p>
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
              <span 
class="cmmi-10">Ψ</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">k</span><span 
class="cmr-7">+1)</span></sup> = <span 
class="cmex-10">∫</span>
  <span 
class="cmmi-10">GJ</span><sub><span 
class="cmmi-7">ϕ</span></sub>(<span 
class="cmmi-10">R</span><span 
class="cmsy-10">′</span><span 
class="cmmi-10">,Ψ</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">k</span><span 
class="cmr-7">)</span></sup><span 
class="cmmi-10">,c</span><sub>
<span 
class="cmr-7">1</span></sub><span 
class="cmmi-10">,c</span><sub><span 
class="cmr-7">2</span></sub><span 
class="cmmi-10">,c</span><sub><span 
class="cmr-7">3</span></sub><span 
class="cmmi-10">,c</span><sub><span 
class="cmr-7">4</span></sub>)<span 
class="cmmi-10">dR</span><span 
class="cmsy-10">′</span><span 
class="cmmi-10">dZ</span><span 
class="cmsy-10">′ </span>+ <span 
class="cmex-10">∑</span>
  <sub><span 
class="cmmi-7">n</span><span 
class="cmr-7">=1</span></sub><sup><span 
class="cmmi-7">N</span><sub><span 
class="cmmi-5">c</span></sub>
    </sup><span 
class="cmmi-10">GI</span><sub><span 
class="cmmi-7">n</span></sub><span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 1124--><p class="nopar" >
or in its discrete form:
</p>
   <table 
class="equation-star"><tr><td>
           <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">ij</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">k</span><span 
class="cmr-7">+1)</span></sup> = <span 
class="cmex-10">∑</span>
   <sub><span 
class="cmmi-7">i</span><span 
class="cmsy-7">′</span><span 
class="cmmi-7">,j</span><span 
class="cmsy-7">′</span></sub><span 
class="cmmi-10">G</span><sub><span 
class="cmmi-7">i</span><span 
class="cmsy-7">′</span><span 
class="cmmi-7">j</span><span 
class="cmsy-7">′</span><span 
class="cmmi-7">ij</span></sub><img 
src="tokamak_equilibrium132x.png" alt="(          )
 ∑Nb
     cnbn,i′j′
 n=1"  class="left" align="middle" /><span 
class="cmmi-10">dS</span><sub><span 
class="cmmi-7">i</span><span 
class="cmsy-7">′</span><span 
class="cmmi-7">j</span><span 
class="cmsy-7">′</span></sub> + <span 
class="cmex-10">∑</span>
  <sub><span 
class="cmmi-7">n</span><span 
class="cmr-7">=1</span></sub><sup><span 
class="cmmi-7">N</span><sub><span 
class="cmmi-5">c</span></sub>
    </sup><span 
class="cmmi-10">G</span><sub><span 
class="cmmi-7">n,ij</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">c</span><span 
class="cmr-7">)</span></sup><span 
class="cmmi-10">I</span><sub>
<span 
class="cmmi-7">n</span></sub><span 
class="cmmi-10">.</span>
</td></tr></table>
<!--l. 1128--><p class="nopar" >
</p><!--l. 1131--><p class="indent" >   Step 5: <span 
class="cmmi-10">k </span>= <span 
class="cmmi-10">k </span>+ 1 and goto Step 1.
</p><!--l. 1133--><p class="indent" >    
</p><!--l. 1135--><p class="indent" >    
</p><!--l. 1138--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">5.3   </span> <a 
 id="x1-260005.3"></a>Vertical displacement instability stabilizer in free-boundary solver<span class="cite">[<span 
class="cmbx-10">?</span>]</span></h4>
<!--l. 1140--><p class="noindent" > 
</p><!--l. 1142--><p class="indent" >   To stabilize the vertical displacement instability in the Picard iteration, we add two
virtual coils that carry oppositive currents (denoted by <span 
class="cmmi-10">I</span><sub><span 
class="cmr-7">vc</span></sub> and <span 
class="cmsy-10">−</span><span 
class="cmmi-10">I</span><sub><span 
class="cmr-7">vc</span></sub>), and are up-down
symmetric, located at (<span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">vc</span></sub><span 
class="cmmi-10">,Z</span><sub><span 
class="cmr-7">vc</span></sub>) and (<span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">vc</span></sub><span 
class="cmmi-10">,</span><span 
class="cmsy-10">−</span><span 
class="cmmi-10">Z</span><sub><span 
class="cmr-7">vc</span></sub>), respectively. And set the current <span 
class="cmmi-10">I</span><sub><span 
class="cmr-7">vc</span></sub>
by
</p>
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
            <span 
class="cmmi-10">I</span><sub><span 
class="cmr-7">vc</span></sub> = <span 
class="cmsy-10">−</span><span 
class="cmmi-10">g</span><sub><span 
class="cmmi-7">z</span></sub><img 
src="tokamak_equilibrium133x.png" alt="--------------BR,vacuum(Rcur,Zcur)--------------
GBR (Rvc,Zvc,Rcur,Zcur) − GBR (Rvc,− Zvc,Rcur,Zcur)"  class="frac" align="middle" /><span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 1150--><p class="nopar" >
where (<span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">cur</span></sub><span 
class="cmmi-10">,Z</span><sub><span 
class="cmr-7">cur</span></sub>) is the location of plasma current center deﬁned by
</p>
   <table 
class="equation-star"><tr><td>
                          <span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">cur</span></sub> = <img 
src="tokamak_equilibrium134x.png" alt="1-
Ip"  class="frac" align="middle" /> <span 
class="cmex-10">∫</span>
    <sub><span 
class="cmmi-7">Ω</span><sub><span 
class="cmr-5">pl</span></sub></sub><span 
class="cmmi-10">RJ</span><sub><span 
class="cmmi-7">ϕ</span></sub>(<span 
class="cmmi-10">R,Z</span>)<span 
class="cmmi-10">dRdZ,</span>
</td></tr></table>
<!--l. 1154--><p class="nopar" >
</p>
   <table 
class="equation-star"><tr><td>
                          <span 
class="cmmi-10">Z</span><sub><span 
class="cmr-7">cur</span></sub> = <img 
src="tokamak_equilibrium135x.png" alt="1
I-
 p"  class="frac" align="middle" /> <span 
class="cmex-10">∫</span>
    <sub><span 
class="cmmi-7">Ω</span><sub><span 
class="cmr-5">pl</span></sub></sub><span 
class="cmmi-10">ZJ</span><sub><span 
class="cmmi-7">ϕ</span></sub>(<span 
class="cmmi-10">R,Z</span>)<span 
class="cmmi-10">dRdZ,</span>
</td></tr></table>
                                                                                

                                                                                
<!--l. 1156--><p class="nopar" >
<span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">R,</span><span 
class="cmr-7">vacuum</span></sub> is the <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">R</span></sub> generated by all the real PF coils, <span 
class="cmmi-10">g</span><sub><span 
class="cmmi-7">z</span></sub> is a positive constant chosen by users. Note
that <span 
class="cmmi-10">g </span>= 1 corresponds to that the <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">R</span></sub> generated by the virtual coils exactly cancles the <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">R</span></sub> generted
by all the real coils. Usually we need value larger than 2, i.e., over compensation. The virtual coils
locatons, (<span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">vc</span></sub><span 
class="cmmi-10">,Z</span><sub><span 
class="cmr-7">vc</span></sub>) and (<span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">vc</span></sub><span 
class="cmmi-10">,</span><span 
class="cmsy-10">−</span><span 
class="cmmi-10">Z</span><sub><span 
class="cmr-7">vc</span></sub>), are usually chosen near the center of the top/bottom boundary of
the computational box.
</p><!--l. 1165--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">5.4   </span> <a 
 id="x1-270005.4"></a>Solving by matrix inversion</h4>
<!--l. 1167--><p class="noindent" >If we want to invert the ﬁnite-diﬀerence version of the Laplace operator <span 
class="cmsy-10">△</span><sup><span 
class="cmsy-7">∗</span></sup> to solve the GS equation for
<span 
class="cmmi-10">Ψ</span>, we encounter two issues: (1) the RHS of the GS equation involves 2 unknown functions <span 
class="cmmi-10">P</span><span 
class="cmsy-10">′</span>(<span 
class="cmmi-10">Ψ</span>) and
<span 
class="cmmi-10">gg</span><span 
class="cmsy-10">′</span>(<span 
class="cmmi-10">Ψ</span>), in addition to the main unknown function <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>); (2) the boundary condition
needs to be given: i.e., the values of <span 
class="cmmi-10">Ψ </span>on a rectangular computational boundry need to be
provided.
</p><!--l. 1174--><p class="indent" >   To address issue (1):  function forms of <span 
class="cmmi-10">P</span><span 
class="cmsy-10">′</span>(<span 
class="cmmi-10">Ψ</span>) and <span 
class="cmmi-10">g</span><span 
class="cmsy-10">′</span><span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>) are chosen by users, often as polymials in
<span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">N</span></sub> with coeﬃcients that are assumed known (which are later obtained in the least-square method to
make the resulting solution approximately match some measurements, as is discussed in the previous
section).
</p><!--l. 1180--><p class="indent" >   To address issue (2): The value of <span 
class="cmmi-10">Ψ </span>on the rectangular boundary is updated using the Green’s
function method (assume that external coil currents are given), as is discussed in the previous
section.
</p><!--l. 1184--><p class="indent" >   Guess values of <span 
class="cmmi-10">Ψ </span>on both the inner gridpoints and boundary points. After this, we can invert <span 
class="cmsy-10">△</span><sup><span 
class="cmsy-7">∗</span></sup> to
update <span 
class="cmmi-10">Ψ </span>within the computational box, and use the Green’s function method to update values of <span 
class="cmmi-10">Ψ </span>on
the boundary. Then iterate to converge.
</p><!--l. 1189--><p class="indent" >   Two iterations: one for <span 
class="cmmi-10">Ψ </span>values on the inner gridpoints, one over <span 
class="cmmi-10">Ψ </span>values on the computational
boundary.
</p><!--l. 1192--><p class="indent" >   External PF coil currents enter the problem via the boundary condition: speciﬁcally via its
contribution to <span 
class="cmmi-10">Ψ </span>on the boundary.
</p><!--l. 1195--><p class="indent" >   The above procedure is just a minor modiﬁcation from the pure Green’s function algorithm
discussed in Sec. <a 
href="#x1-250005.2">5.2<!--tex4ht:ref: 24-11-9-e1 --></a>, i.e., replacing the Green’s function method for the inner gridpoints with the
ﬁnte-diﬀerence Laplace operator inverting.
</p><!--l. 1200--><p class="indent" >   For reference easy, the ﬁnite-diﬀerence schemes for the Laplace operator is listed below.
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-27001r94"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium136x.png" alt="△ ∗Ψ = − μ0RJϕ
" class="math-display"  /></center></td><td class="equation-label">(94)</td></tr></table>
                                                                                

                                                                                
<!--l. 1204--><p class="nopar" >
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium137x.png" alt="          (     )     2
△∗ = R-∂-  1--∂-  + -∂--                        (95)
      ∂R   R ∂R     ∂Z2
     -∂--  1--∂-   ∂2--
   = ∂R2 − R ∂R +  ∂Z2                          (96)
" class="math-display"  /><a 
 id="x1-27002r95"></a><a 
 id="x1-27002r96"></a></center>
</div>
<!--l. 1214--><p class="indent" >   Method 1: discretize Eq. (<a 
href="#x1-27002r95">95<!--tex4ht:ref: 24-7-24-p1 --></a>) as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium138x.png" alt="        ( (     )       (     )     )
     -1-   1-∂Ψ-         -1∂Ψ-
  Ri ΔR    R ∂R  i+1∕2 − R ∂R  i−1∕2

+  Ψi,j+1-−-2Ψi,2j +-Ψi,j−1-= − μ0RiJϕi,j,                   (97)
          Δ Z
" class="math-display"  /></center>
</div>which can be further discretized as <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium139x.png" alt="       (                                    )
  R -1-  --1---Ψi+1,j −-Ψi,j-−--1---Ψi,j −-Ψi−1,j
   iΔR   Ri+1∕2    ΔR       Ri−1∕2    ΔR
  Ψi,j+1 −-2Ψi,j +-Ψi,j−1
+         Δ2         = − μ0RiJϕi,j,                          (98)
           Z
" class="math-display"  /></center>
</div>which can be organized as
   <table 
class="equation-star"><tr><td>
               <span 
class="cmmi-10">aφ</span><sub><span 
class="cmmi-7">i</span><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span><span 
class="cmmi-7">,j</span></sub> + <span 
class="cmmi-10">bφ</span><sub><span 
class="cmmi-7">i,j</span></sub> + <span 
class="cmmi-10">cφ</span><sub><span 
class="cmmi-7">i</span><span 
class="cmr-7">+1</span><span 
class="cmmi-7">,j</span></sub> + <span 
class="cmmi-10">dφ</span><sub><span 
class="cmmi-7">i,j</span><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span></sub> + <span 
class="cmmi-10">eφ</span><sub><span 
class="cmmi-7">i,j</span><span 
class="cmr-7">+1</span></sub> = <span 
class="cmsy-10">−</span><span 
class="cmmi-10">μ</span><sub><span 
class="cmr-7">0</span></sub><span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">i</span></sub><span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕi,j</span></sub><span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 1232--><p class="nopar" >
where <span 
class="cmmi-10">b </span>= <span 
class="cmsy-10">−</span><img 
src="tokamak_equilibrium140x.png" alt="-1-
Δ2R"  class="frac" align="middle" /><img 
src="tokamak_equilibrium141x.png" alt="(--Ri-   -Ri--)
 Ri+1∕2 + Ri−1∕2"  class="left" align="middle" /><span 
class="cmsy-10">−</span><img 
src="tokamak_equilibrium142x.png" alt="-2-
Δ2Z"  class="frac" align="middle" />, <span 
class="cmmi-10">a </span>= <img 
src="tokamak_equilibrium143x.png" alt="-1-
Δ2R"  class="frac" align="middle" /><img 
src="tokamak_equilibrium144x.png" alt="-Ri--
Ri−1∕2"  class="frac" align="middle" />, <span 
class="cmmi-10">c </span>= <img 
src="tokamak_equilibrium145x.png" alt="-1-
Δ2R"  class="frac" align="middle" /><img 
src="tokamak_equilibrium146x.png" alt="--Ri-
Ri+1∕2"  class="frac" align="middle" />, <span 
class="cmmi-10">d </span>= <span 
class="cmmi-10">e </span>= <img 
src="tokamak_equilibrium147x.png" alt="1--
Δ2Z"  class="frac" align="middle" />. Method 2:
discetize Eq. (<a 
href="#x1-27002r96">96<!--tex4ht:ref: 24-7-24-p2 --></a>) </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium148x.png" alt="Ψi+1,j-− 2Ψij +-Ψi−1,j − 1-Ψi+1,j −-Ψi−1,j-+ Ψi,j+1 −-2Ψi,j +-Ψi,j−1
        Δ2R           R     2ΔR                Δ2Z
= − μ0RiJ ϕi,j,
" class="math-display"  /></center>
</div>which can be organized as
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
               <span 
class="cmmi-10">aφ</span><sub><span 
class="cmmi-7">i</span><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span><span 
class="cmmi-7">,j</span></sub> + <span 
class="cmmi-10">bφ</span><sub><span 
class="cmmi-7">i,j</span></sub> + <span 
class="cmmi-10">cφ</span><sub><span 
class="cmmi-7">i</span><span 
class="cmr-7">+1</span><span 
class="cmmi-7">,j</span></sub> + <span 
class="cmmi-10">dφ</span><sub><span 
class="cmmi-7">i,j</span><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span></sub> + <span 
class="cmmi-10">eφ</span><sub><span 
class="cmmi-7">i,j</span><span 
class="cmr-7">+1</span></sub> = <span 
class="cmsy-10">−</span><span 
class="cmmi-10">μ</span><sub><span 
class="cmr-7">0</span></sub><span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">i</span></sub><span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕi,j</span></sub><span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 1246--><p class="nopar" >
where <span 
class="cmmi-10">b </span>= <span 
class="cmsy-10">−</span><img 
src="tokamak_equilibrium149x.png" alt="Δ22-
 R"  class="frac" align="middle" /> <span 
class="cmsy-10">−</span><img 
src="tokamak_equilibrium150x.png" alt="Δ22-
 Z"  class="frac" align="middle" /> <span 
class="cmmi-10">a </span>= <img 
src="tokamak_equilibrium151x.png" alt="Δ12-
 R"  class="frac" align="middle" /> + <img 
src="tokamak_equilibrium152x.png" alt="2R1ΔR-"  class="frac" align="middle" />, <span 
class="cmmi-10">c </span>= <img 
src="tokamak_equilibrium153x.png" alt="Δ12-
  R"  class="frac" align="middle" /> <span 
class="cmsy-10">−</span><img 
src="tokamak_equilibrium154x.png" alt="2R1ΔR-"  class="frac" align="middle" />, <span 
class="cmmi-10">d </span>= <span 
class="cmmi-10">e </span>= <img 
src="tokamak_equilibrium155x.png" alt="Δ12-
  Z"  class="frac" align="middle" />
</p><!--l. 1251--><p class="indent" >   My numerical experiments indicate this scheme is more stable than than the ﬁrst one (for the same
grid size, and without the VDE stabilizer, the ﬁrst scheme blow up while the latter scheme works
well).
</p><!--l. 1255--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">5.5   </span> <a 
 id="x1-280005.5"></a>Semi-free bounday equilibrium problem</h4>
<!--l. 1257--><p class="noindent" >Semi-free boundary equilibrium problems refer to the problems where the LCFS shape and the value of
<span 
class="cmmi-10">Ψ </span>on it are given, and one is asked to solve the currents in the PF coils. This is similar to the ﬁtting
problem discussed above: we consider the control points on the LCFS as virtual ﬂux loops that measure
the poloidal ﬂux. This mode can be used to set the feedforward PF coil currents when a target plasma
state time evolution is given.
</p><!--l. 1264--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">6   </span> <a 
 id="x1-290006"></a>Magnetic control (to be continued)</h3>
<!--l. 1266--><p class="noindent" >Using magnetic measurements as input, a realtime equilibrium reconstruction code (e.g., <span 
class="cmtt-10">rtefit</span>) can
infer the inner structure of <span 
class="cmmi-10">Ψ </span>(observer). On the other hand, PF coil currents can provide actions on <span 
class="cmmi-10">Ψ</span>
(actuactor). With the observer and actuator, we can feedback controll the magnetic conﬁguration (ﬂux
map).
</p><!--l. 1272--><p class="indent" >   For example, consider controlling the shape of LCFS (often called iso-ﬂux control). We choose a
target surface. To make sure that the target surface is a magnetic surface, the value of <span 
class="cmmi-10">Ψ </span>on it should
be made a spatial constant. Dentoe this constant by <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">t</span></sub>. To make sure that there is no
closed ﬂux surface outside the target surface, we select the target surface as a surface that is
tangential to the ﬁrst wall (for limiter conﬁguration) or there is a X-point on it (for divertor
conﬁguration). Then discretize the target surface by a series of discrete coordinates (<span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">i</span></sub><span 
class="cmmi-10">,Z</span><sub><span 
class="cmmi-7">i</span></sub>)
with <span 
class="cmmi-10">i </span>= 1<span 
class="cmmi-10">,</span>2<span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">M</span>. The actions (coil current changes) are chosen to minimise the following
residual:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-29001r99"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium156x.png" alt="M∑  (      N∑c                  ) 2
   (Δ Ψi −   G (R ′j,Z ′j,Ri,Zi)ΔIj)  ,
 i         j
" class="math-display"  /></center></td><td class="equation-label">(99)</td></tr></table>
<!--l. 1285--><p class="nopar" >
where
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-29002r100"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium157x.png" alt="ΔΨi = Ψ (target) − Ψ (oild),
" class="math-display"  /></center></td><td class="equation-label">(100)</td></tr></table>
<!--l. 1289--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-29003r101"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium158x.png" alt="      (new)   (old)
ΔIj = Ij   − Ij  ,
" class="math-display"  /></center></td><td class="equation-label">(101)</td></tr></table>
<!--l. 1292--><p class="nopar" >
the superscritp (old) indicates values before the control actions, <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">i</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmr-7">old</span><span 
class="cmr-7">)</span></sup> is obtained by a real-time
equilibrium reconstruction code. This assumes that the plasma current density remains the same when
the actions are imposed (i.e., no plasma response is included), so that only the coil current changes
contribute to the <span 
class="cmmi-10">Ψ </span>change.
</p><!--l. 1299--><p class="indent" >   If we need to feedback control <span 
class="cmmi-10">X </span>points to desired positions, then the above sum can be extended to
include the following: </p><div class="eqnarray">
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium159x.png" alt="     (                                           )2
  M∑X       (X)  (X)   N∑c       ′  ′  (X)  (X)
     (BR (Ri  ,Zi  )+    GBR (Rj,Zj,Ri  ,Zi  )ΔIj )
   i                   j
  M∑X (                N∑c                         )2
+    (BZ (R(iX),Z(iX))+    GBZ (R′j,Z′j,R(iX),Z(iX))ΔIj ) ,         (102)
   i                   j
" class="math-display"  /></center>
</div>where (<span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">i</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">X</span><span 
class="cmr-7">)</span></sup><span 
class="cmmi-10">,Z</span><sub><span 
class="cmmi-7">i</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">X</span><span 
class="cmr-7">)</span></sup>) are desired poistions of X points.
<!--l. 1309--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">7   </span> <a 
 id="x1-300007"></a>Circuit equation</h3>
<!--l. 1311--><p class="noindent" >Faraday’s law
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-30001r103"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium160x.png" alt="          ∂B-
∇ × E = − ∂t ,
" class="math-display"  /></center></td><td class="equation-label">(103)</td></tr></table>
<!--l. 1314--><p class="nopar" >
can be written in the integral form:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-30002r104"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium161x.png" alt="∮            ∫
  E ⋅dl = − ∂   B⋅dS.
           ∂t
" class="math-display"  /></center></td><td class="equation-label">(104)</td></tr></table>
<!--l. 1319--><p class="nopar" >
(The direction of the loop integration is related to the surface orientation by the right-hand rule.)
I.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-30003r105"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium162x.png" alt="∮
           ∂Ψp-
  E ⋅dl = − ∂t ,
" class="math-display"  /></center></td><td class="equation-label">(105)</td></tr></table>
<!--l. 1325--><p class="nopar" >
where <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub> is the ﬂux linked with the loop.
</p><!--l. 1328--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">7.1   </span> <a 
 id="x1-310007.1"></a>Circuit equation for PF coil currents</h4>
<!--l. 1330--><p class="noindent" >For the No. <span 
class="cmmi-10">k </span>coil, the time derivative of the ﬂux through it can be expressed as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-31001r106"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium163x.png" alt="    |   (          )
∂Ψp-||   (∑Nc    dIj)   -d∫
 ∂t |k =     Mjk  dt  + dt   Mk(r)JϕdS,
         j=1
" class="math-display"  /></center></td><td class="equation-label">(106)</td></tr></table>
<!--l. 1336--><p class="nopar" >
where <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">jk</span></sub> is the mutual indctance between the No. <span 
class="cmmi-10">j </span>coil and No. <span 
class="cmmi-10">k </span>coil, <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">k</span></sub>(<span 
class="cmbx-10">r</span>) is the mutual
inductance between the No. <span 
class="cmmi-10">k </span>coil and a plasma ﬁlament located at <span 
class="cmbx-10">r</span>, and <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub><span 
class="cmmi-10">dS </span>is the current carried
by the ﬁlament. The integration is over a ﬁxed region (time independent) that is large enough to
include all the plasma and small enough to not include any coil.
                                                                                

                                                                                
</p><!--l. 1344--><p class="indent" >   Deﬁne the eﬀective mutual inductance between the plasma and the No. <span 
class="cmmi-10">k </span>coil by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-31002r107"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium164x.png" alt="       1-∫
Mk,p = Ip  Mk (r)J ϕdS,
" class="math-display"  /></center></td><td class="equation-label">(107)</td></tr></table>
<!--l. 1349--><p class="nopar" >
where <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">p</span></sub> is the plasma current, then expression (<a 
href="#x1-31001r106">106<!--tex4ht:ref: 25-2-14-1 --></a>) is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium165x.png" alt="   |   ( N∑c        )
∂Ψp|| = (    Mjk dIj) + d-(IpMk,p)
∂t |k    j=1    dt     dt
       (           )
       ( N∑c     dIj)       dIp
     ≈      Mjk dt   + Mk,pdt ,                    (108)
         j=1
" class="math-display"  /></center>
</div>where the term proportional to the time derivative of <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">k,p</span></sub> is ignored (is this a good approximation?).
Including the above emf in the circuit equation, we get
   <table 
class="equation"><tr><td><a 
 id="x1-31004r109"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium166x.png" alt="     (          )
       N∑c    dIj        dIp
Vk − (    Mjk-dt) − Mk,p-dt = Ikℛk,
       j=1
                                                                                

                                                                                
" class="math-display"  /></center></td><td class="equation-label">(109)</td></tr></table>
<!--l. 1365--><p class="nopar" >
where <span 
class="cmsy-10">ℛ</span><sub><span 
class="cmmi-7">k</span></sub> is the resistence of the coil, <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">k</span></sub> is the current in the present coil,  <span 
class="cmmi-10">V</span> <sub><span 
class="cmmi-7">k</span></sub> is the voltage
imposed on the coil by the power supply. (Here the positive direction of <span 
class="cmmi-10">V</span> <sub><span 
class="cmmi-7">k</span></sub> and <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">k</span></sub> must
be chosen consistent with the loop integration discussed above i.e., anti-clockwise in top
view.)
</p><!--l. 1372--><p class="indent" >   The VDE controlling coils are made of two coils (one upper and one lower, with updown symmetry),
which are anti-conneted in series and powered by one voltage source. For the upper (<span 
class="cmmi-10">U</span>) coil, the circuit
equation is
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-31005r110"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium167x.png" alt="    (  Nc       )
VU −( ∑  MjU dIj) − MU,p dIp-= IUℛU .
      j=1     dt         dt
" class="math-display"  /></center></td><td class="equation-label">(110)</td></tr></table>
<!--l. 1378--><p class="nopar" >
Similarly, for the lower (<span 
class="cmmi-10">L</span>) coil, the circuit equation is
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-31006r111"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium168x.png" alt="     ( Nc       )
V  − (∑  M   dIj) − M    dIp-= I ℛ  .
 L    j=1  jL dt      L,p dt    L  L
" class="math-display"  /></center></td><td class="equation-label">(111)</td></tr></table>
<!--l. 1385--><p class="nopar" >
The anti-series connection implies that
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-31007r112"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium169x.png" alt="IL = − IU,
" class="math-display"  /></center></td><td class="equation-label">(112)</td></tr></table>
<!--l. 1389--><p class="nopar" >
and
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-31008r113"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium170x.png" alt="VU − VL = VVDE,
" class="math-display"  /></center></td><td class="equation-label">(113)</td></tr></table>
<!--l. 1393--><p class="nopar" >
where <span 
class="cmmi-10">V</span> <sub><span 
class="cmr-7">VDE</span></sub> is the source voltage (assuming the voltage source positive terminal is connected to the
upper coil that goes anti-clockwise in top view). Combining these equations, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-31009r114"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium171x.png" alt="       ( N               )
       (∑ c            dIj)                dIp
VVDE −     (MjU − MjL )dt   − (MU,p − ML,p)dt = IU(ℛU +ℛL ).
        j=1
" class="math-display"  /></center></td><td class="equation-label">(114)</td></tr></table>
<!--l. 1401--><p class="nopar" >
This is used as an equation for the upper VDE coil current. Eq. (<a 
href="#x1-31007r112">112<!--tex4ht:ref: 25-4-24-1 --></a>) is used as an equation for the
lower VDE coil current.
                                                                                

                                                                                
</p><!--l. 1405--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">7.2   </span> <a 
 id="x1-320007.2"></a>Circuit equation for total plasma current</h4>
<!--l. 1407--><p class="noindent" >Because the mutual inductance between two objects is symmetric (i.e., <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">AB</span></sub> = <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">BA</span></sub>), the mutual
inductance <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">k,p</span></sub> given by expression (<a 
href="#x1-31002r107">107<!--tex4ht:ref: 25-2-20-3 --></a>) can also be used to calculate the eﬀective emf induced in the
plasma by the coils: </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium172x.png" alt="  (         )
d- ∑Nc            N∑c     dIk
dt    Mk,pIk  ≈ −    Mk,p dt .
   k=1            k=1
" class="math-display"  /></center>
</div>(Here <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">k,p</span></sub> can be understood as <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub> weighted average of <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">k</span></sub>(<span 
class="cmbx-10">r</span>). Why to use <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub> weighted, rather than
just equal-weighted spatial average? This is to ensure energy conservation: the power is <span 
class="cmbx-10">E </span><span 
class="cmsy-10">⋅ </span><span 
class="cmbx-10">J</span>, so the
current density should serve as a weight.)
<!--l. 1421--><p class="indent" >   Similarly, the eﬀective emf self-induced in the plasma is given by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-32002r115"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium173x.png" alt="  d ( 1 ∫ ∫                      )
−dt  I-     Jϕi′j′Mi ′j′ijJϕijdSijdSi′j′ ,
      p
" class="math-display"  /></center></td><td class="equation-label">(115)</td></tr></table>
<!--l. 1425--><p class="nopar" >
where <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">i</span><span 
class="cmsy-7">′</span><span 
class="cmmi-7">j</span><span 
class="cmsy-7">′</span><span 
class="cmmi-7">ij</span></sub> is the mutual inductance between <span 
class="cmmi-10">ij </span>ﬁlament and <span 
class="cmmi-10">i</span><span 
class="cmsy-10">′</span><span 
class="cmmi-10">j</span><span 
class="cmsy-10">′ </span>ﬁlament; both the 2D integrations
are over a ﬁxed region that includes the plasma but does not include any coil; one of the two 2D
integrations can be regarded as <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub> weighted average and the other is the integration over
the source. Expresion (<a 
href="#x1-32002r115">115<!--tex4ht:ref: 25-2-20-p1 --></a>) motivates us to deﬁne the eﬀective self-inductance of plasma
by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-32003r116"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium174x.png" alt="       ∫ ∫
Lp = 12     Jϕi′j′Mi′j′ijJ ϕijdSijdSi′j′,
     Ip
" class="math-display"  /></center></td><td class="equation-label">(116)</td></tr></table>
<!--l. 1435--><p class="nopar" >
Then the eﬀective emf in expression (<a 
href="#x1-32002r115">115<!--tex4ht:ref: 25-2-20-p1 --></a>) is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium175x.png" alt="  d            dI
−--(LpIp) ≈ − Lp-p,
 dt             dt
" class="math-display"  /></center>
</div>where the term proportional to the time derivative of <span 
class="cmmi-10">L</span><sub><span 
class="cmmi-7">p</span></sub> is ignored. Then the circuit equation for the
plasma current is written as
   <table 
class="equation"><tr><td><a 
 id="x1-32005r117"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium176x.png" alt="         ∑Nc
− LpdIp−    Mk,p dIk= Ipℛp,
     dt  k=1     dt
" class="math-display"  /></center></td><td class="equation-label">(117)</td></tr></table>
<!--l. 1445--><p class="nopar" >
where <span 
class="cmsy-10">ℛ</span><sub><span 
class="cmmi-7">p</span></sub> is the eﬀective plasma resistivity.
</p><!--l. 1448--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">7.3   </span> <a 
 id="x1-330007.3"></a>Time discrete form of coupled coil and plasma currents</h4>
<!--l. 1450--><p class="noindent" >Using the Euler implicit scheme, the coil current evolution equation (<a 
href="#x1-31004r109">109<!--tex4ht:ref: 25-2-13-p1 --></a>) is written as
</p>
                                                                                

                                                                                
   <table 
class="equation-star"><tr><td>
          <span 
class="cmmi-10">V </span><sub><span 
class="cmmi-7">k</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">n</span><span 
class="cmr-7">)</span></sup> <span 
class="cmsy-10">−</span><span 
class="cmex-10">∑</span>
  <sub><span 
class="cmmi-7">j</span><span 
class="cmr-7">=1</span></sub><sup><span 
class="cmmi-7">N</span><sub><span 
class="cmmi-5">c</span></sub>
    </sup><span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">jk</span></sub><img 
src="tokamak_equilibrium177x.png" alt=" (n+1)   (n)
Ij----−-Ij-
     Δt"  class="frac" align="middle" /> <span 
class="cmsy-10">− </span><span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">k,p</span></sub><img 
src="tokamak_equilibrium178x.png" alt=" (n+1)   (n)
Ip----−-Ip--
    Δt"  class="frac" align="middle" /> = <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">k</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">n</span><span 
class="cmr-7">+1)</span></sup><span 
class="cmsy-10">ℛ</span><sub>
<span 
class="cmmi-7">k</span></sub><span 
class="cmmi-10">.</span>
</td></tr></table>
<!--l. 1454--><p class="nopar" >
Moving all the unknown (coil currents <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">j</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">n</span><span 
class="cmr-7">+1)</span></sup> and plasma current <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">p</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">n</span><span 
class="cmr-7">+1)</span></sup>) to the left-hand side, we get
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium179x.png" alt="            N       (n+1)
     (n+1)  ∑c     Ij-----      Ip(n+1)-
  ℛkIk    + j=1Mjk  Δt  + Mk,p  Δt
                (n)
   (n)  N∑c     Ij--      I(np)-
= Vk  +    Mjk Δt  +Mk,p Δt .                        (118)
        j=1
" class="math-display"  /></center>
</div>For each coil, we get a linear equation like the above. For <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">c</span></sub> coils, we get <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">c</span></sub> equations. (Note that
<span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">k,p</span></sub> depends on <span 
class="cmmi-10">J</span><sub><span 
class="cmmi-7">ϕ</span></sub>, and thus is time dependent. If we use value of <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">k,p</span></sub> at <span 
class="cmmi-10">t</span><sub><span 
class="cmmi-7">n</span><span 
class="cmr-7">+1</span></sub> in the above
equation, then we need to iterate because <span 
class="cmmi-10">M</span><sub><span 
class="cmmi-7">k,p</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">n</span><span 
class="cmr-7">+1)</span></sup> is unkown. If we use the value at <span 
class="cmmi-10">t</span><sub><span 
class="cmmi-7">n</span></sub>, then no
iteration is needed, whch is the case used in HEQ).
<!--l. 1470--><p class="indent" >   Similarly, the plasma current evolution equation (<a 
href="#x1-32005r117">117<!--tex4ht:ref: 25-3-31-p1 --></a>) is discretized as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-33002r119"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium180x.png" alt="   I(pn+1)− I(pn)   N∑c     I(n+1) − I(n)
− Lp----Δt---- −    Mk,p-k--Δt--k--= I(pn+1)ℛp,
                 k=1
" class="math-display"  /></center></td><td class="equation-label">(119)</td></tr></table>
<!--l. 1476--><p class="nopar" >
i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-33003r120"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium181x.png" alt=" N             (        )                 N
∑ cMk,p- (n+1)         Lp-  (n+1)     I(pn)-  ∑c     I(kn)
    Δt  Ij   +   ℛp + Δt  Ip    = LpΔt  +    Mk,p Δt .
k=1                                       k=1
" class="math-display"  /></center></td><td class="equation-label">(120)</td></tr></table>
<!--l. 1483--><p class="nopar" >
</p><!--l. 1486--><p class="indent" >    
</p><!--l. 1490--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">7.4   </span> <a 
 id="x1-340007.4"></a>Reinforcement learning –to be continued</h4>
<!--l. 1492--><p class="noindent" >Deﬁne the plasma state by the position of the magnetic axis (<span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">a</span></sub><span 
class="cmmi-10">,Z</span><sub><span 
class="cmmi-7">a</span></sub>), total plasma current <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">p</span></sub>, and the
shape of the LCFS. Discretize the LCFS in the cylindrical coordinates by <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">s</span></sub> points. Then the
plasma state can be represented by 2<span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">s</span></sub> + 3 real numbers: <span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">a</span></sub>, <span 
class="cmmi-10">Z</span><sub><span 
class="cmmi-7">a</span></sub>, <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">p</span></sub>, and (<span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">i</span></sub><span 
class="cmmi-10">,Z</span><sub><span 
class="cmmi-7">i</span></sub>) for
<span 
class="cmmi-10">i </span>= 1<span 
class="cmmi-10">,</span>2<span 
class="cmmi-10">,</span><span 
class="cmmi-10">…</span><span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">s</span></sub>.
</p><!--l. 1498--><p class="indent" >   Inputs to the policy network: the magnetic measurements at the present time step <span 
class="cmmi-10">t</span><sub><span 
class="cmmi-7">n</span></sub> (which serves
as a proxy to the actual plasma state), and target plasma states (provided by the designer) at
<span 
class="cmmi-10">t</span><sub><span 
class="cmmi-7">n</span></sub><span 
class="cmmi-10">,t</span><sub><span 
class="cmmi-7">n</span><span 
class="cmr-7">+1</span><span 
class="cmmi-7">,</span><span 
class="cmmi-7">…</span></sub><span 
class="cmmi-10">,t</span><sub><span 
class="cmmi-7">n</span><span 
class="cmr-7">+</span><span 
class="cmmi-7">k</span></sub> (where <span 
class="cmmi-10">k </span>may be a small integer, say <span 
class="cmmi-10">k </span>= 1).
</p><!--l. 1503--><p class="indent" >   Output of the policy network: voltage command to the coils imposed at <span 
class="cmmi-10">t</span><sub><span 
class="cmmi-7">n</span></sub> which can hopefully
make the plasma follow the target state in future time steps.
</p><!--l. 1507--><p class="indent" >   How to train the policy network on a plasma simulator?
</p><!--l. 1509--><p class="indent" >    
</p><!--l. 1511--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">8   </span> <a 
 id="x1-350008"></a>Coordinates based on magnetic ﬁeld structure</h3>
<!--l. 1513--><p class="noindent" >In many studies of tokamak plasmas, one need construct a curvilinear coordinate system based on a
given magnetic coﬁguration in order to make the problem amenable to analytical methods or numerical
methods. Speciﬁcally, many theories and numerical codes use the curvilinear coordinate systems that
                                                                                

                                                                                
are constructed with one coordinate surface coinciding with magnetic surfaces. In these coordinate
systems, we need to choose a poloidal coordinate <span 
class="cmmi-10">𝜃 </span>and a toroidal coordinate <span 
class="cmmi-10">ζ</span>. A particular choice for
<span 
class="cmmi-10">𝜃 </span>and <span 
class="cmmi-10">ζ </span>is one that makes the magnetic ﬁeld lines be straight lines in (<span 
class="cmmi-10">𝜃,ζ</span>) plane. These kinds of
coordinates are often called magnetic coordinates. That is, “magnetic coordinates  are deﬁned so they
conform to the shape of the magnetic surfaces and trivialize the equations for the ﬁeld
lines.”
</p><!--l. 1526--><p class="indent" >   A further tuned magnetic coordinate system is the so-called ﬁeld aligned (or ﬁled-line following)
coordinate system, in which changing one of the three coordinates with the other two ﬁxed would
correspond to following a magnetic ﬁeld line. The ﬁeld aligned coordinates are discussed in Sec.
<a 
href="#x1-9200015">15<!--tex4ht:ref: 21-10-8-1 --></a>.
</p><!--l. 1532--><p class="indent" >   Next, let us discuss some general properties about coordinates transformation[4].
</p><!--l. 1535--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.1   </span> <a 
 id="x1-360008.1"></a>Coordinates transformation</h4>
<!--l. 1537--><p class="noindent" >In the Cartesian coordinates, a point is described by its coordinates (<span 
class="cmmi-10">x,y,z</span>), which, in the vector form,
is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-36001r121"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium182x.png" alt="r = xˆx+ yˆy + zˆz,
" class="math-display"  /></center></td><td class="equation-label">(121)</td></tr></table>
<!--l. 1541--><p class="nopar" >
where <span 
class="cmbx-10">r </span>is the location vector of the point; <img 
src="tokamak_equilibrium183x.png" alt="ˆx"  class="circ"  />, <img 
src="tokamak_equilibrium184x.png" alt="ˆy"  class="circ"  />, and <img 
src="tokamak_equilibrium185x.png" alt="ˆz"  class="circ"  /> are the basis vectors of the Cartesian
coordinates, which are constant, independent of spactial location. The transformation between the
Cartesian coordinates system, (<span 
class="cmmi-10">x,y,z</span>), and a general coordinates system, (<span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">1</span></sub><span 
class="cmmi-10">,x</span><sub><span 
class="cmr-7">2</span></sub><span 
class="cmmi-10">,x</span><sub><span 
class="cmr-7">3</span></sub>), can be expressed
as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-36002r122"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium186x.png" alt="r = x(x1,x2,x3)ˆx + y(x1,x2,x3)ˆy+ z(x1,x2,x3)ˆz.
" class="math-display"  /></center></td><td class="equation-label">(122)</td></tr></table>
<!--l. 1550--><p class="nopar" >
For example, cylindrical coordinates (<span 
class="cmmi-10">R,ϕ,Z</span>) can be considered as a general coordinate systems, which
are deﬁned by  <span 
class="cmbx-10">r </span>= <span 
class="cmmi-10">R</span> cos<span 
class="cmmi-10">ϕ</span><img 
src="tokamak_equilibrium187x.png" alt="ˆx"  class="circ"  /> + <span 
class="cmmi-10">R</span> sin<span 
class="cmmi-10">ϕ</span><img 
src="tokamak_equilibrium188x.png" alt="ˆy"  class="circ"  /> + <span 
class="cmmi-10">Z</span><img 
src="tokamak_equilibrium189x.png" alt="ˆz"  class="circ"  />.
</p><!--l. 1555--><p class="indent" >   The transformation function in Eq. (<a 
href="#x1-36002r122">122<!--tex4ht:ref: 11-8-10dd --></a>) can be written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-36003r123"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium190x.png" alt="x = x(x1,x2,x3)
y = y(x1,x2,x3)
z = z(x1,x2,x3)
" class="math-display"  /></center></td><td class="equation-label">(123)</td></tr></table>
<!--l. 1562--><p class="nopar" >
</p><!--l. 1564--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.2   </span> <a 
 id="x1-370008.2"></a>Jacobian</h4>
<!--l. 1566--><p class="noindent" >A useful quality characterizing coordinate transformation is the Jacobian determinant (or simply called
Jacobian), which, for the transformation in Eq. (<a 
href="#x1-36003r123">123<!--tex4ht:ref: 11-8-10 --></a>), is deﬁned by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-37001r124"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium191x.png" alt="    |           |
    || ∂x-∂x- ∂x-||
𝒥 = || ∂x∂1y-∂∂xy2 ∂x∂3y-||,
    || ∂x∂1z-∂∂xz2 ∂x∂3z-||
      ∂x1 ∂x2 ∂x3
" class="math-display"  /></center></td><td class="equation-label">(124)</td></tr></table>
<!--l. 1578--><p class="nopar" >
which can also be written as
                                                                                

                                                                                
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-37002r125"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium192x.png" alt="     ∂r-- -∂r- -∂r-
𝒥 =  ∂x1 × ∂x2 ⋅∂x3 .
" class="math-display"  /></center></td><td class="equation-label">(125)</td></tr></table>
<!--l. 1584--><p class="nopar" >
It is easy to prove that the Jacobian <span 
class="cmsy-10">𝒥 </span>in Eq. (<a 
href="#x1-37002r125">125<!--tex4ht:ref: 10-21-p3 --></a>) can also be written (the derivation is given in my
notes on Jacobian)
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-37003r126"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium193x.png" alt="                    −1
𝒥  = (∇x1 × ∇x2 ⋅∇x3 ) .
" class="math-display"  /></center></td><td class="equation-label">(126)</td></tr></table>
<!--l. 1590--><p class="nopar" >
Conventionally, the Jacobian of the transformation from the Cartesian coordinates to a particular
coordinate system <span 
class="cmmi-10">σ </span>is called the Jacobian of <span 
class="cmmi-10">σ</span>, without explitly mentioning that this transformation is
with respect to the Cartesian coordinates.
</p><!--l. 1596--><p class="indent" >   Using the deﬁntion in Eq. (<a 
href="#x1-37001r124">124<!--tex4ht:ref: 21-11-29-1 --></a>), the Jacobian <span 
class="cmsy-10">𝒥 </span>of the Cartesian coordinates can be calculated,
yielding 1. Likewise, the Jacobian of the cylindrical coordinates (<span 
class="cmmi-10">R,ϕ,Z</span>) can be calculated as follows:
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium194x.png" alt="    |        |  |                    |
    ||∂∂xR-∂∂xϕ ∂∂xZ||  || ∂R∂cRosϕ-∂Rc∂oϕsϕ ∂R∂cZosϕ-||
𝒥 = ||∂∂yR-∂∂yϕ ∂∂yZ||= || ∂R∂sRinϕ-∂R∂siϕnϕ ∂R∂sZinϕ-||
    ||∂z-∂z ∂z||  ||  ∂Z-    ∂Z-   ∂Z-  ||
    |∂R ∂ϕ ∂Z     |∂R     ∂ϕ    ∂Z
    ||cosϕ − R sinϕ 0||
  = ||sinϕ  R cos ϕ 0||= R
    | 0     0    1|
" class="math-display"  /></center>
</div>If the Jacobian of a coordinate system is greater than zero, it is called a right-handed coordinate
system. Otherwise it is called a left-handed system.
<!--l. 1625--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.3   </span> <a 
 id="x1-380008.3"></a>Orthogonality relation between two sets of basis vectors</h4>
<!--l. 1627--><p class="noindent" >In a curvilinear coordinate system (<span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">1</span></sub><span 
class="cmmi-10">,x</span><sub><span 
class="cmr-7">2</span></sub><span 
class="cmmi-10">,x</span><sub><span 
class="cmr-7">3</span></sub>), there are two kinds of basis vectors: <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">x</span><sub><span 
class="cmmi-7">i</span></sub> and
<span 
class="cmmi-10">∂</span><span 
class="cmbx-10">r</span><span 
class="cmmi-10">∕∂x</span><sub><span 
class="cmmi-7">i</span></sub>, with <span 
class="cmmi-10">i </span>= 1<span 
class="cmmi-10">,</span>2<span 
class="cmmi-10">,</span>3<span 
class="cmmi-10">. </span>These two kinds of basis vectors satisfy the following orthogonality
relation:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-38001r127"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium195x.png" alt="     ∂r--
∇xi ⋅∂xj = δij,
" class="math-display"  /></center></td><td class="equation-label">(127)</td></tr></table>
<!--l. 1634--><p class="nopar" >
where <span 
class="cmmi-10">δ</span><sub><span 
class="cmmi-7">ij</span></sub> is the Kronical delta function. [Proof: Working in a Cartesian coordinate system (<span 
class="cmmi-10">x,y,z</span>) with
the corresponding basis vectors denoted by (<img 
src="tokamak_equilibrium196x.png" alt="ˆx"  class="circ"  /><span 
class="cmmi-10">,</span><img 
src="tokamak_equilibrium197x.png" alt="ˆy"  class="circ"  /><span 
class="cmmi-10">,</span><img 
src="tokamak_equilibrium198x.png" alt="ˆz"  class="circ"  />), then the left-hand side of Eq. (<a 
href="#x1-38001r127">127<!--tex4ht:ref: 4-6-e1 --></a>) can be written
as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium199x.png" alt="          [(    )    (    )    (    )  ] [                                       ]
∇x  ⋅ ∂r-=   ∂xi  ˆx+   ∂xi  ˆy+   ∂xi  ˆz ⋅ -∂x-ˆx+ x-∂ˆx-+ -∂yyˆ+ y ∂-ˆy-+ ∂z-ˆz +z ∂ˆz-
  i  ∂xj     ∂x        ∂y        ∂z       ∂xj     ∂xj   ∂xj     ∂xj   ∂xj     ∂xj
          [( ∂xi)    ( ∂xi)    ( ∂xi)  ] [ ∂x        ∂y        ∂z     ]
        =    ∂x-  ˆx+   ∂y-  ˆy+   ∂z-  ˆz ⋅ ∂xj-ˆx+ 0+  ∂xj ˆy+ 0 + ∂xjˆz+ 0
           ∂x ∂x    ∂x  ∂y   ∂x  ∂z
        =  --i----+ --i----+ --i----
           ∂x ∂xj   ∂y ∂xj   ∂z ∂xj
        =  ∂xi-                                                               (128)
           ∂xj
        = δij,
" class="math-display"  /><a 
 id="x1-38002r128"></a></center>
</div>where the second equality is due to <span 
class="cmmi-10">∂</span><img 
src="tokamak_equilibrium200x.png" alt="ˆx"  class="circ"  /><span 
class="cmmi-10">∕∂x</span><sup><span 
class="cmmi-7">j</span></sup> = 0<span 
class="cmmi-10">,∂</span><img 
src="tokamak_equilibrium201x.png" alt="ˆy"  class="circ"  /><span 
class="cmmi-10">∕∂x</span><sup><span 
class="cmmi-7">j</span></sup> = 0<span 
class="cmmi-10">,∂</span><img 
src="tokamak_equilibrium202x.png" alt="ˆz"  class="circ"  /><span 
class="cmmi-10">∕∂x</span><sup><span 
class="cmmi-7">j</span></sup> = 0 since <img 
src="tokamak_equilibrium203x.png" alt="ˆx"  class="circ"  /><span 
class="cmmi-10">,</span><img 
src="tokamak_equilibrium204x.png" alt="ˆy"  class="circ"  /><span 
class="cmmi-10">,</span><img 
src="tokamak_equilibrium205x.png" alt="ˆz"  class="circ"  /> are
constant vectors independent of spatial location; the chain rule has been used in obtaining Eq.
(<a 
href="#x1-38002r128">128<!--tex4ht:ref: 18-10-10-p1 --></a>)]
<!--l. 1667--><p class="indent" >   [The cylindrical coordinate system (<span 
class="cmmi-10">R,ϕ,Z</span>) is an example of general coordinates. As an exercise, we
can verify that the cylindrical coordinates have the property given in Eq. (<a 
href="#x1-38001r127">127<!--tex4ht:ref: 4-6-e1 --></a>). In this case,
<span 
class="cmmi-10">x </span>= <span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">1</span></sub> cos<span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">2</span></sub>, <span 
class="cmmi-10">y </span>= <span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">1</span></sub> sin<span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">2</span></sub>, <span 
class="cmmi-10">z </span>= <span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">3</span></sub>, where <span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">1</span></sub> <span 
class="cmsy-10">≡ </span><span 
class="cmmi-10">R</span>, <span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">2</span></sub> <span 
class="cmsy-10">≡ </span><span 
class="cmmi-10">ϕ</span>, <span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">3</span></sub> <span 
class="cmsy-10">≡ </span><span 
class="cmmi-10">Z</span>.]
</p><!--l. 1673--><p class="indent" >   It can be proved that <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">x</span><sup><span 
class="cmmi-7">i</span></sup> is a contravariant vector while <span 
class="cmmi-10">∂</span><span 
class="cmbx-10">r</span><span 
class="cmmi-10">∕∂x</span><sup><span 
class="cmmi-7">i</span></sup> is a covariant vector (I do not
prove this and do not bother with the meaning of these names, just using this as a naming scheme for
easy reference).
</p><!--l. 1678--><p class="indent" >   The orthogonality relation in Eq. (<a 
href="#x1-38001r127">127<!--tex4ht:ref: 4-6-e1 --></a>) is fundamental to the theory of general coordinates. The
orthogonality relation allows one to write the covariant basis vectors in terms of contravariant basis
vectors and vice versa. For example, the orthogonality relation tells that <span 
class="cmmi-10">∂</span><span 
class="cmbx-10">r</span><span 
class="cmmi-10">∕∂x</span><sub><span 
class="cmr-7">1</span></sub> is orthogonal to <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">2</span></sub>
and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">3</span></sub>, thus, <span 
class="cmmi-10">∂</span><span 
class="cmbx-10">r</span><span 
class="cmmi-10">∕∂x</span><sub><span 
class="cmr-7">1</span></sub> can be written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-38003r129"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium206x.png" alt="-∂r-
∂x1 = A∇x2 × ∇x3,
" class="math-display"  /></center></td><td class="equation-label">(129)</td></tr></table>
<!--l. 1687--><p class="nopar" >
where <span 
class="cmmi-10">A </span>is a unknown variable to be determined. To determine <span 
class="cmmi-10">A</span>, dotting Eq. (<a 
href="#x1-38003r129">129<!--tex4ht:ref: 9-7-4 --></a>) by <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">1</span></sub>, and using
the orthogonality relation again, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-38004r130"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium207x.png" alt="1 = A (∇x2 × ∇x3)⋅∇x1,
" class="math-display"  /></center></td><td class="equation-label">(130)</td></tr></table>
<!--l. 1693--><p class="nopar" >
which gives </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium208x.png" alt="A = -------1--------
    (∇x2 × ∇x3 )⋅∇x1
 = 𝒥                                         (131)
" class="math-display"  /></center>
</div>Thus <span 
class="cmmi-10">∂</span><span 
class="cmbx-10">r</span><span 
class="cmmi-10">∕∂x</span><sub><span 
class="cmr-7">1</span></sub> is written, in terms of <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">1</span></sub>, <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">2</span></sub>, and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">3</span></sub>, as
   <table 
class="equation"><tr><td><a 
 id="x1-38006r132"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium209x.png" alt=" ∂r
∂x1-= 𝒥 ∇x2 × ∇x3.
" class="math-display"  /></center></td><td class="equation-label">(132)</td></tr></table>
<!--l. 1705--><p class="nopar" >
Similarly, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-38007r133"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium210x.png" alt="-∂r-= 𝒥 ∇x  × ∇x
∂x2       3     1
" class="math-display"  /></center></td><td class="equation-label">(133)</td></tr></table>
<!--l. 1710--><p class="nopar" >
and
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-38008r134"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium211x.png" alt="-∂r-= 𝒥 ∇x1 × ∇x2.
∂x3
" class="math-display"  /></center></td><td class="equation-label">(134)</td></tr></table>
<!--l. 1715--><p class="nopar" >
Equations (<a 
href="#x1-38006r132">132<!--tex4ht:ref: 9-8-1 --></a>)-(<a 
href="#x1-38008r134">134<!--tex4ht:ref: 9-8-3 --></a>) can be generally written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-38009r135"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium212x.png" alt=" ∂r
--- = 𝒥∇xj × ∇xk,
∂xi
" class="math-display"  /></center></td><td class="equation-label">(135)</td></tr></table>
<!--l. 1720--><p class="nopar" >
where (<span 
class="cmmi-10">i,j,k</span>) represents the cyclic order in the variables (<span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">1</span></sub><span 
class="cmmi-10">,x</span><sub><span 
class="cmr-7">2</span></sub><span 
class="cmmi-10">,x</span><sub><span 
class="cmr-7">3</span></sub>). Equation (<a 
href="#x1-38009r135">135<!--tex4ht:ref: 11-18-1 --></a>) expresses the
covariant basis vectors in terms of the contravariant basis vectors. On the other hand, from Eq.
(<a 
href="#x1-38006r132">132<!--tex4ht:ref: 9-8-1 --></a>)-(<a 
href="#x1-38008r134">134<!--tex4ht:ref: 9-8-3 --></a>), we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-38010r136"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium213x.png" alt="∇x  = 𝒥− 1 ∂r-×-∂r-,
   i      ∂xj  ∂xk
" class="math-display"  /></center></td><td class="equation-label">(136)</td></tr></table>
<!--l. 1728--><p class="nopar" >
which expresses the contravariant basis vectors in terms of the covariant basis vectors.
</p><!--l. 1732--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.4   </span> <a 
 id="x1-390008.4"></a>An example: (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinates</h4>
<!--l. 1734--><p class="noindent" >Suppose (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) is an arbitrary general coordinate system. Following Einstein’s notation, contravariant
basis vectors are denoted with upper indices as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium214x.png" alt="eψ ≡ ∇ ψ; e𝜃 ≡ ∇𝜃; eζ ≡ ∇ζ.                    (137)
" class="math-display"  /></center>
</div>and the covariant basis vectors are denoted with low indices as <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium215x.png" alt="     ∂r              ∂r
eψ ≡ --; e𝜃 ≡ ∂∂r𝜃; eζ ≡-.                       (138)
     ∂ψ              ∂ζ
" class="math-display"  /></center>
</div>Then the orthogonality relation, Eq. (<a 
href="#x1-38001r127">127<!--tex4ht:ref: 4-6-e1 --></a>), is written as
   <table 
class="equation"><tr><td><a 
 id="x1-39003r139"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium216x.png" alt="eα ⋅eβ = δαβ.
" class="math-display"  /></center></td><td class="equation-label">(139)</td></tr></table>
<!--l. 1750--><p class="nopar" >
In term of the contravairant basis vectors, <span 
class="cmbx-10">A </span>is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-39004r140"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium217x.png" alt="        ψ      𝜃     ζ
A  = Aψe  + A𝜃e + A ζe ,
" class="math-display"  /></center></td><td class="equation-label">(140)</td></tr></table>
<!--l. 1755--><p class="nopar" >
where the components are easily obtained by taking scalar product with <span 
class="cmbx-10">e</span><sub><span 
class="cmmi-7">ψ</span></sub><span 
class="cmmi-10">,</span><span 
class="cmbx-10">e</span><sub><span 
class="cmmi-7">𝜃</span></sub><span 
class="cmmi-10">,</span>and<span 
class="cmbx-10">e</span><sub><span 
class="cmmi-7">ζ</span></sub>, yielding
<span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">ψ</span></sub> = <span 
class="cmbx-10">A </span><span 
class="cmsy-10">⋅ </span><span 
class="cmbx-10">e</span><sub><span 
class="cmmi-7">ψ</span></sub>, <span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">𝜃</span></sub> = <span 
class="cmbx-10">A </span><span 
class="cmsy-10">⋅ </span><span 
class="cmbx-10">e</span><sub><span 
class="cmmi-7">𝜃</span></sub>, and <span 
class="cmmi-10">A</span><sub><span 
class="cmmi-7">ζ</span></sub> = <span 
class="cmbx-10">A </span><span 
class="cmsy-10">⋅ </span><span 
class="cmbx-10">e</span><sub><span 
class="cmmi-7">ζ</span></sub>. Similarly, in term of the covariant basis vectors, <span 
class="cmbx-10">A </span>is
written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-39005r141"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium218x.png" alt="A  = Aψeψ + A𝜃e𝜃 + A ζeζ,
" class="math-display"  /></center></td><td class="equation-label">(141)</td></tr></table>
<!--l. 1765--><p class="nopar" >
where <span 
class="cmmi-10">A</span><sup><span 
class="cmmi-7">ψ</span></sup> = <span 
class="cmbx-10">A </span><span 
class="cmsy-10">⋅ </span><span 
class="cmbx-10">e</span><sup><span 
class="cmmi-7">ψ</span></sup>, <span 
class="cmmi-10">A</span><sup><span 
class="cmmi-7">𝜃</span></sup> = <span 
class="cmbx-10">A </span><span 
class="cmsy-10">⋅ </span><span 
class="cmbx-10">e</span><sup><span 
class="cmmi-7">𝜃</span></sup>, and <span 
class="cmmi-10">A</span><sup><span 
class="cmmi-7">ζ</span></sup> = <span 
class="cmbx-10">A </span><span 
class="cmsy-10">⋅ </span><span 
class="cmbx-10">e</span><sup><span 
class="cmmi-7">ζ</span></sup>.
</p><!--l. 1770--><p class="indent" >   Using the above notation, the relation in Eq. (<a 
href="#x1-38009r135">135<!--tex4ht:ref: 11-18-1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-39006r142"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium219x.png" alt="        𝜃   ζ
eψ = 𝒥 e × e
" class="math-display"  /></center></td><td class="equation-label">(142)</td></tr></table>
<!--l. 1774--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-39007r143"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium220x.png" alt="e𝜃 = 𝒥eζ × eψ
" class="math-display"  /></center></td><td class="equation-label">(143)</td></tr></table>
<!--l. 1778--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-39008r144"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium221x.png" alt="eζ = 𝒥eψ × e𝜃
" class="math-display"  /></center></td><td class="equation-label">(144)</td></tr></table>
<!--l. 1782--><p class="nopar" >
where  <span 
class="cmsy-10">𝒥 </span>= [(<span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">𝜃</span>) <span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ζ</span>]<sup><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span></sup>. Similarly, the relation in Eq. (<a 
href="#x1-38010r136">136<!--tex4ht:ref: 20-10-15-a1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-39009r145"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium222x.png" alt="eψ = 𝒥 −1e𝜃 × eζ
" class="math-display"  /></center></td><td class="equation-label">(145)</td></tr></table>
<!--l. 1789--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-39010r146"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium223x.png" alt=" 𝜃    − 1
e  = 𝒥  eζ × eψ
" class="math-display"  /></center></td><td class="equation-label">(146)</td></tr></table>
<!--l. 1793--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-39011r147"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium224x.png" alt=" ζ    − 1
e  = 𝒥  eψ × e𝜃
" class="math-display"  /></center></td><td class="equation-label">(147)</td></tr></table>
<!--l. 1797--><p class="nopar" >
                                                                                

                                                                                
</p><!--l. 1800--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.5   </span> <a 
 id="x1-400008.5"></a>Gradient and directional derivative in general coordinates (<span 
class="cmmi-10">ψ,𝜃,ζ</span>)</h4>
<!--l. 1802--><p class="noindent" >The gradient of a scalar function <span 
class="cmmi-10">f</span>(<span 
class="cmmi-10">ψ,𝜃,ζ</span>) is readily calculated from the chain rule,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-40001r148"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium225x.png" alt="      ∂f      ∂f     ∂f
∇f =  --∇ ψ + --∇ 𝜃+ ---∇ζ.
      ∂ψ      ∂𝜃     ∂ ζ
" class="math-display"  /></center></td><td class="equation-label">(148)</td></tr></table>
<!--l. 1808--><p class="nopar" >
Note that the gradient of a scalar function is in the covariant representation. The inverse form of this
expression is obtained by dotting the above equation respectively by the three contravariant basis
vectors, yielding
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-40002r149"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium226x.png" alt="∂f-= (𝒥 ∇𝜃 ×∇ ζ)⋅∇f =  ∂r-⋅∇f
∂ψ                     ∂ψ
" class="math-display"  /></center></td><td class="equation-label">(149)</td></tr></table>
<!--l. 1816--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-40003r150"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium227x.png" alt="∂f-= (𝒥 ∇ζ ×∇ ψ)⋅∇f  = ∂r-⋅∇f
∂𝜃                     ∂𝜃
" class="math-display"  /></center></td><td class="equation-label">(150)</td></tr></table>
<!--l. 1821--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-40004r151"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium228x.png" alt="∂f-= (𝒥 ∇ψ × ∇𝜃)⋅∇f  = ∂r-⋅∇f
∂ζ                     ∂ζ
" class="math-display"  /></center></td><td class="equation-label">(151)</td></tr></table>
<!--l. 1826--><p class="nopar" >
Using Eq. (<a 
href="#x1-40001r148">148<!--tex4ht:ref: 5-6-5 --></a>), the directional derivative in the direction of <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span>is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-40005r152"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium229x.png" alt="∇ ψ ⋅∇f = |∇ ψ|2∂f-+ (∇𝜃 ⋅∇ψ)∂f-+ (∇ ζ ⋅∇ ψ)∂f.
               ∂ψ            ∂𝜃           ∂ζ
" class="math-display"  /></center></td><td class="equation-label">(152)</td></tr></table>
<!--l. 1833--><p class="nopar" >
</p><!--l. 1836--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.6   </span> <a 
 id="x1-410008.6"></a>Divergence operator in general coordinates (<span 
class="cmmi-10">ψ,𝜃,ζ</span>)</h4>
<!--l. 1838--><p class="noindent" >To calculate the divergence of a vector, it is desired that the vector should be in the contravariant form
because we can make use of the fact:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-41001r153"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium230x.png" alt="∇ ⋅(∇ α× ∇ β) = 0,
" class="math-display"  /></center></td><td class="equation-label">(153)</td></tr></table>
<!--l. 1842--><p class="nopar" >
for any scalar quantities <span 
class="cmmi-10">α </span>and <span 
class="cmmi-10">β</span>. Therefore we write vector <span 
class="cmbx-10">A </span>as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-41002r154"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium231x.png" alt="     (ψ)            (𝜃)             (ζ)
A = A   𝒥∇ 𝜃× ∇ ζ + A 𝒥 ∇ ζ × ∇ ψ+ A  𝒥∇ ψ × ∇𝜃,
" class="math-display"  /></center></td><td class="equation-label">(154)</td></tr></table>
<!--l. 1849--><p class="nopar" >
where <span 
class="cmmi-10">A</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">ψ</span><span 
class="cmr-7">)</span></sup> = <span 
class="cmbx-10">A </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ψ</span>, <span 
class="cmmi-10">A</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">𝜃</span><span 
class="cmr-7">)</span></sup> = <span 
class="cmbx-10">A </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">𝜃</span>, <span 
class="cmmi-10">A</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">ζ</span><span 
class="cmr-7">)</span></sup> = <span 
class="cmbx-10">A </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ζ</span>.   Then the divergence of <span 
class="cmbx-10">A </span>is readily calculated
as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium232x.png" alt="∇  ⋅A  = (∇ 𝜃× ∇ ζ)⋅∇ (A (ψ)𝒥 )+ (∇ ζ × ∇ ψ)⋅∇ (A(𝜃)𝒥 )+ (∇ψ × ∇𝜃) ⋅∇(A(ζ)𝒥 ) (155)
        1 ( ∂A(ψ)𝒥   ∂A (𝜃)𝒥   ∂A (ζ)𝒥 )
      = 𝒥-  --∂ψ---+ --∂𝜃---+ --∂ζ--- ,                               (156)
" class="math-display"  /><a 
 id="x1-41003r156"></a></center>
</div>where the second equality is obtained by using Eqs. (<a 
href="#x1-40002r149">149<!--tex4ht:ref: 4-6-1 --></a>), (<a 
href="#x1-40003r150">150<!--tex4ht:ref: 4-6-2 --></a>), and (<a 
href="#x1-40004r151">151<!--tex4ht:ref: 4-6-3 --></a>).
                                                                                

                                                                                
<!--l. 1866--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.7   </span> <a 
 id="x1-420008.7"></a>Laplacian operator in general coordinates (<span 
class="cmmi-10">ψ,𝜃,ζ</span>)</h4>
<!--l. 1868--><p class="noindent" >The Laplacian operator is deﬁned by <span 
class="cmsy-10">∇</span><sup><span 
class="cmr-7">2</span></sup> <span 
class="cmsy-10">≡∇⋅∇</span>. Then <span 
class="cmsy-10">∇</span><sup><span 
class="cmr-7">2</span></sup><span 
class="cmmi-10">f </span>is written as (<span 
class="cmmi-10">f </span>is an arbitrary function)
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium233x.png" alt="∇2f = ∇ ⋅∇f
         ( ∂f      ∂f     ∂f   )
    = ∇ ⋅ ∂-ψ∇ ψ+  ∂𝜃∇ 𝜃+ ∂ζ-∇ζ  .                  (157)
" class="math-display"  /><a 
 id="x1-42001r157"></a></center>
</div>To proceed, we can use the divergence formula (<a 
href="#x1-41003r156">156<!--tex4ht:ref: 6-8-e5 --></a>) to express the divergence in the above expression.
However, the vector in the above (blue term) is not in the covariant form desired by the divergence
formula (<a 
href="#x1-41003r156">156<!--tex4ht:ref: 6-8-e5 --></a>). If we want to directly use the formula (<a 
href="#x1-41003r156">156<!--tex4ht:ref: 6-8-e5 --></a>), we need to transform the vector (blue term
in expression (<a 
href="#x1-42001r157">157<!--tex4ht:ref: 19-1-15-1 --></a>)) to the covariant form. This process seems to be a little complicated. Therefore, I
choose not to use this method. Instead, I try to simplify expression (<a 
href="#x1-42001r157">157<!--tex4ht:ref: 19-1-15-1 --></a>) by using basic vector
identities: <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium234x.png" alt="  2     ( ∂f)         ( ∂f)         (∂f )
∇ f = ∇   ∂ψ- ⋅∇ ψ+ ∇   ∂𝜃- ⋅∇ 𝜃+ ∇  -∂ζ  ⋅∇ζ
        ∂f       ∂f      ∂f
      + --∇2 ψ + --∇2 𝜃+ ---∇2ζ.                          (158)
        ∂ψ       ∂𝜃      ∂ζ
" class="math-display"  /></center>
</div>Using the gradient formula, the above expression is further written as <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium235x.png" alt="∇2f = ∂2f-|∇ ψ|2 +-∂2f-∇ ψ⋅∇ 𝜃+ -∂2f-∇ ψ⋅∇ ζ
      ∂ψ2        ∂ψ ∂𝜃         ∂ψ ∂ζ
         ∂2f          ∂2f    2   ∂2f
      + ∂𝜃∂ψ-∇𝜃 ⋅∇ ψ + ∂𝜃2|∇𝜃| + ∂𝜃∂ζ-∇𝜃 ⋅∇ζ
         ∂2f           ∂2f          ∂2f
      + -----∇ζ ⋅∇ψ + ----∇ ζ ⋅∇ 𝜃+---2|∇ ζ|2
        ∂ζ∂ψ          ∂ζ∂𝜃         ∂ ζ
      + ∂f-∇2ψ + ∂f∇2 𝜃+ ∂f-∇2ζ,                         (159)
        ∂ψ       ∂𝜃      ∂ζ
" class="math-display"  /></center>
</div>and can be simpliﬁed as <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium236x.png" alt="        2           2              2
∇2f =  ∂-f2|∇ψ |2 + 2-∂-f-∇ ψ⋅∇ 𝜃+ 2-∂-f-∇ ψ⋅∇ ζ
       ∂ψ         ∂ ψ∂𝜃          ∂ ψ∂ζ
      + ∂2f|∇ 𝜃|2 + 2-∂2f-∇𝜃 ⋅∇ζ
        ∂𝜃2        ∂𝜃∂ ζ
        ∂2f    2
      + ∂ζ2|∇ ζ|
        ∂f       ∂f      ∂f
      + ---∇2ψ + --∇2 𝜃+ ---∇2ζ.                          (160)
        ∂ψ       ∂𝜃       ∂ζ
" class="math-display"  /></center>
</div>Assume (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) are ﬁeld-line following coordinates with <span 
class="cmmi-10">∂</span><span 
class="cmbx-10">r</span><span 
class="cmmi-10">∕∂𝜃 </span>along the ﬁeld line direction, then
neglect all the parallel derivatives, i.e., derivative over <span 
class="cmmi-10">𝜃</span>, then the above expression is reduced to
<div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium237x.png" alt="∇2f = ∂2f|∇ ψ|2 + 2 ∂2f-∇ ψ ⋅∇ζ + ∂2f|∇ζ|2
      ∂ψ2         ∂ψ∂ζ          ∂ζ2
      ∂f- 2    ∂f- 2
    + ∂ψ ∇ ψ + ∂ζ∇  ζ.                                 (161)
" class="math-display"  /></center>
</div>This approximation reduces the Laplacian operator from being three-dimensional to being
two-dimensional. This approximation is often called the high-<span 
class="cmmi-10">n </span>approximation, where <span 
class="cmmi-10">n </span>is the toroidal
mode number (mode number along <span 
class="cmmi-10">ζ </span>direction).
<!--l. 1941--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.8   </span> <a 
 id="x1-430008.8"></a>Curl operator in general coordinates (<span 
class="cmmi-10">ψ,𝜃,ζ</span>)</h4>
<!--l. 1943--><p class="noindent" >To take the curl of a vector, it should be in the covariant representation since we can make use of the
fact that <span 
class="cmsy-10">∇×∇</span><span 
class="cmmi-10">α </span>= 0. Thus the curl of <span 
class="cmbx-10">A </span>is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium238x.png" alt="∇ × A = ∇ × (A1∇ψ + A2∇ 𝜃+ A3∇ ζ)
      = ∇A1 × ∇ ψ+ ∇A2  × ∇𝜃+ ∇A3  × ∇ζ
        ( ∂A      ∂A    )        ( ∂A       ∂A    )        ( ∂A       ∂A    )
      =   --1∇ 𝜃+ ---1∇ζ  × ∇ ψ+   ---2∇ψ + ---2∇ζ  × ∇ 𝜃+   --3∇ ψ+  --3∇ 𝜃  ×∇ ζ
          ∂(𝜃       ∂ζ )             ∂ψ(      ∂ζ  )           ∂ψ  (    ∂𝜃    )
      = 1-  ∂A2-− ∂A1- 𝒥 ∇ ψ× ∇ 𝜃+ -1  ∂A1-− ∂A3-  𝒥∇ ζ × ∇ ψ + 1  ∂A3-− ∂A2- 𝒥 ∇𝜃 ×(1∇6ζ2.)
        𝒥   ∂ ψ    ∂𝜃              𝒥    ∂ζ    ∂ψ               𝒥   ∂𝜃    ∂ ζ
" class="math-display"  /><a 
 id="x1-43001r162"></a></center>
</div>Note that taking the curl of a vector in the covariant form leaves the vector in the contravariant
form.
<!--l. 1968--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.9   </span> <a 
 id="x1-440008.9"></a>Metric tensor for general coordinate system</h4>
<!--l. 1970--><p class="noindent" >Consider a general coordinate system (<span 
class="cmmi-10">ψ,𝜃,ζ</span>). I deﬁne the metric tensor as the transformation matrix
between the covariant basis vectors and the contravariant ones. Equations (<a 
href="#x1-38009r135">135<!--tex4ht:ref: 11-18-1 --></a>) and (<a 
href="#x1-38010r136">136<!--tex4ht:ref: 20-10-15-a1 --></a>) express the
relation between the two sets of basis vectors using cross product. Next, let us express the relation in
matrix from. To obtain the metric matrix, we write the contrariant basis vectors in terms of the
covariant ones, such as
</p>
                                                                                

                                                                                
   <table 
class="equation"><tr><td><a 
 id="x1-44001r163"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium239x.png" alt="      1            2             3
∇ψ = a 𝒥 ∇𝜃× ∇ ζ + a 𝒥 ∇ζ × ∇ψ + a 𝒥∇ ψ × ∇𝜃.
" class="math-display"  /></center></td><td class="equation-label">(163)</td></tr></table>
<!--l. 1981--><p class="nopar" >
Taking the scalar product respectively with <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ</span>, <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">𝜃</span>, and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ζ</span>, Eq. (<a 
href="#x1-44001r163">163<!--tex4ht:ref: 3-18-a1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44002r164"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium240x.png" alt=" 1      2
a = |∇ψ |,
" class="math-display"  /></center></td><td class="equation-label">(164)</td></tr></table>
<!--l. 1986--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44003r165"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium241x.png" alt="a2 = ∇ ψ⋅∇ 𝜃,
" class="math-display"  /></center></td><td class="equation-label">(165)</td></tr></table>
<!--l. 1989--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44004r166"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium242x.png" alt=" 3
a = ∇ ψ⋅∇ ζ.
" class="math-display"  /></center></td><td class="equation-label">(166)</td></tr></table>
<!--l. 1992--><p class="nopar" >
Similarly, we write
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44005r167"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium243x.png" alt="∇ 𝜃 = b1𝒥∇ 𝜃× ∇ ζ + b2𝒥∇ ζ × ∇ ψ + b3𝒥 ∇ψ × ∇ 𝜃,
" class="math-display"  /></center></td><td class="equation-label">(167)</td></tr></table>
<!--l. 1998--><p class="nopar" >
Taking the scalar product with <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ</span>, <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">𝜃</span>, and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ζ</span>, respectively, the above becomes
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44006r168"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium244x.png" alt="b1 = ∇ 𝜃⋅∇ ψ
" class="math-display"  /></center></td><td class="equation-label">(168)</td></tr></table>
<!--l. 2003--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44007r169"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium245x.png" alt=" 2      2
b = |∇𝜃| ,
" class="math-display"  /></center></td><td class="equation-label">(169)</td></tr></table>
<!--l. 2006--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44008r170"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium246x.png" alt="b3 = ∇ 𝜃⋅∇ ζ.
" class="math-display"  /></center></td><td class="equation-label">(170)</td></tr></table>
<!--l. 2009--><p class="nopar" >
The same situation applies for the <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ζ </span>basis vector,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44009r171"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium247x.png" alt="∇ ζ = c1∇𝜃 × ∇ζ𝒥 + c2∇ζ × ∇ψ 𝒥 + c3∇ ψ × ∇𝜃𝒥 ,
" class="math-display"  /></center></td><td class="equation-label">(171)</td></tr></table>
<!--l. 2015--><p class="nopar" >
Taking the scalar product with <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ</span>, <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">𝜃</span>, and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ζ</span>, respectively, the above equation becomes
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44010r172"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium248x.png" alt=" 1
c = ∇ ζ ⋅∇ ψ
" class="math-display"  /></center></td><td class="equation-label">(172)</td></tr></table>
<!--l. 2020--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44011r173"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium249x.png" alt="c2 = ∇ ζ ⋅∇ 𝜃
" class="math-display"  /></center></td><td class="equation-label">(173)</td></tr></table>
<!--l. 2023--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44012r174"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium250x.png" alt="c3 = |∇ ζ|2
" class="math-display"  /></center></td><td class="equation-label">(174)</td></tr></table>
<!--l. 2026--><p class="nopar" >
Summarizing the above results in matrix form, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44013r175"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium251x.png" alt="(     )   (                      ) (           )
  ∇ ψ        |∇ ψ|2 ∇ ψ⋅∇ 𝜃 ∇ ψ ⋅∇ζ    ∇𝜃 ×∇ ζ𝒥
(  ∇𝜃 ) = ( ∇𝜃 ⋅∇ψ  |∇𝜃|2  ∇𝜃 ⋅∇ ζ) ( ∇ ζ × ∇ ψ𝒥 )
   ∇ζ       ∇ζ ⋅∇ψ ∇ ζ ⋅∇ 𝜃 |∇ ζ|2     ∇ ψ × ∇𝜃𝒥
" class="math-display"  /></center></td><td class="equation-label">(175)</td></tr></table>
<!--l. 2045--><p class="nopar" >
Similarly, to convert contravariant basis vector to covariant one, we write
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44014r176"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium252x.png" alt="∇𝜃 × ∇ζ𝒥 = d1∇ ψ+ d2∇ 𝜃+ d3∇ ζ
" class="math-display"  /></center></td><td class="equation-label">(176)</td></tr></table>
<!--l. 2050--><p class="nopar" >
Taking the scalar product respectively with <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">𝜃 </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">ζ</span><span 
class="cmsy-10">𝒥 </span>, <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ζ </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">ψ</span><span 
class="cmsy-10">𝒥 </span>, and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">𝜃</span><span 
class="cmsy-10">𝒥 </span>, the above
equation becomes
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44015r177"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium253x.png" alt="d1 = |∇ 𝜃× ∇ ζ|2𝒥 2
" class="math-display"  /></center></td><td class="equation-label">(177)</td></tr></table>
<!--l. 2056--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44016r178"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium254x.png" alt="d2 = (∇ 𝜃× ∇ ζ𝒥)⋅(∇ ζ × ∇ ψ𝒥)
" class="math-display"  /></center></td><td class="equation-label">(178)</td></tr></table>
<!--l. 2060--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44017r179"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium255x.png" alt="d3 = (∇ 𝜃× ∇ ζ𝒥)⋅(∇ ψ× ∇ 𝜃𝒥)
" class="math-display"  /></center></td><td class="equation-label">(179)</td></tr></table>
<!--l. 2064--><p class="nopar" >
For the second contravariant basis vector
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44018r180"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium256x.png" alt="∇ϕ × ∇ψ 𝒥 = e1∇ ψ + e2∇ 𝜃+ e3∇ ζ
" class="math-display"  /></center></td><td class="equation-label">(180)</td></tr></table>
<!--l. 2069--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44019r181"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium257x.png" alt="                          2
e1 = (∇ ζ × ∇ ψ)⋅(∇ 𝜃× ∇ ζ)𝒥
" class="math-display"  /></center></td><td class="equation-label">(181)</td></tr></table>
<!--l. 2073--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44020r182"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium258x.png" alt="e2 = (∇ ζ × ∇ ψ)⋅(∇ ζ × ∇ψ )𝒥 2
" class="math-display"  /></center></td><td class="equation-label">(182)</td></tr></table>
<!--l. 2077--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44021r183"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium259x.png" alt="e3 = (∇ ζ × ∇ ψ)⋅(∇ ψ× ∇ 𝜃)𝒥 2
" class="math-display"  /></center></td><td class="equation-label">(183)</td></tr></table>
<!--l. 2081--><p class="nopar" >
For the third contravariant basis vector
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44022r184"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium260x.png" alt="∇ψ × ∇𝜃𝒥  = f1∇ ψ + f2∇ 𝜃+ f3∇ ζ
" class="math-display"  /></center></td><td class="equation-label">(184)</td></tr></table>
<!--l. 2086--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44023r185"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium261x.png" alt="f1 = (∇ψ × ∇𝜃)⋅(∇ 𝜃× ∇ ζ)𝒥 2
" class="math-display"  /></center></td><td class="equation-label">(185)</td></tr></table>
<!--l. 2090--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44024r186"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium262x.png" alt="f2 = (∇ ψ × ∇𝜃)⋅(∇ ζ × ∇ψ )𝒥 2
" class="math-display"  /></center></td><td class="equation-label">(186)</td></tr></table>
<!--l. 2094--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44025r187"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium263x.png" alt="f3 = (∇ ψ × ∇𝜃)⋅(∇ ψ× ∇ 𝜃)𝒥 2
" class="math-display"  /></center></td><td class="equation-label">(187)</td></tr></table>
<!--l. 2098--><p class="nopar" >
Summarizing these results, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-44026r188"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium264x.png" alt="(          )      (    )
  ∇𝜃 × ∇ζ𝒥          ∇ψ
( ∇ζ × ∇ψ𝒥 )  = M ( ∇ 𝜃) ,
  ∇ψ × ∇𝜃𝒥          ∇ ζ
" class="math-display"  /></center></td><td class="equation-label">(188)</td></tr></table>
<!--l. 2110--><p class="nopar" >
where
</p>
   <table 
class="equation-star"><tr><td>
 <span 
class="cmmi-10">M </span>= <img 
src="tokamak_equilibrium265x.png" alt="(               2 2                           2                      2)
(      |∇𝜃 × ∇ζ| 𝒥     2 (∇𝜃 × ∇ζ)⋅(∇ ζ × ∇ψ )𝒥 2 (∇𝜃 ×∇ ζ)⋅(∇ψ × ∇ 𝜃)𝒥 2)
  (∇ζ × ∇ψ )⋅(∇𝜃 ×∇ ζ)𝒥2 (∇ ζ × ∇ ψ)⋅(∇ ζ × ∇ ψ)𝒥2 (∇ ζ × ∇ ψ)⋅(∇ ψ× ∇ 𝜃)𝒥2
  (∇ ψ× ∇ 𝜃)⋅(∇𝜃× ∇ ζ)𝒥  (∇ ψ × ∇𝜃)⋅(∇ ζ × ∇ ψ)𝒥 (∇ ψ × ∇𝜃)⋅(∇ ψ× ∇ 𝜃)𝒥"  class="left" align="middle" /><span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 2125--><p class="nopar" >
This matrix and the matrix in Eqs. (<a 
href="#x1-44013r175">175<!--tex4ht:ref: 7-10-1 --></a>) should be the inverse of each other. It is ready to prove this
by directly calculating the product of the two matrix.
                                                                                

                                                                                
</p>
   <h5 class="subsubsectionHead"><a 
 id="x1-450008.9"></a>Special case: metric tensor for (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinate system</h5>
<!--l. 2133--><p class="noindent" >Suppose that (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) are arbitrary general coordinates except that <span 
class="cmmi-10">ϕ </span>is the usual toroidal angle in
cylindrical coordinates. Then <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ϕ </span>= 1<span 
class="cmmi-10">∕R</span><img 
src="tokamak_equilibrium266x.png" alt="ˆϕ"  class="circ"  /> is perpendicular to both <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span>and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">𝜃</span>. Using this, Eq. (<a 
href="#x1-44013r175">175<!--tex4ht:ref: 7-10-1 --></a>) is
simpliﬁed to
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-45001r189"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium267x.png" alt="( ∇ψ )   (  |∇ ψ|2 ∇ ψ ⋅∇𝜃  0  ) ( ∇ 𝜃× ∇ ϕ𝒥 )
( ∇𝜃 ) = ( ∇ ψ⋅∇ 𝜃 |∇ 𝜃|2   0  ) ( ∇ ϕ× ∇ ψ𝒥 )
  ∇ϕ          0      0    1∕R2    ∇ ψ× ∇ 𝜃𝒥
" class="math-display"  /></center></td><td class="equation-label">(189)</td></tr></table>
<!--l. 2151--><p class="nopar" >
Similarly, Eq. (<a 
href="#x1-44026r188">188<!--tex4ht:ref: 9-5-e1m --></a>) is simpliﬁed to
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-45002r190"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium268x.png" alt="(  ∇𝜃× ∇ ϕ𝒥 )   (   |∇𝜃|2𝒥2∕R2   − ∇ 𝜃⋅∇ ψ𝒥 2∕R2 0 ) ( ∇ ψ)
( ∇ ϕ× ∇ ψ𝒥 ) = ( − ∇ψ ⋅∇ 𝜃𝒥2∕R2   |∇ ψ|2𝒥 2∕R2   0 ) ( ∇ 𝜃)
  ∇ ψ × ∇𝜃𝒥              0             0       R2     ∇ ϕ
" class="math-display"  /></center></td><td class="equation-label">(190)</td></tr></table>
<!--l. 2169--><p class="nopar" >
[Note that the matrix in Eqs. (<a 
href="#x1-45001r189">189<!--tex4ht:ref: 4-13-p3 --></a>) and (<a 
href="#x1-45002r190">190<!--tex4ht:ref: 4-13-p4 --></a>) should be the inverse of each other. The product of the
two matrix,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-45003r191"></a>
   <center class="math-display" >
                                                                                

                                                                                
<img 
src="tokamak_equilibrium269x.png" alt="(                                 ) (                    )
    |∇ 𝜃|2𝒥 2∕R2  − ∇ 𝜃⋅∇ψ 𝒥2∕R2  0      |∇ ψ|2 ∇ ψ⋅∇ 𝜃  0
( − ∇ ψ ⋅∇𝜃𝒥 2∕R2   𝒥R22|∇ψ |2     0 ) ( ∇ψ ⋅∇𝜃  |∇𝜃|2   0  ) ,
        0              0       R2        0      0   1∕R2
" class="math-display"  /></center></td><td class="equation-label">(191)</td></tr></table>
<!--l. 2184--><p class="nopar" >
can be calculated to give
</p>
   <table 
class="equation-star"><tr><td>
                                   <img 
src="tokamak_equilibrium270x.png" alt="(       )
  A  0 0
(  0 A 0 )
   0 0 1"  class="left" align="middle" /><span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 2190--><p class="nopar" >
where
</p>
   <table 
class="equation-star"><tr><td>
                       <span 
class="cmmi-10">A </span>= <span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">𝜃</span><span 
class="cmsy-10">|</span><sup><span 
class="cmr-7">2</span></sup><span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">ψ</span><span 
class="cmsy-10">|</span><sup><span 
class="cmr-7">2</span></sup><span 
class="cmsy-10">𝒥</span><sup><span 
class="cmr-7">2</span></sup><span 
class="cmmi-10">∕R</span><sup><span 
class="cmr-7">2</span></sup> <span 
class="cmsy-10">− </span>(<span 
class="cmsy-10">∇</span><span 
class="cmmi-10">𝜃 </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ψ</span>)<sup><span 
class="cmr-7">2</span></sup><span 
class="cmsy-10">𝒥</span><sup><span 
class="cmr-7">2</span></sup><span 
class="cmmi-10">.</span>
</td></tr></table>
<!--l. 2193--><p class="nopar" >
By using the deﬁnition of the Jacobian in Eq. (<a 
href="#x1-37003r126">126<!--tex4ht:ref: 10-21-p4 --></a>), it is easy to verify that <span 
class="cmmi-10">A </span>= 1, i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-45004r192"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium271x.png" alt="                         2
|∇𝜃|2|∇ ψ|2 − (∇𝜃 ⋅∇ ψ)2 = R-,
                        𝒥2
" class="math-display"  /></center></td><td class="equation-label">(192)</td></tr></table>
<!--l. 2199--><p class="nopar" >
]
</p><!--l. 2203--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.10   </span> <a 
 id="x1-460008.10"></a>Covariant/contravariant representation of equilibrium magnetic ﬁeld</h4>
<!--l. 2205--><p class="noindent" >The axisymmetric equilibrium magnetic ﬁeld is given by Eq. (<a 
href="#x1-22001r66">66<!--tex4ht:ref: 4-15-p3 --></a>), i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-46001r193"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium272x.png" alt="B = ∇ Ψ × ∇ϕ + g∇ϕ.
" class="math-display"  /></center></td><td class="equation-label">(193)</td></tr></table>
<!--l. 2209--><p class="nopar" >
In a general coordinate system (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) (not necessarily ﬂux coordinates), the above expression can be
written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-46002r194"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium273x.png" alt="B  = − Ψψ∇ ϕ× ∇ ψ − Ψ𝜃∇ϕ × ∇𝜃 + g∇ϕ,
" class="math-display"  /></center></td><td class="equation-label">(194)</td></tr></table>
                                                                                

                                                                                
<!--l. 2215--><p class="nopar" >
where the subscripts denote the partial derivatives with the corresponding subscripts. Note that Eq.
(<a 
href="#x1-46002r194">194<!--tex4ht:ref: 4-25-2 --></a>) is a mixed representation, which involves both covariant and contravariant basis vectors.
Equation (<a 
href="#x1-46002r194">194<!--tex4ht:ref: 4-25-2 --></a>) can be converted to the contravariant form by using the metric tensor,
giving
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-46003r195"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium274x.png" alt="                               𝒥
B = − Ψψ∇ ϕ ×∇ ψ − Ψ𝜃∇ϕ × ∇𝜃 + g-2∇ ψ × ∇𝜃.
                               R
" class="math-display"  /></center></td><td class="equation-label">(195)</td></tr></table>
<!--l. 2225--><p class="nopar" >
Similarly, Eq. (<a 
href="#x1-46002r194">194<!--tex4ht:ref: 4-25-2 --></a>) can also be transformed to the covariant form, giving
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-46004r196"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium275x.png" alt="    (                        )      (                          )
B =  Ψ  𝒥-∇ ψ ⋅∇𝜃 + Ψ 𝒥-|∇ 𝜃|2  ∇ψ +  − Ψ -𝒥-|∇ ψ|2 − Ψ-𝒥-∇𝜃 ⋅∇ψ  ∇ 𝜃+ g∇ ϕ.
       ψR2           𝜃R2                ψR2         𝜃R2
" class="math-display"  /></center></td><td class="equation-label">(196)</td></tr></table>
<!--l. 2235--><p class="nopar" >
For the convenience of notation, deﬁne
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-46005r197"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium276x.png" alt="hαβ = 𝒥-∇ α⋅∇ β,
      R2
" class="math-display"  /></center></td><td class="equation-label">(197)</td></tr></table>
<!--l. 2240--><p class="nopar" >
then Eq. (<a 
href="#x1-46004r196">196<!--tex4ht:ref: 7-26-1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-46006r198"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium277x.png" alt="B  = (Ψψh ψ𝜃 + Ψ𝜃h𝜃𝜃)∇ ψ + (− Ψψhψψ − Ψ𝜃hψ𝜃)∇𝜃 + g∇ ϕ.
" class="math-display"  /></center></td><td class="equation-label">(198)</td></tr></table>
<!--l. 2246--><p class="nopar" >
</p><!--l. 2248--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.11   </span> <a 
 id="x1-470008.11"></a>Flux coordinates (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>)</h4>
<!--l. 2250--><p class="noindent" >A coordinate system (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>), where <span 
class="cmmi-10">ϕ </span>is the usual cylindrical toroidal angle, is called a magnetic/ﬂux
coordinate system if <span 
class="cmmi-10">Ψ </span>is a function of only <span 
class="cmmi-10">ψ</span>, i.e., <span 
class="cmmi-10">∂Ψ∕∂𝜃 </span>= 0 (we also have <span 
class="cmmi-10">∂Ψ∕∂ϕ </span>= 0 since we are
considering axially symmetrical case). In terms of (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates, the contravariant form of the
magnetic ﬁeld, Eq. (<a 
href="#x1-46003r195">195<!--tex4ht:ref: 3-13-p10 --></a>), is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-47001r199"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium278x.png" alt="                   𝒥
B = − Ψ ′∇ ϕ× ∇ ψ +g-2∇ ψ ×∇ 𝜃,
                   R
" class="math-display"  /></center></td><td class="equation-label">(199)</td></tr></table>
<!--l. 2259--><p class="nopar" >
where <span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">′≡ </span><span 
class="cmmi-10">dΨ∕dψ</span>. The covariant form of the magnetic ﬁeld, Eq. (<a 
href="#x1-46004r196">196<!--tex4ht:ref: 7-26-1 --></a>), is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-47002r200"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium279x.png" alt="    (            )      (           )
B =   Ψ′ 𝒥-∇ ψ ⋅∇𝜃 ∇ψ +  − Ψ′ 𝒥-|∇ ψ|2 ∇ 𝜃+ g∇ ϕ.
        R2                   R2
" class="math-display"  /></center></td><td class="equation-label">(200)</td></tr></table>
<!--l. 2267--><p class="nopar" >
</p><!--l. 2269--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.12   </span> <a 
 id="x1-480008.12"></a>Local safety factor</h4>
<!--l. 2271--><p class="noindent" >The local safety factor <img 
src="tokamak_equilibrium280x.png" alt="ˆq"  class="circ"  /> is deﬁned by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-48001r201"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium281x.png" alt="   B ⋅∇ ϕ
ˆq =------,
   B ⋅∇ 𝜃
" class="math-display"  /></center></td><td class="equation-label">(201)</td></tr></table>
<!--l. 2275--><p class="nopar" >
which characterizes the local pitch angle of a magnetic ﬁeld line in (<span 
class="cmmi-10">𝜃,ϕ</span>) plane of a magnetic surface.
Substituting the contravariant representation of the magnetic ﬁeld, Eq. (<a 
href="#x1-47001r199">199<!--tex4ht:ref: 12-21-p1 --></a>), into the above equation,
the local safety factor is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-48002r202"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium282x.png" alt="ˆq(ψ,𝜃) = − g2-𝒥′.
          R  Ψ
                                                                                

                                                                                
" class="math-display"  /></center></td><td class="equation-label">(202)</td></tr></table>
<!--l. 2283--><p class="nopar" >
Note that the expression <img 
src="tokamak_equilibrium283x.png" alt="ˆq"  class="circ"  /> in Eq. (<a 
href="#x1-48002r202">202<!--tex4ht:ref: 12-25-1 --></a>) depends on the Jacobian <span 
class="cmsy-10">𝒥 </span>. This is because the
deﬁnition of <img 
src="tokamak_equilibrium284x.png" alt="ˆq"  class="circ"  /> depends on the deﬁnition of <span 
class="cmmi-10">𝜃</span>, which in turn depends on the the Jacobian
<span 
class="cmsy-10">𝒥 </span>.
</p><!--l. 2289--><p class="indent" >   In terms of <img 
src="tokamak_equilibrium285x.png" alt="ˆq"  class="circ"  /> , the contravariant form of the magnetic ﬁeld, Eq. (<a 
href="#x1-47001r199">199<!--tex4ht:ref: 12-21-p1 --></a>), is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-48003r203"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium286x.png" alt="B = − Ψ′(∇ϕ × ∇ψ + ˆq∇ψ × ∇ 𝜃).
" class="math-display"  /></center></td><td class="equation-label">(203)</td></tr></table>
<!--l. 2294--><p class="nopar" >
and the parallel diﬀerential operator <span 
class="cmbx-10">B</span><sub><span 
class="cmr-7">0</span></sub> <span 
class="cmsy-10">⋅∇ </span>is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-48004r204"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium287x.png" alt="                                             (         )
B  ⋅∇ = − Ψ′(∇ ϕ× ∇ ψ + ˆq∇ ψ × ∇𝜃)⋅∇ = − Ψ′𝒥 −1 -∂-+ ˆq-∂- .
  0                                           ∂ 𝜃   ∂ϕ
" class="math-display"  /></center></td><td class="equation-label">(204)</td></tr></table>
<!--l. 2302--><p class="nopar" >
If <img 
src="tokamak_equilibrium288x.png" alt="ˆq"  class="circ"  /> happens to be independent of <span 
class="cmmi-10">𝜃 </span>(i.e., ﬁeld lines are straight in (<span 
class="cmmi-10">𝜃,ϕ</span>) plane), then the above operator
becomes a constant coeﬃcient diﬀerential oprator (after divided by <span 
class="cmsy-10">𝒥</span><sup><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span></sup>). This simpliﬁcation is useful
because diﬀerent poloidal harmonics are decoupled in this case. We will discuss this issue futher in Sec.
<a 
href="#x1-8100014">14<!--tex4ht:ref: 23-12-27-1 --></a>.
</p><!--l. 2310--><p class="indent" >    
</p><!--l. 2312--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.13   </span> <a 
 id="x1-490008.13"></a>Global safety factor</h4>
<!--l. 2314--><p class="noindent" >The global safety factor deﬁned in Eq. (<a 
href="#x1-11004r34">34<!--tex4ht:ref: 9-5-e1 --></a>) is actually the poloidal average of the local safety factor,
i.e., </p><div class="eqnarray">
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium289x.png" alt="          ∫ 2π
q(ψ) ≡ -1-    ˆqd𝜃                              (205)
       2π  0
        -1-g-∫ 2π 𝒥--
     = −2π Ψ′  0  R2d𝜃.                        (206)
" class="math-display"  /><a 
 id="x1-49001r205"></a><a 
 id="x1-49001r206"></a></center>
</div>Note that <span 
class="cmmi-10">q </span>and <img 
src="tokamak_equilibrium290x.png" alt="ˆq"  class="circ"  /> deﬁned this way can be negative, which depends on the choice of the positive
direction of <span 
class="cmmi-10">ϕ </span>and <span 
class="cmmi-10">𝜃 </span>coordinates (note that the safety factor given in G-eqdsk ﬁle is always positive, i.e.
it is the absolute value of the safety factor deﬁned here).
<!--l. 2327--><p class="indent" >   Next, let us transform the <span 
class="cmmi-10">𝜃 </span>integration in expression (<a 
href="#x1-49001r206">206<!--tex4ht:ref: 7-11-p1 --></a>) to a curve integral in the
poloidal plane. Using the relation <span 
class="cmmi-10">dℓ</span><sub><span 
class="cmmi-7">p</span></sub> and <span 
class="cmmi-10">d𝜃 </span>[Eq. (<a 
href="#x1-50004r214">214<!--tex4ht:ref: 5-30-p1 --></a>)], expression (<a 
href="#x1-49001r206">206<!--tex4ht:ref: 7-11-p1 --></a>) is further written
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium291x.png" alt="             ∮
q(ψ) = − 1-g′  sign(𝒥 )-dℓp--
        2πΨ        ∮  R|∇ψ |
    = − 1-g-sign(𝒥)   -dℓp--.                     (207)
        2π sign(Ψ ′)   R |∇ Ψ|
" class="math-display"  /><a 
 id="x1-49002r207"></a></center>
</div>Expression (<a 
href="#x1-49002r207">207<!--tex4ht:ref: 7-12-a1 --></a>) is used in the GTAW code to numerically calculate the value of <span 
class="cmmi-10">q </span>on magnetic surfaces
(as a benchmarking of the <span 
class="cmmi-10">q </span>proﬁle speciﬁed in the G-eqdsk ﬁle). Expression (<a 
href="#x1-49002r207">207<!--tex4ht:ref: 7-12-a1 --></a>) can also be
considered as a relation between <span 
class="cmmi-10">q </span>and <span 
class="cmmi-10">g</span>. In the equilibrium problem where <span 
class="cmmi-10">q </span>is given (ﬁxed-q
equilibrium), we can use expression (<a 
href="#x1-49002r207">207<!--tex4ht:ref: 7-12-a1 --></a>) to obtain the corresponding <span 
class="cmmi-10">g </span>(which explicitly appears in the
GS equation):
   <table 
class="equation"><tr><td><a 
 id="x1-49003r208"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium292x.png" alt="        ( ∮ --dℓp--)−1 sign(Ψ′)
g = − 2πq   R |∇ Ψ|    sign(𝒥 ).
" class="math-display"  /></center></td><td class="equation-label">(208)</td></tr></table>
<!--l. 2346--><p class="nopar" >
We note that expression (<a 
href="#x1-49003r208">208<!--tex4ht:ref: 20-4-7-p1 --></a>) involves magnetic surface averaging, which is unknown before we know
<span 
class="cmmi-10">Ψ</span>. Therefore iteration is usually needed in solving the ﬁxed-q equilibrium (i.e., we guess the unknown
<span 
class="cmmi-10">Ψ</span>, so that the magnetic surface averaging in expression (<a 
href="#x1-49003r208">208<!--tex4ht:ref: 20-4-7-p1 --></a>) can be performed, yielding the values of
<span 
class="cmmi-10">g</span>.)
</p><!--l. 2353--><p class="indent" >   Using <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">p</span></sub> = <span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">|</span><span 
class="cmmi-10">∕R </span>and <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">ϕ</span></sub> = <span 
class="cmmi-10">g∕R</span>,  the absolute value of <span 
class="cmmi-10">q </span>in expression (<a 
href="#x1-49002r207">207<!--tex4ht:ref: 7-12-a1 --></a>) is written
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium293x.png" alt="        ∮
|q| =-1-g  --dℓp-.                           (209)
    2π    R |∇ Ψ|
     1 ∮  1|Bϕ|
  = 2π-  R--Bp-dℓp                          (210)
" class="math-display"  /></center>
</div>which is the familiar formula we see in textbooks.
<!--l. 2362--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.14   </span> <a 
 id="x1-500008.14"></a>Relation between Jacobian and poloidal angle <span 
class="cmmi-10">𝜃</span></h4>
<!--l. 2364--><p class="noindent" >Given the deﬁnition of a magnetic surface coordinate system (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>), the Jacobian of this system is
fully determined. On the other hand, given the deﬁnition of <span 
class="cmmi-10">ψ</span>, <span 
class="cmmi-10">ϕ</span>, and the Jacobian, the deﬁnition of <span 
class="cmmi-10">𝜃</span>
is fully determined (can have some trivial shifting freedoms). Next, let us discuss how to calculate <span 
class="cmmi-10">𝜃 </span>in
this case. In (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates, a line element is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-50001r211"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium294x.png" alt="dl =-∂rdψ + ∂rd𝜃 + ∂rdϕ
    ∂ψ      ∂𝜃     ∂ϕ
                                                                                

                                                                                
" class="math-display"  /></center></td><td class="equation-label">(211)</td></tr></table>
<!--l. 2374--><p class="nopar" >
The line element that lies on a magnetic surface (i.e., <span 
class="cmmi-10">dψ </span>= 0) and in a poloidal plane (i.e., <span 
class="cmmi-10">dϕ </span>= 0) is
then written </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium295x.png" alt="     ∂r-
dℓp = ∂ 𝜃d𝜃
   = 𝒥 ∇ϕ × ∇ ψd𝜃.                          (212)
" class="math-display"  /></center>
</div>We use the convention that <span 
class="cmmi-10">dℓ</span><sub><span 
class="cmmi-7">p</span></sub> and <span 
class="cmmi-10">d𝜃 </span>take the same sign, i.e.,
   <table 
class="equation"><tr><td><a 
 id="x1-50003r213"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium296x.png" alt="dℓp = |𝒥 ∇ϕ × ∇ψ |d𝜃.
" class="math-display"  /></center></td><td class="equation-label">(213)</td></tr></table>
<!--l. 2385--><p class="nopar" >
Using the fact that <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span>and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ϕ </span>are orthogonal and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ϕ </span>= <img 
src="tokamak_equilibrium297x.png" alt="ˆϕ"  class="circ"  /><span 
class="cmmi-10">∕R</span>, the above equation is written
as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-50004r214"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium298x.png" alt="       R
d𝜃 = ------dlp
     |𝒥 ∇ ψ|
" class="math-display"  /></center></td><td class="equation-label">(214)</td></tr></table>
                                                                                

                                                                                
<!--l. 2390--><p class="nopar" >
Given <span 
class="cmsy-10">|𝒥∇</span><span 
class="cmmi-10">ψ</span><span 
class="cmsy-10">|</span>, Eq. (<a 
href="#x1-50004r214">214<!--tex4ht:ref: 5-30-p1 --></a>) can be integrated to determine the <span 
class="cmmi-10">𝜃 </span>coordinate of points on a magnetic
surface.
</p><!--l. 2394--><p class="indent" >   —–
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-50005r215"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium299x.png" alt="-  ∫ 𝜃       ∫ 𝜃 g--𝒥
δ = 0 ˆqd𝜃 = − 0  R2Ψ ′d𝜃
" class="math-display"  /></center></td><td class="equation-label">(215)</td></tr></table>
<!--l. 2398--><p class="nopar" >
</p><!--l. 2400--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">8.15   </span> <a 
 id="x1-510008.15"></a>Calculating poloidal angle</h4>
<!--l. 2402--><p class="noindent" >Once <span 
class="cmsy-10">|𝒥∇</span><span 
class="cmmi-10">ψ</span><span 
class="cmsy-10">| </span>is known, the value of <span 
class="cmmi-10">𝜃 </span>of a point can be obtained by integrating expression (<a 
href="#x1-50004r214">214<!--tex4ht:ref: 5-30-p1 --></a>),
i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-51001r216"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium300x.png" alt="           ∫ xi,j   R
𝜃i,j = 𝜃ref,j +     -----dlp,
            xref,j |𝒥 ∇ψ |
" class="math-display"  /></center></td><td class="equation-label">(216)</td></tr></table>
<!--l. 2408--><p class="nopar" >
where the curve integration is along the contour <span 
class="cmmi-10">Ψ </span>= <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">j</span></sub>, <span 
class="cmbx-10">x</span><sub><span 
class="cmr-7">ref</span><span 
class="cmmi-7">,j</span></sub> is a reference point on the contour,
where value of the poloidal angle is chosen as <span 
class="cmmi-10">𝜃</span><sub><span 
class="cmr-7">ref</span><span 
class="cmmi-7">,j</span></sub>. The choice of the positive direction of <span 
class="cmmi-10">𝜃 </span>is up to
users. Depending on the positive direction chosen, the sign of the Jacobian of the constructed
coordinates can have a sign diﬀerence from the <span 
class="cmsy-10">𝒥 </span>appearing in Eq. (<a 
href="#x1-51001r216">216<!--tex4ht:ref: 12-31-1 --></a>). Denote the Jacobian of the
constructed coordinates by <span 
class="cmsy-10">𝒥′</span>, then
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-51002r217"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium301x.png" alt="𝒥′ = ± 𝒥
" class="math-display"  /></center></td><td class="equation-label">(217)</td></tr></table>
<!--l. 2419--><p class="nopar" >
This sign can be determined after the radial coordinate and the positive direction of the poloidal angle
are chosen. In <span 
class="cmtt-10">GTAW </span>code, I choose the positive direction of <span 
class="cmmi-10">𝜃 </span>to be in anticlockwise direction when
observers look along the direction of <img 
src="tokamak_equilibrium302x.png" alt="ˆϕ"  class="circ"  />. To achieve this, the line integration in Eq. (<a 
href="#x1-51001r216">216<!--tex4ht:ref: 12-31-1 --></a>) should be
along the anticlockwise direction. (I use the determination of the direction matrix, a well known
method in graphic theory, to determine the direction from a given set of discrete points on a magnetic
surface.)
</p>
   <h5 class="subsubsectionHead"><a 
 id="x1-520008.15"></a>Normalized poloidal angle</h5>
<!--l. 2431--><p class="noindent" >The span of <span 
class="cmmi-10">𝜃 </span>deﬁned by Eq. (<a 
href="#x1-51001r216">216<!--tex4ht:ref: 12-31-1 --></a>) is usually not 2<span 
class="cmmi-10">π </span>in one poloidal loop. This poloidal angle can be
scaled by <span 
class="cmmi-10">s</span>(<span 
class="cmmi-10">ψ</span>) to deﬁne a new poloidal coordinate <span class="overline"><span 
class="cmmi-10">𝜃</span></span>, whose span is 2<span 
class="cmmi-10">π </span>in one poloidal loop, where <span 
class="cmmi-10">s</span>(<span 
class="cmmi-10">ψ</span>)
is a magnetic surface function given by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-52001r218"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium303x.png" alt="s(ψ) = ∮--2π----.
        |𝒥R∇ψ|dlp
" class="math-display"  /></center></td><td class="equation-label">(218)</td></tr></table>
<!--l. 2437--><p class="nopar" >
Then <span class="overline"><span 
class="cmmi-10">𝜃</span></span> is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium304x.png" alt="-
𝜃i,j = s(ψj)𝜃i,j
          (       ∫ xi,j        )
   = s(ψj) 𝜃ref,j +     --R---dlp
                   xref,j|𝒥∇ ψ|
     -          ∫ xi,j --R---
   = 𝜃ref,j + s(ψj) x    |𝒥 ∇ψ |dlp,                     (219)
                  ref,j
" class="math-display"  /><a 
 id="x1-52002r219"></a></center>
</div>where <span class="overline"><span 
class="cmmi-10">𝜃</span></span><sub><span 
class="cmr-7">ref</span><span 
class="cmmi-7">,j</span></sub> = <span 
class="cmmi-10">s</span>(<span 
class="cmmi-10">ψ</span><sub><span 
class="cmmi-7">j</span></sub>)<span 
class="cmmi-10">𝜃</span><sub><span 
class="cmr-7">ref</span><span 
class="cmmi-7">,j</span></sub>. Sine we have modiﬁed the deﬁnition of the poloidal angle, the Jacobian of the
new coordinates (<span 
class="cmmi-10">ψ,</span><span class="overline"><span 
class="cmmi-10">𝜃</span></span><span 
class="cmmi-10">,ϕ</span>) is diﬀerent from that of (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>). The Jacobian <span 
class="cmsy-10">𝒥</span><sub><span 
class="cmr-7">new</span></sub> of the new coordinates
(<span 
class="cmmi-10">ψ,</span><span class="overline"><span 
class="cmmi-10">𝜃</span></span><span 
class="cmmi-10">,ϕ</span>) is written as
   <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium305x.png" alt="       ------1-------
𝒥new ≡ (∇ ψ × ∇𝜃)⋅∇ ϕ
               1
    =  {∇ψ-×-∇[s(ψ)𝜃]}⋅∇-ϕ-

    =  -1--------1-------
       s(ψ )(∇ψ × ∇𝜃)⋅∇ ϕ
    =  -1--𝒥′
       s(ψ )
        -1--
    = ± s(ψ)𝒥                                   (220)
" class="math-display"  /><a 
 id="x1-52003r220"></a></center>
</div>The Jacobian <span 
class="cmsy-10">𝒥 </span>can be set to various forms to achieve various poloidal coordinates, which will be
discussed in the next section. After the Jacobian and the radial coordinate <span 
class="cmmi-10">ψ </span>is chosen, all the
quantities on the right-hand side of Eq. (<a 
href="#x1-52002r219">219<!--tex4ht:ref: 10-25-p1 --></a>) are known and the integration can be performed to
obtain the value of <span class="overline"><span 
class="cmmi-10">𝜃</span></span><sub><span 
class="cmmi-7">i,j</span></sub> of each point on each ﬂux surface.
<!--l. 2472--><p class="indent" >   [The reference points <span 
class="cmbx-10">x</span><sub><span 
class="cmr-7">ref</span><span 
class="cmmi-7">,j</span></sub> and the values of poloidal angle at these points can be chosen by users.
One choice of the reference points <span 
class="cmbx-10">x</span><sub><span 
class="cmr-7">ref</span><span 
class="cmmi-7">,j</span></sub> are those points on the horizontal ray in the midplane that
starts from the magnetic axis and points to the low ﬁled side of the device and <span class="overline"><span 
class="cmmi-10">𝜃</span></span><sub><span 
class="cmr-7">ref</span><span 
class="cmmi-7">,j</span></sub> at these
points is chosen as zero (this is my choice in the <span 
class="cmtt-10">GTAW </span>code). In the <span 
class="cmtt-10">TEK </span>code, the reference
points are chosen at the high-ﬁeld side of the midplane and <span class="overline"><span 
class="cmmi-10">𝜃</span></span><sub><span 
class="cmr-7">ref</span><span 
class="cmmi-7">,j</span></sub> = <span 
class="cmsy-10">−</span><span 
class="cmmi-10">π </span>at the reference
points.]
</p>
   <h5 class="subsubsectionHead"><a 
 id="x1-530008.15"></a>Jacobian for equal-arc-length poloidal angle</h5>
                                                                                

                                                                                
<!--l. 2484--><p class="noindent" >If the Jacobian <span 
class="cmsy-10">𝒥 </span>is chosen to be of the following form
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-53001r221"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium306x.png" alt="      R
𝒥 = ---- .
    |∇ ψ|
" class="math-display"  /></center></td><td class="equation-label">(221)</td></tr></table>
<!--l. 2487--><p class="nopar" >
Then <span class="overline"><span 
class="cmmi-10">𝜃</span></span><sub><span 
class="cmmi-7">i,j</span></sub> in Eq. (<a 
href="#x1-52002r219">219<!--tex4ht:ref: 10-25-p1 --></a>) is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-53002r222"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium307x.png" alt="                 ∫
𝜃   = 𝜃   + ∮2π--  xi,jdl.
 i,j    ref,j    dlp  xref,j p
" class="math-display"  /></center></td><td class="equation-label">(222)</td></tr></table>
<!--l. 2493--><p class="nopar" >
and the Jacobian of new coordinates (<span 
class="cmmi-10">ψ,</span><span class="overline"><span 
class="cmmi-10">𝜃</span></span><span 
class="cmmi-10">,ϕ</span>), <span 
class="cmsy-10">𝒥</span><sub><span 
class="cmr-7">new</span></sub>, which is given by Eq. (<a 
href="#x1-52003r220">220<!--tex4ht:ref: 10-25-p7 --></a>), now takes the
form
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-53003r223"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium308x.png" alt="        ∮ dl  R      ∮ dl  R  dΨ
𝒥new = ±---p-----= ± ---p--------.
         2π  |∇ ψ|     2π  |∇ Ψ|dψ
" class="math-display"  /></center></td><td class="equation-label">(223)</td></tr></table>
                                                                                

                                                                                
<!--l. 2501--><p class="nopar" >
Equation (<a 
href="#x1-53002r222">222<!--tex4ht:ref: 7-18-e2 --></a>) indicates a set of poloidal points with equal arc intervals corresponds to a set
of uniform <span 
class="cmmi-10">𝜃</span><sub><span 
class="cmmi-7">i</span></sub> points. Therefore this choice of the Jacobian is called the equal-arc-length
Jacobian. Note that Eq. (<a 
href="#x1-53002r222">222<!--tex4ht:ref: 7-18-e2 --></a>) does not involve the radial coordinate <span 
class="cmmi-10">ψ</span>. Therefore the values
of <span 
class="cmmi-10">𝜃 </span>of points on any magnetic surface can be determined before the radial coordinate is
chosen.
</p>
   <h5 class="subsubsectionHead"><a 
 id="x1-540008.15"></a>Jacobian for equal-volume poloidal angle (Hamada coordinate)</h5>
<!--l. 2511--><p class="noindent" >The volume element in (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates is given by <span 
class="cmmi-10">dV </span>= <span 
class="cmsy-10">|𝒥|</span><span 
class="cmmi-10">d𝜃dϕdψ</span>. If we choose a Jacobian that
is independent of <span 
class="cmmi-10">𝜃</span>, then uniform <span 
class="cmmi-10">𝜃 </span>grids will correspond to grids with uniform volume interval. In this
case, <span 
class="cmsy-10">𝒥 </span>is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-54001r224"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium309x.png" alt="𝒥 = h (ψ ),
" class="math-display"  /></center></td><td class="equation-label">(224)</td></tr></table>
<!--l. 2517--><p class="nopar" >
where <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">ψ</span>) is a function independent of <span 
class="cmmi-10">𝜃</span>. Then <span class="overline"><span 
class="cmmi-10">𝜃</span></span><sub><span 
class="cmmi-7">i,j</span></sub> in Eq. (<a 
href="#x1-52002r219">219<!--tex4ht:ref: 10-25-p1 --></a>) is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-54002r225"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium310x.png" alt="-    -        2π    ∫ xi,j  R
𝜃i,j = 𝜃ref,j + ∮-R--dl      |∇ψ|dlp
             |∇ψ| p  xref,j
" class="math-display"  /></center></td><td class="equation-label">(225)</td></tr></table>
<!--l. 2524--><p class="nopar" >
and the Jacobian of the new coordinates (<span 
class="cmmi-10">ψ,</span><span class="overline"><span 
class="cmmi-10">𝜃</span></span><span 
class="cmmi-10">,ϕ</span>), <span 
class="cmsy-10">𝒥</span><sub><span 
class="cmr-7">new</span></sub>,  is given by Eq. (<a 
href="#x1-52003r220">220<!--tex4ht:ref: 10-25-p7 --></a>), which now takes the
following form:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-54003r226"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium311x.png" alt="         1 ∮   R
𝒥new = ± 2π-  |∇-ψ|dlp.
" class="math-display"  /></center></td><td class="equation-label">(226)</td></tr></table>
<!--l. 2531--><p class="nopar" >
Note that both <span class="overline"><span 
class="cmmi-10">𝜃</span></span><sub><span 
class="cmmi-7">i,j</span></sub> and <span 
class="cmsy-10">𝒥</span><sub><span 
class="cmr-7">new</span></sub> are independent of the function <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">ψ</span>) introduced in Eq. (<a 
href="#x1-54001r224">224<!--tex4ht:ref: 17-10-19-1 --></a>). (<span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">ψ</span>) is
eliminated by the normalization procedure speciﬁed in Sec. <a 
href="#x1-520008.15">8.15<!--tex4ht:ref: 17-10-19-2 --></a> due to the fact that <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">ψ</span>) is constant
on a magnetic surface.) The equal-volume poloidal angle is also called Hamada poloidal
angle.
</p><!--l. 2539--><p class="indent" >   The equal-volume poloidal angle is useful in achieving loading balance for parallel particle
simulations. Assume that markers are loaded uniform in space and the poloidal angle is domain
decomposed and assigned to diﬀerent MPI process. Then the equal-volume poloidal angle can
make marker number in each MPI process be equal to each other and thus work loading to
each process be equal. (**check**If the domain decomposition is also applied to the radial
direction, to achieve loading balance, then the radial coordinate <span 
class="cmmi-10">ψ </span>should be chosen in a way
that makes <span 
class="cmex-10">∮</span>
 (<span 
class="cmmi-10">R∕</span><span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ</span>)<span 
class="cmmi-10">dl</span><sub><span 
class="cmmi-7">p</span></sub> be independent of <span 
class="cmmi-10">ψ</span>, so that <span 
class="cmsy-10">𝒥</span><sub><span 
class="cmr-7">new</span></sub> in Eq. (<a 
href="#x1-54003r226">226<!--tex4ht:ref: 19-4-11-p3 --></a>) is constant in
space.**)
</p>
   <h5 class="subsubsectionHead"><a 
 id="x1-550008.15"></a>Jacobian of Boozer’s poloidal angle</h5>
<!--l. 2552--><p class="noindent" >If the Jacobian <span 
class="cmsy-10">𝒥 </span>is chosen to be of the Boozer form:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-55001r227"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium312x.png" alt="         h(ψ)
𝒥(ψ,𝜃) = -B2-.
" class="math-display"  /></center></td><td class="equation-label">(227)</td></tr></table>
<!--l. 2555--><p class="nopar" >
then the poloidal angle in Eq. (<a 
href="#x1-52002r219">219<!--tex4ht:ref: 10-25-p1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-55002r228"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium313x.png" alt="                    ∫ xi,j  2
𝜃i,j = 𝜃ref,j + ∮-B22πR--      B-R-dlp.
              |∇-ψ|dlp xref,j |∇ ψ|
" class="math-display"  /></center></td><td class="equation-label">(228)</td></tr></table>
<!--l. 2561--><p class="nopar" >
The ﬁnal Jacobian is given by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-55003r229"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium314x.png" alt="        ∮  2
          B|∇-Rψ|dlp 1
𝒥new = ±---2π---B2-.
" class="math-display"  /></center></td><td class="equation-label">(229)</td></tr></table>
<!--l. 2566--><p class="nopar" >
The usefullness of Boozer poloidal angle will be further discussed in Sec. <a 
href="#x1-8900014.8">14.8<!--tex4ht:ref: 23-12-26-1 --></a> after we introduce a
gneralized toroidal angle.
</p><!--l. 2570--><p class="indent" >    
</p>
   <h5 class="subsubsectionHead"><a 
 id="x1-560008.15"></a>Jacobian for PEST poloidal angle (straight-ﬁeld-line poloidal angle)</h5>
<!--l. 2575--><p class="noindent" >If the Jacobian <span 
class="cmsy-10">𝒥 </span>is chosen to be of the following form
</p>
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
                                  <span 
class="cmsy-10">𝒥 </span>(<span 
class="cmmi-10">ψ,𝜃</span>) = <span 
class="cmmi-10">R</span><sup><span 
class="cmr-7">2</span></sup><span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 2576--><p class="nopar" >
then Eq. (<a 
href="#x1-48002r202">202<!--tex4ht:ref: 12-25-1 --></a>) implies that the local safety factor, <img 
src="tokamak_equilibrium315x.png" alt="ˆq"  class="circ"  /> (<span 
class="cmmi-10">ψ,𝜃</span>) = <span 
class="cmsy-10">−</span><span 
class="cmmi-10">g∕Ψ</span><span 
class="cmsy-10">′</span>, is a magnetic surface function, i.e.,
the magnetic ﬁeld lines are straight in (<span 
class="cmmi-10">ψ,𝜃</span>) plane. Then the poloidal angle in Eq. (<a 
href="#x1-52002r219">219<!--tex4ht:ref: 10-25-p1 --></a>) is
written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-56001r230"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium316x.png" alt="                     ∫ xi,j
𝜃i,j = 𝜃ref,j + ∮-2π---      --1--dlp,
              R1|∇-ψ|dlp xref,j R|∇ψ |
" class="math-display"  /></center></td><td class="equation-label">(230)</td></tr></table>
<!--l. 2586--><p class="nopar" >
The Jacobian <span 
class="cmsy-10">𝒥</span><sub><span 
class="cmr-7">new</span></sub> given by Eq. (<a 
href="#x1-52003r220">220<!--tex4ht:ref: 10-25-p7 --></a>) now takes the form
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-56002r231"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium317x.png" alt="          ∮
         2  R|1∇ψ|dlp
𝒥new = ±R  ---2π----.
" class="math-display"  /></center></td><td class="equation-label">(231)</td></tr></table>
<!--l. 2592--><p class="nopar" >
Let us denote an arbitrary poloidal angle by <span 
class="cmmi-10">𝜃 </span>and the above straight-ﬁeld-line poloidal angle by <span 
class="cmmi-10">𝜗</span>,
then it is ready to ﬁnd the following relation between <span 
class="cmmi-10">𝜃 </span>and <span 
class="cmmi-10">𝜗</span>:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-56003r232"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium318x.png" alt="            ∫ 𝜃
𝜗 = 𝜗ref,j + 1    qˆd𝜃,
           q 𝜃ref,j
" class="math-display"  /></center></td><td class="equation-label">(232)</td></tr></table>
<!--l. 2599--><p class="nopar" >
where <img 
src="tokamak_equilibrium319x.png" alt="ˆq"  class="circ"  /> is the local safety factor corresponding to the arbitrary poloidal angle <span 
class="cmmi-10">𝜃</span>, i.e.,
<img 
src="tokamak_equilibrium320x.png" alt="ˆq"  class="circ"  /> = <span 
class="cmbx-10">B</span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ϕ∕</span>(<span 
class="cmbx-10">B</span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">𝜃</span>). [Proof: Using <span 
class="cmmi-10">d𝜃 </span>= <img 
src="tokamak_equilibrium321x.png" alt="|𝒥R∇ψ-|"  class="frac" align="middle" /><span 
class="cmmi-10">dl</span><sub><span 
class="cmmi-7">p</span></sub>, the poloidal angle <span 
class="cmmi-10">𝜗 </span>given in Eq. (<a 
href="#x1-56001r230">230<!--tex4ht:ref: 18-9-27-p1 --></a>) is written as
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium322x.png" alt="                    ∫ x
𝜗 = 𝜗   + ∮---2π---    i,j--1---dl
     ref,j    R|1∇ψ|dlp  xref,jR |∇ ψ| p
                2π      ∫ xi,j   1   |𝒥 ∇ψ |
  = 𝜗ref,j + ∮--1--|𝒥∇ψ|--      -----------d𝜃
            R|∇ψ|--R--d𝜃 xref,j R|∇ψ |  R
          --2π---∫ xi,j|𝒥-|
  = 𝜗ref,j + ∮ |𝒥|d𝜃 x   R2 d𝜃.                            (233)
            R2     ref,j
" class="math-display"  /></center>
</div>Using <img 
src="tokamak_equilibrium323x.png" alt="ˆq"  class="circ"  /> = <span 
class="cmsy-10">−</span><img 
src="tokamak_equilibrium324x.png" alt="g-
R2"  class="frac" align="middle" /><img 
src="tokamak_equilibrium325x.png" alt="𝒥-
Ψ′"  class="frac" align="middle" />, where <span 
class="cmsy-10">𝒥 </span>is the Jacobian of (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates, then the above <span 
class="cmmi-10">𝜗 </span>is reduced to
expression (<a 
href="#x1-56003r232">232<!--tex4ht:ref: 18-9-27-p4 --></a>).]
<!--l. 2621--><p class="indent" >   Note that Boozer poloidal angle is very close to the poloidal angel disccused here because the two
Jacobians are very similar:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-56005r234"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium326x.png" alt="𝒥  = -12-∼ R2.
     B
                                                                                

                                                                                
" class="math-display"  /></center></td><td class="equation-label">(234)</td></tr></table>
<!--l. 2625--><p class="nopar" >
</p>
   <h5 class="subsubsectionHead"><a 
 id="x1-570008.15"></a>Comparison between diﬀerent types of poloidal angle</h5>
<!--l. 2630--><p class="noindent" > 
</p><!--l. 2632--><p class="indent" >   All Jacobians introduced above can be written in a general form:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-57001r235"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium327x.png" alt="         i
𝒥  = --R-j-k,
     |∇ ψ| B
" class="math-display"  /></center></td><td class="equation-label">(235)</td></tr></table>
<!--l. 2635--><p class="nopar" >
The choice of (<span 
class="cmmi-10">i </span>= 2<span 
class="cmmi-10">,j </span>= <span 
class="cmmi-10">k </span>= 0) gives the PEST coordinate, (<span 
class="cmmi-10">i </span>= <span 
class="cmmi-10">j </span>= 0<span 
class="cmmi-10">,k </span>= 2) give the Boozer
coordinate, (<span 
class="cmmi-10">i </span>= <span 
class="cmmi-10">j </span>= 1<span 
class="cmmi-10">,k </span>= 0) gives the equal-arc coordinate, (<span 
class="cmmi-10">i </span>= <span 
class="cmmi-10">j </span>= <span 
class="cmmi-10">k </span>= 0) gives the Hammada
coordinate.
</p><!--l. 2640--><p class="indent" >    
</p><!--l. 2642--><p class="indent" >   Figure <a 
href="#x1-570026">6<!--tex4ht:ref: 8-23-1 --></a> compares the equal-arc-poloidal angle and the straight-line poloidal angle, which shows
that the resolution of the straight-line poloidal angle is not good near the low-ﬁeld-side midplane. Since
ballooning modes take larger amplitude near the low-ﬁeld-side midplane, better resolution is desired
there. This is one reason that I often avoid using the straight-line poloidal angle in my numerical
codes.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-570026"></a>
                                                                                

                                                                                
<!--l. 2650--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/read_gfile/fig161/out1.png" alt="pict"  
 width="113.42375pt" /> <img 
src="my_figure/home/yj/project_new/read_gfile/fig161/out2.png" alt="pict"  
 width="113.42375pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 6: </span><span  
class="content">The equal-arc poloidal angle (left) and the straight-line poloidal angle (right) for EAST
equilibrium #38300@3.9s. The blue lines correspond to the equal-<span 
class="cmmi-10">𝜃 </span>lines, with uniform <span 
class="cmmi-10">𝜃 </span>interval
between neighbour lines. The red lines correspond to the magnetic surfaces, which start from
<img 
src="tokamak_equilibrium328x.png" alt="∘ Ψ--
    t"  class="sqrt"  /> = 0<span 
class="cmmi-10">.</span>01714 (the innermost magnetic surface) and end at <img 
src="tokamak_equilibrium329x.png" alt="∘ Ψ--
    t"  class="sqrt"  />  = 0<span 
class="cmmi-10">.</span>9851 (the boundary
magnetic surface), and are equally spaced in <img 
src="tokamak_equilibrium330x.png" alt="∘ ---
  Ψt"  class="sqrt"  />.</span></div><!--tex4ht:label?: x1-570026 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
   <h5 class="subsubsectionHead"><a 
 id="x1-580008.15"></a>Veriﬁcation of Jacobian</h5>
<!--l. 2663--><p class="noindent" >After the magnetic coordinates are constructed, we can evaluate the Jacobian <span 
class="cmsy-10">𝒥</span><sub><span 
class="cmr-7">new</span></sub> by using directly
the deﬁnition of the Jacobian, i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-58001r236"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium331x.png" alt="       ------1-------
𝒥new = (∇ψ × ∇ 𝜃) ⋅∇ϕ ,
" class="math-display"  /></center></td><td class="equation-label">(236)</td></tr></table>
<!--l. 2669--><p class="nopar" >
which can be further written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-58002r237"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium332x.png" alt="𝒥new = R (R 𝜃Zψ − RψZ𝜃),
" class="math-display"  /></center></td><td class="equation-label">(237)</td></tr></table>
<!--l. 2674--><p class="nopar" >
where the partial diﬀerential can be evaluated by using numerical diﬀerential schemes. The results
obtained by this way should agree with results obtained from the analytical form of the Jacobian. This
consistency check provide a veriﬁcation for the correctness of the theory derivation and numerical
implementation. In evaluating the Jacobian by using the analytical form, we may need to evaluate <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ</span>,
which ﬁnally reduces to evaluating <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">Ψ</span>. The value of <span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">| </span>is obtained numerically based on the
numerical data of <span 
class="cmmi-10">Ψ </span>given in cylindrical coordinate grids. Then the cubic spline interpolating
formula is used to obtain the value of <span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">| </span>at desired points. (<span 
class="cmsy-10">𝒥</span><sub><span 
class="cmr-7">new</span></sub> calculated by the second
method (i.e. using analytic form) is used in the GTAW code; the ﬁrst methods are also
implemented in the code for the benchmark purpose.) In the following sections, for notation
ease, the Jacobiban of the constructed coordinate system will be denoted by <span 
class="cmsy-10">𝒥 </span>, rather than
<span 
class="cmsy-10">𝒥</span><sub><span 
class="cmr-7">new</span></sub>.
                                                                                

                                                                                
</p>
   <h5 class="subsubsectionHead"><a 
 id="x1-590008.15"></a>Radial coordinate</h5>
<!--l. 2693--><p class="noindent" >The radial coordinate <span 
class="cmmi-10">ψ </span>can be chosen to be various surface function, e.g., volume, poloidal or toroidal
magnetic ﬂux within a magnetic surface. The frequently used radial coordinates include <span class="overline"><span 
class="cmmi-10">Ψ</span></span>, and <img 
src="tokamak_equilibrium333x.png" alt="√ --
  Ψ"  class="sqrt"  />,
where <span class="overline"><span 
class="cmmi-10">Ψ</span></span> is deﬁned by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-59001r238"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium334x.png" alt="--  Ψ − Ψ0
Ψ = Ψa-−-Ψ0,
" class="math-display"  /></center></td><td class="equation-label">(238)</td></tr></table>
<!--l. 2699--><p class="nopar" >
where <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">0</span></sub> and <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">a</span></sub> are the values of <span 
class="cmmi-10">Ψ </span>at the magnetic axis and LCFS, respectively. Other choices of
the radial coordinates: the normalized toroidal magnetic ﬂux and its square root, <span class="overline"><span 
class="cmmi-10">Φ</span></span>, and
<img 
src="tokamak_equilibrium335x.png" alt="√ --
  Φ"  class="sqrt"  />.
</p><!--l. 2705--><p class="indent" >   The volume between magnetic surfaces can also be used as a radial coordinate. The diﬀerential
volume element is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-59002r239"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium336x.png" alt=" 3
d V = 𝒥 dψd𝜃dϕ.
" class="math-display"  /></center></td><td class="equation-label">(239)</td></tr></table>
<!--l. 2709--><p class="nopar" >
Integrating over the toroidal angle, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-59003r240"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium337x.png" alt=" 2
d V = 2π𝒥dψd 𝜃
" class="math-display"  /></center></td><td class="equation-label">(240)</td></tr></table>
<!--l. 2713--><p class="nopar" >
Further integrating over the poloidal angle, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-59004r241"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium338x.png" alt="           ∮
d1V = 2πdψ   𝒥 d𝜃,
" class="math-display"  /></center></td><td class="equation-label">(241)</td></tr></table>
<!--l. 2717--><p class="nopar" >
i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-59005r242"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium339x.png" alt="d1V      ∮
----= 2π   𝒥 d𝜃.
 dψ
" class="math-display"  /></center></td><td class="equation-label">(242)</td></tr></table>
<!--l. 2721--><p class="nopar" >
</p><!--l. 2724--><p class="indent" >   The cylindrical coordinates (<span 
class="cmmi-10">R,ϕ,Z</span>) is a right-hand system, with the positive direction
of <span 
class="cmmi-10">Z </span>pointing vertically up. In GTAW code, the positive direction of <span 
class="cmmi-10">𝜃 </span>is chosen in the
anticlockwise direction when observers look along the direction of <img 
src="tokamak_equilibrium340x.png" alt="ˆϕ"  class="circ"  />. Then the deﬁnition
<span 
class="cmsy-10">𝒥</span><sup><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span></sup> = <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">𝜃 </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ϕ </span>indicates that (1) <span 
class="cmsy-10">𝒥 </span>is negative if <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span>points from the magnetic axis to LCFS;
(2) <span 
class="cmsy-10">𝒥 </span>is positive if <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span>points from the LCFS to the magnetic axis. This can be used to
determine the sign of Jacobian after using the analytical formula to obtain the absolute value of
                                                                                

                                                                                
Jacobian.
</p><!--l. 2736--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">9   </span> <a 
 id="x1-600009"></a>Constructing magnetic surface coordinate system from discrete <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>) data</h3>
<!--l. 2738--><p class="noindent" >Given an axisymmetric tokamak equilibrium in (<span 
class="cmmi-10">R,ϕ,Z</span>) coordinates (e.g., 2D data <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>) on a
rectangular grids (<span 
class="cmmi-10">R,Z</span>) in G-ﬁle), we can construct a magnetic surface coordinates (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) by the
following two steps. (1) Find out a series of magnetic surfaces on (<span 
class="cmmi-10">R,Z</span>) plane and select radial
coordinates for each magnetic surface (e.g. the poloidal ﬂux within each magnetic surface). (2) Specify
the Jacobian or some property that we want the poloidal angle to have. Then calculate the poloidal
angle of each point on each ﬂux surface (on the <span 
class="cmmi-10">ϕ </span>= const plane) by using Eq. (<a 
href="#x1-50004r214">214<!--tex4ht:ref: 5-30-p1 --></a>) (if the Jacobian is
speciﬁed) or some method speciﬁed by us to achieve some property we prefer for the poloidal angle (if a
Jacobian is not directly speciﬁed). Then we obtain the magnetic surface coordinates system
(<span 
class="cmmi-10">ψ,𝜃,ϕ</span>).
</p><!--l. 2751--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">9.1   </span> <a 
 id="x1-610009.1"></a>Finding magnetic surfaces</h4>
<!--l. 2753--><p class="noindent" >Two-dimensional data <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>) on a rectangular grids (<span 
class="cmmi-10">R,Z</span>) is read from the G_EQDSK ﬁle (G-ﬁle) of
EFIT code. Based on the 2D array data, I use 2D cubic spline interpolation to construct a interpolating
function <span 
class="cmmi-10">Ψ </span>= <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>). To construct a magnetic surface coordinate system, I need to ﬁnd the contours
of <span 
class="cmmi-10">Ψ</span>, i.e., magnetic surfaces. The values of <span 
class="cmmi-10">Ψ </span>on the magnetic axis, <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">0</span></sub>, and the value of <span 
class="cmmi-10">Ψ </span>on the last
closed ﬂux surface (LCFS), <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">b</span></sub>, are given in G-ﬁle. Using these two values, I construct a
1D array “psival” with value of elements changing uniform from <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">0</span></sub> to <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">b</span></sub>. Then I try to
ﬁnd the contours of <span 
class="cmmi-10">Ψ </span>with contour level value ranging from <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmr-7">0</span></sub> to <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">b</span></sub>. This is done in the
following way: construct a series of straight line (in the poloidal plane) that starts from the
location of the magnetic axis and ends at one of the points on the LCFS. Combine the
straight line equation, <span 
class="cmmi-10">Z </span>= <span 
class="cmmi-10">Z</span>(<span 
class="cmmi-10">R</span>), with the interpolating function <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>), we obtain a
one variable function <span 
class="cmmi-10">h </span>= <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>(<span 
class="cmmi-10">R</span>)). Then ﬁnding the location where <span 
class="cmmi-10">Ψ </span>is equal to a
speciﬁed value <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">i</span></sub>, is reduced to ﬁnding the root of the equation <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>(<span 
class="cmmi-10">R</span>)) <span 
class="cmsy-10">− </span><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">i</span></sub> = 0.
Since this is a one variable equation, the root can be easily found by using simple root
ﬁnding scheme, such as bisection method (bisection method is used in GTAW code). After
ﬁnding the roots for each value in the array “psival” on each straight lines, the process of
ﬁnding the contours of <span 
class="cmmi-10">Ψ </span>is ﬁnished. The contours of <span 
class="cmmi-10">Ψ </span>found this way are plotted in Fig.
<a 
href="#x1-610017">7<!--tex4ht:ref: 4-3-p2 --></a>.
</p><!--l. 2776--><p class="indent" >    
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-610017"></a>
                                                                                

                                                                                
<!--l. 2779--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/read_gfile/fig1/contour.png" alt="pict"  
 width="180.67499pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 7: </span><span  
class="content">Veriﬁcation of the numerical code that calculates the contours of the poloidal ﬂux <span 
class="cmmi-10">Ψ</span>. The
bold line in the ﬁgure indicates the LCFS. The contour lines (solid lines) given by the gnuplot
program agrees well with the results I calculate by using interpolation and root-ﬁnding method
(the two sets of contours are indistinguishable in this scale). My code only calculate the contour
lines within the LCFS, while those given by gnuplot contains additional contour lines below the
X point and on the left top in the ﬁgure. Eqdisk ﬁle of the equilibrium was provided by Dr.
Guoqiang Li (ﬁlename: g013606.07104).</span></div><!--tex4ht:label?: x1-610017 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
<!--l. 2791--><p class="indent" >    
</p><!--l. 2793--><p class="indent" >   In the above, we mentioned that the point of magnetic axis and points on the LCFS are needed to
construct the straight lines. In G-ﬁle, points on LCFS are given explicitly in an array. The location of
magnetic axis is also explicitly given in G-ﬁle. It is obvious that some of the straight lines <span 
class="cmmi-10">Z </span>= <span 
class="cmmi-10">Z</span>(<span 
class="cmmi-10">R</span>)
that pass through the location of magnetic axis and points on the LCFS will have very large or even
inﬁnite slope. On these lines, ﬁnding the accurate root of the equation <span 
class="cmmi-10">Ψ</span>(<span 
class="cmmi-10">R,Z</span>(<span 
class="cmmi-10">R</span>)) <span 
class="cmsy-10">−</span><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">i</span></sub> = 0 is diﬃcult
or even impossible. The way to avoid this situation is obvious: switch to use function <span 
class="cmmi-10">R </span>= <span 
class="cmmi-10">R</span>(<span 
class="cmmi-10">Z</span>)
instead of <span 
class="cmmi-10">Z </span>= <span 
class="cmmi-10">Z</span>(<span 
class="cmmi-10">R</span>) when the slope of <span 
class="cmmi-10">Z </span>= <span 
class="cmmi-10">Z</span>(<span 
class="cmmi-10">R</span>) is large (the switch condition I used is
<span 
class="cmsy-10">|</span><span 
class="cmmi-10">dZ∕dR</span><span 
class="cmsy-10">| </span><span 
class="cmmi-10">&#x003E; </span>1).
</p><!--l. 2804--><p class="indent" >   In constructing the ﬂux surface coordinate with desired Jacobian, we will need the absolute value of
the gradient of <span 
class="cmmi-10">Ψ</span>, <span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">|</span>, on some speciﬁed spatial points. To achieve this, we need to construct a
interpolating function for <span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">|</span>. The <span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">| </span>can be written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-61002r243"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium341x.png" alt="       ∘ ----------------
         (∂ Ψ)2   (∂ Ψ)2
|∇Ψ | =   ---   +  ---  ,
          ∂R       ∂Z
" class="math-display"  /></center></td><td class="equation-label">(243)</td></tr></table>
<!--l. 2812--><p class="nopar" >
By using the center diﬀerence scheme to evaluate the partial derivatives with respect to <span 
class="cmmi-10">R </span>and <span 
class="cmmi-10">Z </span>in the
above equation (using one side diﬀerence scheme for the points on the rectangular boundary), we can
obtain an 2D array for the value of <span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">| </span>on the rectangular (<span 
class="cmmi-10">R,Z</span>) grids. Using this 2D array,
we can construct an interpolating function for <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">Ψ </span>by using the cubic spline interpolation
scheme.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-610038"></a>
                                                                                

                                                                                
<!--l. 2821--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/read_gfile/fig2/plt.png" alt="pict"  
 width="180.67499pt" /> <img 
src="my_figure/home/yj/project_new/read_gfile/fig40/plt.png" alt="pict"  
 width="180.67499pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 8: </span><span  
class="content">Grid points (the intersecting points of two curves in the ﬁgure) corresponding to uniform
poloidal ﬂux and uniform poloidal arc length for EAST equilibrium shot 13606 at 7.1s (left)
(G-ﬁle name: g013606.07104) and shot 38300 at 3.9s (right) (G-ﬁle name: g038300.03900).</span></div><!--tex4ht:label?: x1-610038 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-610049"></a>
                                                                                

                                                                                
<!--l. 2829--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/read_gfile/fig41/p2.png" alt="pict"  
 width="251.94124pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 9: </span><span  
class="content"><span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">| </span>as a function of the poloidal angle. The diﬀerent lines corresponds to the values
of <span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">| </span>on diﬀerent magnetic surfaces. The stars correspond to the values on the boundary
magnetic surface while the plus signs correspond to the value on the innermost magnetic surface
(the magnetic surface adjacent to the magnetic axis). The equilibrium is for EAST shot 38300
at 3.9s.</span></div><!--tex4ht:label?: x1-610049 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-6100510"></a>
                                                                                

                                                                                
<!--l. 2839--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/read_gfile/fig41/p3.png" alt="pict"  
 width="251.94124pt" />                             <img 
src="my_figure/home/yj/project_new/read_gfile/fig41/p4.png" alt="pict"  
 width="251.94124pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 10: </span><span  
class="content">The Poloidal magnetic ﬁeld <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">p</span></sub> = <span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">|</span><span 
class="cmmi-10">∕R </span>(left) and toroidal magnetic ﬁeld <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">ϕ</span></sub> = <span 
class="cmmi-10">g∕R</span>
(right) as a function of the poloidal angle. The diﬀerent lines corresponds to the values on diﬀerent
magnetic surfaces. The stars correspond to the values on the boundary magnetic surface while
the plus signs correspond to the value on the innermost magnetic surface (the magnetic surface
adjacent to the magnetic axis). The equilibrium is for EAST shot 38300 at 3.9s.</span></div><!--tex4ht:label?: x1-6100510 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
<!--l. 2849--><p class="indent" >    
</p><!--l. 2851--><p class="indent" >    
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-6100611"></a>
                                                                                

                                                                                
<!--l. 2854--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/read_gfile/fig41/tmp.png" alt="pict"  
 width="251.94124pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 11: </span><span  
class="content">Equal-arc Jacobian as a function of the poloidal angle on diﬀerent magnetic surfaces.
The dotted line corresponds to the values of Jacobian on the boundary magnetic surface. The
equilibrium is for EAST shot 38300 at 3.9s.</span></div><!--tex4ht:label?: x1-6100611 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-6100712"></a>
                                                                                

                                                                                
<!--l. 2862--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/read_gfile/fig32/tmp.png" alt="pict"  
 width="251.94124pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 12: </span><span  
class="content"><span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">| </span>as a function of the poloidal angle. The diﬀerent lines corresponds to values of
<span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">| </span>on diﬀerent magnetic surfaces. The stars correspond to the values of <span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">| </span>on the boundary
magnetic surface while the plus signs correspond to the value on the innermost magnetic surface
(the magnetic surface adjacent to the magnetic axis). The equilibrium is a Solovev equilibrium.</span></div><!--tex4ht:label?: x1-6100712 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
<!--l. 2871--><p class="indent" >    
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-6100813"></a>
                                                                                

                                                                                
<!--l. 2874--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/read_gfile/fig29/tmp.png" alt="pict"  
 width="251.94124pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 13:  </span><span  
class="content">Jacobian  on  diﬀerent  magnetic  surfaces  as  a  function  of  the  poloidal  angle.  The
equilibrium  is  a  Solovev  equilibrium  and  the  Jacobian  is  an  equal-arc  Jacobian.  The  stars
correspond to the values of Jacobian on the boundary magnetic surface while the plus signs
correspond to the value on the innermost magnetic surface (the magnetic surface adjacent to the
magnetic axis).</span></div><!--tex4ht:label?: x1-6100813 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
<!--l. 2883--><p class="indent" >    
</p>
   <h4 class="subsectionHead"><span class="titlemark">9.2   </span> <a 
 id="x1-620009.2"></a>Expression of metric elements of magnetic coordinates (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>)</h4>
<!--l. 2888--><p class="noindent" >Metric elements of the (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates, e.g., <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">𝜃</span>, are often needed in practical calculations.
Next, we express these metric elements in terms of the cylindrical coordinates (<span 
class="cmmi-10">R,Z</span>) and their partial
derivatives with respect to <span 
class="cmmi-10">ψ </span>and <span 
class="cmmi-10">𝜃</span>. Note that, in this case, the coordinate system is (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) while <span 
class="cmmi-10">R</span>
and <span 
class="cmmi-10">Z </span>are functions of <span 
class="cmmi-10">ψ </span>and <span 
class="cmmi-10">𝜃</span>, i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62001r244"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium342x.png" alt="R = R (ψ,𝜃),
" class="math-display"  /></center></td><td class="equation-label">(244)</td></tr></table>
<!--l. 2896--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62002r245"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium343x.png" alt="Z = R (ψ,𝜃).
" class="math-display"  /></center></td><td class="equation-label">(245)</td></tr></table>
<!--l. 2899--><p class="nopar" >
Then <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">R </span>and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">Z </span>are written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62003r246"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium344x.png" alt="      ˆ
∇R  = R = Rψ∇ ψ + R𝜃∇ 𝜃,
" class="math-display"  /></center></td><td class="equation-label">(246)</td></tr></table>
<!--l. 2904--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62004r247"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium345x.png" alt="∇Z  = ˆZ = Zψ∇ ψ + Z𝜃∇𝜃,
" class="math-display"  /></center></td><td class="equation-label">(247)</td></tr></table>
<!--l. 2908--><p class="nopar" >
wehre <span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">ψ</span></sub> <span 
class="cmsy-10">≡ </span><span 
class="cmmi-10">∂R∕∂ψ</span>, etc. Equations (<a 
href="#x1-62003r246">246<!--tex4ht:ref: 4-19-e10 --></a>) and (<a 
href="#x1-62004r247">247<!--tex4ht:ref: 4-19-e11 --></a>) can be solved to give
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62005r248"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium346x.png" alt="           1
∇ψ =  R-Z--−-Z-R--(Z 𝜃Rˆ − R 𝜃ˆZ),
       ψ 𝜃    ψ 𝜃
" class="math-display"  /></center></td><td class="equation-label">(248)</td></tr></table>
<!--l. 2914--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62006r249"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium347x.png" alt="     -----1------    ˆ     ˆ
∇𝜃 = ZψR 𝜃 − R ψZ𝜃(ZψR − R ψZ).
" class="math-display"  /></center></td><td class="equation-label">(249)</td></tr></table>
<!--l. 2918--><p class="nopar" >
Using the above expressions, the Jacobian of (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates, <span 
class="cmsy-10">𝒥 </span>, is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium348x.png" alt="  −1
𝒥    = ∇ψ × ∇𝜃 ⋅∇ϕ
     = −-------1-------(Z  R ˆϕ − R Z  ˆϕ)× ϕˆ
        (RψZ 𝜃 − ZψR 𝜃)2 𝜃 ψ     𝜃 ψ     R
               1
     = −(Z𝜃R-ψ −-R-𝜃Z-ψ)R,                                (250)
" class="math-display"  /></center>
</div>i.e.,
   <table 
class="equation"><tr><td><a 
 id="x1-62008r251"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium349x.png" alt="𝒥 = R (R 𝜃Zψ − R ψZ𝜃).
" class="math-display"  /></center></td><td class="equation-label">(251)</td></tr></table>
<!--l. 2932--><p class="nopar" >
Using this, Expressions (<a 
href="#x1-62005r248">248<!--tex4ht:ref: 4-19-e2 --></a>) and (<a 
href="#x1-62006r249">249<!--tex4ht:ref: 4-19-e3 --></a>) are written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62009r252"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium350x.png" alt="        R
∇ ψ = − 𝒥 (Z 𝜃Rˆ− R 𝜃ˆZ)
" class="math-display"  /></center></td><td class="equation-label">(252)</td></tr></table>
<!--l. 2937--><p class="nopar" >
and
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62010r253"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium351x.png" alt="∇𝜃 = R-(ZψRˆ− R ψˆZ).
     𝒥
" class="math-display"  /></center></td><td class="equation-label">(253)</td></tr></table>
<!--l. 2942--><p class="nopar" >
Then the elements of the metric matrix are written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62011r254"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium352x.png" alt="        R2
|∇ψ|2 = 𝒥2(Z2𝜃 + R2𝜃),
" class="math-display"  /></center></td><td class="equation-label">(254)</td></tr></table>
<!--l. 2947--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62012r255"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium353x.png" alt="|∇ 𝜃|2 = R2-(Z2 +R2 ),
       𝒥 2  ψ    ψ
" class="math-display"  /></center></td><td class="equation-label">(255)</td></tr></table>
<!--l. 2951--><p class="nopar" >
and
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62013r256"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium354x.png" alt="            2
∇ψ ⋅∇ 𝜃 = − R-(Z 𝜃Z ψ + R 𝜃Rψ).
           𝒥2
" class="math-display"  /></center></td><td class="equation-label">(256)</td></tr></table>
<!--l. 2956--><p class="nopar" >
Equations (<a 
href="#x1-62011r254">254<!--tex4ht:ref: 4-19-e7 --></a>), (<a 
href="#x1-62012r255">255<!--tex4ht:ref: 4-19-e8 --></a>), and (<a 
href="#x1-62013r256">256<!--tex4ht:ref: 4-19-e9 --></a>) are the expressions of the metric elements in terms of <span 
class="cmmi-10">R</span>, <span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">ψ</span></sub>, <span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">𝜃</span></sub>, <span 
class="cmmi-10">Z</span><sub><span 
class="cmmi-7">ψ</span></sub>,
and <span 
class="cmmi-10">Z</span><sub><span 
class="cmmi-7">𝜃</span></sub>. [Combining the above results, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62014r257"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium355x.png" alt="∇ψ ⋅∇ 𝜃    Z Z  + R R
-----2-= − -𝜃--ψ2---𝜃2-ψ.
 |∇ ψ|         Z𝜃 + R 𝜃
" class="math-display"  /></center></td><td class="equation-label">(257)</td></tr></table>
<!--l. 2964--><p class="nopar" >
Equation (<a 
href="#x1-62013r256">256<!--tex4ht:ref: 4-19-e9 --></a>) is used in GTAW code. Using the above results, <span 
class="cmmi-10">h</span><sup><span 
class="cmmi-7">αβ</span></sup> = <img 
src="tokamak_equilibrium356x.png" alt="𝒥-
R2"  class="frac" align="middle" /><span 
class="cmsy-10">∇</span><span 
class="cmmi-10">α </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">β </span>are written
as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62015r258"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium357x.png" alt="       𝒥         1
hψ ψ =--2|∇ψ|2 = -(Z2𝜃 + R2𝜃)
      R          𝒥
" class="math-display"  /></center></td><td class="equation-label">(258)</td></tr></table>
<!--l. 2971--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62016r259"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium358x.png" alt="      𝒥         1
h𝜃𝜃 = -2|∇ 𝜃|2 = -(Z2ψ + R2ψ ),
      R         𝒥
" class="math-display"  /></center></td><td class="equation-label">(259)</td></tr></table>
<!--l. 2975--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-62017r260"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium359x.png" alt="      𝒥             1
hψ𝜃 = R2-∇ψ ⋅∇ 𝜃 = − 𝒥-(Z 𝜃Z ψ + R 𝜃Rψ)
" class="math-display"  /></center></td><td class="equation-label">(260)</td></tr></table>
<!--l. 2979--><p class="nopar" >
As a side product of the above results, we can calculate the arc length in the poloidal plane along a
constant <span 
class="cmmi-10">ψ </span>surface, <span 
class="cmmi-10">dℓ</span><sub><span 
class="cmmi-7">p</span></sub>, which is expressed as </p><div class="eqnarray">
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium360x.png" alt="     ∘ ------------
dℓp =  (dR)2 + (dZ)2
     ∘ -------------2---------------2
   =   (Rψdψ + R𝜃d𝜃) + (Zψdψ + Z𝜃d𝜃) .
" class="math-display"  /></center>
</div>Note that <span 
class="cmmi-10">dψ </span>= 0 since we are considering the arc length along a constant <span 
class="cmmi-10">ψ </span>surface in (<span 
class="cmmi-10">R,Z</span>) plane.
Then the above expression is reduced to <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium361x.png" alt="      ∘----------------
dℓp =  (R-𝜃d𝜃)2 +(Z𝜃d𝜃)2
      ∘  2    2
    =  R 𝜃 + Z𝜃d𝜃
    = |𝒥-∇-ψ|d𝜃,                                (261)
        R
" class="math-display"  /><a 
 id="x1-62019r261"></a></center>
</div>which agrees with Eq. (<a 
href="#x1-50004r214">214<!--tex4ht:ref: 5-30-p1 --></a>).]
<!--l. 2999--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">9.3   </span> <a 
 id="x1-630009.3"></a>Constructing model tokamak magnetic ﬁeld</h4>
<!--l. 3001--><p class="noindent" >In some cases (e.g., turbulence simulation), model tokamak magnetic ﬁeld, which is not an exact
solution to the GS equation, is often used. In the model, the safety factor proﬁle <span 
class="cmmi-10">q</span>(<span 
class="cmmi-10">ψ</span>),
toroidal ﬁeld function <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">ψ</span>), and the magnetic surface shape (<span 
class="cmmi-10">R</span>(<span 
class="cmmi-10">ψ,𝜃</span>)<span 
class="cmmi-10">,Z</span>(<span 
class="cmmi-10">ψ,𝜃</span>)) are given. To
use this model in a simulation, we need to calculate its poloidal magnetic ﬁeld, which is
determined by the poloidal magnetic ﬂux function <span 
class="cmmi-10">Ψ</span>. To determine <span 
class="cmmi-10">Ψ</span>, we need to use Eq. (<a 
href="#x1-49001r206">206<!--tex4ht:ref: 7-11-p1 --></a>),
i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-63001r262"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium362x.png" alt="         1 g ∫ 2π 𝒥
q(ψ) = −2π-Ψ′     R2d𝜃,
               0
" class="math-display"  /></center></td><td class="equation-label">(262)</td></tr></table>
<!--l. 3012--><p class="nopar" >
and re-organize the formula as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-63002r263"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium363x.png" alt="              ∫
dΨ-= − -1-g(ψ-)  2π-𝒥-d𝜃,
dψ     2π q(ψ ) 0  R2
" class="math-display"  /></center></td><td class="equation-label">(263)</td></tr></table>
<!--l. 3017--><p class="nopar" >
which can be integrated to obtain <span 
class="cmmi-10">Ψ </span>and thus the poloidal magnetic ﬁeld <span 
class="cmbx-10">B</span><sub><span 
class="cmmi-7">p</span></sub> = <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">Ψ </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">ϕ</span>, where
<span 
class="cmsy-10">𝒥 </span>= [(<span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">𝜃</span>) <span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ϕ</span>]<sup><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span></sup>. The toroidal magnetic ﬁeld can be obtained from <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">ψ</span>) by <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">ϕ</span></sub> = <span 
class="cmmi-10">g∕R</span>. In most
papers, <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">ψ</span>) is chosen to be a constant.
</p><!--l. 3024--><p class="indent" >   A typical magnetic surface shape used in simulations is the Miller shape, which is given
by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-63003r264"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium364x.png" alt="                          −1
R (r,𝜃) = R0 (r)+ r cos[𝜃+ (sin δ(r))sin𝜃]
Z (r,𝜃) = κ(r)rsin 𝜃
" class="math-display"  /></center></td><td class="equation-label">(264)</td></tr></table>
                                                                                

                                                                                
<!--l. 3032--><p class="nopar" >
where <span 
class="cmmi-10">r </span>= <span 
class="cmmi-10">ψ </span>is the radial coordinate, <span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">0</span></sub>(<span 
class="cmmi-10">r</span>), <span 
class="cmmi-10">δ</span>(<span 
class="cmmi-10">r</span>), and <span 
class="cmmi-10">κ</span><sub><span 
class="cmmi-7">r</span></sub>(<span 
class="cmmi-10">r</span>) are the Shafronov shift, triangularity, and
elongation proﬁles, which can be arbitrarily speciﬁed. For the special case of <span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">0</span></sub> being a constant,
<span 
class="cmmi-10">δ</span>(<span 
class="cmmi-10">r</span>) = 0, and <span 
class="cmmi-10">κ</span>(<span 
class="cmmi-10">r</span>) = 1, this shape reduces to a concentric-circular magnetic ﬁeld. An example of
calculating the poloidal ﬁeld of the model ﬁeld is given in Sec. <span 
class="cmbx-10">??</span>. This kind of model ﬁeld can be
called theoretical physicists’ tokamak. Computational physicists often use this model for
code benchmarking purpose. The famous DIII-D cyclone base case is an example, which
was extensively used for benchmarking gyrokinetic simulation of ion temperature driven
turbulence.
</p><!--l. 3044--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">10   </span> <a 
 id="x1-6400010"></a>Magnetic surface averaging</h3>
<!--l. 3046--><p class="noindent" >Magnetic surface average of a physical quantity <span 
class="cmmi-10">G</span>(<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) is deﬁned by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-64001r265"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium365x.png" alt="           ( ∫ ∫ ∫      )
                 ΔψGd3V
⟨G ⟩ ≡ Δliψm→0  ∫-∫ ∫--d3V-- ,
                 Δ ψ
" class="math-display"  /></center></td><td class="equation-label">(265)</td></tr></table>
<!--l. 3052--><p class="nopar" >
where the volume integration is over a small volume between two adjacent ﬂux surfaces with <span 
class="cmmi-10">ψ </span>diﬀering
by <span 
class="cmsy-10">△</span><span 
class="cmmi-10">ψ</span>. [This formula (with ﬁnite <span 
class="cmmi-10">Δψ</span>) is used in <span 
class="cmtt-10">TEK</span> code to calculate the radial heat
ﬂux.]
</p><!--l. 3058--><p class="indent" >   The above deﬁnition can be written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-64002r266"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium366x.png" alt="       d ∫
⟨G ⟩ =---   Gd3V,
      dV  V
" class="math-display"  /></center></td><td class="equation-label">(266)</td></tr></table>
                                                                                

                                                                                
<!--l. 3061--><p class="nopar" >
where the volume integration is over the volume enclosed by the magnetic surface labeled by
<span 
class="cmmi-10">ψ</span>.
</p><!--l. 3065--><p class="indent" >   The above 3D volume integration can be written as a 2D surface integration. The diﬀerential
volume element is given by <span 
class="cmmi-10">d</span><sup><span 
class="cmr-7">3</span></sup><span 
class="cmmi-10">V </span>= <span 
class="cmsy-10">|𝒥|</span><span 
class="cmmi-10">dψd𝜃dϕ</span>, where <span 
class="cmsy-10">𝒥 </span>is the Jacobian of (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates.
equation (<a 
href="#x1-64001r265">265<!--tex4ht:ref: 6-14-2 --></a>) is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium367x.png" alt="          (                         )
            ∫2π∫ 2π ∫ψ+Δψ G|𝒥 |dψd𝜃dϕ
⟨G ⟩ = Δlψim→0 (-0∫2π0∫2π∫ψψ+Δψ-----------)
              0  0  ψ     |𝒥 |dψd 𝜃dϕ
     ∫ 2π ∫2πG |𝒥 |d𝜃dϕ
   = -0∫2π∫02π---------,                                (267)
       0  0  |𝒥 |d𝜃dϕ
" class="math-display"  /><a 
 id="x1-64003r267"></a></center>
</div>which is a 2D averaging over a magnetic surface. Noting that <span 
class="cmsy-10">𝒥 </span>is independent of <span 
class="cmmi-10">ϕ</span>, expression (<a 
href="#x1-64003r267">267<!--tex4ht:ref: 23-1-4-1 --></a>)
can be written as
   <table 
class="equation"><tr><td><a 
 id="x1-64004r268"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium368x.png" alt="      ∫
      -20πG0-|𝒥-|d𝜃-
⟨G⟩ =  ∫2π|𝒥 |d𝜃  ,
        0
" class="math-display"  /></center></td><td class="equation-label">(268)</td></tr></table>
<!--l. 3084--><p class="nopar" >
where <span 
class="cmmi-10">G</span><sub><span 
class="cmr-7">0</span></sub>(<span 
class="cmmi-10">ψ,𝜃</span>) <span 
class="cmsy-10">≡ </span>(2<span 
class="cmmi-10">π</span>)<sup><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span></sup> <span 
class="cmex-10">∫</span>
   <sub><span 
class="cmr-7">0</span></sub><sup><span 
class="cmr-7">2</span><span 
class="cmmi-7">π</span></sup><span 
class="cmmi-10">G</span>(<span 
class="cmmi-10">ψ,𝜃,ϕ</span>)<span 
class="cmmi-10">dϕ</span>, which is the <span 
class="cmmi-10">n </span>= 0 harmonic of <span 
class="cmmi-10">G</span>, where <span 
class="cmmi-10">n </span>is the toroidal
mode number. Note that the surface averaging of any <span 
class="cmmi-10">n</span><span 
class="cmmi-10">≠</span>0 harmonic is zero. I.e., only the <span 
class="cmmi-10">n </span>= 0
harmonic can contribute to the magnetic surface average.
</p><!--l. 3091--><p class="indent" >   In ﬂux coordinates, Eq. (<a 
href="#x1-64002r266">266<!--tex4ht:ref: 25-5-18-p1 --></a>) can be written as </p><div class="eqnarray">
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium369x.png" alt="      dψ d ∫ ψ ∫ 2π ∫ 2π
⟨G⟩ = ------           G|𝒥|dψd𝜃dϕ
      dV d∫ψ2π0∫ 2π0   0
   =  dψ-        G|𝒥|d𝜃dϕ
      dV  0   0
      2π∫ 2π
   =  V′-   G0 |𝒥 |d𝜃,                                (269)
         0
" class="math-display"  /><a 
 id="x1-64005r269"></a></center>
</div>where <span 
class="cmmi-10">V </span><span 
class="cmsy-10">′ </span>= <span 
class="cmmi-10">dV∕dψ</span>. (For the surface average, in some parts of these notes, I assume that the Jacobian is
postive and thus the absolute value operator is dropped. In most part of this document, axisymmetry is
assumed for <span 
class="cmmi-10">G</span>, i.e., <span 
class="cmmi-10">G </span>= <span 
class="cmmi-10">G</span><sub><span 
class="cmr-7">0</span></sub>.)
<!--l. 3116--><p class="indent" >   The volume within a magnetic surface is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-64006r270"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium370x.png" alt="       ∫ ∫  ∫               ∫ ψ∫ 2π
V (ψ) =       |𝒥 |d𝜃dϕdψ = 2π        |𝒥 |d𝜃dψ.
                             ψ0 0
" class="math-display"  /></center></td><td class="equation-label">(270)</td></tr></table>
<!--l. 3116--><p class="nopar" >
Then the diﬀerential of <span 
class="cmmi-10">V </span>with respect to <span 
class="cmmi-10">ψ </span>is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-64007r271"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium371x.png" alt="     dV     ∫ 2π
V′ ≡ ---= 2π    |𝒥|d𝜃.
     dψ      0
" class="math-display"  /></center></td><td class="equation-label">(271)</td></tr></table>
                                                                                

                                                                                
<!--l. 3116--><p class="nopar" >
</p><!--l. 3118--><p class="indent" >    
</p><!--l. 3120--><p class="indent" >   Sometimes, we do not want the Jacobian to explicitly appear in the formula. This can be achieved
by using  Eq. (<a 
href="#x1-50004r214">214<!--tex4ht:ref: 5-30-p1 --></a>), i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-64008r272"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium372x.png" alt="|𝒥 |d𝜃 = -R--dl,
        |∇ ψ| p
" class="math-display"  /></center></td><td class="equation-label">(272)</td></tr></table>
<!--l. 3124--><p class="nopar" >
Then expression (<a 
href="#x1-64004r268">268<!--tex4ht:ref: 25-4-11-p3 --></a>) is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium373x.png" alt="     ∫ 2π
     -0--G0|R∇ψ|dlp
⟨G ⟩ =  ∫2π-R--dl
     ∫  0 |∇ψ| p
      02π G0B1p dlp
   = --∫2π-1----.                           (273)
        0 Bpdlp
" class="math-display"  /><a 
 id="x1-64009r273"></a></center>
</div>(Equation (<a 
href="#x1-64009r273">273<!--tex4ht:ref: 10-16-3 --></a>) is used in GTAW code<span class="cite">[<span 
class="cmbx-10">?</span>]</span>.)
<!--l. 3134--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">10.1   </span> <a 
 id="x1-6500010.1"></a>Expression of surface-averaged parallel current density</h4>
<!--l. 3136--><p class="noindent" >The parallel current density appears in the ﬂux diﬀusion equation. Let us derive a formula for it in the
ﬂux coordinates. Using <span 
class="cmmi-10">μ</span><sub><span 
class="cmr-7">0</span></sub><span 
class="cmbx-10">J </span>= <span 
class="cmsy-10">∇× </span><span 
class="cmbx-10">B</span>, along with magnetic ﬁeld expression (<a 
href="#x1-47002r200">200<!--tex4ht:ref: 5-6-2 --></a>) and the curl formula
(<a 
href="#x1-43001r162">162<!--tex4ht:ref: 4-16-2 --></a>), we obtain </p><div class="eqnarray">
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium374x.png" alt="        [ ∂ (   𝒥      )   ∂ (   𝒥        )]
μ0J = −  ∂ψ- Ψ′R2-|∇ ψ|2 +  ∂𝜃- Ψ′R2∇ ψ ⋅∇𝜃   ∇ψ × ∇ 𝜃− g′∇ ϕ ×∇ ψ,   (274)
" class="math-display"  /><a 
 id="x1-65001r274"></a></center>
</div>where <span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">′ </span>= <span 
class="cmmi-10">dΨ∕dψ</span>, <span 
class="cmmi-10">g</span><span 
class="cmsy-10">′ </span>= <span 
class="cmmi-10">dg∕dψ</span>. Expression (<a 
href="#x1-65001r274">274<!--tex4ht:ref: 4-16-p2 --></a>) is the contravariant form of <span 
class="cmbx-10">J</span>. Taking dot product
between Eqs. (<a 
href="#x1-47002r200">200<!--tex4ht:ref: 5-6-2 --></a>) and (<a 
href="#x1-65001r274">274<!--tex4ht:ref: 4-16-p2 --></a>), we obtain <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium375x.png" alt="           [ ∂-( ′-𝒥-    2)   ∂-(  ′ 𝒥-      )]
μ0J ⋅B = −  ∂ψ  Ψ R2 |∇ ψ|  +  ∂𝜃  Ψ R2∇ ψ ⋅∇𝜃   g∇ψ × ∇ 𝜃⋅∇ϕ
            (    𝒥      )
         − g′ − Ψ′-2|∇ ψ|2 ∇ ϕ× ∇ ψ⋅∇ 𝜃
           [   ( R        )     (            )]
       = −  ∂-- Ψ′-𝒥-|∇ ψ|2 +  ∂-- Ψ′ 𝒥-∇ ψ ⋅∇𝜃  g𝒥− 1
            ∂ψ    R2          ∂𝜃    R2
           ′ − 1 ′ 𝒥-   2
         +g 𝒥  Ψ  R2|∇ψ|
           2  −1{ 1 ∂ (  ′ 𝒥    2)   1 ∂ (  ′ 𝒥       )   g′ ′ 𝒥     2}
       = − g 𝒥    g∂ψ- Ψ  R2|∇ψ |  + g∂𝜃- Ψ  R2∇ ψ⋅∇ 𝜃  − g2Ψ R2-|∇ ψ|
                [ ∂ ( Ψ′ 𝒥      )   ∂ ( Ψ′𝒥         )]
       = − g2𝒥 −1---  ----2|∇ ψ|2 +  --- ----2∇ψ ⋅∇ 𝜃  .                (275)
                 ∂ψ   g R           ∂𝜃  g R
" class="math-display"  /></center>
</div>Using the deﬁntion of the magnetic surface average, Eq. (<a 
href="#x1-64005r269">269<!--tex4ht:ref: 25-5-14-e1 --></a>), i.e.,
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
                              <span 
class="cmsy-10">⟨</span><span 
class="cmmi-10">.</span><span 
class="cmsy-10">⟩ </span>= <img 
src="tokamak_equilibrium376x.png" alt="2π-
V ′"  class="frac" align="middle" /><span 
class="cmex-10">∫</span>
    <sub><span 
class="cmr-7">0</span></sub><sup><span 
class="cmr-7">2</span><span 
class="cmmi-7">π</span></sup>(<span 
class="cmmi-10">.</span>)<span 
class="cmsy-10">|𝒥|</span><span 
class="cmmi-10">d𝜃</span>
</td></tr></table>
<!--l. 3178--><p class="nopar" >
we obtain </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium377x.png" alt="            ⟨       d ( Ψ′𝒥      ) ⟩
⟨μ0J ⋅B ⟩ = −  g2𝒥 −1---  ----2|∇ ψ|2
               ∫ 2π dψ   g R   (          )
        = − 2π-    |𝒥 |g2𝒥 −1-d-  Ψ′𝒥--|∇ ψ|2  d𝜃
            V ′ 0          dψ   g R2
            2π 2 d ( Ψ′∫ 2π |𝒥 |   2  )
        = − V-′g dψ-  g-     R2-|∇ ψ|d𝜃
             2   (  ′   0 ∫ 2π          )
        = − g--d-- Ψ-V ′2π-    |𝒥-||∇ψ |2d𝜃
            V ′dψ(  g  V⟨′ 0  ⟩R2)
            g2-d-- Ψ′  ′ |∇ψ-|2
        = − V ′dψ   g V   R2     ,                        (276)
" class="math-display"  /><a 
 id="x1-65003r276"></a></center>
</div>which agrees with Eq. (5) in Ref. <span class="cite">[<span 
class="cmbx-10">?</span>]</span>.
<!--l. 3199--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">11   </span> <a 
 id="x1-6600011"></a>Flux Surface Functions</h3>
<!--l. 3201--><p class="noindent" >This is an interesting way of deﬁning ﬂux within a magnetic surface using volume integration, instend
of surface integration. Examine the meaning of the following volume integral:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-66001r277"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium378x.png" alt="          ∫
D (ψ) ≡ 1--  B ⋅∇𝜃dτ,
        2π V
" class="math-display"  /></center></td><td class="equation-label">(277)</td></tr></table>
<!--l. 3207--><p class="nopar" >
where the volume <span 
class="cmmi-10">V </span>= <span 
class="cmmi-10">V </span>(<span 
class="cmmi-10">ψ</span>) is the volume within the magnetic surface labeled by <span 
class="cmmi-10">ψ</span>. Using <span 
class="cmsy-10">∇⋅ </span><span 
class="cmbx-10">B </span>= 0,
the quantity <span 
class="cmmi-10">D </span>can be further written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-66002r278"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium379x.png" alt="       ∫
D = -1-   ∇ ⋅(𝜃B )dτ.
    2π  V
" class="math-display"  /></center></td><td class="equation-label">(278)</td></tr></table>
<!--l. 3214--><p class="nopar" >
Note that <span 
class="cmmi-10">𝜃 </span>is not a single-value function of the spacial points. In order to evaluate the integration in
Eq. (<a 
href="#x1-66002r278">278<!--tex4ht:ref: 4-17-p1 --></a>), we need to select one branch of <span 
class="cmmi-10">𝜃</span>, which can be chosen to be 0 <span 
class="msam-10">≤ </span><span 
class="cmmi-10">𝜃 &#x003C; </span>2<span 
class="cmmi-10">π</span>. Note that
function <span 
class="cmmi-10">𝜃 </span>= <span 
class="cmmi-10">𝜃</span>(<span 
class="cmmi-10">R,Z</span>) is not continuous at the branch cut <span 
class="cmmi-10">𝜃 </span>= 0. Next, we want to use the
divergence theorem to convert the above volume integration to surface integration. Noting the
discontinuity of the integrand <span 
class="cmmi-10">𝜃</span><span 
class="cmbx-10">B </span>at <span 
class="cmmi-10">𝜃 </span>= 0, the volume should be cut there, thus, generating
two surfaces. Denote these two surfaces by <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">1</span></sub> and <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">2</span></sub>, then equation (<a 
href="#x1-66002r278">278<!--tex4ht:ref: 4-17-p1 --></a>) is written as
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium380x.png" alt="     1 ∫           1 ∫            1 ∫
D = ---   𝜃B ⋅dS+  ---  𝜃B ⋅dS + ---   𝜃B ⋅dS,
    2π  S1         2π S2         2π  S3
" class="math-display"  /></center>
</div>where the orientation of surface <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">1</span></sub> is in the negative direction of <span 
class="cmmi-10">𝜃</span>, the orientation of <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">2</span></sub> is in the
positive direction of <span 
class="cmmi-10">𝜃</span>, and the surface <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">3</span></sub> is the toroidal magnetic surface <span 
class="cmmi-10">ψ </span>= <span 
class="cmmi-10">ψ</span><sub><span 
class="cmr-7">0</span></sub>. The surface
integration through <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">3</span></sub> is obviously zero since <span 
class="cmbx-10">B </span>lies in this surface. Therefore, we have
<div class="eqnarray">
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium381x.png" alt="       ∫             ∫
    -1-           -1-
D = 2π  S1 𝜃B ⋅dS+ 2π S2 𝜃B ⋅dS + 0
     1 ∫           1 ∫
  = 2π-   0B ⋅dS+ 2π-   2πB ⋅dS
    ∫   S1            S2
  =    B ⋅dS.                                       (279)
     S2
" class="math-display"  /><a 
 id="x1-66004r279"></a></center>
</div>Eq. (<a 
href="#x1-66004r279">279<!--tex4ht:ref: 4-18-4 --></a>) indicates that <span 
class="cmmi-10">D </span>is the magnetic ﬂux through the <span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">2</span></sub> surface. This is the ﬂux <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmr-7">axis</span><span 
class="cmr-7">)</span></sup> deﬁned
by Eq. (<a 
href="#x1-8006r25">25<!--tex4ht:ref: 12-30-2 --></a>), i.e.,
   <table 
class="equation"><tr><td><a 
 id="x1-66005r280"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium382x.png" alt="           ∫
 (axis)  -1-
Ψp    = 2π  V B ⋅∇ 𝜃dτ.
" class="math-display"  /></center></td><td class="equation-label">(280)</td></tr></table>
<!--l. 3248--><p class="nopar" >
[We can also directly verify <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub><sup><span 
class="cmr-7">(</span><span 
class="cmr-7">axis</span><span 
class="cmr-7">)</span></sup> deﬁned by Eq. (<a 
href="#x1-66005r280">280<!--tex4ht:ref: 25-5-17-p3 --></a>) is the poloidal ﬂux, without using the
divergence theorem. Using the expression of the volume element <span 
class="cmmi-10">dτ </span>= <span 
class="cmsy-10">|𝒥|</span><span 
class="cmmi-10">d𝜃dϕdψ</span>, </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium383x.png" alt="          ∫
Ψ(axis)=  1--  B ⋅∇𝜃|𝒥 |d𝜃dϕdψ
 p      2π  V
       ∫ ψ   ∫ 2π
     =  0  dψ 0  B ⋅∇ 𝜃|𝒥 |d𝜃
       ∫ ψ   ∫ 2π
     =     dψ    Ψ ′∇ ψ ×∇ ϕ ⋅∇𝜃|𝒥|d𝜃
        0     0 ∫     ∫
                  ψ     2π  ′
     = − sign(𝒥 ) 0 dψ  0  Ψ (ψ )d𝜃
                  ∫ ψ
     = − 2πsign (𝒥 )   Ψ ′(ψ)dψ
                   0
     = − 2πsign (𝒥 )[Ψ (ψ )− Ψ(0)].                       (281)
" class="math-display"  /><a 
 id="x1-66006r281"></a></center>
</div>Note that the sign of the Jacobian appears in Eq. (<a 
href="#x1-66006r281">281<!--tex4ht:ref: 4-10-p11 --></a>), which is due to the positive direction of surface
<span 
class="cmmi-10">S</span><sub><span 
class="cmr-7">2</span></sub> is determined by the positive direction of <span 
class="cmmi-10">𝜃</span>, which in turn is determined by the sign of the Jacobian
(In my code, however, the positive direction of <span 
class="cmmi-10">𝜃 </span>is chosen by me and the sign of the Jacobian is
determined by the positive direction of <span 
class="cmmi-10">𝜃</span>). We can verify the sign of Eq. (<a 
href="#x1-66006r281">281<!--tex4ht:ref: 4-10-p11 --></a>) is consistent with that in
Eq. (<a 
href="#x1-8006r25">25<!--tex4ht:ref: 12-30-2 --></a>).]
<!--l. 3275--><p class="indent" >    
</p><!--l. 3277--><p class="indent" >   Similarly, the toroidal ﬂux within a ﬂux surface is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium384x.png" alt="         ∫
Φ(ψ) = 1--  B ⋅∇ϕd τ                         (282)
       2π  V
       1-∫  -g-
    =  2π  V R2 dτ.                           (283)
" class="math-display"  /></center>
</div>In ﬂux coordinates, <span 
class="cmmi-10">Φ </span>is written as <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium385x.png" alt="          ∫
Φ(ψ) = -1-  -g-|𝒥 |d𝜃dϕdψ
       2π   R2
       ∫ ψ   ∫ 2π -g-
     =  0 dψ  0  R2 |𝒥 |d𝜃
       ∫ ψ[   ′⟨   ⟩ ]
     =     gV--  12-  dψ,                       (284)
        0   2π   R
" class="math-display"  /><a 
 id="x1-66008r284"></a></center>
</div>from which, we can also obtain
   <table 
class="equation"><tr><td><a 
 id="x1-66009r285"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium386x.png" alt="dΦ    V ′⟨ 1 ⟩
dψ-= g2π-  R2- ,
" class="math-display"  /></center></td><td class="equation-label">(285)</td></tr></table>
<!--l. 3296--><p class="nopar" >
and
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-66010r286"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium387x.png" alt="dΦ   dΦ dψ     1 ⟨  1⟩
dV-= dψ-dV-= g 2π- R2- .
" class="math-display"  /></center></td><td class="equation-label">(286)</td></tr></table>
<!--l. 3301--><p class="nopar" >
Using <span 
class="cmmi-10">dΦ∕dΨ </span>= 2<span 
class="cmmi-10">πq</span>, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-66011r287"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium388x.png" alt="                    ⟨    ⟩
-dΨ = dΨ-dΦ-= -g--1-- -12 .
dV    dΦ dV   2πq 2π  R
" class="math-display"  /></center></td><td class="equation-label">(287)</td></tr></table>
<!--l. 3306--><p class="nopar" >
Similarly, the toroidal current within a ﬂux surface is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-66012r288"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium389x.png" alt="       1 ∫
I(ψ) =---   J⋅∇ ϕdτ.
      2π  V
" class="math-display"  /></center></td><td class="equation-label">(288)</td></tr></table>
<!--l. 3311--><p class="nopar" >
Let us express <span 
class="cmmi-10">I</span>(<span 
class="cmmi-10">ψ</span>) in ﬂux coordinates: </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium390x.png" alt="       1 ∫
I(ψ) = 2π-  J ⋅∇ϕdτ
         ∫ Vρ ∫ 2π ∫ 2π
     = 1--           J⋅∇ ϕ|𝒥 |dψd𝜃dϕ
       2∫π ∫0  0   0
         ψ  2π
     =  0  0  J ⋅∇ϕ|𝒥|dψd𝜃                           (289)
       ∫ ψV ′
     =    ---⟨J ⋅∇ϕ ⟩dψ.                               (290)
        0 2π
" class="math-display"  /><a 
 id="x1-66013r290"></a></center>
</div>Use Eq. (<a 
href="#x1-17003r51">51<!--tex4ht:ref: 6-9-a1 --></a>), i.e.,
   <table 
class="equation"><tr><td><a 
 id="x1-66014r291"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium391x.png" alt="        1   ∗
Jϕ = − μ0R△  Ψ.
" class="math-display"  /></center></td><td class="equation-label">(291)</td></tr></table>
<!--l. 3327--><p class="nopar" >
and Eq. (<a 
href="#x1-73004r341">341<!--tex4ht:ref: 25-5-22-e1 --></a>), i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-66015r292"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium392x.png" alt="         {    [          ]     [              ]}
△⋆Ψ = R2-  -∂- dΨ-𝒥-|∇ ψ|2  + ∂-- dΨ-𝒥-(∇ψ ⋅∇ 𝜃)  ,
       𝒥   ∂ψ  dψ R2         ∂𝜃  dψR2
" class="math-display"  /></center></td><td class="equation-label">(292)</td></tr></table>
<!--l. 3335--><p class="nopar" >
then <span 
class="cmbx-10">J </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ϕ </span>is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium393x.png" alt="        Jϕ
J⋅∇ ϕ = R--
         1    ∗
      = μ0R2△  Ψ
         1  { ∂  [dΨ 𝒥      ]   ∂ [dΨ  𝒥         ]}
      = ----  --- ----2|∇ψ |2 +  --------2(∇ ψ ⋅∇𝜃)
        μ0𝒥   ∂ψ  dψ R          ∂𝜃 dψ R
" class="math-display"  /></center>
</div>Then the surface average is written as <div class="eqnarray">
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium394x.png" alt="          2π∫ 2π
⟨J ⋅∇ ϕ⟩ = V′-   J ⋅∇ ϕ|𝒥 |d𝜃
            ∫02π   {    [          ]     [              ]}
       =  2π-    1-- ∂-- dΨ-𝒥-|∇ ψ|2  + ∂-- dΨ-𝒥-(∇ψ ⋅∇ 𝜃)  d𝜃
          V′∫0   μ0{ ∂ψ [dψ R2     ]}  ∂𝜃  dψR2
          2π- 2π 1-- ∂-- dΨ-𝒥--   2
       =  V′ 0   μ0  ∂ψ  dψ R2|∇ ψ|   d𝜃
          1 2π ∂  (dΨ ∫ 2π |∇ ψ|2    )
       =  ----′--- ---     --2--𝒥d𝜃
          μ0V  ∂ψ [dψ  0⟨   R  ⟩]
       =  1--1-∂-- dΨ-V′  |∇-ψ|2  .                                (293)
          μ0V ′∂ψ  dψ      R2
" class="math-display"  /></center>
</div>Using this in Eq. (<a 
href="#x1-66013r290">290<!--tex4ht:ref: 25-5-22-e3 --></a>), we obtain <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium395x.png" alt="       ∫ ψV ′1  1  ∂ [dΨ   ⟨ |∇ ψ|2⟩]
I(ψ) =    -------′--- ---V′  --2--   dψ
        0 2π∫μ0ψV  ∂ψ[  dψ ⟨    R ⟩]
     = 1--1-    ∂-- dΨV ′  |∇-ψ|2-  dψ
       μ02π  0  ∂ψ  dψ      R2
       1  1 dΨ  ′⟨ |∇ ψ|2⟩
     = μ02π-dψ-V   -R2--  − 0.                         (294)
" class="math-display"  /><a 
 id="x1-66018r294"></a></center>
</div>
<!--l. 3379--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">12   </span> <a 
 id="x1-6700012"></a>Magnetic ﬂux diﬀusion equation</h3>
                                                                                

                                                                                
<!--l. 3381--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">12.1   </span> <a 
 id="x1-6800012.1"></a>In laboratory static coordinate system</h4>
<!--l. 3383--><p class="noindent" >Faraday’s law
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-68001r295"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium396x.png" alt="∇ × E = − ∂B-,
          ∂t
" class="math-display"  /></center></td><td class="equation-label">(295)</td></tr></table>
<!--l. 3387--><p class="nopar" >
can be written in the integral form:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-68002r296"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium397x.png" alt="∮
           ∂Ψp-
  E ⋅dl = − ∂t ,
" class="math-display"  /></center></td><td class="equation-label">(296)</td></tr></table>
<!--l. 3392--><p class="nopar" >
where <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub> is the ﬂux linked with the loop. Choosing an axisymmetric loop along <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ϕ</span>, and assuming <span 
class="cmbx-10">E </span>is
axisymmetric, Eq. (<a 
href="#x1-68002r296">296<!--tex4ht:ref: 25-5-15-e1 --></a>) is written as
</p>
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
                                 <img 
src="tokamak_equilibrium398x.png" alt="∂-Ψp
 ∂t"  class="frac" align="middle" /> = <span 
class="cmsy-10">−</span>2<span 
class="cmmi-10">πRE</span><sub><span 
class="cmmi-7">ϕ</span></sub>
</td></tr></table>
<!--l. 3396--><p class="nopar" >
i.e.,
</p>
   <table 
class="equation-star"><tr><td>
                               <img 
src="tokamak_equilibrium399x.png" alt="∂Ψp-
 ∂t"  class="frac" align="middle" /> = <span 
class="cmsy-10">−</span>2<span 
class="cmmi-10">πR</span><sup><span 
class="cmr-7">2</span></sup><span 
class="cmbx-10">E </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ϕ,</span>
</td></tr></table>
<!--l. 3399--><p class="nopar" >
Using <span 
class="cmmi-10">∂Ψ</span><sub><span 
class="cmmi-7">p</span></sub><span 
class="cmmi-10">∕∂t </span>= 2<span 
class="cmmi-10">π∂Ψ∕∂t</span>, the above equation is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-68003r297"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium400x.png" alt="∂Ψ-     2
 ∂t = − R E ⋅∇ ϕ.
" class="math-display"  /></center></td><td class="equation-label">(297)</td></tr></table>
<!--l. 3405--><p class="nopar" >
Use Ohm’s law
</p>
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
                                 <span 
class="cmbx-10">E </span>+ <span 
class="cmbx-10">u </span><span 
class="cmsy-10">× </span><span 
class="cmbx-10">B </span>= <span 
class="cmbx-10">R</span><span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 3407--><p class="nopar" >
(where <span 
class="cmbx-10">R </span>stands for all the terms on the rhs of Ohm’s law, typically <span 
class="cmbx-10">R </span>= <span 
class="cmmi-10">η</span>(<span 
class="cmbx-10">J </span><span 
class="cmsy-10">− </span><span 
class="cmbx-10">J</span><sub><span 
class="cmr-7">ni</span></sub>), where <span 
class="cmbx-10">J </span>is the
total current density and <span 
class="cmbx-10">J</span><sub><span 
class="cmr-7">ni</span></sub> is the non-inductive part), to eliminate <span 
class="cmbx-10">E</span>, then Eq. (<a 
href="#x1-68003r297">297<!--tex4ht:ref: 25-5-13-p1 --></a>) is written
as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-68004r298"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium401x.png" alt="∂Ψ
---= − R2 (R − u × B) ⋅∇ϕ.
∂t
" class="math-display"  /></center></td><td class="equation-label">(298)</td></tr></table>
<!--l. 3418--><p class="nopar" >
Using <span 
class="cmbx-10">B </span>= <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">Ψ </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">ϕ </span>+ <span 
class="cmmi-10">g</span><span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ϕ </span>to eliminate <span 
class="cmbx-10">B </span>on the rhs, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-68005r299"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium402x.png" alt="∂ Ψ
--- = − R2R ⋅∇ϕ + R2((∇ Ψ × ∇ϕ) ×∇ ϕ)⋅u.
 ∂t
" class="math-display"  /></center></td><td class="equation-label">(299)</td></tr></table>
<!--l. 3424--><p class="nopar" >
Noting that <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">Ψ </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ϕ </span>= 0, the above equation is simpliﬁed to
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-68006r300"></a>
   <center class="math-display" >
                                                                                

                                                                                
<img 
src="tokamak_equilibrium403x.png" alt="∂Ψ-= − R2R ⋅∇ ϕ− u ⋅∇Ψ.
 ∂t
" class="math-display"  /></center></td><td class="equation-label">(300)</td></tr></table>
<!--l. 3430--><p class="nopar" >
This is an evolution equation for the poloidal ﬂux function <span 
class="cmmi-10">Ψ </span>in the lab frame.
</p><!--l. 3434--><p class="indent" >   Next, let us derive an evolution equation for the toroidal ﬁeld function <span 
class="cmmi-10">g </span><span 
class="cmsy-10">≡ </span><span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">ϕ</span></sub><span 
class="cmmi-10">R</span>. The <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ϕ </span>projection
of Faraday’s law (<a 
href="#x1-68001r295">295<!--tex4ht:ref: 25-5-16-1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-68007r301"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium404x.png" alt="∂-
∂t(B ⋅∇ϕ ) = − ∇ ϕ⋅∇ × E,
" class="math-display"  /></center></td><td class="equation-label">(301)</td></tr></table>
<!--l. 3440--><p class="nopar" >
i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-68008r302"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium405x.png" alt="∂ ( g )
∂t  R2- = ∇ ⋅(∇ϕ × E).
" class="math-display"  /></center></td><td class="equation-label">(302)</td></tr></table>
<!--l. 3445--><p class="nopar" >
Use Ohm’s law to eliminate <span 
class="cmbx-10">E</span>, then Eq. (<a 
href="#x1-68008r302">302<!--tex4ht:ref: 25-5-16-5 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-68009r303"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium406x.png" alt="   (   )
-∂  -g- = ∇ ⋅(∇ ϕ× (R − u ×B )),
∂t  R2
" class="math-display"  /></center></td><td class="equation-label">(303)</td></tr></table>
<!--l. 3451--><p class="nopar" >
i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-68010r304"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium407x.png" alt="∂ ( g )      (                     g  )
∂t  R2- = ∇ ⋅ ∇ϕ × R + (u⋅∇ ϕ)B − R2u  .
" class="math-display"  /></center></td><td class="equation-label">(304)</td></tr></table>
<!--l. 3457--><p class="nopar" >
</p><!--l. 3459--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">12.2   </span> <a 
 id="x1-6900012.2"></a>Transform to time-dependent magnetic coordinates</h4>
<!--l. 3461--><p class="noindent" >Next, let us write Eqs. (<a 
href="#x1-68006r300">300<!--tex4ht:ref: 25-5-16-3 --></a>) and (<a 
href="#x1-68010r304">304<!--tex4ht:ref: 25-5-16-4 --></a>) in a general magnetic coordinate system (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) that is
time-dependent (relative to the laboratory static coordinate system). Why do we need a magnetic
coordinate system? Because it makes it easy to perform the magnetic surface average when we derive
1D transport equations. Then why do we require the magnetic coordinates to be time-dependent?
Because the magnetic surface shapes are evolving, and thus a static transform can not remain conform
to the evolving shapes.
</p><!--l. 3470--><p class="indent" >   For a time-dependent coordinate transform:
</p>
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
                                   <span 
class="cmbx-10">x</span>(<span 
class="cmmi-10">ψ,𝜃,ϕ,t</span>)<span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 3471--><p class="nopar" >
where <span 
class="cmbx-10">x </span>stands for a laboratory static Cartesian coordinate system (<span 
class="cmmi-10">x,y,z</span>), it follows that
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium408x.png" alt="  ||         ||          ||
∂f||    =  ∂f|| + ∂f-⋅ ∂x||
∂t ψ,𝜃,ϕ   ∂t|x  ∂x   ∂t ψ,𝜃,ϕ
          ∂f||
       =  ∂t|x + uc ⋅∇f,                          (305)
" class="math-display"  /></center>
</div>where
   <table 
class="equation"><tr><td><a 
 id="x1-69002r306"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium409x.png" alt="     ∂x ||
uc ≡ ∂t-||   ,
        ψ,𝜃,ϕ
" class="math-display"  /></center></td><td class="equation-label">(306)</td></tr></table>
<!--l. 3486--><p class="nopar" >
is the coordinate velocity. Further deﬁne
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69003r307"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium410x.png" alt="ur ≡ u − uc,
" class="math-display"  /></center></td><td class="equation-label">(307)</td></tr></table>
<!--l. 3490--><p class="nopar" >
which is the ﬂuid velocity observed in (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinate system.
</p><!--l. 3494--><p class="indent" >   Note that the ﬂux evolution equation (<a 
href="#x1-68006r300">300<!--tex4ht:ref: 25-5-16-3 --></a>) is written in a laboratory static coordinate system,
i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69004r308"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium411x.png" alt="   |
∂-Ψ||      2
 ∂t|x = − R R ⋅∇ ϕ− u ⋅∇Ψ.
" class="math-display"  /></center></td><td class="equation-label">(308)</td></tr></table>
<!--l. 3499--><p class="nopar" >
Then in time-dependent (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinate system, the above equation is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69005r309"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium412x.png" alt="∂Ψ||                  2
∂t||    − uc ⋅∇Ψ = − R R ⋅∇ϕ − u ⋅∇Ψ,
   ψ,𝜃,ϕ
" class="math-display"  /></center></td><td class="equation-label">(309)</td></tr></table>
<!--l. 3506--><p class="nopar" >
Noting <span 
class="cmbx-10">u </span>= <span 
class="cmbx-10">u</span><sub><span 
class="cmmi-7">c</span></sub> + <span 
class="cmbx-10">u</span><sub><span 
class="cmmi-7">r</span></sub>, the above equation is simpliﬁed to
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69006r310"></a>
   <center class="math-display" >
                                                                                

                                                                                
<img 
src="tokamak_equilibrium413x.png" alt="  |
∂Ψ||         2
∂t|ψ,𝜃,ϕ = − R R ⋅∇ ϕ− ur ⋅∇Ψ.
" class="math-display"  /></center></td><td class="equation-label">(310)</td></tr></table>
<!--l. 3513--><p class="nopar" >
</p><!--l. 3516--><p class="indent" >   Now we restrict (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) to be ﬂux coordinates (i.e., contours of <span 
class="cmmi-10">ψ </span>are contours of <span 
class="cmmi-10">Ψ</span>) and remain
ﬂux coordinates when both <span 
class="cmmi-10">ψ </span>and <span 
class="cmmi-10">Ψ </span>evolve. Then the rhs of Eq. (<a 
href="#x1-69006r310">310<!--tex4ht:ref: 25-5-16-p5 --></a>) must be chosen to be
independent of <span 
class="cmmi-10">𝜃</span>, i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69007r311"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium414x.png" alt="   2
− R R ⋅∇ ϕ− ur ⋅∇Ψ = f(ψ,t),
" class="math-display"  /></center></td><td class="equation-label">(311)</td></tr></table>
<!--l. 3523--><p class="nopar" >
where <span 
class="cmmi-10">f</span>(<span 
class="cmmi-10">ψ,t</span>) is a function to be determined. For later use, multiplying the above equation by
<span 
class="cmmi-10">g∕R</span><sup><span 
class="cmr-7">2</span></sup>:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69008r312"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium415x.png" alt="           g           g
− R ⋅g∇ ϕ − R2ur ⋅∇Ψ = R2-f(ψ),
" class="math-display"  /></center></td><td class="equation-label">(312)</td></tr></table>
<!--l. 3529--><p class="nopar" >
and performing the magnetic surface average on it, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69009r313"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium416x.png" alt="            ⟨         ⟩   ⟨       ⟩
− ⟨R ⋅g∇ϕ ⟩− -g-ur ⋅∇ Ψ =  -g-f(ψ) .
             R2            R2
" class="math-display"  /></center></td><td class="equation-label">(313)</td></tr></table>
<!--l. 3535--><p class="nopar" >
</p><!--l. 3538--><p class="indent" >   Next, consider the evolution equation for <span 
class="cmmi-10">g</span>, Eq. (<a 
href="#x1-68010r304">304<!--tex4ht:ref: 25-5-16-4 --></a>), which can be written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69010r314"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium417x.png" alt="       |
∂-( g-)||      (                           -g- )
∂t  R2 |x = ∇ ⋅ ∇ϕ × R + ((ur +uc) ⋅∇ϕ)B − R2 u ,
" class="math-display"  /></center></td><td class="equation-label">(314)</td></tr></table>
<!--l. 3545--><p class="nopar" >
We note that <span 
class="cmbx-10">u</span><sub><span 
class="cmmi-7">c</span></sub> <span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ϕ </span>= 0. Then the above equation is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69011r315"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium418x.png" alt="∂ ( g )||      (                      g  )
∂t R2- || = ∇ ⋅ ∇ ϕ ×R  +(ur ⋅∇ϕ)B − R2-u ,
        x
" class="math-display"  /></center></td><td class="equation-label">(315)</td></tr></table>
<!--l. 3553--><p class="nopar" >
To facilitate later use, we multiply the above equation by the Jacobian J of (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates:
</p>
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
                <span 
class="cmsy-10">𝒥</span><img 
src="tokamak_equilibrium419x.png" alt="       |
∂-( g-)||
∂t  R2 |"  class="left" align="middle" /><sub><span 
class="cmbx-7">x</span></sub> = <span 
class="cmsy-10">𝒥∇⋅</span><img 
src="tokamak_equilibrium420x.png" alt="(                     g-- )
 ∇ ϕ× R + (ur ⋅∇ ϕ)B − R2u"  class="left" align="middle" /><span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 3559--><p class="nopar" >
i.e.,
</p>
   <table 
class="equation-star"><tr><td>
           <img 
src="tokamak_equilibrium421x.png" alt="∂ (   g )||
-- 𝒥 --2 ||
∂t   R"  class="left" align="middle" /><sub><span 
class="cmbx-7">x</span></sub> <span 
class="cmsy-10">−</span><img 
src="tokamak_equilibrium422x.png" alt="g
-2-
R"  class="frac" align="middle" /><img 
src="tokamak_equilibrium423x.png" alt="∂𝒥 ||
---||
∂t"  class="left" align="middle" /><sub><span 
class="cmbx-7">x</span></sub> = <span 
class="cmsy-10">𝒥∇⋅</span><img 
src="tokamak_equilibrium424x.png" alt="(                      g  )
 ∇ ϕ ×R  +(ur ⋅∇ϕ)B − --2u
                      R"  class="left" align="middle" /><span 
class="cmmi-10">.</span>
</td></tr></table>
<!--l. 3565--><p class="nopar" >
Tansforming to time-dependent (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinate system, the above equation is written as
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium425x.png" alt="                                   (                  )
   ∂ (  g )||           (   g )   g   ∂𝒥 ||
  ∂t  𝒥 R2-||    − uc ⋅∇ 𝒥 R2- −  R2- -∂t||    − uc ⋅∇ 𝒥 .
      (     ψ,𝜃,ϕ                )        ψ,𝜃,ϕ
= 𝒥∇ ⋅  ∇ϕ × R + (ur ⋅∇ϕ)B − -g-u  .                            (316)
                            R2
" class="math-display"  /><a 
 id="x1-69012r316"></a></center>
</div>For notation ease, the subscripts (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) of the time derivative is dropped in the following, with the
understanding that the time derivatives are taken with (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) held ﬁxed. Equation (<a 
href="#x1-69012r316">316<!--tex4ht:ref: 25-5-17-1 --></a>) simpliﬁes to
<div class="eqnarray">
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium426x.png" alt="  ∂ (   g )         ( g )    g ∂𝒥
  ∂t 𝒥 R2- − uc ⋅𝒥∇   R2- − R2-∂t-
      (                     -g- )
= 𝒥∇ ⋅ ∇ ϕ × R + (ur ⋅∇ϕ)B − R2 u .
" class="math-display"  /></center>
</div>Noting that <span 
class="cmbx-10">u </span>= <span 
class="cmbx-10">u</span><sub><span 
class="cmmi-7">c</span></sub> + <span 
class="cmbx-10">u</span><sub><span 
class="cmmi-7">r</span></sub>, the above equation is written as <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium427x.png" alt="   ∂ (  g )         ( g )   g ∂ 𝒥
  --  𝒥 -2- − uc ⋅𝒥 ∇ --2 −  -2---
  ∂t   (R            R      Rg ∂t)       ( g   )
= 𝒥 ∇ ⋅ ∇ϕ × R + (ur ⋅∇ ϕ)B − R2ur  − 𝒥 ∇ ⋅ R2-uc
" class="math-display"  /></center>
</div>which simpliﬁes to <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium428x.png" alt="    (     )
  ∂-  𝒥-g-  − g--∂𝒥-
  ∂t   R(2     R2 ∂t              )
= 𝒥 ∇ ⋅ ∇ϕ × R + (ur ⋅∇ϕ )B − -g2ur − 𝒥 -g2∇ ⋅uc.            (317)
                            R         R
" class="math-display"  /><a 
 id="x1-69015r317"></a></center>
</div>Use the well known relation (to be proved):
   <table 
class="equation"><tr><td><a 
 id="x1-69016r318"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium429x.png" alt="∂-𝒥 = 𝒥 ∇ ⋅u ,
 ∂t         c
" class="math-display"  /></center></td><td class="equation-label">(318)</td></tr></table>
<!--l. 3614--><p class="nopar" >
then Eq. (<a 
href="#x1-69015r317">317<!--tex4ht:ref: 25-5-16-p2 --></a>) simpliﬁes to
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69017r319"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium430x.png" alt="  (     )       (                          )
∂- 𝒥 -g- = 𝒥 ∇ ⋅ ∇ ϕ× R + (ur ⋅∇ ϕ)B −-gur
∂t   R2                               R2
" class="math-display"  /></center></td><td class="equation-label">(319)</td></tr></table>
<!--l. 3621--><p class="nopar" >
Integrating Eq. (<a 
href="#x1-69017r319">319<!--tex4ht:ref: 25-5-16-e1 --></a>) over <span 
class="cmmi-10">𝜃</span>:
</p>
   <table 
class="equation-star"><tr><td>
          <span 
class="cmex-10">∫</span>
            <sub><span 
class="cmr-7">0</span></sub><sup><span 
class="cmr-7">2</span><span 
class="cmmi-7">π</span></sup><img 
src="tokamak_equilibrium431x.png" alt="∂
∂t"  class="frac" align="middle" /><img 
src="tokamak_equilibrium432x.png" alt="(   g )
 𝒥 R2-"  class="left" align="middle" /><span 
class="cmmi-10">d𝜃 </span>= <span 
class="cmex-10">∫</span>
  <sub><span 
class="cmr-7">0</span></sub><sup><span 
class="cmr-7">2</span><span 
class="cmmi-7">π</span></sup><span 
class="cmsy-10">𝒥∇⋅</span><img 
src="tokamak_equilibrium433x.png" alt="(                      g   )
 ∇ ϕ ×R + (ur ⋅∇ϕ)B − R2-ur"  class="left" align="middle" /><span 
class="cmmi-10">d𝜃,</span>
</td></tr></table>
<!--l. 3626--><p class="nopar" >
we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69018r320"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium434x.png" alt="   (∫          )  ∫
-∂    2π  -g-       2π     (                     -g-  )
∂t   0  𝒥 R2 d𝜃 =   0  𝒥∇ ⋅ ∇ ϕ× R + (ur ⋅∇ ϕ)B − R2 ur d𝜃
" class="math-display"  /></center></td><td class="equation-label">(320)</td></tr></table>
<!--l. 3633--><p class="nopar" >
Using the deﬁntion of the surface average, Eq. (<a 
href="#x1-64005r269">269<!--tex4ht:ref: 25-5-14-e1 --></a>), i.e.,
</p>
   <table 
class="equation-star"><tr><td>
                               <span 
class="cmsy-10">⟨</span><span 
class="cmmi-10">.</span><span 
class="cmsy-10">⟩ </span>= <img 
src="tokamak_equilibrium435x.png" alt="2π
-′-
V"  class="frac" align="middle" /><span 
class="cmex-10">∫</span>
    <sub><span 
class="cmr-7">0</span></sub><sup><span 
class="cmr-7">2</span><span 
class="cmmi-7">π</span></sup>(<span 
class="cmmi-10">.</span>)<span 
class="cmsy-10">𝒥</span><span 
class="cmmi-10">d𝜃</span>
</td></tr></table>
<!--l. 3636--><p class="nopar" >
(where <span 
class="cmmi-10">V </span><span 
class="cmsy-10">′ </span>= <span 
class="cmmi-10">dV∕dψ</span>, <span 
class="cmmi-10">V </span>is the volume enclosed by surface <span 
class="cmmi-10">ψ</span>), Eq. (<a 
href="#x1-69018r320">320<!--tex4ht:ref: 25-5-18-e1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69019r321"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium436x.png" alt=" 1 ∂             V′ ⟨   (                     g   )⟩
-----(V ′g⟨R −2⟩) = --- ∇ ⋅ ∇ϕ × R + (ur ⋅∇ ϕ)B −-2ur   .
2π ∂t            2π                           R
" class="math-display"  /></center></td><td class="equation-label">(321)</td></tr></table>
<!--l. 3644--><p class="nopar" >
Noting the relation (proof is given in Sec. <span 
class="cmbx-10">??</span>):
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69020r322"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium437x.png" alt="         1--∂-  ′
⟨∇ ⋅A⟩ = V′∂ψ (V ⟨A  ⋅∇ ψ⟩),
" class="math-display"  /></center></td><td class="equation-label">(322)</td></tr></table>
<!--l. 3650--><p class="nopar" >
Eq. (<a 
href="#x1-69019r321">321<!--tex4ht:ref: 25-5-16-e3 --></a>) is written as
</p>
   <table 
class="equation-star"><tr><td>
        <img 
src="tokamak_equilibrium438x.png" alt="-1-
2π"  class="frac" align="middle" /><img 
src="tokamak_equilibrium439x.png" alt="∂-
∂t"  class="frac" align="middle" />(<span 
class="cmmi-10">V </span><span 
class="cmsy-10">′</span><span 
class="cmmi-10">g</span><span 
class="cmsy-10">⟨</span><span 
class="cmmi-10">R</span><sup><span 
class="cmsy-7">−</span><span 
class="cmr-7">2</span></sup><span 
class="cmsy-10">⟩</span>) = <img 
src="tokamak_equilibrium440x.png" alt="V-′
2π"  class="frac" align="middle" /><img 
src="tokamak_equilibrium441x.png" alt="1--
V′"  class="frac" align="middle" /><img 
src="tokamak_equilibrium442x.png" alt="-∂-
∂ψ"  class="frac" align="middle" /><img 
src="tokamak_equilibrium443x.png" alt="(  ′⟨(                     g-- )     ⟩)
 V    ∇ ϕ× R + (ur ⋅∇ ϕ)B − R2ur ⋅∇ ψ"  class="left" align="middle" />
</td></tr></table>
<!--l. 3656--><p class="nopar" >
Noting that <span 
class="cmbx-10">B </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ψ </span>= 0, the above equation is simpliﬁed to
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-69021r323"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium444x.png" alt=" ∂             ∂  [  ⟨                g       ⟩]
∂t(V ′g⟨R− 2⟩) = ∂ψ- V′ (∇ ψ× ∇ ϕ)⋅R − R2-ur ⋅∇ ψ .
" class="math-display"  /></center></td><td class="equation-label">(323)</td></tr></table>
<!--l. 3664--><p class="nopar" >
                                                                                

                                                                                
</p><!--l. 3666--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">12.3   </span> <a 
 id="x1-7000012.3"></a>Choice of coordinates</h4>
<!--l. 3668--><p class="noindent" >The toroidal magnetic ﬂux is given by Eq. (<a 
href="#x1-66008r284">284<!--tex4ht:ref: 25-5-17-p4 --></a>), i.e.,
</p>
   <table 
class="equation-star"><tr><td>
                            <span 
class="cmmi-10">Φ </span>= <span 
class="cmex-10">∫</span>
  <sub><span 
class="cmr-7">0</span></sub><sup><span 
class="cmmi-7">ψ</span></sup><img 
src="tokamak_equilibrium445x.png" alt="[   ′⟨   ⟩]
 gV-- -1-
  2π  R2"  class="left" align="middle" /><span 
class="cmmi-10">dψ.</span>
</td></tr></table>
<!--l. 3670--><p class="nopar" >
Then the time partial derivative in (<span 
class="cmmi-10">ψ,𝜃,ϕ,t</span>) coordinates is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium446x.png" alt="        ( ∫  [    ⟨   ⟩ ]  )
∂-Φ = ∂-    ψ gV-′  1--  dψ
 ∂t   ∂t   0   2π   R2
        ∫ ψ   [    ⟨   ⟩]
    = 1--   ∂- gV ′ -1-   dψ.                     (324)
      2π  0 ∂t      R2
" class="math-display"  /><a 
 id="x1-70001r324"></a></center>
</div>Use Eq. (<a 
href="#x1-69021r323">323<!--tex4ht:ref: 25-5-16-p4 --></a>), then Eq. (<a 
href="#x1-70001r324">324<!--tex4ht:ref: 25-5-20-1 --></a>) is written as <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium447x.png" alt="        ∫
∂Φ-  -1-  ψ ∂--[ ′⟨               -g-      ⟩]
∂t = 2π  0  ∂ψ V   (∇ψ × ∇ ϕ)⋅R − R2 ur ⋅∇ ψ dψ
      1   ′⟨               g        ⟩||ψ= ψ
   = 2π-V   (∇ ψ × ∇ϕ) ⋅R − R2ur ⋅∇ψ  |ψ=0
      1   ⟨                g       ⟩
   = 2π-V′ (∇ ψ× ∇ ϕ)⋅R − R2-ur ⋅∇ ψ ,                     (325)
" class="math-display"  /><a 
 id="x1-70002r325"></a></center>
</div>where use has been made of the fact that <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span>= 0 at <span 
class="cmmi-10">ψ </span>= 0.
<!--l. 3695--><p class="indent" >   If we choose <span 
class="cmmi-10">ψ </span>as the toroidal magnetic ﬂux, i.e., <span 
class="cmmi-10">ψ </span>= <span 
class="cmmi-10">Φ </span>(or more general <span 
class="cmmi-10">ψ </span>= <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">Φ</span>), where <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">.</span>) is an
arbitrary time-independent monotonical function), then, by deﬁntion
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-70003r326"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium448x.png" alt="∂ Φ
--- = 0.
 ∂t
" class="math-display"  /></center></td><td class="equation-label">(326)</td></tr></table>
<!--l. 3700--><p class="nopar" >
Combining this with Eqs. (<a 
href="#x1-70002r325">325<!--tex4ht:ref: 25-5-20-p2 --></a>), we get
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-70004r327"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium449x.png" alt="                ⟨ g       ⟩
⟨(∇ ψ ×∇ ϕ)⋅R ⟩−  --2ur ⋅∇ ψ = 0.
                 R
" class="math-display"  /></center></td><td class="equation-label">(327)</td></tr></table>
<!--l. 3706--><p class="nopar" >
This is a condition that the coordinate velocity <span 
class="cmbx-10">u</span><sub><span 
class="cmmi-7">c</span></sub> (and thus <span 
class="cmbx-10">u</span><sub><span 
class="cmmi-7">r</span></sub>) satisﬁes when you choose <span 
class="cmmi-10">ψ </span>as
<span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">Φ</span>).
</p><!--l. 3710--><p class="indent" >   Meanwhile, as is discussed above, the requirement of (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) being ﬂux coordinates imposes a
constraint given by Eq. (<a 
href="#x1-69007r311">311<!--tex4ht:ref: 25-5-17-4 --></a>). Next, we combine this constraint with Eq. (<a 
href="#x1-70004r327">327<!--tex4ht:ref: 25-5-16-e8 --></a>) to uniquely determine
<span 
class="cmmi-10">f</span>(<span 
class="cmmi-10">ψ,t</span>) appearing in Eq. (<a 
href="#x1-69007r311">311<!--tex4ht:ref: 25-5-17-4 --></a>). Mutiplying Eq. (<a 
href="#x1-70004r327">327<!--tex4ht:ref: 25-5-16-e8 --></a>) by <span 
class="cmsy-10">−</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">′ </span>and then adding it to Eq. (<a 
href="#x1-69009r313">313<!--tex4ht:ref: 25-5-16-e9 --></a>), we
obtain
                                                                                

                                                                                
</p>
   <table 
class="equation-star"><tr><td>
      <span 
class="cmsy-10">−⟨</span>(<span 
class="cmsy-10">∇</span><span 
class="cmmi-10">Ψ </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">ϕ</span>) <span 
class="cmsy-10">⋅ </span><span 
class="cmbx-10">R</span><span 
class="cmsy-10">⟩ </span>+ <img 
src="tokamak_equilibrium450x.png" alt="⟨          ⟩
  g-ur ⋅∇Ψ
  R2"  class="left" align="middle" /><span 
class="cmsy-10">−⟨</span><span 
class="cmbx-10">R </span><span 
class="cmsy-10">⋅ </span><span 
class="cmmi-10">g</span><span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ϕ</span><span 
class="cmsy-10">⟩−</span><img 
src="tokamak_equilibrium451x.png" alt="⟨         ⟩
 -g-ur ⋅∇ Ψ
 R2"  class="left" align="middle" /> = <img 
src="tokamak_equilibrium452x.png" alt="⟨         ⟩
  g-f(ψ,t)
  R2"  class="left" align="middle" />
</td></tr></table>
<!--l. 3720--><p class="nopar" >
which simpliﬁes to (<span 
class="cmbx-10">u</span><sub><span 
class="cmmi-7">r</span></sub> terms cancel out)
</p>
   <table 
class="equation-star"><tr><td>
                             <span 
class="cmsy-10">−⟨</span><span 
class="cmbx-10">B </span><span 
class="cmsy-10">⋅ </span><span 
class="cmbx-10">R</span><span 
class="cmsy-10">⟩ </span>= <img 
src="tokamak_equilibrium453x.png" alt="⟨ g      ⟩
 R2-f(ψ, t)"  class="left" align="middle" /><span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 3723--><p class="nopar" >
i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-70005r328"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium454x.png" alt="          ⟨B ⋅R⟩
f(ψ,t) = −---−2-.
          g⟨R  ⟩
" class="math-display"  /></center></td><td class="equation-label">(328)</td></tr></table>
                                                                                

                                                                                
<!--l. 3728--><p class="nopar" >
Then the poloidal magnetic ﬂux diﬀusion equation is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-70006r329"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium455x.png" alt="∂Ψ     ⟨B ⋅R ⟩
∂t-= − g⟨R−2⟩.
" class="math-display"  /></center></td><td class="equation-label">(329)</td></tr></table>
<!--l. 3733--><p class="nopar" >
Note that it is in the moving ﬂux coordinates (<span 
class="cmmi-10">Φ,𝜃,ϕ</span>) that the poloidal magnetic ﬂux diﬀusion can be
written in the form given by Eq. (<a 
href="#x1-70006r329">329<!--tex4ht:ref: 25-5-17-e3 --></a>). Before I did the above derivation, I considered Eq. (<a 
href="#x1-70006r329">329<!--tex4ht:ref: 25-5-17-e3 --></a>) (which
appears in many papers) as an approximate equation in static lab frame (approximating the toroidal
component by the parallel component). It turns out that it is an exact equation in the moving
coordinate system.
</p><!--l. 3742--><p class="indent" >   We can switch the role of <span 
class="cmmi-10">Ψ </span>and <span 
class="cmmi-10">Φ </span>and do similar derivation as the above. I.e., we choose <span 
class="cmmi-10">ψ </span>= <span 
class="cmmi-10">h</span><sub><span 
class="cmr-7">2</span></sub>(<span 
class="cmmi-10">Ψ</span>)
and derive an evolution equation for the toroidal ﬂux <span 
class="cmmi-10">Φ</span>. (It would be interesting to do this derivation.
to be done.) But most researchers have chosen <span 
class="cmmi-10">ψ </span>= <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">Φ</span>). Some reasons behind this choice are as
follows. Like the poloidal ﬂux, the toroidal ﬂux is contributed by two parts: coils and plasma. Diﬀerent
from the poloidal ﬂux, the toroidal ﬂux is mainly contributed by the coils. This is because the plasma
poloidal current (which contributes to the toroidal ﬂux) is much smaller than the TF coil currents.
Because TF coil currents usually do not change during one discharge, the toroidal ﬂux <span 
class="cmmi-10">Φ</span>(<span 
class="cmmi-10">R,Z,t</span>)
remains almost constant in a discharge (small variation is contributed by the varying plasma
poloidal current, which is much smaller than the TF coil current). We usually prefer to our
coordinate not moving signiﬁcantly with respect to the lab frame. So we prefer <span 
class="cmmi-10">ψ </span>= <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">Φ</span>) over
<span 
class="cmmi-10">ψ </span>= <span 
class="cmmi-10">h</span><sub><span 
class="cmr-7">2</span></sub>(<span 
class="cmmi-10">Ψ</span>).
</p><!--l. 3758--><p class="indent" >   A confusion I once had: if you choose <span 
class="cmmi-10">ψ </span>= <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">Φ</span>), then <span 
class="cmmi-10">ψ </span>can also be considered as a function of <span 
class="cmmi-10">Ψ</span>
because <span 
class="cmmi-10">Φ </span>is a function of <span 
class="cmmi-10">Ψ</span>. Then why does it matter which one is chosen in the above derivation? The
reason why we can not easily switch between <span 
class="cmmi-10">Φ </span>and <span 
class="cmmi-10">Ψ </span>is that thier relation is time-dependent,
i.e., <span 
class="cmmi-10">Φ </span>= <span 
class="cmmi-10">Φ</span>(<span 
class="cmmi-10">Ψ,t</span>). This time-dependence will show up when we want to switch from one to
another.
</p><!--l. 3765--><p class="indent" >   Assume <span 
class="cmbx-10">R </span>= <span 
class="cmmi-10">η</span>(<span 
class="cmbx-10">J </span><span 
class="cmsy-10">− </span><span 
class="cmbx-10">J</span><sub><span 
class="cmr-7">ni</span></sub>), then Eq. (<a 
href="#x1-70006r329">329<!--tex4ht:ref: 25-5-17-e3 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-70007r330"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium456x.png" alt="∂Ψ-    η⟨B-⋅J⟩    ⟨B-⋅Jni⟩
 ∂t = − g⟨R −2⟩ + η g⟨R−2⟩ .
" class="math-display"  /></center></td><td class="equation-label">(330)</td></tr></table>
<!--l. 3772--><p class="nopar" >
Using Eq. (<a 
href="#x1-65003r276">276<!--tex4ht:ref: 25-5-18-e5 --></a>), the above equation is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-70008r331"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium457x.png" alt="                  (      ⟨     ⟩ )
∂Ψ-=  ---η----g-d-- Ψ′V ′ |∇ψ-|2    +η ⟨B-⋅Jni⟩,
∂t    μ0⟨R −2⟩V ′dψ   g     R2         g⟨R− 2⟩
" class="math-display"  /></center></td><td class="equation-label">(331)</td></tr></table>
<!--l. 3780--><p class="nopar" >
</p><!--l. 3783--><p class="indent" >   Deﬁne <span 
class="cmmi-10">ρ </span>by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-70009r332"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium458x.png" alt="    ∘ -----
      -Φ---
ρ =   πBϕ0,
" class="math-display"  /></center></td><td class="equation-label">(332)</td></tr></table>
<!--l. 3786--><p class="nopar" >
where <span 
class="cmmi-10">B</span><sub><span 
class="cmmi-7">ϕ</span><span 
class="cmr-7">0</span></sub> is typical value of the toroidal ﬁeld (a space-time constant). Since <span 
class="cmmi-10">ρ </span>is a time-independent
function of <span 
class="cmmi-10">Φ</span>, so <span 
class="cmmi-10">ρ </span>can be used as the radial coordinate, i.e., <span 
class="cmmi-10">ψ </span>= <span 
class="cmmi-10">ρ</span>. Then Eq. (<a 
href="#x1-70008r331">331<!--tex4ht:ref: 25-5-22-3 --></a>) is written
as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-70010r333"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium459x.png" alt="                  (  ′⟨    2⟩    )
∂Ψ-= ---η−-2 g′-∂- V--  |∇-ρ2|- ∂-Ψ  + η⟨B-⋅J−n2i⟩,
∂t   μ0⟨R  ⟩ V ∂ρ   g    R     ∂ρ      g⟨R   ⟩
" class="math-display"  /></center></td><td class="equation-label">(333)</td></tr></table>
<!--l. 3799--><p class="nopar" >
which agrees with Eq. (8) in Ref. <span class="cite">[<span 
class="cmbx-10">?</span>]</span>. The radial derivative of volume is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-70011r334"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium460x.png" alt="                                    2
V′ = ∂V = ∂V-∂Φ-=  -2π---2πρBϕ0 = 4π-ρBϕ0,
     ∂ρ   ∂Φ ∂ρ    g⟨R −2⟩         g⟨R −2⟩
" class="math-display"  /></center></td><td class="equation-label">(334)</td></tr></table>
<!--l. 3807--><p class="nopar" >
where use has been made of Eq. (<a 
href="#x1-66010r286">286<!--tex4ht:ref: 25-5-22-4 --></a>), i.e., <span 
class="cmmi-10">dΦ∕dV </span>= <span 
class="cmmi-10">g</span><span 
class="cmsy-10">⟨</span><span 
class="cmmi-10">R</span><sup><span 
class="cmsy-7">−</span><span 
class="cmr-7">2</span></sup><span 
class="cmsy-10">⟩</span><span 
class="cmmi-10">∕</span>(2<span 
class="cmmi-10">π</span>).
</p><!--l. 3811--><p class="indent" >    
</p><!--l. 3814--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">12.4   </span> <a 
 id="x1-7100012.4"></a>Boundary conditions for poloidal magnetic ﬂux diﬀusion equation</h4>
<!--l. 3816--><p class="noindent" > 
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-71001r335"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium461x.png" alt="∂Ψ (Φ,t)   ∂Ψ ∂Φ    1           ρ
------- = ------= ----2ρπBϕ0 = -Bϕ0
   ∂ρ     ∂Φ ∂ρ   2πq          q
" class="math-display"  /></center></td><td class="equation-label">(335)</td></tr></table>
                                                                                

                                                                                
<!--l. 3823--><p class="nopar" >
We know that <span 
class="cmmi-10">Φ </span>= 0 and <span 
class="cmmi-10">ρ </span>= 0 at the magnetic axis. We also know that the safety factor <span 
class="cmmi-10">q </span>is nonzero
at the magnetic axis. Then Eq. (<a 
href="#x1-71001r335">335<!--tex4ht:ref: 25-5-21-p1 --></a>) implies
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-71002r336"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium462x.png" alt="  |
∂Ψ||   = 0,
∂ρ|ρ=0
" class="math-display"  /></center></td><td class="equation-label">(336)</td></tr></table>
<!--l. 3829--><p class="nopar" >
which serves as an inner boundary for the diﬀusion equation (<a 
href="#x1-70010r333">333<!--tex4ht:ref: 25-5-21-p3 --></a>).
</p><!--l. 3833--><p class="indent" >   Using Eq. (<a 
href="#x1-66018r294">294<!--tex4ht:ref: 25-5-23-1 --></a>), the outer boundary condition can be written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-71003r337"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium463x.png" alt="   |
∂Ψ-||    = 2πμ0I(ρ = ρb)∕G(ρ = ρb),
 ∂ρ|ρ= ρb
" class="math-display"  /></center></td><td class="equation-label">(337)</td></tr></table>
<!--l. 3837--><p class="nopar" >
where
</p>
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
                                <span 
class="cmmi-10">G </span>= <span 
class="cmmi-10">V </span><span 
class="cmsy-10">′</span><img 
src="tokamak_equilibrium464x.png" alt="⟨     ⟩
  |∇-ρ|2-
   R2"  class="left" align="middle" /><span 
class="cmmi-10">.</span>
</td></tr></table>
<!--l. 3839--><p class="nopar" >
</p><!--l. 3842--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">13   </span> <a 
 id="x1-7200013"></a>Fixed boundary equilibrium problem</h3>
<!--l. 3844--><p class="noindent" >The ﬁxed boundary equilibrium problem (also called the “inverse equilibrium problem” by some
authors) refers to the case where the shape of a boundary magnetic surface is given and one is asked to
solve the equilibrium within this magnetic surface. To make it convenient to deal with the shape of the
boundary, one usually uses a general coordinates system which has one coordinate surface coinciding
with the given magnetic surface. This makes it trivial to deal with the irregular boundary.
To obtain the equilibrium, one needs to solve the GS equation in the general coordinate
system.
</p><!--l. 3853--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">13.1   </span> <a 
 id="x1-7300013.1"></a>Toroidal elliptic operator in general coordinates</h4>
<!--l. 3855--><p class="noindent" >Next we derive the form of the toroidal elliptic operator <span 
class="cmsy-10">△</span><sup><span 
class="cmmi-7">⋆</span></sup> in a general curvilinear coordinate system.
Speciﬁcally, we consider a curvilinear coordinate system (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>), which is an arbitrary coordinate
system except that <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ϕ </span>is perpendicular to both <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span>and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">𝜃</span>.
</p><!--l. 3861--><p class="indent" >   The toroidal elliptic operator takes the form given by Eq. (<a 
href="#x1-17004r52">52<!--tex4ht:ref: 25-5-24-p1 --></a>), i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-73001r338"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium465x.png" alt="            ( 1    )
△ ∗Ψ ≡ R2∇ ⋅ R2-∇ Ψ  .
" class="math-display"  /></center></td><td class="equation-label">(338)</td></tr></table>
<!--l. 3866--><p class="nopar" >
The gradient of <span 
class="cmmi-10">Ψ </span>is written as (note that <span 
class="cmmi-10">Ψ </span>is independent of <span 
class="cmmi-10">ϕ</span>)
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-73002r339"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium466x.png" alt="     ∂ Ψ      ∂Ψ
∇Ψ = ---∇ ψ + --∇ 𝜃.
      ∂ψ      ∂𝜃
" class="math-display"  /></center></td><td class="equation-label">(339)</td></tr></table>
<!--l. 3872--><p class="nopar" >
Using this expression and the divergence formula (<a 
href="#x1-41003r156">156<!--tex4ht:ref: 6-8-e5 --></a>), the elliptic operator in Eq. (<a 
href="#x1-73001r338">338<!--tex4ht:ref: 4-23-5 --></a>) is written
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium467x.png" alt="            (  1 ∂Ψ       1 ∂Ψ   )
△ ∗Ψ = R2∇ ⋅  -2---∇ ψ + -2---∇ 𝜃
              R( ∂ψ      R  ∂𝜃                 )
     = R2 1-∂-- 𝒥 -1-∂Ψ∇ ψ ⋅∇ψ + 𝒥 1-∂-Ψ∇ 𝜃⋅∇ ψ
          𝒥 ∂ψ(   R2 ∂ψ            R2 ∂𝜃      )
        2 1-∂--   1-∂Ψ-           -1-∂Ψ-
     + R  𝒥 ∂𝜃  𝒥 R2∂ψ ∇ ψ⋅∇ 𝜃+ 𝒥 R2 ∂𝜃∇ 𝜃⋅∇ 𝜃
         2[(          )    (            )  ]
     = R--   Ψψ 𝒥-|∇ ψ|2  +   Ψ𝜃 𝒥-∇ψ ⋅∇𝜃
        𝒥      R2       ψ      R2         ψ
       R2 [(   𝒥        )    (   𝒥      ) ]
     + -𝒥-  Ψ ψR2-∇ψ ⋅∇𝜃   +  Ψ 𝜃R2|∇𝜃|2   .                (340)
                          𝜃              𝜃
" class="math-display"  /><a 
 id="x1-73003r340"></a></center>
</div>where the subscripts denotes partial derivatives, <span 
class="cmsy-10">𝒥 </span>is the Jacobian of the coordinate system
(<span 
class="cmmi-10">ψ,𝜃,ϕ</span>).
<!--l. 3899--><p class="indent" >   In a ﬂux coordinate system, <span 
class="cmmi-10">Ψ </span>is independent of <span 
class="cmmi-10">𝜃</span>, i.e., <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">𝜃</span></sub> = 0. Then the toroidal elliptic operator is
written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-73004r341"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium468x.png" alt="          {                                }
  ⋆    R2  [   𝒥     2]    [  𝒥          ]
△  Ψ = 𝒥--  Ψψ R2|∇ψ |   +  ΨψR2-(∇ ψ ⋅∇𝜃)    ,
                       ψ                  𝜃
" class="math-display"  /></center></td><td class="equation-label">(341)</td></tr></table>
<!--l. 3906--><p class="nopar" >
Using Eq. (<a 
href="#x1-73003r340">340<!--tex4ht:ref: 4-23-4 --></a>), the GS equation (<a 
href="#x1-21006r65">65<!--tex4ht:ref: 7-1-p1 --></a>) is written </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium469x.png" alt="  2[(           )    (            ) ]
 R--  Ψψ-𝒥-|∇ψ|2   +  Ψ𝜃-𝒥-∇ψ ⋅∇ 𝜃
 𝒥      R2       ψ      R2         ψ
  R2 [(   𝒥        )    (   𝒥     )  ]
+ ---  Ψψ -2∇ ψ ⋅∇𝜃   +  Ψ𝜃--2|∇ 𝜃|2
  𝒥       R          𝜃     R        𝜃
= − μ0R2dP-−  dgg,                                    (342)
        dΨ    dΨ
" class="math-display"  /><a 
 id="x1-73005r342"></a></center>
</div>which is the form of the GS equation in (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinate system.
<!--l. 3924--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">13.2   </span> <a 
 id="x1-7400013.2"></a>Finite diﬀerence form of toroidal elliptic operator in general coordinate system</h4>
<!--l. 3926--><p class="noindent" >The toroidal elliptic operator in Eq. (<a 
href="#x1-73003r340">340<!--tex4ht:ref: 4-23-4 --></a>) can be written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-74001r343"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium470x.png" alt="       R2
△ ∗Ψ = ---[(hψψΨψ)ψ + (h 𝜃𝜃Ψ𝜃)𝜃 + (hψ𝜃Ψ𝜃)ψ + (hψ𝜃Ψψ)𝜃],
       𝒥
" class="math-display"  /></center></td><td class="equation-label">(343)</td></tr></table>
<!--l. 3931--><p class="nopar" >
where <span 
class="cmmi-10">h</span><sup><span 
class="cmmi-7">aβ</span></sup> is deﬁned by Eq. (<a 
href="#x1-46005r197">197<!--tex4ht:ref: 4-25-e20 --></a>), i.e.,
</p>
                                                                                

                                                                                
   <table 
class="equation"><tr><td><a 
 id="x1-74002r344"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium471x.png" alt="hαβ = 𝒥-∇ α⋅∇ β.
      R2
" class="math-display"  /></center></td><td class="equation-label">(344)</td></tr></table>
<!--l. 3936--><p class="nopar" >
Next, we derive the ﬁnite diﬀerence form of the toroidal elliptic operator. The ﬁnite diﬀerence form of
the term (<span 
class="cmmi-10">h</span><sup><span 
class="cmmi-7">ψψ</span></sup><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">ψ</span></sub>)<sub><span 
class="cmmi-7">ψ</span></sub> is written </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium472x.png" alt="                [       (           )         (           ) ]
(hψψΨψ)ψ|i,j =-1- hψψ      Ψi,j+1-−-Ψi,j- − hψψ     Ψi,j −-Ψi,j−1
             δψ   i,j+1∕2      δψ          i,j− 1∕2      δψ
           = H ψψ   (Ψi,j+1 − Ψi,j)− H ψψ  (Ψi,j − Ψi,j−1),           (345)
               i,j+1∕2                i,j− 1∕2
" class="math-display"  /></center>
</div>where
   <table 
class="equation"><tr><td><a 
 id="x1-74004r346"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium473x.png" alt="       hψψ
Hψψ = ----2.
      (δψ)
" class="math-display"  /></center></td><td class="equation-label">(346)</td></tr></table>
<!--l. 3952--><p class="nopar" >
The ﬁnite diﬀerence form of (<span 
class="cmmi-10">h</span><sup><span 
class="cmmi-7">𝜃𝜃</span></sup><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">𝜃</span></sub>)<sub><span 
class="cmmi-7">𝜃</span></sub> is written </p><div class="eqnarray">
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium474x.png" alt="              [       (           )          (           )]
(h𝜃𝜃Ψ𝜃)𝜃|i,j = 1- h 𝜃𝜃i+1∕2,j  Ψi+1,j −-Ψi,j − h𝜃i𝜃−1∕2,j  Ψi,j-−-Ψi−1,j
            δ𝜃              δ𝜃                    δ𝜃
          = Hi𝜃𝜃+1∕2,j(Ψi+1,j − Ψi,j)− H𝜃i𝜃−1∕2,j(Ψi,j − Ψi−1,j),             (347)
" class="math-display"  /></center>
</div>where
   <table 
class="equation"><tr><td><a 
 id="x1-74006r348"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium475x.png" alt="H 𝜃𝜃 =-h𝜃𝜃-.
      (δ𝜃)2
" class="math-display"  /></center></td><td class="equation-label">(348)</td></tr></table>
<!--l. 3967--><p class="nopar" >
The ﬁnite diﬀerence form of (<span 
class="cmmi-10">h</span><sup><span 
class="cmmi-7">ψ𝜃</span></sup><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">𝜃</span></sub>)<sub><span 
class="cmmi-7">ψ</span></sub> is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-74007r349"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium476x.png" alt="        |     1 [       (Ψi+1,j+1∕2 − Ψi−1,j+1∕2 )        ( Ψi+1,j− 1∕2 − Ψi−1,j−1∕2)]
(Ψ𝜃hψ𝜃)ψ|i,j =--- hψi𝜃,j+1∕2  -------------------- − hψi𝜃,j−1∕2  --------------------  .
             δψ                  2δ𝜃                             2δ𝜃
" class="math-display"  /></center></td><td class="equation-label">(349)</td></tr></table>
<!--l. 3976--><p class="nopar" >
Approximating the value of <span 
class="cmmi-10">Ψ </span>at the grid centers by the average of the value of <span 
class="cmmi-10">Ψ </span>at the neighbor grid
points, Eq. (<a 
href="#x1-74007r349">349<!--tex4ht:ref: 4-27-e1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-74008r350"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium477x.png" alt="    ψ𝜃        ψ𝜃                                    ψ𝜃
(Ψ𝜃h  )ψ|i,j = H i,j+1∕2(Ψi+1,j+Ψi+1,j+1− Ψi−1,j− Ψi−1,j+1)− H i,j−1∕2(Ψi+1,j− 1+ Ψi+1,j− Ψi−1,j−1− Ψi− 1,j).
" class="math-display"  /></center></td><td class="equation-label">(350)</td></tr></table>
<!--l. 3984--><p class="nopar" >
where
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-74009r351"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium478x.png" alt="  ψ𝜃   -hψ𝜃--
H    = 4δψd𝜃.
" class="math-display"  /></center></td><td class="equation-label">(351)</td></tr></table>
<!--l. 3989--><p class="nopar" >
Similarly, the ﬁnite diﬀerence form of (<span 
class="cmmi-10">h</span><sup><span 
class="cmmi-7">ψ𝜃</span></sup><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">ψ</span></sub>)<sub><span 
class="cmmi-7">𝜃</span></sub> is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium479x.png" alt="               [       (                    )         (                    )]
(Ψ hψ𝜃)|  =  1- hψ𝜃     Ψi+1∕2,j+1 −-Ψi+1∕2,j−1 − hψ𝜃      Ψi−-1∕2,j+1 −-Ψi−1∕2,j−1
  ψ    𝜃i,j   δ𝜃   i+1∕2,j         2δψ             i−1∕2,j          2δψ
          = H ψ𝜃   (Ψ      + Ψ    − Ψ       − Ψ   ) − H ψ𝜃  (Ψ    + Ψ       − Ψ    − Ψ  (352).)
              i+1∕2,j  i+1,j+1   i,j+1   i+1,j−1    i,j−1     i−1∕2,j  i,j+1   i−1,j+1    i,j−1    i− 1,j− 1
" class="math-display"  /></center>
</div>Using the above results, the ﬁnite diﬀerence form of the operator <span 
class="cmsy-10">𝒥△</span><sup><span 
class="cmmi-7">⋆</span></sup><span 
class="cmmi-10">Ψ∕R</span><sup><span 
class="cmr-7">2</span></sup> is written as
<div class="eqnarray">
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium480x.png" alt=" 𝒥     ||
R2-△∗Ψ ||  = (h ψ𝜃Ψ 𝜃)ψ + (h ψψΨψ)ψ + (h𝜃𝜃Ψ𝜃)𝜃 + (h ψ𝜃Ψ ψ)𝜃
       i,j
          = Hψiψ,j+1∕2(Ψi,j+1 − Ψi,j) − Hψiψ,j−1∕2(Ψi,j − Ψi,j−1)
          + H𝜃𝜃    (Ψ     − Ψ ) − H𝜃𝜃   (Ψ   − Ψ   )
             i+1∕2,j i+1,j    i,j    i−1∕2,j i,j    i−1,j
          + Hψi𝜃,j+1∕2(Ψi+1,j + Ψi+1,j+1 − Ψi− 1,j − Ψi−1,j+1)− Hiψ,j𝜃−1∕2(Ψi+1,j−1 + Ψi+1,j − Ψi− 1,j−1 − Ψi−1,j)
             ψ𝜃                                        ψ𝜃
          + Hi+1∕2,j(Ψi+1,j+1 +Ψi,j+1 − Ψi+1,j− 1 − Ψi,j−1)− Hi−1∕2,j(Ψi,j+1 + Ψi− 1,j+1 − Ψi− 1,j−1 − Ψi,j−1)
          = Ψi,j(− Hiψ,jψ+1∕2 − H ψi,ψj− 1∕2 − H 𝜃i+𝜃1∕2,j − H 𝜃i𝜃−1∕2,j)
                     ψ𝜃       ψ𝜃              ψψ       ψ𝜃       ψ𝜃
          + Ψi− 1,j−1(H i,j−1∕2 +H i−1∕2,j) +Ψi,j−1(H i,j− 1∕2 − H i+1∕2,j +H i−1∕2,j)
          + Ψi+1,j− 1(− H ψ𝜃   − H ψ𝜃   )+ Ψi−1,j(H𝜃𝜃    − Hψ 𝜃   + H ψ𝜃   )
                      i,j−1∕2ψ𝜃  i+1∕2,jψ𝜃        i−1∕2,j   iψ,j𝜃+1∕2   i,jψ−𝜃1∕2
          + Ψi+1,j(H 𝜃i+𝜃1∕2,j + Hi,j+1∕2 − Hi,j−1∕2)+ Ψi− 1,j+1(− Hi,j+1∕2 − Hi−1∕2,j)
          + Ψ    (H ψψ    + Hψ𝜃    − Hψ𝜃    )+ Ψ     (H ψ𝜃   + H ψ𝜃   )
             i,j+1  i,j+1∕2    i+1∕2,j   i−1∕2,j    i+1,j+1   i,j+1∕2    i+1∕2,j
" class="math-display"  /></center>
</div>The coeﬃcients are given by
   <table 
class="equation"><tr><td><a 
 id="x1-74012r353"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium481x.png" alt="       𝒥         1
hψψ = --2|∇ ψ|2 =--(R2𝜃 + Z2𝜃),
      R         𝒥
" class="math-display"  /></center></td><td class="equation-label">(353)</td></tr></table>
<!--l. 4042--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-74013r354"></a>
   <center class="math-display" >
                                                                                

                                                                                
<img 
src="tokamak_equilibrium482x.png" alt="h𝜃𝜃 = 𝒥-|∇ 𝜃|2 = 1(R2 + Z2 ),
      R2        𝒥   ψ   ψ
" class="math-display"  /></center></td><td class="equation-label">(354)</td></tr></table>
<!--l. 4046--><p class="nopar" >
and
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-74014r355"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium483x.png" alt="hψ𝜃 = 𝒥-∇ ψ ⋅∇𝜃 = −-1(R R  + Z Z  ),
      R2           𝒥   𝜃  ψ    𝜃 ψ
" class="math-display"  /></center></td><td class="equation-label">(355)</td></tr></table>
<!--l. 4051--><p class="nopar" >
where the Jacobian
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-74015r356"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium484x.png" alt="𝒥 = R (R 𝜃Zψ − R ψZ𝜃).
" class="math-display"  /></center></td><td class="equation-label">(356)</td></tr></table>
<!--l. 4055--><p class="nopar" >
The partial derivatives, <span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">𝜃</span></sub>, <span 
class="cmmi-10">R</span><sub><span 
class="cmmi-7">ψ</span></sub>, <span 
class="cmmi-10">Z</span><sub><span 
class="cmmi-7">𝜃</span></sub>, and <span 
class="cmmi-10">Z</span><sub><span 
class="cmmi-7">ψ</span></sub>, appearing in Eqs. (<a 
href="#x1-74012r353">353<!--tex4ht:ref: 7-5-1 --></a>)-(<a 
href="#x1-74015r356">356<!--tex4ht:ref: 7-5-2 --></a>) are calculated by using the
central diﬀerence scheme. The values of <span 
class="cmmi-10">h</span><sup><span 
class="cmmi-7">ψψ</span></sup>, <span 
class="cmmi-10">h</span><sup><span 
class="cmmi-7">𝜃𝜃</span></sup>, <span 
class="cmmi-10">h</span><sup><span 
class="cmmi-7">ψ𝜃</span></sup> and <span 
class="cmsy-10">𝒥 </span>at the middle points are approximated by
the linear average of their values at the neighbor grid points.
</p><!--l. 4063--><p class="indent" >    
</p><!--l. 4065--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">13.3   </span> <a 
 id="x1-7500013.3"></a>Pressure and toroidal ﬁeld function proﬁle</h4>
                                                                                

                                                                                
<!--l. 4067--><p class="noindent" >The function <span 
class="cmmi-10">p</span>(<span 
class="cmmi-10">Ψ</span>) and <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>) in the GS equation are free functions which must be speciﬁed by users
before solving the GS equation. Next, we discuss one way to specify the free functions. Following Ref.
<span class="cite">[<span 
class="cmbx-10">?</span>]</span>,  we take <span 
class="cmmi-10">P</span>(<span 
class="cmmi-10">Ψ</span>) and <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>) to be of the forms
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-75001r357"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium485x.png" alt="                     --
P(Ψ) = P0 − (P0 − Pb)ˆp(Ψ),
" class="math-display"  /></center></td><td class="equation-label">(357)</td></tr></table>
<!--l. 4073--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-75002r358"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium486x.png" alt="1       1         --
2g2(Ψ) = 2 g20(1 − γ ˆg(Ψ )),
" class="math-display"  /></center></td><td class="equation-label">(358)</td></tr></table>
<!--l. 4077--><p class="nopar" >
with <img 
src="tokamak_equilibrium487x.png" alt="ˆp"  class="circ"  /> and <span 
class="cmmi-10">ĝ</span> chosen to be of polynomial form:
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-75003r359"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium488x.png" alt="  --  --α
ˆp(Ψ) = Ψ ,
" class="math-display"  /></center></td><td class="equation-label">(359)</td></tr></table>
                                                                                

                                                                                
<!--l. 4081--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-75004r360"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium489x.png" alt="  --  --β
ˆg(Ψ) = Ψ ,
" class="math-display"  /></center></td><td class="equation-label">(360)</td></tr></table>
<!--l. 4084--><p class="nopar" >
where
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-75005r361"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium490x.png" alt="--  Ψ − Ψa
Ψ ≡ Ψ-−-Ψ--,
     b    a
" class="math-display"  /></center></td><td class="equation-label">(361)</td></tr></table>
<!--l. 4088--><p class="nopar" >
with <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">b</span></sub> the value of <span 
class="cmmi-10">Ψ </span>on the boundary, <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">a</span></sub> the value of <span 
class="cmmi-10">Ψ </span>on the magnetic axis, <span 
class="cmmi-10">α</span>, <span 
class="cmmi-10">β</span>, <span 
class="cmmi-10">γ</span>, <span 
class="cmmi-10">P</span><sub><span 
class="cmr-7">0</span></sub>, <span 
class="cmmi-10">P</span><sub><span 
class="cmmi-7">b</span></sub>, and
<span 
class="cmmi-10">g</span><sub><span 
class="cmr-7">0</span></sub> are free parameters. Using the proﬁles of <span 
class="cmmi-10">P </span>and <span 
class="cmmi-10">g </span>given by Eqs. (<a 
href="#x1-75001r357">357<!--tex4ht:ref: 4-28-p1 --></a>) and (<a 
href="#x1-75002r358">358<!--tex4ht:ref: 4-28-p2 --></a>), we
obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-75006r362"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium491x.png" alt="                     --
dP-(Ψ-)= − 1-(P0 − Pb)αΨα−1
  dΨ      Δ
                                                                                

                                                                                
" class="math-display"  /></center></td><td class="equation-label">(362)</td></tr></table>
<!--l. 4096--><p class="nopar" >
where <span 
class="cmmi-10">Δ </span>= <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">b</span></sub> <span 
class="cmsy-10">− </span><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">a</span></sub>, and
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-75007r363"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium492x.png" alt="g dg-= − 1g2γ 1-βΨβ−1.
  dΨ     2 0 Δ
" class="math-display"  /></center></td><td class="equation-label">(363)</td></tr></table>
<!--l. 4101--><p class="nopar" >
Then the term on the r.h.s (nonlinear source term) of the GS equation is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-75008r364"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium493x.png" alt="                      [            --  ]          --
− μ0R2dP- − dgg = μ0R2  1-(P0 − Pb)α Ψα−1 +  1g20γ 1-βΨβ−1.
       dΨ   dΨ          Δ                  2   Δ
" class="math-display"  /></center></td><td class="equation-label">(364)</td></tr></table>
<!--l. 4109--><p class="nopar" >
The value of parameters <span 
class="cmmi-10">P</span><sub><span 
class="cmr-7">0</span></sub>, <span 
class="cmmi-10">P</span><sub><span 
class="cmmi-7">b</span></sub>, and <span 
class="cmmi-10">g</span><sub><span 
class="cmr-7">0</span></sub> in Eqs. (<a 
href="#x1-75001r357">357<!--tex4ht:ref: 4-28-p1 --></a>) and (<a 
href="#x1-75002r358">358<!--tex4ht:ref: 4-28-p2 --></a>), and the value of <span 
class="cmmi-10">α </span>and <span 
class="cmmi-10">β </span>in Eqs. (<a 
href="#x1-75003r359">359<!--tex4ht:ref: 1-2-1 --></a>)
and (<a 
href="#x1-75004r360">360<!--tex4ht:ref: 1-2-2 --></a>) can be chosen arbitrarily. The parameter <span 
class="cmmi-10">γ </span>is used to set the value of the total toroidal
current. The toroidal current density is given by Eq. (<span 
class="cmbx-10">??</span>), i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-75009r365"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium494x.png" alt="J  = RdP- + 1-dg-g-,
 ϕ    dΨ    μ0dΨ R
" class="math-display"  /></center></td><td class="equation-label">(365)</td></tr></table>
<!--l. 4118--><p class="nopar" >
which can be integrated over the poloidal cross section within the boundary magnetic surface to give
the total toroidal current, </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium495x.png" alt="    ∫
Iϕ =   JϕdS
    ∫  (              )
          dP-  1--dgg-
  =     R dΨ + μ0dΨ R   dRdZ
    ∫  [ (   1)           --    1  1   1   --]
  =     R  −--  (P0 − Pb)ˆp′(Ψ) −-----g20γ--ˆg′(Ψ)  dRdZ          (366)
            Δ                  μ0R 2   Δ
" class="math-display"  /><a 
 id="x1-75010r366"></a></center>
</div>Using
   <table 
class="equation"><tr><td><a 
 id="x1-75011r367"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium496x.png" alt="        1
dRdZ = R-𝒥 dψd𝜃,
" class="math-display"  /></center></td><td class="equation-label">(367)</td></tr></table>
<!--l. 4132--><p class="nopar" >
Eq. (<a 
href="#x1-75010r366">366<!--tex4ht:ref: 9-28-1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-75012r368"></a>
   <center class="math-display" >
                                                                                

                                                                                
<img 
src="tokamak_equilibrium497x.png" alt="    ∫ [(    )                               ]
          -1           ′--   -1--1  2 1- ′--
Iϕ =      −Δ   (P0 − Pb)ˆp(Ψ)− μ0R22 g0γ Δ ˆg(Ψ) 𝒥 dψd𝜃,
" class="math-display"  /></center></td><td class="equation-label">(368)</td></tr></table>
<!--l. 4139--><p class="nopar" >
from which we solve for <span 
class="cmmi-10">γ</span>, giving
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-75013r369"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium498x.png" alt="                    ∫   --
    −-ΔIϕ-− (P0-−-Pb)-[pˆ′(Ψ)]𝒥-dψd𝜃
γ =     -1g2 ∫ [-12ˆg′(Ψ)]𝒥dψd 𝜃  .
        2μ00   R
" class="math-display"  /></center></td><td class="equation-label">(369)</td></tr></table>
<!--l. 4146--><p class="nopar" >
If the total toroidal current <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">ϕ</span></sub> is given, Eq. (<a 
href="#x1-75013r369">369<!--tex4ht:ref: 9-28-2 --></a>) can be used to determine the value of
<span 
class="cmmi-10">γ</span>.
</p><!--l. 4150--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">13.4   </span> <a 
 id="x1-7600013.4"></a>Boundary magnetic surface and initial coordinates</h4>
<!--l. 4152--><p class="noindent" >In the ﬁxed boundary equilibrium problem, the shape of the boundary magnetic surface (it is also the
boundary of the computational region) is given while the shape of the inner ﬂux surface is
to be solved. A simple analytical expression for a D-shaped magnetic surface takes the
form
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-76001r370"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium499x.png" alt="R = R0 + acos(𝜃 +Δ sin𝜃),
" class="math-display"  /></center></td><td class="equation-label">(370)</td></tr></table>
<!--l. 4158--><p class="nopar" >
                                                                                

                                                                                
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-76002r371"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium500x.png" alt="Z = κa sin𝜃,
" class="math-display"  /></center></td><td class="equation-label">(371)</td></tr></table>
<!--l. 4161--><p class="nopar" >
with <span 
class="cmmi-10">𝜃 </span>changing from 0 to 2<span 
class="cmmi-10">π</span>. According to the deﬁnition in Eqs. (<span 
class="cmbx-10">??</span>), (<span 
class="cmbx-10">??</span>), and (<span 
class="cmbx-10">??</span>) we can readily
verify that the parameters <span 
class="cmmi-10">a</span>, <span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">0</span></sub>, <span 
class="cmmi-10">κ </span>appearing in Eqs. (<a 
href="#x1-76001r370">370<!--tex4ht:ref: 4-20-1 --></a>) and (<a 
href="#x1-76002r371">371<!--tex4ht:ref: 4-20-2 --></a>) are indeed the minor radius,
major radius, and ellipticity, respectively. According to the deﬁnition of triangularity Eq.
(<span 
class="cmbx-10">??</span>), the triangularity <span 
class="cmmi-10">δ </span>for the magnetic surface deﬁned by Eqs. (<a 
href="#x1-76001r370">370<!--tex4ht:ref: 4-20-1 --></a>) and (<a 
href="#x1-76002r371">371<!--tex4ht:ref: 4-20-2 --></a>) is written
as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-76003r372"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium501x.png" alt="δ = sin Δ.
" class="math-display"  /></center></td><td class="equation-label">(372)</td></tr></table>
<!--l. 4171--><p class="nopar" >
Another common expression for the shape of a magnetic surface was given by Miller<span class="cite">[<span 
class="cmbx-10">?</span>, <span 
class="cmbx-10">?</span>]</span>, which is
written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-76004r373"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium502x.png" alt="R = R0 + acos[𝜃+ arcsin(Δ sin𝜃)],
                                                                                

                                                                                
" class="math-display"  /></center></td><td class="equation-label">(373)</td></tr></table>
<!--l. 4176--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-76005r374"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium503x.png" alt="Z = κa sin𝜃.
" class="math-display"  /></center></td><td class="equation-label">(374)</td></tr></table>
<!--l. 4179--><p class="nopar" >
Note that Miller’s formula is only slightly diﬀerent from the formula (<a 
href="#x1-76001r370">370<!--tex4ht:ref: 4-20-1 --></a>). For Miller’s formula, it is
easy to prove that the triangularity <span 
class="cmmi-10">δ </span>is equal to <span 
class="cmmi-10">Δ </span>(instead of <span 
class="cmmi-10">δ </span>= sin<span 
class="cmmi-10">Δ </span>as given in Eq.
(<a 
href="#x1-76003r372">372<!--tex4ht:ref: 8-10-1 --></a>)).
</p><!--l. 4185--><p class="indent" >   In the iterative metric method<span class="cite">[<span 
class="cmbx-10">?</span>]</span> for solving the ﬁxed boundary equilibrium problem, we need to
provide an initial guess of the shape of the inner ﬂux surface (this initial guess is used to construct a
initial generalized coordinates system). A common guess of the inner ﬂux surfaces is given
by
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-76006r375"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium504x.png" alt="R = ψα(RLCFS − R0)+ R0,
" class="math-display"  /></center></td><td class="equation-label">(375)</td></tr></table>
<!--l. 4192--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-76007r376"></a>
   <center class="math-display" >
                                                                                

                                                                                
<img 
src="tokamak_equilibrium505x.png" alt="Z = ψαZLCFS,
" class="math-display"  /></center></td><td class="equation-label">(376)</td></tr></table>
<!--l. 4195--><p class="nopar" >
where <span 
class="cmmi-10">α </span>is a parameter, <span 
class="cmmi-10">ψ </span>is a label parameter of ﬂux surface. If the shape of the LCFS is given by Eqs.
(<a 
href="#x1-76001r370">370<!--tex4ht:ref: 4-20-1 --></a>) and (<a 
href="#x1-76002r371">371<!--tex4ht:ref: 4-20-2 --></a>), then Eqs. (<a 
href="#x1-76006r375">375<!--tex4ht:ref: 4-25-p5 --></a>) and (<a 
href="#x1-76007r376">376<!--tex4ht:ref: 4-25-p6 --></a>) are written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-76008r377"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium506x.png" alt="R = R0 + ψ αacos(𝜃 + Δ sin𝜃),
" class="math-display"  /></center></td><td class="equation-label">(377)</td></tr></table>
<!--l. 4202--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-76009r378"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium507x.png" alt="      a
Z = ψ κa sin 𝜃.
" class="math-display"  /></center></td><td class="equation-label">(378)</td></tr></table>
<!--l. 4205--><p class="nopar" >
Fig. <a 
href="#x1-7601014">14<!--tex4ht:ref: 4-25-p10 --></a> plots the shape given by Eqs. (<a 
href="#x1-76008r377">377<!--tex4ht:ref: 4-25-p8 --></a>) and (<a 
href="#x1-76009r378">378<!--tex4ht:ref: 4-25-p9 --></a>) for <span 
class="cmmi-10">a </span>=0.4, <span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">0</span></sub> = 1<span 
class="cmmi-10">.</span>7, <span 
class="cmmi-10">κ </span>= 1<span 
class="cmmi-10">.</span>7, <span 
class="cmmi-10">Δ </span>= arcsin(0<span 
class="cmmi-10">.</span>6),
and <span 
class="cmmi-10">α </span>= 1 with <span 
class="cmmi-10">ψ </span>varying from zero to one.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-7601014"></a>
                                                                                

                                                                                
<!--l. 4211--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/inverse_metric_method/fig1/plt.png" alt="pict"  
 width="180.67499pt" /> <img 
src="my_figure/home/yj/project_new/inverse_metric_method/fig2/plt.png" alt="pict"  
 width="180.67499pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 14: </span><span  
class="content">Shape of ﬂux surface given by Eqs. (<a 
href="#x1-76008r377">377<!--tex4ht:ref: 4-25-p8 --></a>) and (<a 
href="#x1-76009r378">378<!--tex4ht:ref: 4-25-p9 --></a>). Left ﬁgure: points with the same
value of <span 
class="cmmi-10">ψ </span>are connected to show <span 
class="cmmi-10">ψ </span>coordinate surface; Right ﬁgure: dot plot. Parameters are
<span 
class="cmmi-10">a </span>=0.4m, <span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">0</span></sub> = 1<span 
class="cmmi-10">.</span>7<span 
class="cmmi-10">m</span>, <span 
class="cmmi-10">κ </span>= 1<span 
class="cmmi-10">.</span>7, <span 
class="cmmi-10">Δ </span>= arcsin(0<span 
class="cmmi-10">.</span>6), <span 
class="cmmi-10">α </span>= 1 with <span 
class="cmmi-10">ψ </span>varying from zero (center) to one
(boundary). The shape parameters of LCFS are chosen according to the parameters of EAST
tokamak.</span></div><!--tex4ht:label?: x1-7601014 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
   <h4 class="subsectionHead"><span class="titlemark">13.5   </span> <a 
 id="x1-7700013.5"></a>Fixed boundary equilibrium numerical code</h4>
<!--l. 4223--><p class="noindent" >The tokamak equilibrium problem where the shape of the LCFS is given is called ﬁxed boundary
equilibrium problem. I wrote a numerical code that uses the iterative metric method<span class="cite">[<span 
class="cmbx-10">?</span>]</span> to solve this
kind of equilibrium problem. Figure <a 
href="#x1-7700115">15<!--tex4ht:ref: 12-26-1 --></a> describes the steps involved in the iterative metric
method.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-7700115"></a>
                                                                                

                                                                                
<!--l. 4230--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/inverse_metric_method/fig3/plt.png" alt="pict"  
 width="180.67499pt" /> <img 
src="my_figure/home/yj/project_new/inverse_metric_method/fig4/plt.png" alt="pict"  
 width="180.67499pt" />
</p><!--l. 4232--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/inverse_metric_method/fig3/reshape.png" alt="pict"  
 width="180.67499pt" /> <img 
src="my_figure/home/yj/project_new/inverse_metric_method/fig6/plt.png" alt="pict"  
 width="180.67499pt" />
</p><!--l. 4234--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/inverse_metric_method/fig5/plt.png" alt="pict"  
 width="180.67499pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 15: </span><span  
class="content">Upper left ﬁgure plots the initial coordinate surfaces. After solving the GS equation to
obtain the location of the magnetic axis, I shift the origin point of the initial coordinate system
to the location of the magnetic axis (upper right ﬁgure). Then, reshape the coordinate surface so
that the coordinate surfaces <span 
class="cmmi-10">ψ </span>= const lies on magnetic surfaces (middle left ﬁgure). Recalculate
the radial coordinate <span 
class="cmmi-10">ψ </span>that is consistent with the Jacobian constraint and interpolate ﬂux
surface to uniform <span 
class="cmmi-10">ψ </span>coordinates (middle right ﬁgure). Recalculate the poloidal coordinate <span 
class="cmmi-10">𝜃 </span>that
is consistent with the Jacobian constraint and interpolate poloidal points on every ﬂux surface
to uniform <span 
class="cmmi-10">𝜃 </span>coordinates (bottom left ﬁgure).</span></div><!--tex4ht:label?: x1-7700115 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
   <h4 class="subsectionHead"><span class="titlemark">13.6   </span> <a 
 id="x1-7800013.6"></a>Benchmark of the code</h4>
<!--l. 4250--><p class="noindent" >To benchmark the numerical code, I set the proﬁle of <span 
class="cmmi-10">P </span>and <span 
class="cmmi-10">g </span>according to Eqs. (<span 
class="cmbx-10">??</span>) and (<span 
class="cmbx-10">??</span>) with the
parameters <span 
class="cmmi-10">c</span><sub><span 
class="cmr-7">2</span></sub> = 0, <span 
class="cmmi-10">c</span><sub><span 
class="cmr-7">1</span></sub> = <span 
class="cmmi-10">B</span><sub><span 
class="cmr-7">0</span></sub>(<span 
class="cmmi-10">κ</span><sub><span 
class="cmr-7">0</span></sub><sup><span 
class="cmr-7">2</span></sup> + 1)<span 
class="cmmi-10">∕</span>(<span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">0</span></sub><sup><span 
class="cmr-7">2</span></sup><span 
class="cmmi-10">κ</span><sub><span 
class="cmr-7">0</span></sub><span 
class="cmmi-10">q</span><sub><span 
class="cmr-7">0</span></sub>), <span 
class="cmmi-10">κ</span><sub><span 
class="cmr-7">0</span></sub> = 1<span 
class="cmmi-10">.</span>5, and <span 
class="cmmi-10">q</span><sub><span 
class="cmr-7">0</span></sub> = 1<span 
class="cmmi-10">.</span>5. The comparison of the analytic
and numerical results are shown in Fig. <a 
href="#x1-7800116">16<!--tex4ht:ref: 3-15-a2 --></a>.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-7800116"></a>
                                                                                

                                                                                
<!--l. 4257--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/inverse_metric_method/fig13/tmp.png" alt="pict"  
 width="180.67499pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 16: </span><span  
class="content">Agreement between the magnetic surfaces (contours of <span 
class="cmmi-10">Ψ</span>) given by the Solovev analytic
formula and those calculated by the numerical code. The two sets of magnetic surfaces are
indistinguishable at this scale. The boundary magnetic surface is selected by the requirement
that <span class="overline"><span 
class="cmmi-10">Ψ</span></span> = 0<span 
class="cmmi-10">.</span>11022 in the Solovev formula (<span 
class="cmbx-10">??</span>). Parameters: <span 
class="cmmi-10">κ</span><sub><span 
class="cmr-7">0</span></sub> = 1<span 
class="cmmi-10">.</span>5, <span 
class="cmmi-10">q</span><sub><span 
class="cmr-7">0</span></sub> = 1<span 
class="cmmi-10">.</span>5.</span></div><!--tex4ht:label?: x1-7800116 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
<!--l. 4266--><p class="indent" >   Note that the parameter <span 
class="cmmi-10">c</span><sub><span 
class="cmr-7">0</span></sub> in the Solovev equilibrium seems to be not needed in the numerical
calculation. In fact this impression is wrong: the <span 
class="cmmi-10">c</span><sub><span 
class="cmr-7">0</span></sub> parameter is actually needed in determining the
boundary magnetic surface of the numerical equilibrium (in the case considered here <span 
class="cmmi-10">c</span><sub><span 
class="cmr-7">0</span></sub> is chosen as
<span 
class="cmmi-10">c</span><sub><span 
class="cmr-7">0</span></sub> = <span 
class="cmmi-10">B</span><sub><span 
class="cmr-7">0</span></sub><span 
class="cmmi-10">∕</span>(<span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">0</span></sub><sup><span 
class="cmr-7">2</span></sup><span 
class="cmmi-10">κ</span><sub><span 
class="cmr-7">0</span></sub><span 
class="cmmi-10">q</span><sub><span 
class="cmr-7">0</span></sub>)).
</p>
   <h4 class="subsectionHead"><span class="titlemark">13.7   </span> <a 
 id="x1-7900013.7"></a>Low-beta equilibrium vs. high-beta equilibrium</h4>
<!--l. 4274--><p class="noindent" >With the pressure increasing, the magnetic axis usually shifts to the low-ﬁeld-side of the device, as is
shown in Fig. <a 
href="#x1-7900117">17<!--tex4ht:ref: 10-31-e8 --></a>.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x1-7900117"></a>
                                                                                

                                                                                
<!--l. 4278--><p class="noindent" > <img 
src="my_figure/home/yj/project_new/inverse_metric_method/fig14/tmp1.png" alt="pict"  
 width="180.67499pt" /> <img 
src="my_figure/home/yj/project_new/inverse_metric_method/fig14/tmp2.png" alt="pict"  
 width="180.67499pt" />
<br /> </p><div class="caption" 
><span class="id">Fig. 17: </span><span  
class="content">Comparison of two equilibria obtained with <span 
class="cmmi-10">P</span><sub><span 
class="cmr-7">0</span></sub> = 10<sup><span 
class="cmr-7">4</span></sup> Pasca (left) and <span 
class="cmmi-10">P</span><sub><span 
class="cmr-7">0</span></sub> = 10<sup><span 
class="cmr-7">5</span></sup> Pasca
(right), respectively, where <span 
class="cmmi-10">P</span><sub><span 
class="cmr-7">0</span></sub> is the pressure at the magnetic axis. All the other parameters are
the same for the two equilibria, <span 
class="cmmi-10">α </span>= 1<span 
class="cmmi-10">.</span>0, <span 
class="cmmi-10">β </span>= 1<span 
class="cmmi-10">.</span>0, <span 
class="cmmi-10">P</span><sub><span 
class="cmmi-7">b</span></sub> = 10<sup><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span></sup> Pasca, <span 
class="cmmi-10">g</span><sub><span 
class="cmr-7">0</span></sub> = 1<span 
class="cmmi-10">.</span>0<span 
class="cmmi-10">Tm</span>, <span 
class="cmmi-10">I</span><sub><span 
class="cmmi-7">ϕ</span></sub> = 500kA,
and the LCFS is given by miller’s formulas (<a 
href="#x1-76004r373">373<!--tex4ht:ref: 10-31-e1 --></a>) and (<a 
href="#x1-76005r374">374<!--tex4ht:ref: 10-31-e2 --></a>) with <span 
class="cmmi-10">R</span><sub><span 
class="cmr-7">0</span></sub> = 1<span 
class="cmmi-10">.</span>7, <span 
class="cmmi-10">a </span>= 0<span 
class="cmmi-10">.</span>45, <span 
class="cmmi-10">κ </span>= 1<span 
class="cmmi-10">.</span>7,
and <span 
class="cmmi-10">δ </span>= 0<span 
class="cmmi-10">.</span>6.</span></div><!--tex4ht:label?: x1-7900117 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
<!--l. 4289--><p class="indent" >    
</p><!--l. 4291--><p class="indent" >    
</p><!--l. 4293--><p class="indent" >    
</p>
   <h4 class="subsectionHead"><span class="titlemark">13.8   </span> <a 
 id="x1-8000013.8"></a>Grad-Shafranov equation with prescribed safety factor proﬁle (to be ﬁnished)</h4>
<!--l. 4298--><p class="noindent" >In the GS equation, <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>) is one of the two free functions which can be prescribed by users. In some
cases, we want to specify the safety factor proﬁle <span 
class="cmmi-10">q</span>(<span 
class="cmmi-10">Ψ</span>), instead of <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>), in solving the GS equation.
Next, we derive the form of the GS equation that contains <span 
class="cmmi-10">q</span>(<span 
class="cmmi-10">Ψ</span>), rather than <span 
class="cmmi-10">g</span>(<span 
class="cmmi-10">Ψ</span>), as a free function.
The safety factor deﬁned in Eq. (<a 
href="#x1-49001r206">206<!--tex4ht:ref: 7-11-p1 --></a>) can be written </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium508x.png" alt="        1  g ∫ 2π𝒥
q(ψ) = − 2πΨ-′   R2-d𝜃                             (379)
             ∫02π  −2    ∫ 2π
    = − 1--g -0∫R---𝒥d𝜃-    𝒥d𝜃
        2πΨ ′  02π𝒥 d𝜃   0
        1  g      ∫ 2π
    = − ----′⟨R −2⟩    𝒥d𝜃                          (380)
        2πΨ        0
    = − sgn(𝒥 )-V-′-⟨R−2⟩g.                         (381)
              (2π)2 Ψ ′
" class="math-display"  /><a 
 id="x1-80001r381"></a></center>
</div>Equation (<a 
href="#x1-80001r381">381<!--tex4ht:ref: 12-21-p2 --></a>) gives the relation between the safety factor <span 
class="cmmi-10">q </span>and the toroidal ﬁeld function <span 
class="cmmi-10">g</span>. This
relation can be used in the GS equation to eliminate <span 
class="cmmi-10">g </span>in favor of <span 
class="cmmi-10">q</span>, which gives
   <table 
class="equation"><tr><td><a 
 id="x1-80002r382"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium509x.png" alt="            (2π)2
g = − sgn(𝒥 )-′-−2-Ψ ′q.
           V ⟨R  ⟩
" class="math-display"  /></center></td><td class="equation-label">(382)</td></tr></table>
                                                                                

                                                                                
<!--l. 4321--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80003r383"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium510x.png" alt="                 [           ]
  -dg    -(2π)2-- --(2π-)2--  ′
⇒ dΨ g = V′⟨R −2⟩q V ′⟨R −2⟩qΨ  ψ.
" class="math-display"  /></center></td><td class="equation-label">(383)</td></tr></table>
<!--l. 4326--><p class="nopar" >
Note that this expression involves the ﬂux surface average, which depends on the ﬂux surface shape and
the shape is unknown before <span 
class="cmmi-10">Ψ </span>is determined.
</p><!--l. 4330--><p class="indent" >   Multiplying Eq. (<span 
class="cmbx-10">??</span>) by <span 
class="cmmi-10">R</span><sup><span 
class="cmsy-7">−</span><span 
class="cmr-7">2</span></sup> gives
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80004r384"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium511x.png" alt="  [                                 ]
1  (   𝒥      )    (   𝒥         )        dp       dg
𝒥-   Ψ′R2|∇ψ |2   +  Ψ ′R2(∇ψ ⋅∇ 𝜃)   + μ0dΨ-+ R −2dΨ-g = 0.
                ψ                  𝜃
" class="math-display"  /></center></td><td class="equation-label">(384)</td></tr></table>
<!--l. 4336--><p class="nopar" >
Surface-averaging the above equation, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80005r385"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium512x.png" alt="       [                                ]
2π∫     (  ′ 𝒥    2)    ( ′ 𝒥         )       dp     −2 dg
V′-  d𝜃  Ψ R2-|∇ψ|    +  Ψ R2-(∇ψ ⋅∇𝜃)    + μ0dΨ-+ ⟨R  ⟩dΨ-g = 0,
                    ψ                  𝜃
" class="math-display"  /></center></td><td class="equation-label">(385)</td></tr></table>
<!--l. 4343--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80006r386"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium513x.png" alt="     ∫    (          )
⇒  2π-- d𝜃  Ψ′-𝒥-|∇ ψ|2   +μ0 dp-+ ⟨R −2⟩dgg = 0,
   V′        R2       ψ     dΨ        dΨ
" class="math-display"  /></center></td><td class="equation-label">(386)</td></tr></table>
<!--l. 4348--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80007r387"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium514x.png" alt="     [       (       ) ]
   2π-  ′∫      |∇ψ-|2        -dp     −2 dg-
⇒  V′ Ψ    d𝜃 𝒥   R2    ψ + μ0dΨ + ⟨R  ⟩dΨg = 0,
" class="math-display"  /></center></td><td class="equation-label">(387)</td></tr></table>
<!--l. 4354--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80008r388"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium515x.png" alt="     [     ⟨     ⟩ ]
   1--  ′ ′ |∇ψ-|2        -dp     −2 dg-
⇒  V′ V Ψ     R2    ψ + μ0dΨ + ⟨R  ⟩dΨg = 0.
" class="math-display"  /></center></td><td class="equation-label">(388)</td></tr></table>
<!--l. 4359--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80009r389"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium516x.png" alt="   [    ⟨     2⟩]
⇒   V′Ψ′  |∇-ψ2|-    + μ0V′ dp-+ ⟨R−2⟩V′ dg-g = 0,
           R     ψ       dΨ          dΨ
" class="math-display"  /></center></td><td class="equation-label">(389)</td></tr></table>
<!--l. 4365--><p class="nopar" >
Substitute Eq. (<a 
href="#x1-80003r383">383<!--tex4ht:ref: 4-18-p3 --></a>) into the above equation to eliminate <span 
class="cmmi-10">gdg∕dΨ</span>, we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80010r390"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium517x.png" alt="  [    ⟨      ⟩ ]                  [       ]
     ′ ′ |∇ψ|2          ′dp-       4 --qΨ-′--
⇒  V Ψ    R2     ψ + μ0V dΨ + q(2π) V ′⟨R− 2⟩ ψ = 0,
" class="math-display"  /></center></td><td class="equation-label">(390)</td></tr></table>
<!--l. 4372--><p class="nopar" >
Eq. (<a 
href="#x1-80010r390">390<!--tex4ht:ref: 4-19-5 --></a>) agrees with Eq. (5.55) in Ref. <span class="cite">[<span 
class="cmbx-10">?</span>]</span>.
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80011r391"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium518x.png" alt="     ⟨     ⟩     [  ⟨      ⟩]                   [        ]          [       ]
⇒ V ′ |∇ψ-|2  Ψ′′+  V′  |∇-ψ|2    Ψ′+μ V ′ dp+q (2π)4 ---q----Ψ ′′+q (2π)4  ---q----  Ψ′ = 0
        R2             R2    ψ     0   dΨ         V′⟨R −2⟩            V′⟨R−2⟩ ψ
" class="math-display"  /></center></td><td class="equation-label">(391)</td></tr></table>
<!--l. 4380--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80012r392"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium519x.png" alt="              {                                              }
    ′′     1   [  ′⟨|∇ψ |2⟩ ]   ′      4[   q    ]   ′     ′ dp
⇒  Ψ  = −V-′D   V   --R2-    Ψ  +q(2π)  V-′⟨R-−2⟩  Ψ + μ0V  dΨ-
                            ψ                    ψ
" class="math-display"  /></center></td><td class="equation-label">(392)</td></tr></table>
<!--l. 4386--><p class="nopar" >
where
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80013r393"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium520x.png" alt="    ⟨|∇ ψ|2⟩    (2π )4 ( q )2
D =  ---2-  + ---−2  --′
       R      ⟨R   ⟩ V
" class="math-display"  /></center></td><td class="equation-label">(393)</td></tr></table>
<!--l. 4391--><p class="nopar" >
The GS equation is
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80014r394"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium521x.png" alt="△ ⋆Ψ = − μ R2 dp-− g dg
         0   dΨ     dΨ
" class="math-display"  /></center></td><td class="equation-label">(394)</td></tr></table>
<!--l. 4396--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80015r395"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium522x.png" alt="                          4 [     ′  ]
⇒  △ ⋆Ψ = − μ0R2-dp−  q(2π)-----qΨ----
               dΨ    V′⟨R −2⟩ V ′⟨R −2⟩ ψ
" class="math-display"  /></center></td><td class="equation-label">(395)</td></tr></table>
<!--l. 4401--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80016r396"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium523x.png" alt="                         4 { [       ]      [        ]  }
⇒ △ ⋆Ψ = − μ0R2-dp− q(2π)---  ---q----  Ψ′ + ---q---- Ψ′′
              dΨ    V′⟨R −2⟩   V ′⟨R−2⟩ ψ      V ′⟨R− 2⟩
" class="math-display"  /></center></td><td class="equation-label">(396)</td></tr></table>
<!--l. 4407--><p class="nopar" >
Using Eq. (<a 
href="#x1-80012r392">392<!--tex4ht:ref: 1-2-4 --></a>) to eliminate <span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">′′</span> in the above equation, the coeﬃcients before (<span 
class="cmsy-10">−</span><span 
class="cmmi-10">μ</span><sub><span 
class="cmr-7">0</span></sub><span 
class="cmmi-10">dp∕dΨ</span>) is written as
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium524x.png" alt="                { [       ]       }
B = R2 − -q(2π)4--  ---q---- -1--V′
         V′⟨R −2⟩   V′⟨R−2⟩  V′D
    1 {  2    ( q )2 (2π)4 }
  = D-  R D −  V-′  ⟨R−-2⟩2  .                        (397)
" class="math-display"  /></center>
</div>Substituting the expression of <span 
class="cmmi-10">D </span>into the above equation, we obtain <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium525x.png" alt="     1 { 2 ⟨|∇ψ |2⟩     2 (2π)4 ( q )2 ( q )2 (2π)4}
B = D-  R   --R2-  + R  ⟨R-−2⟩  V′- −   V′- ⟨R-−2⟩2
       {   ⟨    2⟩   (   )2    4 (          ) }
  = -1  R2  |∇ψ2|  +  -q′  -(2π−)2  R2 − --1−2-   ,             (398)
    D         R       V    ⟨R   ⟩      ⟨R  ⟩
" class="math-display"  /><a 
 id="x1-80018r398"></a></center>
</div>which is equal to the expression (5.58) in Ref. <span class="cite">[<span 
class="cmbx-10">?</span>]</span>. The coeﬃcient before <span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">′ </span>is written as
   <table 
class="equation-star"><tr><td>
<span 
class="cmmi-10">A </span>= <span 
class="cmsy-10">−</span><img 
src="tokamak_equilibrium526x.png" alt=" q(2π)4
--′--−2-
V ⟨R   ⟩"  class="frac" align="middle" /><img 
src="tokamak_equilibrium527x.png" alt="{[    q   ]   [    q   ]  1  [(   ⟨|∇ψ |2⟩ )         [    q   ] ]}
   -′--−2-- −   -′--−2----′-   V ′ ---2-     + q(2π)4  -′--−2--
   V ⟨R   ⟩ ψ    V ⟨R   ⟩ V  D         R     ψ          V ⟨R   ⟩ ψ"  class="left" align="middle" />
</td></tr></table>
<!--l. 4435--><p class="nopar" >
Deﬁne
</p>
   <table 
class="equation-star"><tr><td>
                                                                                

                                                                                
                                 <span 
class="cmmi-10">α </span>= <img 
src="tokamak_equilibrium528x.png" alt="⟨     ⟩
 |∇ψ-|2
   R2"  class="left" align="middle" /><span 
class="cmmi-10">,</span>
</td></tr></table>
<!--l. 4437--><p class="nopar" >
</p>
   <table 
class="equation-star"><tr><td>
                                  <span 
class="cmmi-10">β </span>= <img 
src="tokamak_equilibrium529x.png" alt="---q----
V ′⟨R− 2⟩"  class="frac" align="middle" /><span 
class="cmmi-10">.</span>
</td></tr></table>
<!--l. 4438--><p class="nopar" >
</p>
   <table 
class="equation-star"><tr><td>
                   <span 
class="cmmi-10">A </span>= <span 
class="cmsy-10">−</span>(2<span 
class="cmmi-10">π</span>)<sup><span 
class="cmr-7">4</span></sup><span 
class="cmmi-10">β</span><img 
src="tokamak_equilibrium530x.png" alt="{                           }
 β  − β--1-[(V′α) + q(2π)4β  ]
  ψ    V ′D       ψ        ψ"  class="left" align="middle" />
</td></tr></table>
<!--l. 4440--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80019r399"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium531x.png" alt="      D                1   ′          4
=⇒ −-(2π)4β-A = Dβψ − βV-′[(V α)ψ +q(2π) βψ]
" class="math-display"  /></center></td><td class="equation-label">(399)</td></tr></table>
<!--l. 4444--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80020r400"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium532x.png" alt="= ⇒ ---D----A = D β − β-1[V′′α + V ′α  + q(2π )4β ]
    − β(2π)4       ψ    V ′         ψ         ψ
" class="math-display"  /></center></td><td class="equation-label">(400)</td></tr></table>
<!--l. 4448--><p class="nopar" >
Using
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80021r401"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium533x.png" alt="D = α + (2π )4⟨R− 2⟩β2
" class="math-display"  /></center></td><td class="equation-label">(401)</td></tr></table>
<!--l. 4452--><p class="nopar" >
Eq. () is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80022r402"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium534x.png" alt="                                                                    ]
=⇒  ---D---A = αβ  + (2π)4⟨R −2⟩β2β  − β-1-V′′α − β-1V ′α  − β 1-q(2π )4β
    − β(2π)4     ψ               ψ    V ′       V ′   ψ    V′      ψ
" class="math-display"  /></center></td><td class="equation-label">(402)</td></tr></table>
<!--l. 4459--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80023r403"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium535x.png" alt="       D                 4  −2  2      1  ′′           1     4  ]
=⇒  −-β(2π-)4A = α βψ + (2π) ⟨R  ⟩β βψ − β V′V α − βαψ − βV-′q(2π) βψ
" class="math-display"  /></center></td><td class="equation-label">(403)</td></tr></table>
<!--l. 4465--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80024r404"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium536x.png" alt="   A                                1
−-β(2π)4D = αβψ + (2π )4⟨R− 2⟩β2βψ − βV-′V ′′α − β αψ − β2⟨R −2⟩(2π)4βψ
" class="math-display"  /></center></td><td class="equation-label">(404)</td></tr></table>
<!--l. 4470--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80025r405"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium537x.png" alt="       A               1   ′′
= ⇒ −-β(2π)4-D = αβψ − βV′V  α− βα ψ
" class="math-display"  /></center></td><td class="equation-label">(405)</td></tr></table>
<!--l. 4474--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80026r406"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium538x.png" alt="                   (   )
=⇒  ---A---D  = − β2 α-   − β 1-V ′′α
    − β(2π)4          β  ψ    V′
" class="math-display"  /></center></td><td class="equation-label">(406)</td></tr></table>
<!--l. 4479--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80027r407"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium539x.png" alt="      A            (α )       1   α
=⇒  − β(2π)4D = − β2 β   − β2V-′V ′′β-
                       ψ
" class="math-display"  /></center></td><td class="equation-label">(407)</td></tr></table>
<!--l. 4485--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80028r408"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium540x.png" alt="                   [               ]
      A             (α )     1   α
=⇒ −-β(2π)4D = − β2  -β   + V-′V ′′β-
                        ψ
" class="math-display"  /></center></td><td class="equation-label">(408)</td></tr></table>
<!--l. 4490--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80029r409"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium541x.png" alt="                      [(  )           ]
    ---A----      2-1-   α-    ′   ′′α-
= ⇒ − β(2π)4 D = − β V ′  β  ψV  + V β
" class="math-display"  /></center></td><td class="equation-label">(409)</td></tr></table>
<!--l. 4496--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80030r410"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium542x.png" alt="       A            1 (α   )
=⇒  − β(2π)4D = − β2V-′ β-V′
                            ψ
" class="math-display"  /></center></td><td class="equation-label">(410)</td></tr></table>
<!--l. 4500--><p class="nopar" >
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80031r411"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium543x.png" alt="           4 (        )3   [⟨     2⟩   −2    ]
=⇒  A = (2π)- ----q---   1--  |∇-ψ|-  ⟨R--⟩V ′2
         D    V ′⟨R −2⟩   V′    R2      q      ψ
" class="math-display"  /></center></td><td class="equation-label">(411)</td></tr></table>
<!--l. 4506--><p class="nopar" >
But the expression of <span 
class="cmmi-10">A </span>is slightly diﬀerent from that given in Ref. <span class="cite">[<span 
class="cmbx-10">?</span>]</span> [Eq. (5.57)]. Using the above
coeﬃcients, the GS equation with the <span 
class="cmmi-10">q</span>-proﬁle held ﬁxed is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-80032r412"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium544x.png" alt="(          )
   ⋆    -∂-           dp-
  Δ  − A∂ψ   Ψ = − B μ0dΨ.
" class="math-display"  /></center></td><td class="equation-label">(412)</td></tr></table>
<!--l. 4513--><p class="nopar" >
</p><!--l. 4516--><p class="indent" >    
</p><!--l. 4518--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">14   </span> <a 
 id="x1-8100014"></a>Magnetic coordinates with general toroidal angle</h3>
<!--l. 4520--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">14.1   </span> <a 
 id="x1-8200014.1"></a>General toroidal angle <span 
class="cmmi-10">ζ</span></h4>
<!--l. 4522--><p class="noindent" >In Sec. <a 
href="#x1-480008.12">8.12<!--tex4ht:ref: 7-25-e5 --></a>, we introduced the local safety factor <img 
src="tokamak_equilibrium545x.png" alt="ˆq"  class="circ"  /> (<span 
class="cmmi-10">ψ,𝜃</span>). Equation (<a 
href="#x1-48002r202">202<!--tex4ht:ref: 12-25-1 --></a>) indicates that if the Jacobian
is chosen to be of the particular form <span 
class="cmsy-10">𝒥 </span>= <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">ψ</span>)<span 
class="cmmi-10">R</span><sup><span 
class="cmr-7">2</span></sup>, then the local safety factor is independent of <span 
class="cmmi-10">𝜃</span>, i.e.,
magnetic line is straight in (<span 
class="cmmi-10">𝜃,ϕ</span>) plane. On the other hand, if we want to make ﬁeld line straight in
(<span 
class="cmmi-10">𝜃,ϕ</span>) plane, the Jacobian must be chosen to be of the speciﬁc form <span 
class="cmsy-10">𝒥 </span>= <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">ψ</span>)<span 
class="cmmi-10">R</span><sup><span 
class="cmr-7">2</span></sup>. We note that, as
mentioned in Sec. <a 
href="#x1-500008.14">8.14<!--tex4ht:ref: 3-13-p7 --></a>, the poloidal angle is fully determined by the choice of the Jacobian.
The speciﬁc choice of <span 
class="cmsy-10">𝒥 </span>= <span 
class="cmmi-10">α</span>(<span 
class="cmmi-10">ψ</span>)<span 
class="cmmi-10">R</span><sup><span 
class="cmr-7">2</span></sup> is usually too restrictive for achieve a desired poloidal
resolution (for example, the equal-arc poloidal angle can not be achieved by this choice of
Jacobian). Is there any way that we can make the ﬁeld line straight in a coordinate system at
                                                                                

                                                                                
the same time ensure that the Jacobian can be freely adjusted to obtain desired poloidal
angle? The answer is obvious: Yes, we can achieve this by deﬁning a new toroidal angle
<span 
class="cmmi-10">ζ </span>that generalizes the usual (cylindrical) toroidal angle <span 
class="cmmi-10">ϕ</span>. Deﬁne a new toroidal angle <span 
class="cmmi-10">ζ</span>
by<span class="cite">[<span 
class="cmbx-10">?</span>]</span>
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-82001r413"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium546x.png" alt="ζ = ϕ− q(ψ)δ(ψ,𝜃),
" class="math-display"  /></center></td><td class="equation-label">(413)</td></tr></table>
<!--l. 4541--><p class="nopar" >
where <span 
class="cmmi-10">δ </span>= <span 
class="cmmi-10">δ</span>(<span 
class="cmmi-10">ψ,𝜃</span>) is a unknown function to be determined by the constraint of ﬁeld line being straight
in (<span 
class="cmmi-10">𝜃,ζ</span>) plane. Using Eq. (<a 
href="#x1-48003r203">203<!--tex4ht:ref: 18-3-9-a1 --></a>), the new local safety factor in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinates is written as
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium547x.png" alt="ˆqnew ≡ B-⋅∇-ζ
      B ⋅∇ 𝜃
    = (∇-ϕ×-∇-ψ+-ˆq∇-ψ-×∇-𝜃)⋅∇-ζ
      (∇ ϕ× ∇ ψ+ ˆq∇ ψ ×∇ 𝜃)⋅∇ 𝜃
      ∇-ϕ×-∇-ψ-⋅∇ζ-+qˆ∇-ψ-×-∇𝜃-⋅∇ζ
    =        (∇ϕ × ∇ψ )⋅∇𝜃
      ∇ ϕ× ∇ ψ ⋅∇(− qδ)+ ˆq∇ ψ ×∇ 𝜃⋅∇ ϕ
    = ---------(∇ϕ-×-∇ψ-)⋅∇𝜃---------

    = − q∂δ+ ˆq.                                       (414)
         ∂𝜃
" class="math-display"  /><a 
 id="x1-82002r414"></a></center>
</div>To make the new local safety factor be independent of <span 
class="cmmi-10">𝜃</span>, the right-hand side of Eq. (<a 
href="#x1-82002r414">414<!--tex4ht:ref: 6-24-5 --></a>) should be
independent of <span 
class="cmmi-10">𝜃</span>, i.e.,
   <table 
class="equation"><tr><td><a 
 id="x1-82003r415"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium548x.png" alt="− q∂δ-+qˆ= c(ψ ),
   ∂𝜃
" class="math-display"  /></center></td><td class="equation-label">(415)</td></tr></table>
<!--l. 4566--><p class="nopar" >
where <span 
class="cmmi-10">c</span>(<span 
class="cmmi-10">ψ</span>) can be an arbitrary function of <span 
class="cmmi-10">ψ</span>. A convenient choice for <span 
class="cmmi-10">c</span>(<span 
class="cmmi-10">ψ</span>) is <span 
class="cmmi-10">c</span>(<span 
class="cmmi-10">ψ</span>) = <span 
class="cmmi-10">q</span>, i.e., making the
new local safety factor be equal to the original global safety factor, i.e., <img 
src="tokamak_equilibrium549x.png" alt="ˆq"  class="circ"  /> <sub><span 
class="cmr-7">new</span></sub> = <span 
class="cmmi-10">q</span>. In this case, equation
(<a 
href="#x1-82003r415">415<!--tex4ht:ref: 6-24-8 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-82004r416"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium550x.png" alt="∂δ-= ˆq− 1,
∂𝜃   q
" class="math-display"  /></center></td><td class="equation-label">(416)</td></tr></table>
<!--l. 4574--><p class="nopar" >
which, on a magnetic surface labed by <span 
class="cmmi-10">ψ</span>, can be integrated over <span 
class="cmmi-10">𝜃 </span>to give
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-82005r417"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium551x.png" alt="                            1 ∫ 𝜃
δ(ψ,𝜃) = δ(ψ,𝜃ref)− (𝜃− 𝜃ref)+-     ˆqd𝜃,
                            q  𝜃ref
" class="math-display"  /></center></td><td class="equation-label">(417)</td></tr></table>
<!--l. 4581--><p class="nopar" >
where <span 
class="cmmi-10">𝜃</span><sub><span 
class="cmr-7">ref</span></sub> is an starting poloidal angle arbitrarily chosen for the integration, and <span 
class="cmmi-10">δ</span>(<span 
class="cmmi-10">ψ,𝜃</span><sub><span 
class="cmr-7">ref</span></sub>) is the
constant of integration. In the following, both <span 
class="cmmi-10">𝜃</span><sub><span 
class="cmr-7">ref</span></sub> and <span 
class="cmmi-10">δ</span>(<span 
class="cmmi-10">ψ,𝜃</span><sub><span 
class="cmr-7">ref</span></sub>) will be chosen to be zero. Then the
above equations is written
</p>
                                                                                

                                                                                
   <table 
class="equation"><tr><td><a 
 id="x1-82006r418"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium552x.png" alt="         1∫ 𝜃
δ = − 𝜃 + q 0 qˆd𝜃.
" class="math-display"  /></center></td><td class="equation-label">(418)</td></tr></table>
<!--l. 4590--><p class="nopar" >
Substituting the above expression into the deﬁnition of <span 
class="cmmi-10">ζ </span>(Eq. <a 
href="#x1-82001r413">413<!--tex4ht:ref: 5-13-e10 --></a>), we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-82007r419"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium553x.png" alt="           ∫ 𝜃
ζ = ϕ + q𝜃−   ˆqd𝜃,
            0
" class="math-display"  /></center></td><td class="equation-label">(419)</td></tr></table>
<!--l. 4596--><p class="nopar" >
which is the formula for calculating the general toroidal angle. If <span 
class="cmmi-10">𝜃 </span>is a straight-ﬁeld line poloidal angle,
then <span 
class="cmmi-10">ζ </span>in Eq. (<a 
href="#x1-82007r419">419<!--tex4ht:ref: 17-4-11-1 --></a>) reduces to the usual toroidal angle <span 
class="cmmi-10">ϕ</span>.
</p><!--l. 4601--><p class="indent" >   In summary, magnetic ﬁeld line is straight in (<span 
class="cmmi-10">𝜃,ζ</span>) plane with slope being <span 
class="cmmi-10">q </span>if <span 
class="cmmi-10">ζ </span>is deﬁned by Eq.
(<a 
href="#x1-82007r419">419<!--tex4ht:ref: 17-4-11-1 --></a>). In this method, we make the ﬁeld line straight by deﬁning a new toroidal angle, instead of
requiring the Jacobian to take particular forms. Thus, the freedom of choosing the form of
the Jacobian is still available to be used later to choose a good poloidal angle coordinate.
Note that the Jacobian of the new coordinates (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) is equal to that of (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>). [Proof:
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium554x.png" alt="𝒥−ne1w = ∇ ψ × ∇𝜃⋅∇ ζ
    = ∇ ψ × ∇𝜃⋅∇ (ϕ− qδ)

    = (∇ ψ× ∇ 𝜃)⋅∇ ϕ− (∇ψ × ∇ 𝜃) ⋅∇(qδ)
    = ∇ ψ × ∇𝜃⋅∇ ϕ − 0
    = 𝒥 −1.
" class="math-display"  /></center>
</div>] Also note that <span 
class="cmmi-10">δ</span>(<span 
class="cmmi-10">ψ,𝜃</span>) deﬁned by Eq. (<a 
href="#x1-82006r418">418<!--tex4ht:ref: 17-3-18-2 --></a>) is a periodic function of <span 
class="cmmi-10">𝜃</span>. [Proof: Equation (<a 
href="#x1-82006r418">418<!--tex4ht:ref: 17-3-18-2 --></a>) implies
that <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium555x.png" alt="              ∫
             1  𝜃+2π
δ(ψ,𝜃+ 2π) = q 0    ˆqd𝜃− (𝜃− 𝜃ref)− 2π
             1∫ 𝜃                    1∫ 𝜃+2π
          =  -   ˆqd𝜃 − (𝜃 − 𝜃ref)− 2π +      qˆd𝜃
             q 0          ∫          q  𝜃
          = δ(ψ,𝜃)− 2π + 1  𝜃+2πˆqd𝜃
                         q 𝜃
          = δ(ψ,𝜃).                                        (420)
" class="math-display"  /></center>
</div>]
<!--l. 4632--><p class="indent" >   [In numerical implementation, the term <span 
class="cmex-10">∫</span>
 <sub><span 
class="cmr-7">0</span></sub><sup><span 
class="cmmi-7">𝜃</span></sup><img 
src="tokamak_equilibrium556x.png" alt="B-⋅∇ϕ
B ⋅∇𝜃"  class="frac" align="middle" /><span 
class="cmmi-10">d𝜃 </span>appearing in <span 
class="cmmi-10">δ </span>is computed by using
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium557x.png" alt="∫             ∫           ∫
  𝜃B-⋅∇-ϕ      𝜃 -g-𝒥-      𝜃 g--1 -R--
 0 B ⋅∇ 𝜃d𝜃 =  0 R2 Ψ′d𝜃 = 0  R2Ψ ′|∇ ψ|dlp
              ∫ 𝜃 g 1
            =    ------dlp
              ∫0 𝜃 R |∇ Ψ|
            =    1-Bϕdℓ .                               (421)
               0 R Bp  p
" class="math-display"  /></center>
</div>
<!--l. 4646--><p class="indent" >   For later use, from Eq. (<a 
href="#x1-82006r418">418<!--tex4ht:ref: 17-3-18-2 --></a>), we obtain </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium558x.png" alt="                 ∫               ∫
∂(δq)    -d-(-g )  𝜃-𝒥-    -g ∂--  𝜃𝒥--    dq-
 ∂ψ   = −dψ  Ψ ′  0 R2 d𝜃− Ψ ′∂ψ  0 R2 d𝜃− dψ 𝜃.           (422)
" class="math-display"  /><a 
 id="x1-82011r422"></a></center>
</div>This formula is used in GTAW code, where the derivative <span 
class="cmmi-10">∂</span>(<span 
class="cmmi-10">g∕Ψ</span><span 
class="cmsy-10">′</span>)<span 
class="cmmi-10">∕∂ψ </span>is calculated numerically by
using the central diﬀerence scheme.]
<!--l. 4658--><p class="indent" >    
</p><!--l. 4661--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">14.2   </span> <a 
 id="x1-8300014.2"></a> Contravariant form of magnetic ﬁeld in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinates</h4>
<!--l. 4663--><p class="noindent" >Recall that the contravariant form of the magnetic ﬁeld in (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates is given by Eq. (<a 
href="#x1-48003r203">203<!--tex4ht:ref: 18-3-9-a1 --></a>),
i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-83001r423"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium559x.png" alt="B = − Ψ′(∇ϕ × ∇ψ + ˆq∇ψ × ∇ 𝜃).
" class="math-display"  /></center></td><td class="equation-label">(423)</td></tr></table>
                                                                                

                                                                                
<!--l. 4668--><p class="nopar" >
Next, let us derive the corresponding form in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinates. Using the deﬁnition of <span 
class="cmmi-10">ζ</span>, equation
(<a 
href="#x1-83001r423">423<!--tex4ht:ref: 6-24-p10 --></a>) is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium560x.png" alt="       ′                ′
B = − Ψ ∇′ (ζ + qδ)× ∇ψ′ − Ψ ˆq∇ψ × ∇ 𝜃′
  = − Ψ ∇ ζ × ∇ ψ − Ψ ∇ (qδ) × ∇ψ − Ψ ˆq∇ψ × ∇𝜃
       ′           ′∂-δ           ′
  = − Ψ ∇ ζ × ∇ ψ − Ψ q∂ 𝜃∇𝜃 × ∇ψ − Ψ ˆq∇ψ × ∇𝜃           (424)
" class="math-display"  /></center>
</div>Using Eq. (<a 
href="#x1-82004r416">416<!--tex4ht:ref: 11-12-p1 --></a>), the above equation is simpliﬁed as <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium561x.png" alt="B  = − Ψ′(∇ζ × ∇ψ + q∇ψ × ∇ 𝜃).                    (425)
" class="math-display"  /><a 
 id="x1-83003r425"></a></center>
</div>Equation (<a 
href="#x1-83003r425">425<!--tex4ht:ref: 3-13-p3 --></a>) is the contravariant form of the magnetic ﬁeld in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinates.
<!--l. 4690--><p class="indent" >   The expression of the magnetic ﬁeld in Eq. (<a 
href="#x1-83003r425">425<!--tex4ht:ref: 3-13-p3 --></a>) can be rewritten in terms of the ﬂux function <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub>
and <span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">t</span></sub> discussed in Sec. (). Equation (<a 
href="#x1-83003r425">425<!--tex4ht:ref: 3-13-p3 --></a>) is
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-83004r426"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium562x.png" alt="B = ∇ Ψ × ∇ ζ + q∇ 𝜃× ∇ Ψ,
" class="math-display"  /></center></td><td class="equation-label">(426)</td></tr></table>
                                                                                

                                                                                
<!--l. 4696--><p class="nopar" >
which, by using Eq. (), i.e., <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">Ψ </span>= <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">Ψ</span><sub><span 
class="cmmi-7">p</span></sub><span 
class="cmmi-10">∕</span>(2<span 
class="cmmi-10">π</span>), is rewritten as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-83005r427"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium563x.png" alt="B = -1-(∇ζ ×∇ Ψ + q∇ Ψ × ∇ 𝜃),
    2π         p      p
" class="math-display"  /></center></td><td class="equation-label">(427)</td></tr></table>
<!--l. 4702--><p class="nopar" >
which, by using Eq. (), i.e., <span 
class="cmmi-10">q </span>= <span 
class="cmmi-10">dΦ∕dΨ</span><sub><span 
class="cmmi-7">p</span></sub>, is further written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-83006r428"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium564x.png" alt="B = -1-(∇ ζ × ∇ Ψ + ∇ Φ ×∇ 𝜃).
    2π         p
" class="math-display"  /></center></td><td class="equation-label">(428)</td></tr></table>
<!--l. 4707--><p class="nopar" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">14.3   </span> <a 
 id="x1-8400014.3"></a>Relation between the partial derivatives in (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) and (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinates</h4>
<!--l. 4711--><p class="noindent" >Noting the simple fact that
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-84001r429"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium565x.png" alt="-d-=  --d---,
dx    d(x + c)
" class="math-display"  /></center></td><td class="equation-label">(429)</td></tr></table>
<!--l. 4714--><p class="nopar" >
where <span 
class="cmmi-10">c </span>is a constant, we conclude that
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-84002r430"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium566x.png" alt="(   )     (    )
  ∂f-       ∂f-
  ∂ζ  ψ,𝜃 =  ∂ϕ  ψ,𝜃 ,
" class="math-display"  /></center></td><td class="equation-label">(430)</td></tr></table>
<!--l. 4719--><p class="nopar" >
(since <span 
class="cmmi-10">ϕ </span>= <span 
class="cmmi-10">ζ </span>+ <span 
class="cmmi-10">q</span>(<span 
class="cmmi-10">ψ</span>)<span 
class="cmmi-10">δ</span>(<span 
class="cmmi-10">ψ,𝜃</span>), where the part <span 
class="cmmi-10">q</span>(<span 
class="cmmi-10">ψ</span>)<span 
class="cmmi-10">δ</span>(<span 
class="cmmi-10">ψ,𝜃</span>) acts as a constant when we hold <span 
class="cmmi-10">ψ </span>and <span 
class="cmmi-10">𝜃</span>
constant), i.e., the symmetry property with respect to the new toroidal angle <span 
class="cmmi-10">ζ </span>is identical with the one
with respect to the old toroidal angle <span 
class="cmmi-10">ϕ</span>. On the other hand, generally,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-84003r431"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium567x.png" alt="( ∂f )     ( ∂f)
  ∂ψ-    ⁄=  ∂-ψ
      𝜃,ζ         𝜃,ϕ
" class="math-display"  /></center></td><td class="equation-label">(431)</td></tr></table>
<!--l. 4728--><p class="nopar" >
and
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-84004r432"></a>
   <center class="math-display" >
                                                                                

                                                                                
<img 
src="tokamak_equilibrium568x.png" alt="(   )     (    )
  ∂f-       ∂f-
  ∂𝜃 ψ,ζ ⁄=  ∂𝜃  ψ,ϕ .
" class="math-display"  /></center></td><td class="equation-label">(432)</td></tr></table>
<!--l. 4733--><p class="nopar" >
In the special case that <span 
class="cmmi-10">f </span>is axisymmetric (i.e., <span 
class="cmmi-10">f </span>is independent of <span 
class="cmmi-10">ϕ </span>in (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates), then two
sides of Eqs. (<a 
href="#x1-84003r431">431<!--tex4ht:ref: 6-28-1 --></a>) and (<a 
href="#x1-84004r432">432<!--tex4ht:ref: 6-28-2 --></a>) are equal to each other. Note that the partial derivatives <span 
class="cmmi-10">∂∕∂ψ </span>and <span 
class="cmmi-10">∂∕∂𝜃</span>
in Sec. <a 
href="#x1-8200014.1">14.1<!--tex4ht:ref: 6-25-3 --></a> and <a 
href="#x1-8300014.2">14.2<!--tex4ht:ref: 6-25-4 --></a> are taken in (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates. Because the quantities involved in Sec. <a 
href="#x1-8200014.1">14.1<!--tex4ht:ref: 6-25-3 --></a> and
<a 
href="#x1-8300014.2">14.2<!--tex4ht:ref: 6-25-4 --></a> are axisymmetric, these partial derivatives are equal to their counterparts in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>)
coordinates.
</p><!--l. 4743--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">14.4   </span> <a 
 id="x1-8500014.4"></a>Steps to construct a straight-line magnetic coordinate system</h4>
<!--l. 4745--><p class="noindent" >In Sec. <a 
href="#x1-600009">9<!--tex4ht:ref: 6-25-1 --></a>, we have provided the steps to construct the magnetic surface coordinate system (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>).
Only one additional step is needed to construct the straight-line ﬂux coordinate system (<span 
class="cmmi-10">ψ,𝜃,ζ</span>). The
additional step is to calculate the generalized toroidal angle <span 
class="cmmi-10">ζ </span>according to Eq. (<a 
href="#x1-82001r413">413<!--tex4ht:ref: 5-13-e10 --></a>), where <span 
class="cmmi-10">δ </span>is
obtained from Eq. (<a 
href="#x1-82006r418">418<!--tex4ht:ref: 17-3-18-2 --></a>). Also note that the Jacobian of (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinates happens to be equal to
that of (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates.
</p><!--l. 4754--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">14.5   </span> <a 
 id="x1-8600014.5"></a>Form of operator <span 
class="cmmi-10">B </span><span 
class="cmsy-10">⋅∇ </span>in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinates</h4>
<!--l. 4756--><p class="noindent" >The usefulness of the contravariant form [Eq. (<a 
href="#x1-83003r425">425<!--tex4ht:ref: 3-13-p3 --></a>] of the magnetic ﬁeld lies in that it allows a simple
form of <span 
class="cmbx-10">B </span><span 
class="cmsy-10">⋅∇ </span>operator in a coordinate system. (The operator <span 
class="cmbx-10">B</span><sub><span 
class="cmr-7">0</span></sub> <span 
class="cmsy-10">⋅∇ </span>is usually called magnetic
diﬀerential operator.) In (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinate system, by using the contravariant form Eq. (<a 
href="#x1-83003r425">425<!--tex4ht:ref: 3-13-p3 --></a>), the
operator is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium569x.png" alt="B ⋅∇f  = − Ψ ′(∇ζ × ∇ψ )⋅∇f(ψ,𝜃,ζ)− Ψ ′q(∇ψ × ∇ 𝜃)⋅∇f(ψ,𝜃,ζ)
                ( ∂     ∂ )
       = − Ψ ′𝒥 −1 --+ q---  f.                                  (433)
                  ∂𝜃   ∂ ζ
" class="math-display"  /><a 
 id="x1-86001r433"></a></center>
</div>Next, consider the solution of the following magnetic diﬀerential equation:
   <table 
class="equation"><tr><td><a 
 id="x1-86002r434"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium570x.png" alt="B ⋅∇f = h.
" class="math-display"  /></center></td><td class="equation-label">(434)</td></tr></table>
<!--l. 4772--><p class="nopar" >
where <span 
class="cmmi-10">h </span>= <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">ψ,𝜃,ζ</span>) is some known function. Using Eq. (<a 
href="#x1-86001r433">433<!--tex4ht:ref: 4-7-a4 --></a>), the magnetic diﬀerential equation is
written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-86003r435"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium571x.png" alt="( ∂        ∂)       1
  --+ q(ψ)--- f = − -′𝒥h(ψ,𝜃,ζ).
  ∂𝜃      ∂ζ        Ψ
" class="math-display"  /></center></td><td class="equation-label">(435)</td></tr></table>
<!--l. 4779--><p class="nopar" >
Note that the coeﬃcients before the two partial derivatives of the above equation are all independent of
<span 
class="cmmi-10">𝜃 </span>and <span 
class="cmmi-10">ζ</span>. This indicates that diﬀerent Fourier harmonics in <span 
class="cmmi-10">𝜃 </span>and <span 
class="cmmi-10">ζ </span>are decoupled. As a result of this
fact, if <span 
class="cmmi-10">f </span>is Fourier expanded as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-86004r436"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium572x.png" alt="          ∑         i(m𝜃−nζ)
f(ψ,𝜃,ζ) =   fmn(ψ)e       ,
          m,n
" class="math-display"  /></center></td><td class="equation-label">(436)</td></tr></table>
<!--l. 4787--><p class="nopar" >
(note that, following the convention adopted in tokamak literature<span class="cite">[<span 
class="cmbx-10">?</span>]</span>, the Fourier harmonics are chosen
to be <span 
class="cmmi-10">e</span><sup><span 
class="cmmi-7">i</span><span 
class="cmr-7">(</span><span 
class="cmmi-7">m𝜃</span><span 
class="cmsy-7">−</span><span 
class="cmmi-7">nζ</span><span 
class="cmr-7">)</span></sup>, instead of <span 
class="cmmi-10">e</span><sup><span 
class="cmmi-7">i</span><span 
class="cmr-7">(</span><span 
class="cmmi-7">m𝜃</span><span 
class="cmr-7">+</span><span 
class="cmmi-7">nζ</span><span 
class="cmr-7">)</span></sup>), and the right-hand side is expanded as
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-86005r437"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium573x.png" alt="  1             ∑
− -′𝒥 h(ψ, 𝜃,ζ) =    γmn(ψ)ei(m𝜃−nζ),
  Ψ             m,n
" class="math-display"  /></center></td><td class="equation-label">(437)</td></tr></table>
<!--l. 4795--><p class="nopar" >
then Eq. (<a 
href="#x1-86003r435">435<!--tex4ht:ref: 4-7-a3 --></a>) can be readily solved to give
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-86006r438"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium574x.png" alt="         γ
fmn = ----mn--.
      i[m − nq]
" class="math-display"  /></center></td><td class="equation-label">(438)</td></tr></table>
<!--l. 4799--><p class="nopar" >
The usefulness of the straight line magnetic coordinates (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) lies in that, as mentioned previously, it
makes the coeﬃcients before the two partial derivatives both independent of <span 
class="cmmi-10">𝜃 </span>and <span 
class="cmmi-10">ζ</span>, thus, allowing a
simple solution to the magnetic diﬀerential equation.
</p><!--l. 4805--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">14.6   </span> <a 
 id="x1-8700014.6"></a>Resonant surface of a perturbation</h4>
<!--l. 4807--><p class="noindent" >Equation (<a 
href="#x1-86006r438">438<!--tex4ht:ref: 10-6-e1 --></a>) indicates that, for the diﬀerential equation (<a 
href="#x1-86002r434">434<!--tex4ht:ref: 17-4-27-1 --></a>), there is a resonant response to a
perturbation <span 
class="cmmi-10">e</span><sup><span 
class="cmmi-7">i</span><span 
class="cmr-7">(</span><span 
class="cmmi-7">m𝜃</span><span 
class="cmsy-7">−</span><span 
class="cmmi-7">nζ</span><span 
class="cmr-7">)</span></sup> on a magnetic surface with <span 
class="cmmi-10">m </span><span 
class="cmsy-10">− </span><span 
class="cmmi-10">nq </span>= 0. Therefore, the magnetic surface with
<span 
class="cmmi-10">q </span>= <span 
class="cmmi-10">m∕n </span>is called the “resonant surface” for the perturbation <span 
class="cmmi-10">e</span><sup><span 
class="cmmi-7">i</span><span 
class="cmr-7">(</span><span 
class="cmmi-7">m𝜃</span><span 
class="cmsy-7">−</span><span 
class="cmmi-7">nζ</span><span 
class="cmr-7">)</span></sup>.
</p><!--l. 4813--><p class="indent" >   The phase change of the perturbation <span 
class="cmmi-10">e</span><sup><span 
class="cmmi-7">i</span><span 
class="cmr-7">(</span><span 
class="cmmi-7">m𝜃</span><span 
class="cmsy-7">−</span><span 
class="cmmi-7">nζ</span><span 
class="cmr-7">)</span></sup> along a magnetic ﬁeld is given by <span 
class="cmmi-10">mΔ𝜃 </span><span 
class="cmsy-10">− </span><span 
class="cmmi-10">nΔζ</span>,
which can be written as <span 
class="cmmi-10">Δ𝜃</span>(<span 
class="cmmi-10">m</span><span 
class="cmsy-10">−</span><span 
class="cmmi-10">nq</span>). Since <span 
class="cmmi-10">m</span><span 
class="cmsy-10">−</span><span 
class="cmmi-10">nq </span>= 0 on a resonant surface, this indicates that there
is no phase change along a magnetic ﬁeld line on a resonant surface, i.e., the parallel wavenumber <span 
class="cmmi-10">k</span><sub><span 
class="cmsy-7">∥</span></sub> is
zero on a resonant surface.
</p><!--l. 4820--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">14.7   </span> <a 
 id="x1-8800014.7"></a>Helical angle used in tearing mode theory</h4>
<!--l. 4822--><p class="noindent" >Next, we discuss a special poloidal angle, which is useful in describling a perturnbation of single
harmonic (<span 
class="cmmi-10">m,n</span>). This poloidal angle is deﬁned by
                                                                                

                                                                                
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-88001r439"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium575x.png" alt="        n
χ = 𝜃−  mζ,
" class="math-display"  /></center></td><td class="equation-label">(439)</td></tr></table>
<!--l. 4826--><p class="nopar" >
where (<span 
class="cmmi-10">m,n</span>) are the mode numbers of the perturbation. The poloidal angle <span 
class="cmmi-10">χ </span>is often called helical
angle and is special in that its deﬁnition is associated with a perturbation (the mode numbers of the
perturbation appear in the deﬁnition) while the deﬁnition of the poloidal angles discussed previously
only involve the equilibrium quantities.
</p><!--l. 4833--><p class="indent" >   The poloidal angle <span 
class="cmmi-10">χ </span>is designed to make 3D perturbations of the form <span 
class="cmsy-10">∼ </span><span 
class="cmmi-10">f</span>(<span 
class="cmmi-10">ψ,m𝜃 </span><span 
class="cmsy-10">−</span><span 
class="cmmi-10">nζ</span>) reduce to
2D perturbations, i.e.,
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-88002r440"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium576x.png" alt="  |
∂f||   = 0.
∂ζ|ψ,χ
" class="math-display"  /></center></td><td class="equation-label">(440)</td></tr></table>
<!--l. 4837--><p class="nopar" >
</p><!--l. 4840--><p class="indent" >   It is ready to verify that the Jacobian of coordinates (<span 
class="cmmi-10">ψ,χ,ζ</span>) is equal to that of coordinates (<span 
class="cmmi-10">ψ,𝜃,ζ</span>)
[proof: (<span 
class="cmsy-10">𝒥′</span>)<sup><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span></sup> = <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">χ </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ζ </span>= <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span><span 
class="cmsy-10">×∇</span>(<span 
class="cmmi-10">𝜃 </span><span 
class="cmsy-10">− </span><span 
class="cmmi-10">nζ∕m</span>) <span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ζ </span>= <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">𝜃 </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ζ </span>= <span 
class="cmsy-10">𝒥</span><sup><span 
class="cmsy-7">−</span><span 
class="cmr-7">1</span></sup>].
</p><!--l. 4846--><p class="indent" >   The component of <span 
class="cmbx-10">B </span>along <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">χ </span>direction (i.e., the covariant component) is written </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium577x.png" alt="B(χ) ≡ B ⋅∇ χ
    = − Ψ′(∇ ζ × ∇ ψ + q∇ ψ × ∇𝜃)⋅∇ (𝜃− nζ∕m )
         ′                 ′ n
    = − Ψ (∇ ζ × ∇ ψ ⋅∇𝜃)+ Ψ m-(q∇ψ × ∇ 𝜃⋅∇ ζ)
         ′ −1    ′ n  −1
    = − Ψ 𝒥   + Ψ m q𝒥
    = Ψ ′𝒥 −1( nq− 1) .                                   (441)
              m
" class="math-display"  /><a 
 id="x1-88003r441"></a></center>
</div>At the resonant surface <span 
class="cmmi-10">q </span>= <span 
class="cmmi-10">m∕n</span>, equation (<a 
href="#x1-88003r441">441<!--tex4ht:ref: 1-10-1 --></a>) implies <span 
class="cmmi-10">B</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">χ</span><span 
class="cmr-7">)</span></sup> = 0. The direction <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">χ </span>deﬁnes the
reconnecting component of the magnetic ﬁeld?
<!--l. 4864--><p class="indent" >   On the other hand, the component of <span 
class="cmbx-10">B </span>along <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">𝜃 </span>direction is written </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium578x.png" alt="B(𝜃) ≡ B ⋅∇𝜃
    = − Ψ ′(∇ ζ × ∇ ψ+ q∇ ψ× ∇ 𝜃)⋅∇ 𝜃
    = − Ψ ′∇ ζ × ∇ ψ⋅∇ 𝜃
         ′ −1
    = − Ψ 𝒥  .                                      (442)
" class="math-display"  /><a 
 id="x1-88004r442"></a></center>
</div>Using (<a 
href="#x1-88004r442">442<!--tex4ht:ref: 5-13-1b --></a>) and (<a 
href="#x1-88003r441">441<!--tex4ht:ref: 1-10-1 --></a>), the relation between <span 
class="cmmi-10">B</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">𝜃</span><span 
class="cmr-7">)</span></sup> and <span 
class="cmmi-10">B</span><sup><span 
class="cmr-7">(</span><span 
class="cmmi-7">χ</span><span 
class="cmr-7">)</span></sup> is written as
   <table 
class="equation"><tr><td><a 
 id="x1-88005r443"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium579x.png" alt="          (    nq)
B (χ) = B (𝜃) 1 − m- .
" class="math-display"  /></center></td><td class="equation-label">(443)</td></tr></table>
<!--l. 4878--><p class="nopar" >
                                                                                

                                                                                
</p>
   <h4 class="subsectionHead"><span class="titlemark">14.8   </span> <a 
 id="x1-8900014.8"></a>Covariant form of magnetic ﬁeld in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinate system</h4>
<!--l. 4882--><p class="noindent" >In the above, we have obtained the covariant form of the magnetic ﬁeld in (<span 
class="cmmi-10">ψ,𝜃,ϕ</span>) coordinates (i.e., Eq.
(<a 
href="#x1-47002r200">200<!--tex4ht:ref: 5-6-2 --></a>)). Next, we derive the corresponding form in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinate. In order to do this, we need to
express the <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ϕ </span>basis vector in terms of <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ</span>, <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">𝜃</span>, and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ζ </span>basis vectors. Using the deﬁnition of the
generalized toroidal angle, we obtain </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium580x.png" alt="g∇ ϕ = g∇ (ζ + qδ)
    = g∇ ζ + gq∇ δ+ gδ∇q
               (∂δ      ∂δ   )      ′
    = g∇ ζ + gq ∂ψ-∇ψ + ∂𝜃-∇𝜃  + gδq∇ ψ
      (           )
    =   gq∂δ-+ gδq′ ∇ ψ+ gq∂δ-∇𝜃 + g∇ ζ
          ∂ψ               ∂𝜃
    = g ∂(qδ)∇ ψ + gq ∂δ∇ 𝜃+ g∇ζ.                        (444)
         ∂ψ         ∂𝜃
" class="math-display"  /><a 
 id="x1-89001r444"></a></center>
</div>Using Eq. (<a 
href="#x1-89001r444">444<!--tex4ht:ref: 5-6-1 --></a>), the covariant form of the magnetic ﬁeld, Eq. (<a 
href="#x1-47002r200">200<!--tex4ht:ref: 5-6-2 --></a>), is written as
   <table 
class="equation"><tr><td><a 
 id="x1-89002r445"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium581x.png" alt="     (  𝒥            ∂(qδ))      (  ∂δ     𝒥      )
B =   Ψ′R2-∇ψ ⋅∇𝜃 + g-∂ψ-- ∇ ψ +  gq∂𝜃-− Ψ′R2|∇ψ |2  ∇𝜃 + g∇ζ.
" class="math-display"  /></center></td><td class="equation-label">(445)</td></tr></table>
<!--l. 4909--><p class="nopar" >
This expression can be further simpliﬁed by using equation (<a 
href="#x1-82004r416">416<!--tex4ht:ref: 11-12-p1 --></a>) to eliminate <span 
class="cmmi-10">∂δ∕∂𝜃</span>, which gives
</p><div class="eqnarray">
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="tokamak_equilibrium582x.png" alt="     (  𝒥            ∂(qδ))      (  g2    R2          ) 𝒥
B  =  Ψ′--2∇ψ ⋅∇ 𝜃+ g----- ∇ ψ +  − -′ − gq--− Ψ ′|∇ψ |2  -2∇ 𝜃+ g∇ ζ
     (  R             ∂ψ  )      (  Ψ      𝒥        )   R
   =  Ψ′ 𝒥-∇ψ ⋅∇ 𝜃+ g∂(qδ) ∇ ψ +  − g2 +-|∇-Ψ|2− gqR2  𝒥-∇ 𝜃+ g∇ ζ.   (446)
        R2            ∂ψ               Ψ ′        𝒥   R2
" class="math-display"  /></center>
</div>Using <span 
class="cmmi-10">B</span><sup><span 
class="cmr-7">2</span></sup> = (<span 
class="cmsy-10">|∇</span><span 
class="cmmi-10">Ψ</span><span 
class="cmsy-10">|</span><sup><span 
class="cmr-7">2</span></sup> + <span 
class="cmmi-10">g</span><sup><span 
class="cmr-7">2</span></sup>)<span 
class="cmmi-10">∕R</span><sup><span 
class="cmr-7">2</span></sup>, the above equation is written as <div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium583x.png" alt="    (                    )      (              )
B =  Ψ′-𝒥-∇ψ ⋅∇ 𝜃+ g∂(qδ) ∇ ψ +  − B2R2-− gqR2-  𝒥-∇ 𝜃+ g∇ ζ
       R2            ∂ψ             Ψ ′      𝒥   R2
    ( ′ 𝒥           ∂(qδ))      (  B2      )
  =  Ψ R2-∇ψ ⋅∇ 𝜃+ g-∂ψ-- ∇ ψ +  − Ψ′ 𝒥 − gq ∇ 𝜃+ g∇ζ.           (447)
" class="math-display"  /><a 
 id="x1-89004r447"></a></center>
</div>Equation (<a 
href="#x1-89004r447">447<!--tex4ht:ref: 5-6-4 --></a>) is the covariant form of the magnetic ﬁeld in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinate system. For the
particular choice of the radial coordinate <span 
class="cmmi-10">ψ </span>= <span 
class="cmsy-10">−</span><span 
class="cmmi-10">Ψ </span>and the Jacobian <span 
class="cmsy-10">𝒥 </span>= <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">ψ</span>)<span 
class="cmmi-10">∕B</span><sup><span 
class="cmr-7">2</span></sup> (i.e., Boozer’s
Jacobian, discussed in Sec. <a 
href="#x1-9000014.9">14.9<!--tex4ht:ref: 18-5-1-p1 --></a>), equation (<a 
href="#x1-89004r447">447<!--tex4ht:ref: 5-6-4 --></a>) reduces to
   <table 
class="equation"><tr><td><a 
 id="x1-89005r448"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium584x.png" alt="    (   𝒥           ∂(qδ))
B =   −--2∇ψ ⋅∇ 𝜃+ g----- ∇ ψ + I(ψ )∇ 𝜃+ g(ψ)∇ ζ,
       R             ∂ψ
" class="math-display"  /></center></td><td class="equation-label">(448)</td></tr></table>
<!--l. 4944--><p class="nopar" >
with <span 
class="cmmi-10">I</span>(<span 
class="cmmi-10">ψ</span>) = <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">ψ</span>) <span 
class="cmsy-10">− </span><span 
class="cmmi-10">gq</span>. The magnetic ﬁeld expression in Eq. (<a 
href="#x1-89005r448">448<!--tex4ht:ref: 9-10-1 --></a>) frequently appears in tokamak
literature<span class="cite">[<span 
class="cmbx-10">?</span>]</span>. In this form, the coeﬃcients before both <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">𝜃 </span>and <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ζ </span>depends on only the radial
coordinate. In terms of <span 
class="cmmi-10">I</span>(<span 
class="cmmi-10">ψ</span>), the Jabobian can also be written as
                                                                                

                                                                                
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-89006r449"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium585x.png" alt="𝒥  = gq+-I.
      B2
" class="math-display"  /></center></td><td class="equation-label">(449)</td></tr></table>
<!--l. 4952--><p class="nopar" >
</p><!--l. 4956--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">14.9   </span> <a 
 id="x1-9000014.9"></a>Form of operator (<span 
class="cmmi-10">B </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">ψ∕B</span><sup><span 
class="cmr-7">2</span></sup>) <span 
class="cmsy-10">⋅∇ </span>in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinates</h4>
<!--l. 4958--><p class="noindent" >In solving the MHD eigenmode equations in toroidal geometries, besides the <span 
class="cmbx-10">B </span><span 
class="cmsy-10">⋅∇ </span>operator, we will
also encounter another surface operator (<span 
class="cmbx-10">B</span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">ψ∕B</span><sup><span 
class="cmr-7">2</span></sup>) <span 
class="cmsy-10">⋅∇</span>. Next, we derive the form of the this operator
in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinate system. Using the covariant form of the equilibrium magnetic ﬁeld [Eq.  (<a 
href="#x1-89004r447">447<!--tex4ht:ref: 5-6-4 --></a>)],
we obtain
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-90001r450"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium586x.png" alt="B × ∇ ψ    1 (  B2      )            g
----2-- = -2- − --′ 𝒥 − gq ∇ 𝜃× ∇ ψ+ --2∇ ζ × ∇ ψ.
  B       B     Ψ                   B
" class="math-display"  /></center></td><td class="equation-label">(450)</td></tr></table>
<!--l. 4968--><p class="nopar" >
Using this, the (<span 
class="cmbx-10">B </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">ψ∕B</span><sup><span 
class="cmr-7">2</span></sup>) <span 
class="cmsy-10">⋅∇ </span>operator is written as </p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium587x.png" alt="                (         )
B-×-∇-ψ ⋅∇ = -1- B2-𝒥 + gq  𝒥− 1 ∂-+-g-𝒥 −1 ∂-            (451)
  B2         B2   Ψ′            ∂ζ  B2     ∂𝜃
             ( 1    𝒥 −1 ) ∂     𝒥−1 ∂
           =  Ψ-′ + g-B2-q ∂ζ-+g B2--∂𝜃,                  (452)
" class="math-display"  /><a 
 id="x1-90002r452"></a></center>
</div>which is the form of the operator in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinate system.
<!--l. 4983--><p class="indent" >   Examining Eq. (<a 
href="#x1-90002r452">452<!--tex4ht:ref: 5-9-a3 --></a>), we ﬁnd that the coeﬃcients before the two partial derivatives will be
independent of <span 
class="cmmi-10">𝜃 </span>and <span 
class="cmmi-10">ζ </span>if the Jacobian <span 
class="cmsy-10">𝒥 </span>is chosen to be of the form <span 
class="cmsy-10">𝒥 </span>= <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">ψ</span>)<span 
class="cmmi-10">∕B</span><sup><span 
class="cmr-7">2</span></sup>, where <span 
class="cmmi-10">h </span>is some
magnetic surface function. It is obvious that the independence of the coeﬃcients on <span 
class="cmmi-10">𝜃 </span>and <span 
class="cmmi-10">ζ </span>will be
advantageous to some applications. The coordinate system (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) with the particular choice of
<span 
class="cmsy-10">𝒥 </span>= <span 
class="cmmi-10">h</span>(<span 
class="cmmi-10">ψ</span>)<span 
class="cmmi-10">∕B</span><sup><span 
class="cmr-7">2</span></sup> is called the Boozer coordinates. The usefulness of the new toroidal angle <span 
class="cmmi-10">ζ </span>is highlighted
in Boozer’s choice of the Jacobian, which makes both <span 
class="cmbx-10">B </span><span 
class="cmsy-10">⋅∇ </span>and (<span 
class="cmbx-10">B </span><span 
class="cmsy-10">×∇</span><span 
class="cmmi-10">ψ∕B</span><sup><span 
class="cmr-7">2</span></sup>) <span 
class="cmsy-10">⋅∇ </span>be a
constant-coeﬃcient diﬀerential operator. For other choices of the Jacobian, only the <span 
class="cmbx-10">B</span><span 
class="cmsy-10">⋅∇ </span>operator is a
constant-coeﬃcient diﬀerential operator.
</p><!--l. 4997--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">14.10   </span> <a 
 id="x1-9100014.10"></a>Radial diﬀerential operator</h4>
<!--l. 4999--><p class="noindent" >In solving the MHD eigenmode equations in toroidal geometry, we also need the radial
diﬀerential operator <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span><span 
class="cmsy-10">⋅∇</span>. Next, we derive the form of the operator in (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinates.
Using
</p>
   <table 
class="equation-star"><tr><td>
                          <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">f </span>= <img 
src="tokamak_equilibrium588x.png" alt="∂f
---
∂ψ"  class="frac" align="middle" /><span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span>+ <img 
src="tokamak_equilibrium589x.png" alt="∂f
---
∂ 𝜃"  class="frac" align="middle" /><span 
class="cmsy-10">∇</span><span 
class="cmmi-10">𝜃 </span>+ <img 
src="tokamak_equilibrium590x.png" alt="∂f
---
∂ζ"  class="frac" align="middle" /><span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ζ,</span>
</td></tr></table>
<!--l. 5004--><p class="nopar" >
the radial diﬀerential operator is written as </p><div class="eqnarray">
   <center class="math-display" >
                                                                                

                                                                                
<img 
src="tokamak_equilibrium591x.png" alt="∇ ψ ⋅∇f = |∇ ψ|2∂f-+ (∇𝜃 ⋅∇ ψ)∂f-+ (∇ζ ⋅∇ψ )∂f-
               ∂ψ           ∂ 𝜃           ∂ζ
              2∂f-          ∂f-                     ∂f-
        = |∇ ψ| ∂ψ + (∇𝜃 ⋅∇ ψ)∂ 𝜃 + {∇ [ϕ − qδ(ψ,𝜃)]⋅∇ ψ}∂ζ
              2∂f           ∂f            ∂f
        = |∇ ψ| ∂ψ-+ (∇𝜃 ⋅∇ ψ)∂-𝜃 − ∇ [qδ]⋅∇ ψ∂ζ
               ∂f           ∂f                  ∂f
        = |∇ ψ|2---+ (∇𝜃 ⋅∇ ψ)---− [q∇δ +δ∇q ]⋅∇ψ ---
               ∂ψ           ∂ 𝜃  [ (            ∂ζ)        ]
        = |∇ ψ|2∂f-+ (∇𝜃 ⋅∇ ψ)∂f-−  q  ∂δ-∇ψ + ∂δ∇ 𝜃  + δq′∇ ψ ⋅∇ ψ∂f-
               ∂ψ           ∂ 𝜃  [   ∂ψ      ∂𝜃         ]        ∂ζ
              2∂f-          ∂f-   ∂-(qδ)    2   ∂δ-        ∂f-
        = |∇ ψ| ∂ψ + (∇𝜃 ⋅∇ ψ)∂ 𝜃 −  ∂ ψ |∇ψ| + q∂𝜃 ∇𝜃 ⋅∇ψ  ∂ζ,        (453)
" class="math-display"  /><a 
 id="x1-91001r453"></a></center>
</div>where <span 
class="cmmi-10">∂</span>(<span 
class="cmmi-10">qδ</span>)<span 
class="cmmi-10">∕∂ψ </span>and <span 
class="cmmi-10">q∂δ∕∂𝜃 </span>are given respectively by Eqs. (<a 
href="#x1-82011r422">422<!--tex4ht:ref: 6-25-a1 --></a>) and (<a 
href="#x1-82004r416">416<!--tex4ht:ref: 11-12-p1 --></a>). Using the above formula,
<span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ψ </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ζ </span>is written as
   <table 
class="equation"><tr><td><a 
 id="x1-91002r454"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium592x.png" alt="            [∂(qδ)   2    ∂δ       ]
∇ ψ ⋅∇ζ = −  -∂ψ--|∇ ψ| + q∂𝜃∇ 𝜃⋅∇ ψ .
" class="math-display"  /></center></td><td class="equation-label">(454)</td></tr></table>
<!--l. 5040--><p class="nopar" >
This formula is used in GTAW code.
</p><!--l. 5043--><p class="noindent" >
</p>
   <h3 class="sectionHead"><span class="titlemark">15   </span> <a 
 id="x1-9200015"></a>Field-line-following coordinates</h3>
<!--l. 5045--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">15.1   </span> <a 
 id="x1-9300015.1"></a>Deﬁnition</h4>
<!--l. 5047--><p class="noindent" >In (<span 
class="cmmi-10">ψ,𝜃,ζ</span>) coordinates, a magnetic ﬁeld line is straight in (<span 
class="cmmi-10">𝜃,ζ</span>) plane with the slope being <span 
class="cmmi-10">q</span>. So the
equation for magnetic ﬁeld lines is given by <span 
class="cmmi-10">ζ </span>= <span 
class="cmmi-10">q𝜃 </span>+ <span 
class="cmmi-10">α</span>, where <span 
class="cmmi-10">α </span>is a constant in (<span 
class="cmmi-10">𝜃,ζ</span>) plane. Note that
<span 
class="cmmi-10">α </span>can be used to label diﬀerent magnetic ﬁeld lines on a magnetic surface. This motivates us to use <span 
class="cmmi-10">α</span>,
i.e.,
                                                                                

                                                                                
</p>
   <table 
class="equation"><tr><td><a 
 id="x1-93001r455"></a>
   <center class="math-display" >
<img 
src="tokamak_equilibrium593x.png" alt="α ≡ ζ − q𝜃,
" class="math-display"  /></center></td><td class="equation-label">(455)</td></tr></table>
<!--l. 5055--><p class="nopar" >
to as a new coordinate to replace <span 
class="cmmi-10">ζ</span>. Then we obtain a new set of coordinate: (<span 
class="cmmi-10">ψ,𝜃,α</span>), which
are called ﬁeld-line-following coordinates. Using Eqs. (<a 
href="#x1-93001r455">455<!--tex4ht:ref: 17-3-18-1 --></a>) and (<a 
href="#x1-82007r419">419<!--tex4ht:ref: 17-4-11-1 --></a>), <span 
class="cmmi-10">α </span>can be written as
</p><div class="eqnarray">
   <center class="math-display" >
<img 
src="tokamak_equilibrium594x.png" alt="       ∫ 𝜃
α = ϕ −   ˆqd𝜃,                            (456)
        0
" class="math-display"  /><a 
 id="x1-93002r456"></a></center>
</div>where <img 
src="tokamak_equilibrium595x.png" alt="ˆq"  class="circ"  /> = <span 
class="cmbx-10">B </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">ϕ∕</span><span 
class="cmbx-10">B </span><span 
class="cmsy-10">⋅∇</span><span 
class="cmmi-10">𝜃 </span>is the local safety factor. (If we choose the straight-ﬁeld-line <span 
class="cmmi-10">𝜃</span>, then <span 
class="cmmi-10">α </span>is
written as <span 
class="cmmi-10">α </span>= <span 
class="cmmi-10">ϕ </span><span 
class="cmsy-10">− </span><span 
class="cmmi-10">q𝜃</span>.) Deﬁne <span class="overline"><span 
class="cmmi-10">δ</span></span> = <span 
class="cmex-10">∫</span>
 <sub><span 
class="cmr-7">0</span></sub><sup><span 
class="cmmi-7">𝜃</span></sup><img 
src="tokamak_equilibrium596x.png" alt="qˆ"  class="circ"  /> <span 
class="cmmi-10">d𝜃</span>, which is called <span 
class="cmtt-10">tor</span><span 
class="cmtt-10">_shift</span> in <span 
class="cmtt-10">TEK</span> code, then
<span 
class="cmmi-10">α </span>= <span 
class="cmmi-10">ϕ </span><span 
class="cmsy-10">−</span><span class="overline"><span 
class="cmmi-10">δ</span></span>.
<!--l. 5070--><p class="indent" >   In <span 
class="cmtt-10">TEK</span>, I choose <span 
class="cmmi-10">𝜃 </span><span 
class="cmsy-10">∈ </span>[<span 
class="cmsy-10">−</span><span 
class="cmmi-10">π,π</span>) with <span 
class="cmmi-10">𝜃 </span>= <span 
class="cmsy-10">±</span><span 
class="cmmi-10">π </span>corresponding to the high-ﬁeld-side midplane, and <span 
class="cmmi-10">𝜃 </span>is
increasing along the counter-clockwise direction wehn viewed along <span 
class="cmsy-10">∇</span><span 
class="cmmi-10">ϕ</span>.  There are two reasons why <span 
class="cmmi-10">𝜃</span>
is chosen this way: 1. The toroidal shift <span class="overline"><span 
class="cmmi-10">δ</span></span> remain small near the low-ﬁeld-side <span 
class="cmmi-10">𝜃 </span>= 0. This may be good
for spatial resolution in this important region where ballooning modes often have larger amplitude.
2. The <span 
class="cmmi-10">𝜃 </span>cut, i.e., <span 
class="cmmi-10">𝜃 </span>= <span 
class="cmsy-10">±</span><span 
class="cmmi-10">π</span>, is far away from the important low-ﬁeld-side. The gyrokinetic
ﬁeld equations are not solved at <span 
class="cmmi-10">𝜃 </span>= +<span 
class="cmmi-10">π</span>. Perturbations there need to obtained by using
interpolations at the <span 
class="cmmi-10">𝜃 </span>cut, i.e., infer values of perturbations on <span 
class="cmmi-10">α </span>gridpoints at <span 
class="cmmi-10">𝜃 </span>= +<span 
class="cmmi-10">π</span>
from the corresponding values at <span 
class="cmmi-10">𝜃 </span>= <span 
class="cmsy-10">−</span><span 
class="cmmi-10">π</span>. Numerical errors more likely appear there. So
we prefer that the <span 
class="cmmi-10">𝜃 </span>cut is located in less important area (area where mode amplitude is
small).
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
                                                                                


