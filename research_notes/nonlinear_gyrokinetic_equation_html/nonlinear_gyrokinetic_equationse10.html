<?xml version="1.0" encoding="utf-8" ?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">  
<!--http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd-->  
<html xmlns="http://www.w3.org/1999/xhtml"  
> 
<head><title>Implementation of gyrokinetics in particle-in-cell (PIC) codes</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
<meta name="generator" content="TeX4ht (http://www.tug.org/tex4ht/)" /> 
<meta name="originator" content="TeX4ht (http://www.tug.org/tex4ht/)" /> 
<!-- xhtml,2,charset=utf-8,html --> 
<meta name="src" content="nonlinear_gyrokinetic_equation.tex" /> 
<link rel="stylesheet" type="text/css" href="nonlinear_gyrokinetic_equation.css" /> 
</head><body 
>
   <!--l. 3282--><div class="crosslinks"><p class="noindent">[<a 
href="nonlinear_gyrokinetic_equationse11.html" >next</a>] [<a 
href="nonlinear_gyrokinetic_equationse9.html" >prev</a>] [<a 
href="nonlinear_gyrokinetic_equationse9.html#tailnonlinear_gyrokinetic_equationse9.html" >prev-tail</a>] [<a 
href="#tailnonlinear_gyrokinetic_equationse10.html">tail</a>] [<a 
href="nonlinear_gyrokinetic_equation.html#nonlinear_gyrokinetic_equationse10.html" >up</a>] </p></div>
   <h3 class="sectionHead"><span class="titlemark">A   </span> <a 
 id="x11-61000A"></a>Implementation of gyrokinetics in particle-in-cell (PIC) codes</h3>
<!--l. 3285--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">A.1   </span> <a 
 id="x11-62000A.1"></a>Monte-Carlo evaluation of distribution function moment at grid-points</h4>
<!--l. 3287--><p class="noindent" >Suppose that the 6D guiding-center phase-space (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,</span><span 
class="cmbx-10">v</span>) is described by (<span 
class="cmmi-10">œà,ùúÉ,œï,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmmi-10">,Œ±,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub>) coordinates.
The Jacobian of the coordinate system is given by <span 
class="cmsy-10">ùí• </span>= <span 
class="cmsy-10">ùí•</span><sub><span 
class="cmmi-7">r</span></sub><span 
class="cmmi-10">v</span><sub><span 
class="cmsy-7">‚ä•</span></sub>, where <span 
class="cmsy-10">ùí•</span><sub><span 
class="cmmi-7">r</span></sub> = <span 
class="cmsy-10">ùí• </span>(<span 
class="cmmi-10">œà,ùúÉ</span>) is the Jacobian of
the coordinates (<span 
class="cmmi-10">œà,ùúÉ,œï</span>).
</p><!--l. 3293--><p class="indent" >   Suppose that we sample the 6D phase-space by using a probability function <span 
class="cmmi-10">P</span>(<span 
class="cmmi-10">œà,ùúÉ,œï,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,Œ±,v</span><sub><span 
class="cmsy-7">‚à•</span></sub>).
(Then the eÔ¨Äecitive probability function used in rejection method is <span 
class="cmmi-10">P</span><span 
class="cmsy-10">ùí•</span><sub><span 
class="cmmi-7">r</span></sub><span 
class="cmmi-10">v</span><sub><span 
class="cmsy-7">‚ä•</span></sub>.). We will sample a
distribution function <span 
class="cmmi-10">Œ¥f</span><sub><span 
class="cmmi-7">g</span></sub>(<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmmi-10">,Œ±</span>) that happens to be independent of the gyro-angle <span 
class="cmmi-10">Œ± </span>using the
above markers.
</p><!--l. 3300--><p class="indent" >   Since there is no indication that some values of <span 
class="cmmi-10">Œ± </span>would be more important than others, it is
natural to smaple <span 
class="cmmi-10">Œ± </span>using a uniform probability function, i.e., <span 
class="cmmi-10">P</span>(<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,Œ±,v</span><sub><span 
class="cmsy-7">‚à•</span></sub>) can be chosen to be
independent of <span 
class="cmmi-10">Œ±</span>.
</p><!--l. 3305--><p class="indent" >   In terms of sampling <span 
class="cmmi-10">Œ¥f</span><sub><span 
class="cmmi-7">g</span></sub>(<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,Œ±,v</span><sub><span 
class="cmsy-7">‚à•</span></sub>), there is no need to specify <span 
class="cmmi-10">Œ± </span>because both <span 
class="cmmi-10">f</span><sub><span 
class="cmmi-7">g</span></sub> and marker
distribution <span 
class="cmmi-10">g </span>= <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">p</span></sub><span 
class="cmmi-10">P </span>are indepedent of <span 
class="cmmi-10">Œ±</span>, and thus the weight <span 
class="cmmi-10">Œ¥f</span><sub><span 
class="cmmi-7">g</span></sub><span 
class="cmmi-10">‚àïg </span>is also independent of <span 
class="cmmi-10">Œ±</span>. It
turns out that sampling <span 
class="cmmi-10">Œ± </span>is necessary in simulations. The reason is as follows. The density
needed in solving the Ô¨Åeld equation is the moement of the particle distribution function
<span 
class="cmmi-10">Œ¥f</span><sub><span 
class="cmmi-7">p</span></sub>(<span 
class="cmbx-10">x</span><span 
class="cmmi-10">,v</span><sub><sub><span 
class="cmsy-5">‚ä•</span></sub></sub><span 
class="cmsy-10">‚Ä≤</span><span 
class="cmmi-10">,Œ±</span><span 
class="cmsy-10">‚Ä≤</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmsy-10">‚Ä≤</span>) at Ô¨Åxed <span 
class="cmbx-10">x</span>, and <span 
class="cmmi-10">Œ¥f</span><sub><span 
class="cmmi-7">p</span></sub>(<span 
class="cmbx-10">x</span><span 
class="cmmi-10">,v</span><sub><sub><span 
class="cmsy-5">‚ä•</span></sub></sub><span 
class="cmsy-10">‚Ä≤</span><span 
class="cmmi-10">,Œ±</span><span 
class="cmsy-10">‚Ä≤</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmsy-10">‚Ä≤</span>) is not uniform in <span 
class="cmmi-10">Œ±</span><span 
class="cmsy-10">‚Ä≤</span>. [Proof: <span 
class="cmmi-10">Œ¥f</span><sub><span 
class="cmmi-7">p</span></sub>(<span 
class="cmbx-10">x</span><span 
class="cmmi-10">,v</span><sub><sub><span 
class="cmsy-5">‚ä•</span></sub></sub><span 
class="cmsy-10">‚Ä≤</span><span 
class="cmmi-10">,Œ±</span><span 
class="cmsy-10">‚Ä≤</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmsy-10">‚Ä≤</span>)
with only <span 
class="cmmi-10">Œ±</span><span 
class="cmsy-10">‚Ä≤ </span>changing corresponds to both <span 
class="cmbx-10">X </span>and <span 
class="cmmi-10">Œ± </span>changing in (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,Œ±,v</span><sub><span 
class="cmsy-7">‚à•</span></sub>) coordinates, and
thus the corresponding <span 
class="cmmi-10">Œ¥f</span><sub><span 
class="cmmi-7">g</span></sub>(<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,Œ±,v</span><sub><span 
class="cmsy-7">‚à•</span></sub>), which is equal to <span 
class="cmmi-10">Œ¥f</span><sub><span 
class="cmmi-7">p</span></sub>(<span 
class="cmbx-10">x</span><span 
class="cmmi-10">,v</span><sub><sub><span 
class="cmsy-5">‚ä•</span></sub></sub><span 
class="cmsy-10">‚Ä≤</span><span 
class="cmmi-10">,Œ±</span><span 
class="cmsy-10">‚Ä≤</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmsy-10">‚Ä≤</span>), is varying
because <span 
class="cmmi-10">Œ¥f</span><sub><span 
class="cmmi-7">g</span></sub> is dependent on <span 
class="cmbx-10">X </span>and is independent of <span 
class="cmmi-10">Œ±</span>.] Therefore <span 
class="cmmi-10">Œ±</span><span 
class="cmsy-10">‚Ä≤ </span>needs to be speciÔ¨Åed in
(<span 
class="cmbx-10">x</span><span 
class="cmmi-10">,v</span><sub><sub><span 
class="cmsy-5">‚ä•</span></sub></sub><span 
class="cmsy-10">‚Ä≤</span><span 
class="cmmi-10">,Œ±</span><span 
class="cmsy-10">‚Ä≤</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmsy-10">‚Ä≤</span>) coordinates, which can be achieved by specifying <span 
class="cmmi-10">Œ± </span>in (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,Œ±,v</span><sub><span 
class="cmsy-7">‚à•</span></sub>) because of
<span 
class="cmmi-10">Œ±</span><span 
class="cmsy-10">‚Ä≤ </span>= <span 
class="cmmi-10">Œ±</span>.
</p><!--l. 3325--><p class="indent" >   ¬†
</p><!--l. 3327--><p class="indent" >   From the perspective of programming, it is ready to understand why <span 
class="cmmi-10">Œ± </span>needs to be
speciÔ¨Åed. When computing density at grid-points, we need to compute particle locations
from the guiding-center locations which requires us to specify the gyro-angle <span 
class="cmmi-10">Œ± </span>for each
marker.
</p><!--l. 3332--><p class="indent" >   Markers in guiding-center space (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,Œ±,v</span><sub><span 
class="cmsy-7">‚à•</span></sub>) with Ô¨Åxed (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub>) but varying <span 
class="cmmi-10">Œ± </span>correspond to
markers in particle space with varying locations and varying <span 
class="cmmi-10">Œ±</span><span 
class="cmsy-10">‚Ä≤ </span>(marker weights are constant since
marker weights in guiding-center space with only <span 
class="cmmi-10">Œ± </span>varying are constant). In the PIC method of
computing the particle density at Ô¨Åxed <span 
class="cmbx-10">x</span>, the contribution of each particle marker to the density is
solely determined by the distance of the particle marker to the Ô¨Åxed <span 
class="cmbx-10">x </span>(the gyro-angle <span 
class="cmmi-10">Œ±</span><span 
class="cmsy-10">‚Ä≤ </span>has not eÔ¨Äect
here). Therefore diÔ¨Äerent values of <span 
class="cmmi-10">Œ± </span>contributes diÔ¨Äerently to the density, and thus the resolution of <span 
class="cmmi-10">Œ±</span>
matters.
</p><!--l. 3344--><p class="indent" >   For a marker with coordinators (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmmi-10">,Œ±</span>), where <span 
class="cmmi-10">Œ± </span>is the gyro-angle, the corresponding particle
position can be calculated by using the inverse guiding-center transformation (<a 
href="nonlinear_gyrokinetic_equationse2.html#x3-5003r19">19<!--tex4ht:ref: 19-1-19-p2 --></a>). Then we can deposit
the marker weight to grid-points in the same way that we do in conventional PIC simulations. Looping
                                                                                

                                                                                
over all markers, we build the particle density at grids.
</p><!--l. 3351--><p class="indent" >   Compared with conventional PIC methods, where particle positions are directly sampled, what
is the beneÔ¨Åt of sampling guiding-center positions and then transform them back to the
particle positions? More computations are involved since we need to numerically perform
the inverse guiding-center transformation. The answer lies in the important fact that the
distribution function <span 
class="cmmi-10">f</span><sub><span 
class="cmmi-7">g</span></sub>(<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmmi-10">,Œ±</span>) that needs to be numerically evolved in gyrokinetic
simulation is actually independent of the gyro-angle <span 
class="cmmi-10">Œ±</span>. Furthermore, we use a probability density
function <span 
class="cmmi-10">P </span>that is independent of <span 
class="cmmi-10">Œ± </span>to sample the 6D phase space (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmmi-10">,Œ±</span>). Then
the marker weight <span 
class="cmmi-10">w </span><span 
class="cmsy-10">‚â° </span><span 
class="cmmi-10">f</span><sub><span 
class="cmmi-7">g</span></sub><span 
class="cmmi-10">‚àï</span>(<span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">p</span></sub><span 
class="cmmi-10">P</span>) is independent of <span 
class="cmmi-10">Œ±</span>, where <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">p</span></sub> is number of markers
loaded.
</p><!--l. 3363--><p class="indent" >   Suppose we have a concrete sampling of <span 
class="cmmi-10">f</span><sub><span 
class="cmmi-7">g</span></sub> in the 6D phase-space (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmmi-10">,Œ±</span>), i.e.,
(<span 
class="cmbx-10">X</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,Œ±</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,w</span><sub><span 
class="cmmi-7">j</span></sub>) with <span 
class="cmmi-10">j </span>= 1<span 
class="cmmi-10">,</span><span 
class="cmmi-10">‚Ä¶</span><span 
class="cmmi-10">,N</span><sub><span 
class="cmmi-7">p</span></sub>, then we can do the inverse guiding-center transform and then
deposit particles to the grids to obtain a moment (e.g. density).
</p><!--l. 3369--><p class="indent" >   Since <span 
class="cmmi-10">P</span><span 
class="cmsy-10">ùí•</span><sub><span 
class="cmmi-7">rv</span></sub>, where <span 
class="cmsy-10">ùí•</span><sub><span 
class="cmmi-7">rv</span></sub> = <span 
class="cmsy-10">ùí•</span><sub><span 
class="cmmi-7">r</span></sub><span 
class="cmmi-10">v</span><sub><span 
class="cmsy-7">‚ä•</span></sub> is the Jacobian of (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmmi-10">,Œ±</span>), is independent of <span 
class="cmmi-10">Œ±</span>, the sampling
<span 
class="cmmi-10">Œ±</span><sub><span 
class="cmmi-7">j</span></sub> with <span 
class="cmmi-10">j </span>= 0<span 
class="cmmi-10">,</span>1<span 
class="cmmi-10">,</span><span 
class="cmmi-10">‚Ä¶</span><span 
class="cmmi-10">,N</span><sub><span 
class="cmmi-7">p</span></sub> are uniform distributed random numbers. Therefore we can generate another
sampling of <span 
class="cmmi-10">Œ± </span>(denoted by <span 
class="cmmi-10">Œ±</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmsy-10">‚Ä≤ </span>with <span 
class="cmmi-10">j </span>= 1<span 
class="cmmi-10">,</span><span 
class="cmmi-10">‚Ä¶</span><span 
class="cmmi-10">,N</span><sub><span 
class="cmmi-7">p</span></sub>) using random number generators and combine <span 
class="cmmi-10">Œ±</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmsy-10">‚Ä≤</span>
with the old sampling (<span 
class="cmbx-10">X</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span><span 
class="cmmi-7">j</span></sub>) to obtain a new sampling (<span 
class="cmbx-10">X</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,Œ±</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmsy-10">‚Ä≤</span><span 
class="cmmi-10">,w</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmsy-10">‚Ä≤</span>). ¬†The values of <span 
class="cmmi-10">w</span>
at the new sampling points are equal to the original values, i.e., <span 
class="cmmi-10">w</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmsy-10">‚Ä≤ </span>= <span 
class="cmmi-10">w</span><sub><span 
class="cmmi-7">j</span></sub> since the particle
weight <span 
class="cmmi-10">w </span>= <span 
class="cmmi-10">f</span><sub><span 
class="cmmi-7">g</span></sub><span 
class="cmmi-10">‚àï</span>(<span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">p</span></sub><span 
class="cmmi-10">P</span>) is independent of <span 
class="cmmi-10">Œ±</span>. ¬†Using the new sampling and following the same
procedures given above, we can estimate values of the moment at grid-points again, which will
diÔ¨Äer from the estimation obtained using the old sampling. Taking the average of the two
estimations will give a more accurate estimation because the resolution in the gyro-angle is
increased.
</p><!--l. 3385--><p class="indent" >   [Note that even if <span 
class="cmmi-10">P</span><span 
class="cmsy-10">ùí•</span><sub><span 
class="cmmi-7">rv</span></sub> is dependent on <span 
class="cmmi-10">Œ± </span>due to the possible dependence of <span 
class="cmsy-10">ùí•</span><sub><span 
class="cmmi-7">rv</span></sub> on <span 
class="cmmi-10">Œ±</span>, we still can
easily generate a new set of sampling which diÔ¨Äers from the old sampling only in <span 
class="cmmi-10">Œ±</span>. SpeciÔ¨Åcally, in the
rejection method, we use the old sampling (<span 
class="cmbx-10">X</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span><span 
class="cmmi-7">j</span></sub>) for each reject step and only adjust <span 
class="cmmi-10">Œ± </span>to
satisfy the acceptance criteria.]
</p><!--l. 3392--><p class="indent" >   We can also construct a new sampling by replacing <span 
class="cmmi-10">Œ±</span><sub><span 
class="cmmi-7">j</span></sub> by <span 
class="cmmi-10">Œ±</span><sub><span 
class="cmmi-7">j</span></sub> + Œî, where Œî is a constant.
Then the new sampling is given by (<span 
class="cmbx-10">X</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,Œ±</span><sub><span 
class="cmmi-7">j</span></sub> + Œî<span 
class="cmmi-10">,w</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmsy-10">‚Ä≤</span>) with <span 
class="cmmi-10">j </span>= 1<span 
class="cmmi-10">,</span><span 
class="cmmi-10">‚Ä¶</span><span 
class="cmmi-10">,N</span><sub><span 
class="cmmi-7">p</span></sub>. Since the
original sampling probability function <span 
class="cmmi-10">P</span><span 
class="cmsy-10">ùí•</span><sub><span 
class="cmmi-7">r</span></sub><span 
class="cmmi-10">v</span><sub><span 
class="cmsy-7">‚ä•</span></sub> is independent of <span 
class="cmmi-10">Œ±</span>, then (<span 
class="cmbx-10">X</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,Œ±</span><sub><span 
class="cmmi-7">j</span></sub> + Œî)
is still a consistent sampling that can be generated by the original probability function
<span 
class="cmmi-10">P</span><span 
class="cmsy-10">ùí•</span><sub><span 
class="cmmi-7">r</span></sub><span 
class="cmmi-10">v</span><sub><span 
class="cmsy-7">‚ä•</span></sub>. Furthermore, since the particle weight <span 
class="cmmi-10">w </span>= <span 
class="cmmi-10">f</span><sub><span 
class="cmmi-7">g</span></sub><span 
class="cmmi-10">‚àï</span>(<span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">p</span></sub><span 
class="cmmi-10">P</span>) is independent of <span 
class="cmmi-10">Œ±</span>, we
infer that the values of <span 
class="cmmi-10">w </span>at the new sampling points are equal to the original values, i.e.,
<span 
class="cmmi-10">w</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmsy-10">‚Ä≤ </span>= <span 
class="cmmi-10">w</span><sub><span 
class="cmmi-7">j</span></sub>.
</p><!--l. 3403--><p class="indent" >   In doing the deposition, each marker has a single gyro-angle. Due to the independence of the weight
(<span 
class="cmmi-10">w </span>= <span 
class="cmmi-10">f</span><sub><span 
class="cmmi-7">g</span></sub><span 
class="cmmi-10">‚àï</span>(<span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">p</span></sub><span 
class="cmmi-10">P</span>)) of the gyro-angle, the resolution over the gyro-angle can be increased in a way that
there can be several gyro-angles for a single (<span 
class="cmbx-10">X</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span><span 
class="cmmi-7">j</span></sub>). This gives the wrong impression
that the gyro-angle of a guiding-center marker is arbitrary. The correct understanding is
that given above, i.e., we do 4 separate sampling of the phase space and then average the
results.
</p><!--l. 3411--><p class="indent" >   In the code, the gyro-angle is deÔ¨Åned relative to the direction <span 
class="cmsy-10">‚àá</span><span 
class="cmmi-10">œà‚àï</span><span 
class="cmsy-10">|‚àá</span><span 
class="cmmi-10">œà</span><span 
class="cmsy-10">| </span>at the guiding-center
position. SpeciÔ¨Åcally, the gyro-angle is deÔ¨Åned as the included angle between <span 
class="cmsy-10">‚àá</span><span 
class="cmmi-10">œà‚àï</span><span 
class="cmsy-10">|‚àá</span><span 
class="cmmi-10">œà</span><span 
class="cmsy-10">| </span>and
<span 
class="cmsy-10">‚àí</span><span 
class="cmbx-10">v </span><span 
class="cmsy-10">√ó </span><span 
class="cmbx-10">e</span><sub><span 
class="cmsy-7">‚à•</span></sub>(<span 
class="cmbx-10">x</span>)<span 
class="cmmi-10">‚àï</span>Œ©(<span 
class="cmbx-10">x</span>), where <span 
class="cmbx-10">e</span><sub><span 
class="cmsy-7">‚à•</span></sub>(<span 
class="cmbx-10">x</span>)<span 
class="cmmi-10">‚àï</span>Œ©(<span 
class="cmbx-10">x</span>) is approximated by the value at the guiding-center
location.
</p><!--l. 3418--><p class="indent" >   ¬†
</p><!--l. 3420--><p class="indent" >   Then (<span 
class="cmbx-10">X</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span><span 
class="cmmi-7">j</span></sub>) can be evolved by using the guiding-center motion equation. (It is
obvious how to evalute the gyro-averaging of the electromagnetic Ô¨Åelds needed in pusing
markers.)
</p>
                                                                                

                                                                                
   <table 
class="equation"><tr><td><a 
 id="x11-62001r258"></a>
   <center class="math-display" >
<img 
src="nonlinear_gyrokinetic_equation289x.png" alt="      ‚àë
Œ¶(x) =   Œ¶ijcij(x).
       i,j
" class="math-display"  /></center></td><td class="equation-label">(258)</td></tr></table>
<!--l. 3427--><p class="nopar" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">A.2   </span> <a 
 id="x11-63000A.2"></a>Monte-Carlo sampling of 6D guiding-center phase-space </h4>
<!--l. 3431--><p class="noindent" >Suppose that the 6D guiding-center phase-space (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,</span><span 
class="cmbx-10">v</span>) is described by (<span 
class="cmmi-10">œà,ùúÉ,œï,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,Œ±</span>) coordinates.
The Jacobian of the coordinate system is given by <span 
class="cmsy-10">ùí• </span>= <span 
class="cmsy-10">ùí•</span><sub><span 
class="cmmi-7">r</span></sub><span 
class="cmmi-10">v</span><sub><span 
class="cmsy-7">‚ä•</span></sub>, where <span 
class="cmsy-10">ùí•</span><sub><span 
class="cmmi-7">r</span></sub> = <span 
class="cmsy-10">ùí• </span>(<span 
class="cmmi-10">œà,ùúÉ</span>) is the Jacobian of
the coordinates (<span 
class="cmmi-10">œà,ùúÉ,œï</span>). Suppose that we sample the 6D phase-space by using the following probability
density function:
</p>
   <table 
class="equation"><tr><td><a 
 id="x11-63001r259"></a>
   <center class="math-display" >
<img 
src="nonlinear_gyrokinetic_equation290x.png" alt="                     (    )3‚àï2   [  m(v2+ v2 )]
P(œà,ùúÉ,œï,v‚à•,v‚ä•, Œ±) =-1  -m--    exp ‚àí ---‚à•---‚ä•-- ,
                  Vr  2œÄT              2T
" class="math-display"  /></center></td><td class="equation-label">(259)</td></tr></table>
<!--l. 3442--><p class="nopar" >
where <span 
class="cmmi-10">V</span> <sub><span 
class="cmmi-7">r</span></sub> is the volume of the spatial simulation box, <span 
class="cmmi-10">T </span>is a constant temperature. <span 
class="cmmi-10">P </span>given above is
independent of <span 
class="cmmi-10">œà,ùúÉ,œï </span>and <span 
class="cmmi-10">Œ±</span>. It is ready to verify that the above <span 
class="cmmi-10">P </span>satisÔ¨Åes the following normalization
condition:
</p>
   <table 
class="equation"><tr><td><a 
 id="x11-63002r260"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="nonlinear_gyrokinetic_equation291x.png" alt="‚à´  ‚à´           ‚à´  ‚à´ +‚àû ‚à´ ‚àû‚à´ 2œÄ
      PdvdX =                  Pv‚ä•dŒ±dv‚ä•dv ‚à•ùí•rd œàdùúÉdœï = 1.
 Vr             Vr  ‚àí‚àû   0   0
" class="math-display"  /></center></td><td class="equation-label">(260)</td></tr></table>
<!--l. 3451--><p class="nopar" >
I use the rejection method to numerically generate <span 
class="cmmi-10">N</span><sub><span 
class="cmmi-7">p</span></sub> markers that satisfy the above probability
density function. [The eÔ¨Äective probability density function actually used in the rejection method is <span 
class="cmmi-10">P</span><span 
class="cmsy-10">‚Ä≤</span>,
which is related to <span 
class="cmmi-10">P </span>by
</p>
   <table 
class="equation"><tr><td><a 
 id="x11-63003r261"></a>
   <center class="math-display" >
<img 
src="nonlinear_gyrokinetic_equation292x.png" alt="P‚Ä≤ = |ùí•rùí•v|P = |ùí•r (œà,ùúÉ)|v‚ä•P
" class="math-display"  /></center></td><td class="equation-label">(261)</td></tr></table>
<!--l. 3459--><p class="nopar" >
Note that <span 
class="cmmi-10">P</span><span 
class="cmsy-10">‚Ä≤ </span>does not depend on the gyro-angle <span 
class="cmmi-10">Œ±</span>.]
</p><!--l. 3462--><p class="indent" >   Then the weight of a marker is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x11-63004r262"></a>
   <center class="math-display" >
<img 
src="nonlinear_gyrokinetic_equation293x.png" alt="    Œ¥fg(œà,ùúÉ,œï,v‚à•,v‚ä•)
w = -----N--P------.
           p
" class="math-display"  /></center></td><td class="equation-label">(262)</td></tr></table>
<!--l. 3466--><p class="nopar" >
Since both <span 
class="cmmi-10">f</span><sub><span 
class="cmmi-7">g</span></sub> and <span 
class="cmmi-10">P </span>is independent of the gyro-angle <span 
class="cmmi-10">Œ±</span>, <span 
class="cmmi-10">w </span>is also independent of <span 
class="cmmi-10">Œ±</span>.
</p><!--l. 3470--><p class="indent" >   The numerical representation of <span 
class="cmmi-10">Œ¥f</span><sub><span 
class="cmmi-7">g</span></sub> is written
</p>
   <table 
class="equation"><tr><td><a 
 id="x11-63005r263"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="nonlinear_gyrokinetic_equation294x.png" alt="           Np
Œ¥fÀú = --1--‚àë  w Œ¥(œà‚àí œà )Œ¥(ùúÉ‚àí ùúÉ )Œ¥(œï ‚àí œï )Œ¥(v ‚àí v  )Œ¥(v  ‚àí v  )Œ¥(Œ± ‚àí Œ± ).
  g   ùí•rv‚ä•  j  j       j      j       j   ‚à•   ‚à•j   ‚ä•    ‚ä•j       j
" class="math-display"  /></center></td><td class="equation-label">(263)</td></tr></table>
<!--l. 3476--><p class="nopar" >
Although the distribution function <span 
class="cmmi-10">Œ¥f</span><sub><span 
class="cmmi-7">g</span></sub> to be sampled is independent of the gyro-angle <span 
class="cmmi-10">Œ±</span>,
we still need to specify the gyro-angle because we need to use the inverse guiding-center
transformation, which needs the gyro-angle. Each marker needs to have a speciÔ¨Åc gyro-angle value <span 
class="cmmi-10">Œ±</span><sub><span 
class="cmmi-7">j</span></sub>
so that we know how to transform its <span 
class="cmbx-10">X</span><sub><span 
class="cmmi-7">j</span></sub> to <span 
class="cmbx-10">x</span><sub><span 
class="cmmi-7">j</span></sub> and then do the charge deposition in <span 
class="cmbx-10">x</span>
space.
</p><!--l. 3484--><p class="indent" >   To increase the resolution over the gyro-angle (the quantity of intest to us, e.g., density,
is the integration of the particle distribution function at Ô¨Åxed spatial location, and the
distribution at the Ô¨Åxed location is not uniform in the gyro-angle), we need to load more
markers. However, thanks to the fact that both sampling probability density function <span 
class="cmmi-10">P </span>and
<span 
class="cmmi-10">Œ¥f</span><sub><span 
class="cmmi-7">g</span></sub> are independent of <span 
class="cmmi-10">Œ±</span>, the resolution over the gyro-angle can be increased in a simple
way.
</p>
   <table 
class="equation"><tr><td><a 
 id="x11-63006r264"></a>
   <center class="math-display" >
<img 
src="nonlinear_gyrokinetic_equation295x.png" alt="       n1(x-)+-n2(x-)+-n3(x-)+-n4(x-)
n(x) =             4             .
" class="math-display"  /></center></td><td class="equation-label">(264)</td></tr></table>
<!--l. 3494--><p class="nopar" >
This corresponds to sampling the 6D phase-space 4 separate times (each time with identical
sampling points in (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub>) but diÔ¨Äerent sampling points in <span 
class="cmmi-10">Œ±</span>) and then using the averaging
of the 4 Monte-Carlo integrals to estimate the exact value. This estimation can also be
(roughly) considered as a Monte-Carlo estimation using 4 times larger number of markers
as that is originally used (the Monte-Carlo estimation using truly 4 time larger number
of markers is more accurate than the result we obtained above because the former also
increase the resolution of (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub>) while the latter keeps the resolution of (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub>)
unchanged.)
</p><!--l. 3506--><p class="indent" >   In numerical code, we choose <span 
class="cmmi-10">N </span>sampling points that are evenly distributed on the gyro-ring (<span 
class="cmmi-10">N </span>is
usually 4 as a compromise between eÔ¨Éciency and accuracy). Denote the Mote-Carlo weight of the <span 
class="cmmi-10">j</span> th
marker by <span 
class="cmmi-10">w</span><sub><span 
class="cmmi-7">j</span></sub>. Then the weight is evenly split by the <span 
class="cmmi-10">N </span>sub-markers on the gyro-ring. Therefore each
sub-marker have a Monte-Carlo weight <span 
class="cmmi-10">w</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">‚àïN</span>. Then calculating the integration (<a 
href="#x11-65003r270">270<!--tex4ht:ref: 19-1-19-p1 --></a>) at a grid
                                                                                

                                                                                
corresponds to depositing all the <span 
class="cmmi-10">N </span>sub-markers associated with each guiding-center marker to the grid,
as is illustrated in Fig. <a 
href="#x11-630076">6<!--tex4ht:ref: 19-1-19-p4 --></a>. However, interpreting in this way is confusing to me because, with a single
sampling of the phase-space, the phase-space volume or weight can not be easily split. I prefer the
above interpretation that the 6D phase space is sampled 4 separate times and thus we get 4 estimations
and Ô¨Ånally we take the averaging of these 4 estimations. It took a long time for me to Ô¨Ånally Ô¨Ånd this
way of understanding.
</p>
   <hr class="figure" /><div class="figure" 
>
                                                                                

                                                                                
<a 
 id="x11-630076"></a>
                                                                                

                                                                                
<!--l. 3522--><p class="noindent" > <img 
src="my_figure/home/yj/theory/figures/grids_cells/grids-3.png" alt="pict"  
 width="182.6825pt" />
<br /> </p><div class="caption" 
><span class="id">Figure¬†6: </span><span  
class="content">The spatial grid in the plane perpendicular to the equilibrium magnetic Ô¨Åeld, a
guiding-center marker <span 
class="cmmi-10">C</span>, and its gyro-ring with 4 sampling points (sub-markers) on it. The 4
sub-markers are calculated by using the transformation (<a 
href="nonlinear_gyrokinetic_equationse2.html#x3-5003r19">19<!--tex4ht:ref: 19-1-19-p2 --></a>) (inverse guiding-center transform).
Assume that Monte-Carlo weight of the guiding-center marker <span 
class="cmmi-10">C</span> is <span 
class="cmmi-10">w</span><sub><span 
class="cmmi-7">j</span></sub>. Then The Monte-Carlo
weight of each sub-marker is <span 
class="cmmi-10">w</span><sub><span 
class="cmmi-7">j</span></sub><span 
class="cmmi-10">‚àï</span>4. The value of integration (<a 
href="#x11-65003r270">270<!--tex4ht:ref: 19-1-19-p1 --></a>) at a grid point is approximated
by  <span 
class="cmmi-10">I‚àï</span>Œî<span 
class="cmmi-10">V </span>,  where  <span 
class="cmmi-10">I  </span>is  the  Monte-Carlo  integration  of  all  sub-markers  (associated  with  all
guiding-center markers) in the cell, Œî<span 
class="cmmi-10">V </span>is the cell volume. The cell associated with a grid-point
(e.g., <span 
class="cmmi-10">A</span>) is indicated by the dashed rectangle (this is for the 2D projection, the cell is 3D and
it is a cube). If the Dirac delta function is used as the shape function of the sub-markers,
then calculating the contribution of a sub-marker to a grid corresponds to the nearest-point
interpolation (for example, the 4 sub-markers will contribute nothing to grid point <span 
class="cmmi-10">B </span>since no-sub
marker is located within the cell). In practice, the Ô¨Çat-top shape function with its support equal
to the cell size is often used, then the depositing corresponds to linearly interpolating the weight
of each sub-marker to the nearby grids.</span></div><!--tex4ht:label?: x11-630076 -->
                                                                                

                                                                                
   </div><hr class="endfigure" />
<!--l. 3545--><p class="indent" >   ¬†
</p><!--l. 3547--><p class="indent" >   In summary, the phase-space to be sampled in gyrokinetic simulations are still 6D rather than
5D. In this sense, the statement that gyrokinetic simulation works in a 5D phase space is
misleading. We are still working in the 6D phase-space. The only subtle thing is that the sixth
dimension, i.e., gyro-angle, can be sampled in an easy way that is independent of the other 5
variables.
</p><!--l. 3554--><p class="indent" >   In numerical implementation, the gyro-angle may not be explicitly used. We just try to Ô¨Ånd 4
arbitrary points on the gyro-ring that are easy to calculate. Some codes (e.g. ORB5) introduces a
random variable to rotate these 4 points for diÔ¨Äerent markers so that the gyro-angle can be sampled
less biased.
</p><!--l. 3560--><p class="indent" >   From the view of particle simulations, the gyrokinetic model can be considered as a noise reduction
method, where the averaging over the gyro-angle is equivalent to a time averaging over a gyro-period,
which reduces the Ô¨Çuctuation level (in both time and space) associated with evaluating the
Monte-Carlo phase integration. Here the averaging in gyrokinetic particle simulation refers to taking
several points on a gyro-ring when depositing markers to spatial grids to obtain the density and current
on the grids. (Another gyro-averaging appears in evaluating the guiding-center drift.) In gyrokinetic
particle simulation, even a step size smaller than a gyro-period is taken, the quantities used
in the model is still the ones averaged over one gyro-period. In this sense, a gyrokinetic
simulation is only meaningful when the time step size is larger than one gyro-period. [**Some
authors may disagree with that the gyro-averaging is a time-averaging. They may consider the
gyro-averaging as the phase-space integration over the gyro-angle coordinate. This view
seems to be right in Euler simulations but seems to be wrong in particle simulations. The
reason is as follows. For each marker, choose a random gyro-phase and then do the inverse
transformation to obtain particle position, and sum over all markers (this corresponds to phase-space
Monte-Carlo integration, which include the gyro-angle integration, so no further gyro-angle
integration is needed); choose another random gyro-phase and repeat the above procedure
(this can be interpreted as do the phase-space Monte-Carlo integration at another time),
choose further random gyro-phase for each marker and repeat. Finally averaging all the
above values to obtain the Ô¨Ånal estimation of the phase-space integration. This amounts to
a time-averaging over a gyro-motion. In summary, sampling several times with diÔ¨Äerent
gyro-phases for each marker and taking the average amounts to the time averaging over
gyro-motion**]
</p><!--l. 3588--><p class="indent" >   When doing the time-average over the ion cyclotron motion, the time variation of the low-frequency
mode is negligible and only the spatial variation of the modes is important. For the gyro-motion, only
the gyro-angle is changing and all the other variables, (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚ä•</span></sub><span 
class="cmmi-10">,v</span><sub><span 
class="cmsy-7">‚à•</span></sub>), ¬†are approximately constant. As a
result, this time averaging Ô¨Ånally reduces to a gyro-averaging.
</p><!--l. 3595--><p class="indent" >   ¬†
</p><!--l. 3597--><p class="indent" >   I am always reasoning in terms of particle position and velocity, considering the guiding-center
location as an image of the particle position. When working in the guiding-center coordinates, I always
reason by transforming back to the particle position. This reasoning is clear and help me avoid some
confusions I used to have.
</p><!--l. 3603--><p class="indent" >   ¬†
</p><!--l. 3605--><p class="indent" >   ¬†
</p>
   <h4 class="subsectionHead"><span class="titlemark">A.3   </span> <a 
 id="x11-64000A.3"></a>Distribution function transform**check</h4>
<!--l. 3609--><p class="noindent" >In the above, we assume that <span 
class="cmbx-10">X </span>and <span 
class="cmbx-10">x </span>are related to each other by the guiding-center transformation
                                                                                

                                                                                
(<a 
href="nonlinear_gyrokinetic_equationse2.html#x3-5001r17">17<!--tex4ht:ref: 16-9-21-1 --></a>) or (<a 
href="nonlinear_gyrokinetic_equationse2.html#x3-5003r19">19<!--tex4ht:ref: 19-1-19-p2 --></a>) , i.e., <span 
class="cmbx-10">x </span>and <span 
class="cmbx-10">X </span>are not independent. For some cases, it may be convenient to treat <span 
class="cmbx-10">x </span>and <span 
class="cmbx-10">X</span>
as independent variables and express the guiding-center transformation via an integral of the Dirac
delta function. For example,
</p>
   <table 
class="equation"><tr><td><a 
 id="x11-64001r265"></a>
   <center class="math-display" >
<img 
src="nonlinear_gyrokinetic_equation296x.png" alt="         ‚à´
f (x,v) =  f (X,v)Œ¥3(X ‚àí x+ œÅ)dX,
 p          g
" class="math-display"  /></center></td><td class="equation-label">(265)</td></tr></table>
<!--l. 3618--><p class="nopar" >
where <span 
class="cmbx-10">x </span>and <span 
class="cmbx-10">X </span>are considered as independent variables, <span 
class="cmmib-10">œÅ</span> is the gyroradius evaluated at <span 
class="cmbx-10">x</span>,
<span 
class="cmmi-10">Œ¥</span><sup><span 
class="cmr-7">3</span></sup>(<span 
class="cmbx-10">x </span><span 
class="cmsy-10">‚àí </span><span 
class="cmbx-10">X </span><span 
class="cmsy-10">‚àí</span> <span 
class="cmmib-10">œÅ</span>) is the three-dimensional Dirac delta function. [In terms of general coordinates
(<span 
class="cmmi-10">x</span><sub><span 
class="cmr-7">1</span></sub><span 
class="cmmi-10">,x</span><sub><span 
class="cmr-7">2</span></sub><span 
class="cmmi-10">,x</span><sub><span 
class="cmr-7">3</span></sub>), the three-dimensional Dirac delta function is deÔ¨Åned via the 1D Dirac delta function as
follows:
</p>
   <table 
class="equation"><tr><td><a 
 id="x11-64002r266"></a>
   <center class="math-display" >
<img 
src="nonlinear_gyrokinetic_equation297x.png" alt="Œ¥3(x) = -1-Œ¥(x1)Œ¥(x2)Œ¥(x3),
       |ùí• |
" class="math-display"  /></center></td><td class="equation-label">(266)</td></tr></table>
<!--l. 3628--><p class="nopar" >
where <span 
class="cmsy-10">ùí• </span>is the the Jacobian of the general coordinate system. The Jacobian is included in order to
make <span 
class="cmmi-10">Œ¥</span><sup><span 
class="cmr-7">3</span></sup>(<span 
class="cmbx-10">x</span>) satisfy the normalization condition <span 
class="cmex-10">‚à´</span>
  <span 
class="cmmi-10">Œ¥</span><sup><span 
class="cmr-7">3</span></sup>(<span 
class="cmbx-10">x</span>)<span 
class="cmmi-10">d</span><span 
class="cmbx-10">x </span>= <span 
class="cmex-10">‚à´</span>
  <span 
class="cmmi-10">Œ¥</span><sup><span 
class="cmr-7">3</span></sup>(<span 
class="cmbx-10">x</span>)<span 
class="cmsy-10">|ùí•|</span><span 
class="cmmi-10">dx</span><sub><span 
class="cmr-7">1</span></sub><span 
class="cmmi-10">dx</span><sub><span 
class="cmr-7">2</span></sub><span 
class="cmmi-10">dx</span><sub><span 
class="cmr-7">3</span></sub> = 1.]
</p><!--l. 3634--><p class="indent" >   Expression (<a 
href="#x11-64001r265">265<!--tex4ht:ref: 19-1-20-e1 --></a>) can be considered as a transformation that transforms an arbitrary function from
the guiding-center coordinates to the particle coordinates. Similarly,
</p>
   <table 
class="equation"><tr><td><a 
 id="x11-64003r267"></a>
                                                                                

                                                                                
   <center class="math-display" >
<img 
src="nonlinear_gyrokinetic_equation298x.png" alt="          ‚à´
fg(X,v) =   fp(x,v)Œ¥3(x ‚àí X ‚àí œÅ )dx,
" class="math-display"  /></center></td><td class="equation-label">(267)</td></tr></table>
<!--l. 3640--><p class="nopar" >
is a transformation that transforms an arbitrary function from the the particle coordinates to the
guiding-center coordinates.
</p><!--l. 3645--><p class="noindent" >
</p>
   <h4 class="subsectionHead"><span class="titlemark">A.4   </span> <a 
 id="x11-65000A.4"></a>Moments of distribution function expressed as integration over guiding-center
variables</h4>
<!--l. 3647--><p class="noindent" >In terms of particle variables (<span 
class="cmbx-10">x</span><span 
class="cmmi-10">,</span><span 
class="cmbx-10">v</span>), it is straightforward to calculate the moment of the distribution
function. For example, the number density <span 
class="cmmi-10">n</span>(<span 
class="cmbx-10">x</span>) is given by
</p>
   <table 
class="equation"><tr><td><a 
 id="x11-65001r268"></a>
   <center class="math-display" >
<img 
src="nonlinear_gyrokinetic_equation299x.png" alt="      ‚à´
n(x) =  fp(x,v)dv.
" class="math-display"  /></center></td><td class="equation-label">(268)</td></tr></table>
<!--l. 3653--><p class="nopar" >
However, it is a little diÔ¨Écult to calculate <span 
class="cmmi-10">n</span>(<span 
class="cmbx-10">x</span>) at real space location <span 
class="cmbx-10">x </span>by using the guiding-center
variables (<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,</span><span 
class="cmbx-10">v</span>). This is because holding <span 
class="cmbx-10">x </span>constant and changing <span 
class="cmbx-10">v</span>, which is required by the
integration in Eq. (<a 
href="#x11-65001r268">268<!--tex4ht:ref: 18-12-26-p1 --></a>), means the guiding-center variable <span 
class="cmbx-10">X </span>is changing according to Eq. (<a 
href="nonlinear_gyrokinetic_equationse2.html#x3-5001r17">17<!--tex4ht:ref: 16-9-21-1 --></a>). Using
Eq. (<a 
href="nonlinear_gyrokinetic_equationse2.html#x3-8001r24">24<!--tex4ht:ref: 17-8-19-p1 --></a>), expression (<a 
href="#x11-65001r268">268<!--tex4ht:ref: 18-12-26-p1 --></a>) is written as
</p>
   <table 
class="equation"><tr><td><a 
 id="x11-65002r269"></a>
   <center class="math-display" >
                                                                                

                                                                                
<img 
src="nonlinear_gyrokinetic_equation300x.png" alt="      ‚à´
n(x) =   f (X (x,v),v )dv,
          g
" class="math-display"  /></center></td><td class="equation-label">(269)</td></tr></table>
<!--l. 3664--><p class="nopar" >
As is mentioned above, the <span 
class="cmmi-10">d</span><span 
class="cmbx-10">v </span>integration in Eq. (<a 
href="#x11-65002r269">269<!--tex4ht:ref: 18-12-26-p2 --></a>) should be performed by holding <span 
class="cmbx-10">x </span>constant and
changing <span 
class="cmbx-10">v</span>, which means the guiding-center variable <span 
class="cmbx-10">X </span>= <span 
class="cmbx-10">X</span>(<span 
class="cmbx-10">x</span><span 
class="cmmi-10">,</span><span 
class="cmbx-10">v</span>) is changing. This means that, in
(<span 
class="cmbx-10">X</span><span 
class="cmmi-10">,</span><span 
class="cmbx-10">v</span>) space, the above integration is a (generalized) curve integral along the the curve
¬†<span 
class="cmbx-10">X</span>(<span 
class="cmbx-10">v</span>) = <span 
class="cmbx-10">x </span><span 
class="cmsy-10">‚àí</span><span 
class="cmmib-10">œÅ</span>(<span 
class="cmbx-10">x</span><span 
class="cmmi-10">,</span><span 
class="cmbx-10">v</span>) with <span 
class="cmbx-10">x </span>being constant. Treating <span 
class="cmbx-10">X </span>and <span 
class="cmbx-10">x </span>as independent variables and using the
Dirac delta function <span 
class="cmmi-10">Œ¥</span>, this curve integral can be written as the following double integration over the
independent variables <span 
class="cmbx-10">X </span>and <span 
class="cmbx-10">v</span>:
</p>
   <table 
class="equation"><tr><td><a 
 id="x11-65003r270"></a>
   <center class="math-display" >
<img 
src="nonlinear_gyrokinetic_equation301x.png" alt="      ‚à´  ‚à´
n(x) =     f (X, v)Œ¥3(X ‚àí x + œÅ)dvdX.
            g
" class="math-display"  /></center></td><td class="equation-label">(270)</td></tr></table>
<!--l. 3679--><p class="nopar" >
Another perspective of interpreting Eq. (<a 
href="#x11-65003r270">270<!--tex4ht:ref: 19-1-19-p1 --></a>) is that we are Ô¨Årst using the transformation (<a 
href="#x11-64001r265">265<!--tex4ht:ref: 19-1-20-e1 --></a>) to
transform <span 
class="cmmi-10">f</span><sub><span 
class="cmmi-7">g</span></sub> to <span 
class="cmmi-10">f</span><sub><span 
class="cmmi-7">p</span></sub> and then integrating <span 
class="cmmi-10">f</span><sub><span 
class="cmmi-7">p</span></sub> in the velocity space.
</p><!--l. 3684--><p class="indent" >   ¬†
</p><!--l. 3686--><p class="indent" >   ¬†
                                                                                

                                                                                
</p>
   <!--l. 3688--><div class="crosslinks"><p class="noindent">[<a 
href="nonlinear_gyrokinetic_equationse11.html" >next</a>] [<a 
href="nonlinear_gyrokinetic_equationse9.html" >prev</a>] [<a 
href="nonlinear_gyrokinetic_equationse9.html#tailnonlinear_gyrokinetic_equationse9.html" >prev-tail</a>] [<a 
href="nonlinear_gyrokinetic_equationse10.html" >front</a>] [<a 
href="nonlinear_gyrokinetic_equation.html#nonlinear_gyrokinetic_equationse10.html" >up</a>] </p></div>
<!--l. 3688--><p class="indent" >   <a 
 id="tailnonlinear_gyrokinetic_equationse10.html"></a>  </p> 
</body></html> 
